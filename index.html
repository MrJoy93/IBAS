<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<!-- Safariにダークモード対応を宣言 -->
<meta name="color-scheme" content="dark light">
<meta name="theme-color" content="#121826" media="(prefers-color-scheme: dark)">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=M+PLUS+2:wght@400;500;700&display=swap" rel="stylesheet">
<title>IBASD  Ver. 8.0.1</title>
<style>

  html, body {
  background-color: #121826 !important;
  color: #eaf6ff; /* 既存の文字色と統一 */
}

*, *::before, *::after { box-sizing: border-box; }
html, body { overflow-x: hidden; }
html { scrollbar-gutter: stable; }

  #resetOverlay {
  position: fixed;
  z-index: 99999;
  left: 0; top: 0; width: 100%; height: 100vh;
  background: #191924;
  opacity: 0;
  transition: opacity 0.8s;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
}
#resetOverlay.active {
  opacity: 1;
  pointer-events: auto;
}

#matrixCanvas {
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 100vh;
  z-index: 2;
  pointer-events: none;
}

#resetFlash {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100vh;
  background: white;
  opacity: 0;
  z-index: 3;
  transition: opacity 0.5s;
  pointer-events: none;
}

body {
  background: linear-gradient(135deg, #191924, #212c4a 80%);
  color: #eaf6ff;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  font-size: 20px;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  letter-spacing: 0.02em;
}

body[data-active-app="app1"],
body[data-active-app="app2"],
body[data-active-app="app3"]{
  padding-top: var(--tabs-h);
}

/* --- タブバー --- */
.tabs {
  display: flex;
  background: rgba(24, 24, 48, 0.78);
  backdrop-filter: blur(8px);
  position: fixed;
  top: 0;
  z-index: 2000;
  border-bottom: 1.5px solid #0ff7ff55;
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  box-shadow: 0 4px 32px #161a2899;
}
.tab {
  flex: 1;
  padding: 16px 0;
  text-align: center;
  color: #97e4f5;
  cursor: pointer;
  user-select: none;
  border-bottom: 3px solid transparent;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  font-size: 20px;
  letter-spacing: 0.07em;
  transition: background 0.25s, border-bottom-color 0.3s, color 0.3s;
}
.tab:hover {
  background: rgba(0,255,255,0.08);
}
.tab.active {
  background: rgba(16,16,48,0.8);
  border-bottom-color: #00f5ff;
  color: #00f5ff;
  font-weight: 600;
  text-shadow: 0 0 8px #00f5ff55;
}

/* --- 共通セクション --- */
.content {
  background: rgba(30, 38, 60, 0.78);
  color: #eaf6ff;
  padding: 30px 5vw 80px 5vw;
  padding-top: calc(var(--tabs-h) + var(--subnav-h) - 50px ) !important;
  min-height: 300px;
  width: 100%;
  max-width: none !important;
  margin: 0 !important;
  box-sizing: border-box;
  text-align: left;
}

/* --- ボタン --- */
button {
  background: linear-gradient(90deg, #202056 60%, #009be6 120%);
  color: #eaf6ff;
  border: 1.5px solid #00eaff;
  border-radius: 10px;
  padding: 12px 28px;
  font-size: 18px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  box-shadow: 0 0 10px #00eaff44;
  margin: 3px 6px;
  cursor: pointer;
  transition: all 0.2s;
  outline: none;
  letter-spacing: 0.09em;
  text-align: center;
  min-width: 80px;
}
button:hover, .tab.active {
  background: linear-gradient(90deg, #00f5ff 20%, #2636b3 80%);
  color: #fff;
  box-shadow: 0 0 18px #00f5ffbb;
  transform: translateY(-2px) scale(1.02);
}

/* --- テーブル --- */
table {
  border-radius: 16px;
  border-collapse: separate;
  border-spacing: 0;
  background: rgba(20,28,40,0.82);
  box-shadow: 0 0 24px #00eaff33;
  overflow: hidden;
  width: 100%;
  margin-bottom: 26px;
}
tbody {
  border-radius: 14px;
  overflow: hidden;
}
th, td {
  border-bottom: 1.5px solid #00f5ff55;
  padding: 10px 7px;
  text-align: left; /* ←左揃え */
  background: rgba(24,30,50,0.85);
  font-size: 17px;
}
th {
  color: #00f5ff;
  font-size: 18px;
  background: linear-gradient(90deg,#23467a 40%,#197b91 100%);
  font-weight: bold;
  letter-spacing: 0.05em;
}
tr:last-child td {
  border-bottom: none;
}
tr.row:hover td {
  background: rgba(0,245,255,0.09);
}

/* --- 各フォーム/グループ --- */
.group {
  padding: 24px 24px 16px 24px;
  margin: 18px 0;
  border-radius: 18px;
  background: rgba(10, 20, 40, 0.87);
  box-shadow: 0 2px 18px #00eaff12;
}

.group h3, .group-title {
  text-align: left !important;
  font-size: 22px;
  margin: 0 0 18px 0;
  padding-left: 3px;
  color: #fff;
  letter-spacing: 0.02em;
}

/* --- labelの横並び＋右寄せフォーム --- */
.group label {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 0;
  margin-bottom: 12px;
  width: 100%;
}

.group label > span,
.group label > strong,
.group label > b {
  min-width: 140px;
  max-width: 210px;
  text-align: left;
  letter-spacing: 0.03em;
  font-size: 17px;
  flex-shrink: 0;
}

.group label input,
.group label select,
.group label button {
  margin-left: auto;
  flex: 1 1 120px;
  min-width: 120px;
  max-width: 260px;
  width: 150px;
  text-align: right;
  box-sizing: border-box;
}

.group label input[type="checkbox"] {
  flex: 0 0 auto;
  margin-left: 15px;
  width: auto;
}

.group label button {
  min-width: 100px;
  max-width: 180px;
  width: 120px;
}

/* --- 入力欄 --- */
input, select, textarea {
  background: rgba(38, 56, 77, 0.72);
  color: #00f5ff;
  border: 1.5px solid #25f1ff77;
  border-radius: 7px;
  font-size: 17px;
  padding: 9px 14px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  margin: 3px 0;
  outline: none;
  box-shadow: 0 1px 8px #00eaff44;
  transition: border 0.2s, background 0.19s;
}
input:focus, select:focus, textarea:focus {
  border-color: #00eaff;
  background: rgba(42, 86, 120, 0.95);
  color: #fff;
}

/* --- テーブル行削除ボタン --- */
.delete-btn {
  background: linear-gradient(90deg, #f73378 40%, #0ff 160%);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 18px;
  box-shadow: 0 0 12px #00eaff99;
  cursor: pointer;
  transition: background 0.23s, box-shadow 0.19s, transform 0.12s;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
}
.delete-btn:hover {
  background: #ff007c;
  color: #fff;
  box-shadow: 0 0 24px #f7337888, 0 0 10px #0ff;
  transform: scale(1.07);
}

/* --- 固定ナビ --- */
#app1-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

#app1-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app1-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}

#app1-nav, #app2-nav, #app3-nav { display: none; }

body[data-active-app="app1"] #app1-nav { display: flex !important; }
body[data-active-app="app2"] #app2-nav { display: flex !important; }
body[data-active-app="app3"] #app3-nav { display: flex !important; }

/* app3 ではどちらも非表示 */
body[data-active-app="app3"] #app1-nav,
body[data-active-app="app3"] #app2-nav { display: none !important; }
body {
  padding-bottom: 86px;
}

/* --- 履歴 --- */
.history {
  margin-top: 38px;
  background: rgba(0,34,43,0.23);
  border-radius: 10px;
  box-shadow: 0 2px 12px #00f5ff12;
}
.history h3 {
  color: #00f5ff;
  margin-bottom: 8px;
}
.history li {
  margin-bottom: 10px;
  background: rgba(33,90,104,0.14);
  border-radius: 8px;
  box-shadow: 0 1px 8px #00eaff33;
  padding: 9px 15px;
  color: #97e4f5;
}

/* 赤系リセット・クリアボタン共通クラス */
.red-btn, .clear-btn, .reset-btn {
  background: linear-gradient(90deg, #f73378 30%, #d80032 100%);
  color: #fff !important;
  border: 1.5px solid #d80032;
  box-shadow: 0 0 12px #ff006288;
}
.red-btn:hover, .clear-btn:hover, .reset-btn:hover {
  background: linear-gradient(90deg, #f44 10%, #b00020 90%);
  color: #fff;
  box-shadow: 0 0 20px #ff2e62aa;
  transform: scale(1.05);
}

/* --- アニメーション・グロー --- */
.tab, button, .group, input, select, textarea {
  transition: box-shadow 0.23s, background 0.23s, color 0.18s, border 0.16s;
}
input:focus, select:focus {
  box-shadow: 0 0 12px #00f5ff77;
}

::-webkit-input-placeholder { color: #60ecffcc; }
::-moz-placeholder          { color: #60ecffcc; }
:-ms-input-placeholder      { color: #60ecffcc; }
::placeholder              { color: #60ecffcc; }

 #result {
  background: #1e1e1e;
  color: #fff;
  padding: 22px 18px 12px 18px;
  border-radius: 12px;
  margin-top: 24px;
  box-shadow: 0 0 8px rgba(0,0,0,0.08);
  font-size: 22px;
  font-family: Arial, sans-serif;
  border: none;
  letter-spacing: normal;
}

.subtotal, .totalAmount, .finalAmount {
  background: none !important;
  color: #fff !important;
  font-size: inherit !important;
  text-shadow: none !important;
  margin-bottom: 0;
  padding: 0;
}

.finalAmount, .print-highlight {
  color: #00eaff !important;
  font-size: 28px !important;
  font-weight: bold;
  background: none !important;
}

.subtotal {
  color: #36ffe7 !important;
}

.totalAmount {
  color: #feffb3 !important;
}

/* 結果全体 */
#result {
  background: linear-gradient(180deg,#142944 90%,#123);
  border-radius: 18px;
  color: #43eaff;
  padding: 32px 34px 18px 34px;
  margin-top: 22px;
  font-family: 'Orbitron','Segoe UI',Arial,sans-serif;
  font-size: 22px;
  box-shadow: 0 0 24px #00f5ff1c;
  border: none;
  text-align: left;
  letter-spacing: 0.02em;
}

#result .right-note{
  float: right;
  color: #fff4b7;
  font-size: 15px;
  opacity: .95;

  /* ←ここ1行だけ追加して左に寄せる */
  margin-right: 3mm;  /* 数値を2〜5mmで微調整 */
}

/* app1の伝票入力部分だけ調整する例 */

#app1 table, #app1 .row, #app1 input, #app1 select {
  /* 伝票テーブルや各行、入力欄の装飾 */
  background: rgba(30, 30, 40, 0.85);
  color: #f6ffe8;
  font-size: 18px;
  border-radius: 10px;
  box-shadow: 0 2px 12px #0ff3;
  border: none;
  margin-bottom: 8px;
}

#app1 th, #app1 td {
  background: rgba(24,30,50,0.85);
  color: #81e1ff;
  font-size: 17px;
  border-bottom: 1.5px solid #00f5ff33;
  padding: 8px 5px;
}

#app1 tr.row:hover td {
  background: rgba(0,245,255,0.13);
}

#app1 input[type="text"], #app1 input[type="number"], #app1 select {
  background: #18344c;
  color: #fff;
  border: 1.5px solid #25f1ff44;
  border-radius: 5px;
  font-size: 17px;
  padding: 6px 11px;
  margin: 2px 0;
  outline: none;
  box-shadow: 0 1px 8px #00eaff22;
}

#app1 input[type="text"]:focus, #app1 input[type="number"]:focus {
  border-color: #00eaff;
  background: #225a7a;
  color: #fff;
}

#app1 .delete-btn {
  background: linear-gradient(90deg, #f73378 40%, #0ff 160%);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 26px;
  height: 26px;
  font-size: 15px;
  box-shadow: 0 0 12px #00eaff44;
  cursor: pointer;
  margin: 0 auto;
}

#app1 input[type="text"],
#app1 input[type="number"],
#app1 select {
  text-align: right !important;
}


/* コンテンツ切替時の近未来的なアニメーション */
.content {
  opacity: 0;
  transform: scale(0.96) translateY(10px);
  transition: opacity 0.4s ease, transform 0.4s ease;
}

.content.active {
  opacity: 1;
  transform: scale(1) translateY(0);
}

/* スライドインアニメーション */
@keyframes slideInRow {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

/* アニメーション用クラス */
.row.slide-in {
  animation: slideInRow 0.5s ease-out;
}

@keyframes slideOutLeft {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-120%);
  }
}
.row.slide-out-left {
  animation: slideOutLeft 0.32s cubic-bezier(.77,.17,.3,1.11) forwards;
}

@keyframes slideInRight {
  0% {
    opacity: 0;
    transform: translateX(120%);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}
.row.slide-out-left {
  animation: slideOutLeft 0.28s cubic-bezier(.77,.17,.3,1.11) forwards;
}
.row.slide-in-right {
  animation: slideInRight 0.28s cubic-bezier(.77,.17,.3,1.11) forwards;
}

#app2-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

#app2-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app2-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}

#app3-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

/* app3 サブナビボタン */
#app3-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app3-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}



/* どの端末でも横スクロールを封じる & 幅計算を安定させる */
*, *::before, *::after { box-sizing: border-box; }
html, body { overflow-x: hidden; }



/* 100vw ではみ出すのを防ぐ（PC時の横ズレ対策） */
.tabs    { width: 100%; }   /* もともと width:100vw なら上書き */
.content { width: 100%; }   /* もともと width:100vw なら上書き */


/* ===== PC/タブレット(共通)：従来どおり横並び ===== */
.ticket-toolbar{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
}
.ticket-toolbar .add-btn{
  padding: 12px 24px;
  line-height: 1;
}
.ticket-toolbar .search-box{
  display: flex;
  align-items: center;
  gap: 8px;
}
.ticket-toolbar .search-box #searchAmount{
  width: 160px;
  text-align: right;
}



/* === CB表 4列の見た目を整える === */
#categorySection th, #categorySection td { text-align: left; }
#categorySection th:nth-child(1), #categorySection td:nth-child(1) {
  width: 56px; text-align: center;
}
#categorySection th:nth-child(3), #categorySection td:nth-child(3),
#categorySection th:nth-child(4), #categorySection td:nth-child(4) {
  text-align: right;
}
/* チェックを少し大きく */
#categorySection input[type="checkbox"] { transform: scale(1.15); }


/* === CB表：チェック列を細く、残り3列を均等割りに === */
#categorySection table{
  table-layout: fixed;                 /* ← 幅指定をきっちり効かせる */
  width: 100%;
}

/* 余白と折返しを整える（ヘッダが縦に割れないように） */
#categorySection th, #categorySection td{
  padding: 8px 6px;
  white-space: nowrap;
}

/* 1列目：チェックだけ。極細＋中央寄せ */
#categorySection th:nth-child(1),
#categorySection td:nth-child(1){
  width: 40px;                         /* ← ここで細く */
  text-align: center;
  padding-left: 4px; padding-right: 4px;
}
#categorySection td:nth-child(1) input[type="checkbox"]{
  /* 大きすぎると幅を食うので控えめに */
  transform: scale(1.0);
  margin: 0 auto; display: block;
}

/* 残り3列を完全均等割り（calc で残り幅を3分割） */
#categorySection th:nth-child(2),
#categorySection td:nth-child(2),
#categorySection th:nth-child(3),
#categorySection td:nth-child(3),
#categorySection th:nth-child(4),
#categorySection td:nth-child(4){
  width: calc((100% - 40px) / 3);      /* ← 40px はチェック列の幅と一致させる */
}

/* 体裁：カテゴリは左、数値は右で揃える */
#categorySection th:nth-child(2), #categorySection td:nth-child(2){ text-align: left;  }
#categorySection th:nth-child(3), #categorySection td:nth-child(3),
#categorySection th:nth-child(4), #categorySection td:nth-child(4){ text-align: right; }


/* === app2 サイドナビ（右端固定） === */
#app2-sideNav{
  position: fixed;
  top: 140px;
  right: 23px;                 /* 右端に少し余白 */
  width: 210px;
  padding: 12px 10px;
  background: rgba(10,20,40,0.92);
  backdrop-filter: blur(8px);

  /* ← ここを変更：左だけの罫線→全面ボーダー＋角丸 */
  border: 1.5px solid rgba(0,245,255,.35);
  border-radius: 14px;

  /* 影も“面”で回す（右側が切れて見えない） */
  box-shadow:
    0 6px 28px rgba(0,245,255,.18),
    0 2px 10px rgba(0,0,0,.35);

  z-index: 1200;
  overflow: hidden;            /* 内側のグロー用にマスク */
}

#app2-sideNav .sideNav-title {
  font-size: 16px;
  font-weight: bold;
  color: #00f5ff;
  text-align: center;
  margin-bottom: 10px;
  letter-spacing: .05em;
}

#app2-sideNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#app2-sideNav li { margin-bottom: 8px; }

#app2-sideNav button {
  width: 100%;
  padding: 9px 10px;
  font-size: 15px;
  background: rgba(20,40,70,.85);
  border: 1px solid rgba(0,234,255,.35);
  border-radius: 10px;
  color: #eaf6ff;
  cursor: pointer;
  transition: background .2s, color .2s, transform .12s;

  /* ★これを追加 */
  text-align: center;      /* テキストを中央揃え */
  justify-content: center; /* flex要素化されている場合も中央揃え */
}

/* === サイドナビのクリアボタンだけ赤にする === */
#app2-sideNav #side-clear {
  background: linear-gradient(90deg, #f73378 30%, #d80032 100%) !important;
  color: #fff !important;
  border: 1.5px solid #d80032 !important;
  box-shadow: 0 0 12px #ff006288 !important;
}
#app2-sideNav #side-clear:hover {
  background: linear-gradient(90deg, #f44 10%, #b00020 90%) !important;
  box-shadow: 0 0 20px #ff2e62aa !important;
  transform: scale(1.05);
}

#app2-sideNav button:hover {
  background: #00f5ff;
  color: #111;
  transform: translateY(-1px);
}

/* 氏名の上 */
#app2-sideNav li:first-of-type button {
  border-top: 2px solid #00f5ff !important;
  margin-top: 8px !important;
  padding-top: 8px !important;
}

/* Drink の下 */
#app2-sideNav button[data-target="a"] {
  border-bottom: 2px solid #00f5ff !important;
  margin-bottom: 8px !important;
  padding-bottom: 8px !important;
}

/* 計算 の上 */
#side-calc {
  border-top: 2px solid #00f5ff !important;
  margin-top: 8px !important;
  padding-top: 8px !important;
}

/* クリア の下 */
#side-clear {
  border-bottom: 2px solid #00f5ff !important;
  margin-bottom: 8px !important;
  padding-bottom: 8px !important;
}

/* 履歴 の上下 */
#side-scroll-history {
  border-top: 2px solid #00f5ff !important;
  border-bottom: 2px solid #00f5ff !important;
  margin-top: 10px !important;
  margin-bottom: 10px !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}


/* サイドナビのぶん app2 コンテンツを縮小 */
#app2 {
  width: calc(100% - 140px) !important;
  max-width: none !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  box-sizing: border-box;
}

/* 既定は非表示にする */
#app2-sideNav { display: none; }

body[data-active-app="app2"] #app2-sideNav {
  display:block !important;
  position:fixed;
  top:140px;
  right:8px;
  width:100px;
  padding:8px;
  border-radius:10px;
  z-index:1200;
}

/* APP1とAPP3の時は非表示（保険） */
body[data-active-app="app1"] #app2-sideNav,
body[data-active-app="app3"] #app2-sideNav {
  display:none !important;
}

/* 内側の薄い縁取り＋外周グロー */
#app2-sideNav::before{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  box-shadow:
    inset 0 0 0 1px rgba(0,245,255,.25),
    0 0 32px rgba(0,245,255,.15);
  pointer-events: none;
}

#app2-sideNav::after{
  content: "";
  position: absolute;
  inset: -10px;                /* 外側にも少し光を回す */
  border-radius: inherit;
  background:
    radial-gradient(120px 60px at 90% 10%, rgba(0,245,255,.25), transparent 70%),
    radial-gradient(120px 60px at 10% 90%, rgba(0,245,255,.18), transparent 70%);
  filter: blur(16px);
  opacity: .5;
  pointer-events: none;
}

/* ボタン等の中身はそのままでOK（必要ならお好みで） */
#app2-sideNav .sideNav-title{
  font-size: 16px; font-weight: 700; letter-spacing: .05em;
  color: #00f5ff; text-align: center; margin-bottom: 10px;
}
#app2-sideNav ul{ list-style: none; margin: 0; padding: 0; }
#app2-sideNav li{ margin-bottom: 8px; }
#app2-sideNav button{
  width: 100%; min-width: 0;
  padding: 9px 10px; font-size: 15px;
  background: rgba(20,40,70,.85);
  border: 1px solid rgba(0,234,255,.35);
  border-radius: 10px; color: #eaf6ff;
  transition: background .2s, color .2s, transform .12s;
}
#app2-sideNav button:hover{ background:#00f5ff; color:#111; transform: translateY(-1px); }

/* === app2 サイドナビ：ボタン中央寄せを強制 === */
#app2-sideNav ul{
  display: flex;
  flex-direction: column;
  gap: 10px;              /* li間のすき間を一定に */
  align-items: stretch;   /* ボタンは列幅いっぱいに */
}

#app2-sideNav li{
  margin: 0; padding: 0;
  text-align: center;     /* 念のため */
}

#app2-sideNav button{
  display: flex;                /* 中央寄せの確実化 */
  align-items: center;
  justify-content: center;      /* ← 水平中央 */
  text-align: center !important;/* ← テキスト中央（上書き） */
  width: 100%;
  margin: 0;                    /* 余計な押し出しをリセット */
  padding-inline: 12px;         /* 左右バランス */
}

:root{
  --ff-orbi-jp: 'Orbitron', 'M PLUS 2', 'Noto Sans JP', 'Yu Gothic UI', 'Meiryo', sans-serif;
  --subnav-bg: rgba(0, 34, 43, 0.95);
  --tabs-h: 56px;
  --subnav-h: 50px;

  /* ★ 追加：スマホ時のサイドナビ幅とクリアランス */
  --side-nav-w: 100px;
  --side-nav-gap: 12px;
}

/* まず body に統一 */
html, body { font-family: var(--ff-orbi-jp) !important; }

/* 要素ごとのバラバラ指定を上書きして継承させる */
button, .tab, input, select, textarea,
.content, .group, table, th, td,
#result, #app1-nav button, #app2-nav button {
  font-family: inherit !important;
}

.group label > span,
.group label > strong,
.group label > b {
  font-family: inherit !important;
}

#app1-nav,
#app2-nav,
#app2-sideNav{
  background: var(--subnav-bg) !important;
}

/* カテゴリ表の金額横のミニボタン */
#categorySection .print-mini{
  padding: 3px 8px;
  font-size: 12px;
  line-height: 1.2;
  min-width: 0;
  margin-left: 8px;
}

/* app2/app3 の .content では transform を殺して固定化を守る */
body[data-active-app="app2"] #app2,
body[data-active-app="app2"] #app2.active,
body[data-active-app="app3"] #app3,
body[data-active-app="app3"] #app3.active {
  transform: none !important;
}

/* 合計行の人数セルを右寄せ */
#totalCount {
  text-align: right !important;
  white-space: nowrap;
}
#totalCount .count-value {
  display: inline-block;
  margin-right: 6px; /* 数字とボタンの間隔 */
}
#totalCount button {
  vertical-align: middle; /* 数字と高さを揃える */
}

/* サブナビ共通（PC/スマホ共通でタブ直下） */
.subnav{
  position: fixed;
  left: 0; right: 0;
  top: var(--tabs-h);          /* ← タブの直下 */
  height: var(--subnav-h);
  z-index: 1900;
  display: none;               /* アクティブ時のみ表示（下で切替） */
  justify-content: center;
  align-items: center;
  background: rgba(0,34,43,0.95);
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

/* ボタン共通 */
.subnav button{
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff; border: none; border-radius: 8px;
  padding: 9px 28px; margin: 0 16px; font-size: 19px;
  letter-spacing: 0.07em; box-shadow: 0 2px 8px #00f5ff66;
  transition: background .25s, box-shadow .19s;
}
.subnav button:hover{
  background:#00f5ff; color:#121212; box-shadow:0 2px 22px #00f5ff88;
}

/* アクティブアプリに応じて該当サブナビだけ表示 */
#app1-nav, #app2-nav, #app3-nav{ display:none; }
body[data-active-app="app1"] #app1-nav{ display:flex !important; }
body[data-active-app="app2"] #app2-nav{ display:flex !important; }
body[data-active-app="app3"] #app3-nav{ display:flex !important; }

#app1-nav, #app2-nav, #app3-nav{
  position: fixed;
  left: 0; right: 0;
  height: var(--subnav-h);
}


/* 共通デザイン */
#app2 .bottle-form {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  gap: 10px;   /* 少し広めに */
}

/* 左グループ（削除ボタン＋詳細セレクト） */
#app2 .bottle-form .left-group {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1 1 auto;   /* 左グループは残り幅を使う */
}

#app2 .bottle-form .delete-btn {
  flex: 0 0 28px;
  width: 28px;
  height: 28px;
  font-size: 15px;
  margin-right: 4px; /* セレクトと少し間隔 */
}

/* セレクト（詳細欄を大きめに） */
#app2 .bottle-form select.bottleDetails {
  flex: 1 1 220px;   /* ←詳細を広め */
  max-width: 260px;
  min-width: 180px;
}

/* 割人数・数量・金額を等幅で右に寄せる */
#app2 .bottle-form input.splitCount,
#app2 .bottle-form input.bottleQuantity,
#app2 .bottle-form input.bottleAmount {
  flex: 0 0 90px;    /* 等幅で揃える */
  width: 90px;
  text-align: right;
}

/* 金額フォームだけは少し大きめ（他ドリンク欄と揃える） */
#app2 .bottle-form input.bottleAmount {
  flex: 0 0 250px !important;  /* ← 幅を強制 */
  width: 140px;
  min-width: 140px;
}




/* 履歴インデックス（テーブル） */
.history-index-table {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)) !important;
  gap: 12px 16px !important;             /* 行と列のすき間 */
  justify-content: center !important;    /* 中央寄せ */
  align-items: center !important;
  padding: 16px 12px !important;
  background: rgba(20,28,40,0.82) !important;
  border-radius: 12px !important;
  box-shadow: 0 0 18px #00eaff22 !important;
}

/* テーブル構造を無視してボタンだけグリッド内に並べる */
.history-index-table thead,
.history-index-table tbody,
.history-index-table tr,
.history-index-table td {
  display: contents !important;
}

/* ボタンの見た目・間隔統一 */
.history-index-table .idx-btn {
  display: block !important;
  width: 100% !important;
  max-width: 120px !important;
  margin: 0 !important;
  padding: 8px 10px !important;
  text-align: center !important;
  border: 1px solid #00eaff !important;
  border-radius: 8px !important;
  background: rgba(0,245,255,.08) !important;
  color: #00f5ff !important;
  cursor: pointer !important;
  transition: transform .15s, background .15s, color .15s !important;
}
.history-index-table .idx-btn:hover {
  background: #00f5ff !important;
  color: #111 !important;
  transform: translateY(-2px) scale(1.03) !important;
}

/* スクロール時にサブナビに潜らないよう上余白を確保 */
#app2-historySection .history-item{
  scroll-margin-top: calc(var(--tabs-h) + var(--subnav-h) + 10px);
}

/* 見出しの左右レイアウト＆右端カウンタ */
.history-index-table .history-index-head{
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.history-index-table .history-index-count{
  font-size: 14px;
  color: #eaf6ff;
  opacity: .95;
}

/* 共通：見出し行をボタン化（左右にタイトル/人数/▼） */
.history-index-toggle{
  width:100%;
  display:flex; align-items:center; justify-content:space-between;
  background: transparent; border: none; color: inherit; padding: 10px 12px;
  font: inherit; cursor: pointer;
}
.history-index-toggle .caret{ opacity:.9; }


/* =========================================================
   MOBILE (<=700px) — 統合版（app1/app2/app3）
   これ1つでOK。既存の max-width:700px ブロックは削除してOK。
========================================================= */
@media (max-width:700px){

  /* ---------- 共通レイアウト/タイポ ---------- */
  .tabs{ font-size:15px; }
  .tab{ font-size:15px; padding:9px 0; }
  .content{
    padding: calc(var(--tabs-h) + var(--subnav-h) - 40px ) 12px 110px 12px !important;
  }
  th, td{ font-size:15px; }
  #app1 .group{ padding:12px 6px 8px 6px; margin:10px 0; border-radius:12px; }
  #app1 .group label{ flex-direction:column; align-items:stretch; margin-bottom:8px; gap:6px; }
  #app1 .group label > span,
  #app1 .group label > strong,
  #app1 .group label > b{ min-width:unset; max-width:unset; width:100%; }
  #app1 .group label input,
  #app1 .group label select,
  #app1 .group label button{ margin-left:0; width:100%; min-width:unset; max-width:unset; }

  /* ---------- app1：伝票＝カード化、ツールバー整列 ---------- */
  #app1 table, #app1 tbody, #app1 tr, #app1 td{
    display:block; width:100% !important;
  }
  #app1 tr.row{
    position:relative;
    margin:14px 0; padding:12px 12px 10px;
    border-radius:12px;
    background:rgba(25,35,55,.9);
    box-shadow:0 2px 12px #00f5ff44;
    overflow:hidden;
  }
  #app1 td{ border:none !important; padding:6px 2px !important; }
  #app1 td:first-child, #app1 td.rowNumber{
    display:inline-block; width:auto; padding-right:8px !important;
  }
  #app1 .delete-btn{
    position:absolute; top:8px; right:8px; float:none; width:32px; height:32px;
  }
  #app1 input, #app1 select{
    width:100% !important; max-width:100% !important;
    text-align:left !important; margin-top:4px;
  }

  /* 伝票ツールバー：2×2グリッド */
  .ticket-toolbar{
    display:grid !important;
    grid-template-columns:110px 1fr;
    grid-template-rows:auto auto;
    gap:10px 12px; align-items:stretch;
  }
  .ticket-toolbar .add-btn{
    grid-row:1 / span 2; grid-column:1;
    padding:12px 0; width:100%; min-width:0; font-size:16px; line-height:1.2;
  }
  .ticket-toolbar .search-box{
    grid-column:2; display:grid; grid-template-columns:1fr 1fr; grid-template-rows:auto auto; gap:8px 10px;
  }
  .ticket-toolbar .search-box #searchAmount{
    grid-column:1 / -1; width:100%; text-align:right; padding:10px 12px; font-size:14px;
  }
  .ticket-toolbar .search-box button{ width:100%; padding:10px 0; font-size:14px; margin:0; }

  /* カテゴリボタン（editSection）：1行目ぶち抜き + 2行目2つ + 以降3列 */
  #editSection > .tab{
    display:grid !important;
    grid-template-columns:repeat(3, 1fr);
    gap:10px; padding:8px 6px;
    background:transparent; border:0; box-shadow:none; flex:none; text-align:initial;
  }
  #editSection > .tab .tablinks{
    min-width:0; width:100%; margin:0; padding:10px 0;
    font-size:14px; line-height:1.15; border-radius:10px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #editSection > .tab .tablinks:nth-child(1){ grid-column:1 / -1; } /* 全表示 */
  #editSection > .tab .tablinks:nth-child(2){ grid-column:1; }      /* 現金抽出 */
  #editSection > .tab .tablinks:nth-child(3){ grid-column:2; }      /* カード抽出 */

  /* app1：カテゴリ集計テーブルは「カード化せず」テーブルのまま */
  #categorySection table{ display:table !important; }
  #categorySection thead{ display:table-header-group !important; }
  #categorySection tbody{ display:table-row-group !important; }
  #categorySection tr{ display:table-row !important; }
  #categorySection th, #categorySection td{
    display:table-cell !important; font-size:14px;
  }

  /* ---------- app2：サイドナビ非表示 + ナビ/フォームをコンパクト ---------- */

  #app2-sideNav {
  display:block !important;
  position:fixed;
  top:82px !important;
  right:4px !important;
  width:100px;   /* ←スマホ用に縮める */
  padding:8px;
  border-radius:10px;
  z-index:1200;
}

#app2{
  width: 100% !important;
  max-width: none !important;
  margin-right: 0 !important;
  padding-right: calc(var(--side-nav-w) + var(--side-nav-gap)) !important; /* サイドナビ分の逃げ */
  box-sizing: border-box !important;
}



  #app2-nav{ padding:4px 6px !important; }
  #app2-nav button{
    display:inline-flex; align-items:center; justify-content:center;
    height:32px; padding:0 10px; font-size:14px; line-height:1;
    min-width:0; margin:2px 4px; white-space:nowrap;
  }
  

  /* app2/app3：フォーム部品の薄型化（iOSズーム回避で16px維持） */
  #app2 input[type="text"], #app2 input[type="number"], #app2 select,
  #app3 input[type="text"], #app3 input[type="number"], #app3 select{
    font-size:16px !important;
    height:34px !important; line-height:32px !important;
    padding-block:2px !important; padding-inline:10px !important;
    box-sizing:border-box !important;
  }
  #app2 textarea, #app3 textarea{
    font-size:16px !important; min-height:64px !important;
    padding:6px 10px !important; line-height:1.25 !important;
  }
  #app2 .group button, #app3 .group button, #app2 .button-row button{
    height:34px; padding:0 12px; font-size:14px; line-height:1; min-width:0;
  }
  #app2 input[type="checkbox"], #app3 input[type="checkbox"]{ transform:scale(.95); }

  /* ---------- app3：グループの余白微調整（さらにコンパクト） ---------- */
  #app3 .group{ padding:10px 10px 8px !important; margin:10px 0 !important; }
  #app3 .group h3{ font-size:18px; margin:0 0 10px; }

  #app1-nav button, #app2-nav button, #app3-nav button {
    height: 32px;                /* ボタンも薄型に */
    padding: 0 10px;
    font-size: 14px;
    line-height: 1;
    margin: 2px 4px;
    border-radius: 6px;
  }

 /* ---------- app2 入力フォーム：横幅・高さをさらに調整 ---------- */
  #app2 .group label {
    flex-direction: row;
    justify-content: space-between;
    gap: 4px;                     /* すき間をさらに縮小 */
    margin-bottom: 5px;
  }

/* ---------- app2 入力フォーム：横幅・高さをさらに圧縮 ---------- */
#app2 .group label > span,
#app2 .group label > strong,
#app2 .group label > b {
  min-width: 65px !important;   /* ← ラベル幅をさらに小さく */
  font-size: 12px !important;   /* ← フォントも小さく */
  line-height: 1.2 !important;
}

#app2 .group label input,
#app2 .group label select {
  max-width: 100px !important;  /* ← 入力欄をさらに細めに */
  height: 24px !important;      /* ← 高さを圧縮 */
  font-size: 12px !important;
  padding: 1px 5px !important;  /* ← 内側余白も最小化 */
  line-height: 20px !important;
  box-sizing: border-box !important;
}

  #app2 .group {
    padding: 6px 5px;
    margin: 5px 0;
    border-radius: 6px;
  }

  #app2 .group h3,
#app2 .group .group-title {
  font-size: 15px !important;   /* ← 表題を小さめに */
  margin-bottom: 8px !important;
  line-height: 1.3 !important;
}


  /* app2 各項目名（ラベル左側） */
  body[data-active-app="app2"] #app2 .group label span,
  body[data-active-app="app2"] #app2 .group label strong,
  body[data-active-app="app2"] #app2 .group label b {
    font-size: 11px !important;   /* ← フォントを小さく */
    min-width: 50px !important;   /* ← 横幅をさらに小さく */
    max-width: 100px !important;  /* ← はみ出し防止 */
    line-height: 1.2 !important;
    flex-shrink: 1 !important;    /* ← 縮小を許可 */
    white-space: nowrap;          /* ← 改行せずに収める */
  }

  :root{
    --tabs-h: 40px;   /* SP想定（.tab: padding 9px / fs 15px）*/
    --subnav-h: 40px; /* SPのサブナビ実高 */
  }

    #app2 .bottle-form {
    flex-wrap: wrap;
    gap: 6px;
    padding: 5px;
  }

  #app2 .bottle-form .left-group {
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
  }

  #app2 .bottle-form select.bottleDetails {
    flex: 1 1 100%;
    max-width: 100%;
  }

  #app2 .bottle-form input.splitCount,
  #app2 .bottle-form input.bottleQuantity,
  #app2 .bottle-form input.bottleAmount {
    flex: 1 1 30%;
    min-width: 70px;
    max-width: 100%;
  }

  #app2 .bottle-form input.bottleAmount {
    margin-left: 0; /* スマホでは通常並び */
  }

    #app2 .bottle-form .delete-btn {
    order: -1;              /* ← 先頭に持ってくる */
    margin: 0 auto 6px;     /* 中央に配置 */
    display: block;
  }

  /* 折りたたみ（ボディの高さをアニメで出し入れ） */
  #historyIndexTable tbody{
    display:block;                 /* 高さアニメのためblock化 */
    max-height: 180px;             /* 展開時の上限（好みで） */
    overflow: hidden;
    transition: max-height .25s ease;
  }
  #historyIndexTable.collapsed tbody{
    max-height: 0;
  }

}

@media (min-width:700px){
  #app1 table{ table-layout:fixed; width:100%; }
  #app1 th, #app1 td{ padding:6px 6px; vertical-align:middle; }

  /* 10列割当 */
  #app1 tr.row > td:nth-child(1){ width:50px;  text-align:center; }  /* 削除 */
  #app1 tr.row > td:nth-child(2){ width:40px;  text-align:center; }  /* 行番号 */
  #app1 tr.row > td:nth-child(3){ width:70px;  }                     /* 卓番 */
  #app1 tr.row > td:nth-child(4){ width:70px;  }                     /* 本指 */
  #app1 tr.row > td:nth-child(5){ width:90px;  }                     /* 区分 */
  #app1 tr.row > td:nth-child(6){ width:120px; text-align:right; }   /* 金額 */
  #app1 tr.row > td:nth-child(7){ width:60px;  text-align:center; }  /* 人数 */
  #app1 tr.row > td:nth-child(8){ width:90px;  }                     /* 詳細 */
  #app1 tr.row > td:nth-child(9){ width:100px; }                     /* カード */
  #app1 tr.row > td:nth-child(10){ width:120px; text-align:right; }  /* 総合計 */

  #app1 input, #app1 select{
    width:100% !important; max-width:100% !important;
    height:32px; padding:4px 6px; font-size:15px; box-sizing:border-box;
  }



  body[data-active-app="app2"] #app2-sideNav {
    width: 130px !important;
    right: 10px !important;
  }

body[data-active-app="app2"] #app2 {
  margin-right: 0 !important;
}

    .subnav {
    top: calc(var(--tabs-h) + 4px) !important;   /* 好みで 2〜6px 調整 */
    padding-top: 4px; height: calc(var(--subnav-h) + 4px);
  }

}

@media (max-width: 700px) {
  /* スマホ時：履歴インデックスを狭める */
  /* 履歴インデックスをフレックスレイアウト化 */
  #historyIndexTable {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: flex-END !important; /* ← 左寄せに変更 */
    align-items: flex-start !important; /* ← stretchをflex-startに変更（これが肝） */
    gap: 6px !important;
    padding: 6px 4px !important;
    width: 100% !important;
    background: rgba(20,28,40,0.82) !important;
    border: 1px solid rgba(0,245,255,0.25) !important;
    border-radius: 10px !important;
    box-shadow: 0 0 18px #00eaff22 !important;
    box-sizing: border-box !important;
  }

  #historyIndexTable tr,
  #historyIndexTable td,
  #historyIndexBody {
    display: contents !important; /* テーブルの行/列構造を無視して並べる */
  }

  /* 履歴ボタンを3列並び＋中央寄せ */
  #historyIndexTable .idx-btn {
    flex: 0 0 calc(33.333% - 6px) !important;  /* ← 3列維持しつつ左寄せ */
    display: block !important;
    height: auto !important;          /* ← 高さを自動に */
    line-height: 1.4 !important;      /* ← テキスト中央に見えるように */
    box-sizing: border-box !important;
    text-align: center !important;
    padding: 6px 0 !important;        /* ← 押しやすく */
    font-size: 13px !important;
    white-space: nowrap !important;
    border: 1px solid #00eaff !important;
    border-radius: 8px !important;
    background: rgba(0,245,255,.08) !important;
    color: #00f5ff !important;
    transition: transform .15s, background .15s, color .15s !important;
  }

    #historyIndexTable .idx-btn:hover {
    background: #00f5ff !important;
    color: #111 !important;
    transform: translateY(-2px) scale(1.03) !important;
  }

  /* 全体調整 */
  #historyIndexTable .history-chip-row {
    display: contents !important; /* flex内で統合 */
  }
  
}



/* ==========================
   APP2 履歴ボタン 強制レイアウト修正
========================== */
#app2-historySection .history-actions {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important;
  gap: 8px !important;
  align-items: stretch !important;
  margin-top: 8px !important;
}

#app2-historySection .history-actions button,
#app2-historySection .history-action {
  all: unset !important;              /* ← 既存の button スタイルを完全リセット */
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  background: linear-gradient(90deg, #202056 60%, #009be6 120%) !important;
  border: 1.5px solid #00eaff !important;
  border-radius: 10px !important;
  color: #eaf6ff !important;
  font-size: 15px !important;
  padding: 8px 0 !important;
  width: 100% !important;
  height: 38px !important;
  cursor: pointer !important;
  box-shadow: 0 0 8px #00eaff55 !important;
  transition: all 0.2s ease !important;
}

/* ホバー時 */
#app2-historySection .history-actions button:hover {
  background: linear-gradient(90deg, #00f5ff 20%, #2636b3 80%) !important;
  color: #fff !important;
  transform: translateY(-2px) scale(1.03) !important;
}

/* スマホでは 2x2 */
@media (max-width:700px){
  #app2-historySection .history-actions {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
  }
}

/* ===== Hotfix: App2サイドナビはapp2時のみ表示 ===== */
#app2-sideNav{ display:none !important; }
body[data-active-app="app2"] #app2-sideNav{ display:block !important; }

/* SP時の位置・サイズ調整 */
@media (max-width:700px){
  body[data-active-app="app2"] #app2-sideNav{
    top:82px !important;
    right:4px !important;
    width:var(--side-nav-w);
  }
}

/* 履歴詳細を3行の行レイアウトで整える（見た目は現状に寄せる） */
#app2-historySection .history-summary-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:2px 0;
  line-height:1.35;
}
#app2-historySection .history-summary-row .label{
  opacity:.95;
  letter-spacing:.02em;
}
#app2-historySection .history-summary-row .value{
  font-weight:700;
}

/* 履歴のアクションは2ボタンに（復元・出力） */
#app2-historySection .history-actions{
  display:grid !important;
  grid-template-columns:repeat(2,1fr) !important;   /* ← 2列固定 */
  gap:8px !important;
  align-items:stretch !important;
  margin-top:8px !important;
}

/* ↑/↓ など余計なボタンは一応CSSでも隠しておく（JSでも削除するが保険） */
#app2-historySection .history-actions button[data-role="up"],
#app2-historySection .history-actions button[data-role="down"],
#app2-historySection .history-actions .history-action--up,
#app2-historySection .history-actions .history-action--down{
  display:none !important;
}



/* ==============================================================
   APP2 一括入力フォーム（#bulkGrid）— 整理版（機能そのまま・最終）
   ※ 必ずスタイルの一番最後に置くこと
=================================================================*/

/* ========== 変数（PC用ガター等） ========== */
:root{
  --side-nav-w-pc: 100px;
  --side-nav-gap-pc: 18px;
  --side-nav-between-pc: 24px;
  --bulk-wide-gutter-pc: clamp(18px, 2.5vw, 28px);
}

/* ========== ベース：表・セル・フォーム ========== */
body[data-active-app="app2"] #bulkGrid{
  table-layout: fixed !important;
  width: 100% !important;
  border-collapse: collapse !important;
  border-spacing: 0 !important;
}
body[data-active-app="app2"] #bulkGrid th,
body[data-active-app="app2"] #bulkGrid td{
  text-align: center !important;
  vertical-align: middle !important;
  padding: 3px 4px !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* 入力系のベース（input/select） */
body[data-active-app="app2"] #bulkGrid input,
body[data-active-app="app2"] #bulkGrid select{
  width: 100% !important;
  box-sizing: border-box !important;
  margin: 0 !important;
  padding: 2px 3px !important;
  height: 24px !important;
  line-height: 22px !important;
  font-size: 0.8em !important;
}

/* ボタンのベース（※ +/- は除外） */
body[data-active-app="app2"] #bulkGrid button:not(.btl-plus):not(.btl-minus){
  width: 100% !important;
  box-sizing: border-box !important;
  margin: 0 !important;
  padding: 2px 3px !important;
  height: 24px !important;
  line-height: 22px !important;
  font-size: 0.8em !important;
}

/* ========== 列幅（PC時） ========== */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(1){ width: 3.5%; } /* # */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(2){ width: 9%;  } /* 氏名 */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(3){ width: 5%;  } /* 体/貸 */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(4){ width: 5%;  } /* 送迎 */
/* F1〜E（5〜19列目） */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(n+5):nth-child(-n+19){ width: 3%; }

/* VIP列（14列目）だけ広めに */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(14){ width: 4.5%;}

/* 品名・割・数量・金額（20〜23列目） */
body[data-active-app="app2"] #bulkGrid thead th:nth-child(20){ width: 11%; }
body[data-active-app="app2"] #bulkGrid thead th:nth-child(21){ width: 4%;  }
body[data-active-app="app2"] #bulkGrid thead th:nth-child(22){ width: 4%;  }
body[data-active-app="app2"] #bulkGrid thead th:nth-child(23){ width: 9%;  }

/* ========== ボトル行（サブ行） ========== */
#bulkGrid tr.btl-subrow td{
  padding: 3px 4px !important;
  vertical-align: middle !important;
  background: rgba(255,255,255,0.03) !important;
  border-bottom: 1px dashed #28324a !important;
}
#bulkGrid tr.btl-subrow select.bottleDetails,
#bulkGrid tr.btl-subrow input.splitCount,
#bulkGrid tr.btl-subrow input.bottleQuantity,
#bulkGrid tr.btl-subrow input.bottleAmount{
  height: 24px !important;
  font-size: 0.8em !important;
  line-height: 22px !important;
  box-sizing: border-box !important;
  text-align: right !important;
}
#bulkGrid select.bottleDetails{ width: 100% !important; max-width: 140px !important; }

/* ボトル +/- ボタン（汎用buttonの100%指定を除外済み） */
body[data-active-app="app2"] #bulkGrid .btl-plus,
body[data-active-app="app2"] #bulkGrid .btl-minus{
  width: calc(40% - 2px) !important;  /* 左右で半分ずつ */
  min-width: 0 !important;
  display: inline-flex !important;
  justify-content: center !important;
  align-items: center !important;
  padding: 2px 0 !important;
  height: 24px !important;
  line-height: 1.2 !important;
  border: 1px solid #2f4a7a !important;
  background: #233255 !important;
  color: #eaf6ff !important;
  border-radius: 6px !important;
}
body[data-active-app="app2"] #bulkGrid .btl-plus + .btl-minus{ margin-left: 4px !important; }

/* ========== レイアウト補助（APP2フル幅の基本） ========== */
body[data-active-app="app2"] #app2{
  width:100% !important; max-width:100% !important;
  margin:0 auto !important; box-sizing:border-box !important;
}
body[data-active-app="app2"] .bulk-grid-wrap{
  width:100% !important; max-width:100% !important;
  padding-right:0 !important; margin:0 auto !important;
  overflow-x:hidden !important; overflow-y:auto !important;
}

/* ========== サイドナビ表示ルール ========== */
/* 一括入力フォーム展開時だけ PCで非表示（スマホは維持） */
body[data-active-app="app2"].bulk-wide #sideNav,
body[data-active-app="app2"].bulk-wide .side-nav,
body[data-active-app="app2"].bulk-wide [id*="sideNav"],
body[data-active-app="app2"].bulk-wide [class*="side-nav"]{
  display: none !important; visibility: hidden !important;
  opacity: 0 !important; pointer-events: none !important;
}
@media (max-width: 768px){
  body[data-active-app="app2"].bulk-wide #sideNav,
  body[data-active-app="app2"].bulk-wide .side-nav,
  body[data-active-app="app2"].bulk-wide [id*="sideNav"],
  body[data-active-app="app2"].bulk-wide [class*="side-nav"]{
    display: block !important; visibility: visible !important;
    opacity: 1 !important; pointer-events: auto !important;
  }
}

/* ========== スマホ：氏名・体験・送迎のみ表示 ========== */
@media (max-width: 768px){
  body[data-active-app="app2"] #bulkGrid{ display: table !important; font-size: 13px !important; }
  /* いったん全列非表示 */
  body[data-active-app="app2"] #bulkGrid thead th,
  body[data-active-app="app2"] #bulkGrid tbody td{ display: none !important; }
  /* 2:氏名 / 3:体験(貸出) / 4:送迎 を再表示 */
  body[data-active-app="app2"] #bulkGrid thead th:nth-child(2),
  body[data-active-app="app2"] #bulkGrid tbody td:nth-child(2),
  body[data-active-app="app2"] #bulkGrid thead th:nth-child(3),
  body[data-active-app="app2"] #bulkGrid tbody td:nth-child(3),
  body[data-active-app="app2"] #bulkGrid thead th:nth-child(4),
  body[data-active-app="app2"] #bulkGrid tbody td:nth-child(4){
    display: table-cell !important; visibility: visible !important;
  }
  /* 入力しやすさ微調整 */
  body[data-active-app="app2"] #bulkGrid input,
  body[data-active-app="app2"] #bulkGrid select{
    font-size: 14px !important; height: 26px !important; padding: 3px 4px !important;
  }
  /* 横スクロール抑止 */
  body[data-active-app="app2"] .bulk-grid-wrap{ overflow-x: hidden !important; }
}

/* ========== PC：通常時の“サイドナビと本体の間”を広げる ========== */
@media (min-width: 769px){
  body[data-active-app="app2"]:not(.bulk-wide) #app2-sideNav{
    display: block !important; position: fixed !important;
    top: calc(var(--tabs-h) + var(--subnav-h) + 12px) !important;
    right: var(--side-nav-gap-pc) !important;
    width: var(--side-nav-w-pc) !important; z-index: 1200;
  }
  body[data-active-app="app2"]:not(.bulk-wide) #app2,
  body[data-active-app="app2"]:not(.bulk-wide) #app2.content{
    width: 100% !important; max-width: none !important;
    padding-right: calc(var(--side-nav-w-pc) + var(--side-nav-gap-pc) + var(--side-nav-between-pc)) !important;
    box-sizing: border-box !important; margin-right: 0 !important;
  }
}

/* ========== PC：bulk-wide 時の左右ガター統一 ========== */
@media (min-width: 769px){
  body[data-active-app="app2"].bulk-wide #app2-sideNav{ display: none !important; }
  body[data-active-app="app2"].bulk-wide #app2,
  body[data-active-app="app2"].bulk-wide #app2.content{
    padding-left:  var(--bulk-wide-gutter-pc) !important;
    padding-right: var(--bulk-wide-gutter-pc) !important;
    box-sizing: border-box !important;
  }
  body[data-active-app="app2"].bulk-wide .bulk-grid-wrap{
    padding-left:  var(--bulk-wide-gutter-pc) !important;
    padding-right: var(--bulk-wide-gutter-pc) !important;
  }
  body[data-active-app="app2"].bulk-wide #bulkGrid{
    margin-left: 0 !important; margin-right: 0 !important; width: 100% !important;
  }
}

/* ========== 保険：どこかで幅を上書きしていても守る ========== */
body[data-active-app="app2"] #app2-sideNav{ width: var(--side-nav-w-pc) !important; }
body[data-active-app="app2"] #app2 table,
body[data-active-app="app2"] #app2 .group{ max-width: 100% !important; overflow: visible; }

/* ========== 一括ツール行（統合版） ========== */
.bulk-actions{
  display: grid; grid-template-columns: 1fr 1fr 1fr; /* 左 / 中央 / 右 */
  align-items: center; gap: 12px; width: 100%;
  position: relative; z-index: 5;  /* ボタン押下を優先 */
}
#bulkClear{ grid-column: 1; justify-self: start; }
#bulkRegister{ grid-column: 2; justify-self: center; }  /* 中央 */
#bulkImportFromHistory{ grid-column: 3; justify-self: end; }

/* 行数セレクタを右上にフロート */
#bulkRows{
  position: absolute; top: 0; right: 0;
  transform: translateY(-140%); margin-right: 8px;
  padding: 4px 6px; border-radius: 6px;
  background: #12192b; color: #00faff;
  border: 1px solid #00a8e8; box-shadow: 0 0 8px rgba(0,255,255,0.25);
  cursor: pointer;
}
#bulkClear{
  background: linear-gradient(90deg,#f73378 30%,#d80032 100%);
  color:#fff; border:1.5px solid #d80032; box-shadow:0 0 12px rgba(255,0,98,.45);
}
#bulkClear:hover{ background: linear-gradient(90deg,#ff3b6e 10%,#b00020 90%); transform: translateY(-1px); }
@media (max-width:700px){ .bulk-actions{ gap:8px; } }

/* ========== サブナビ直下固定（thead sticky） ========== */
body[data-active-app="app2"] #app2,
body[data-active-app="app2"] #app2.active,
body[data-active-app="app2"] #app2.content{ transform: none !important; }
body[data-active-app="app2"].bulk-wide .bulk-grid-wrap{ overflow: visible !important; }
body[data-active-app="app2"].bulk-wide #bulkGrid thead{
  position: sticky !important;
  top: calc(var(--tabs-h) + var(--subnav-h) + 2px) !important;
  z-index: 1890 !important; background: #0f1625 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.45);
}
body[data-active-app="app2"].bulk-wide #bulkGrid thead th{ position: static !important; background:#0f1625 !important; }
body[data-active-app="app2"].bulk-wide #bulkGrid thead tr{ border-bottom: 1.5px solid rgba(0,255,255,0.25); }
body[data-active-app="app2"].bulk-wide #bulkGrid{ position: relative !important; z-index: 100 !important; margin-top: 0 !important; }

/* ========== グループ仕切り線（右：太線） ========== */
body[data-active-app="app2"] #bulkGrid th,
body[data-active-app="app2"] #bulkGrid td{ border-right: 1px solid rgba(0,245,255,.18); }

/* 右に太線 → 1 | 4 | 7 | 11 | 14 | 19 */
body[data-active-app="app2"] #bulkGrid th:nth-child(1),
body[data-active-app="app2"] #bulkGrid td:nth-child(1),
body[data-active-app="app2"] #bulkGrid th:nth-child(4),
body[data-active-app="app2"] #bulkGrid td:nth-child(4),
body[data-active-app="app2"] #bulkGrid th:nth-child(7),
body[data-active-app="app2"] #bulkGrid td:nth-child(7),
body[data-active-app="app2"] #bulkGrid th:nth-child(11),
body[data-active-app="app2"] #bulkGrid td:nth-child(11),
body[data-active-app="app2"] #bulkGrid th:nth-child(14),
body[data-active-app="app2"] #bulkGrid td:nth-child(14),
body[data-active-app="app2"] #bulkGrid th:nth-child(19),
body[data-active-app="app2"] #bulkGrid td:nth-child(19){
  border-right: 2.4px solid #00f5ff !important;
  box-shadow: 1px 0 8px rgba(0,245,255,.7);
}
body[data-active-app="app2"] #bulkGrid thead th:nth-child(1),
body[data-active-app="app2"] #bulkGrid thead th:nth-child(4),
body[data-active-app="app2"] #bulkGrid thead th:nth-child(7),
body[data-active-app="app2"] #bulkGrid thead th:nth-child(11),
body[data-active-app="app2"] #bulkGrid thead th:nth-child(14),
body[data-active-app="app2"] #bulkGrid thead th:nth-child(19){
  box-shadow: 1px 0 10px rgba(0,255,255,.8);
}

/* ========== 補助線（送迎/場内/HE/VIP の“左”に薄線） ========== */
/* border-collapse の都合で「直前列の右線」で左線を表現 */
body[data-active-app="app2"] #bulkGrid th:nth-child(3),
body[data-active-app="app2"] #bulkGrid td:nth-child(3),   /* 送迎(4)の左 */
body[data-active-app="app2"] #bulkGrid th:nth-child(6),
body[data-active-app="app2"] #bulkGrid td:nth-child(6),   /* 場内(7)の左 */
body[data-active-app="app2"] #bulkGrid th:nth-child(10),
body[data-active-app="app2"] #bulkGrid td:nth-child(10),  /* HE(11)の左 */
body[data-active-app="app2"] #bulkGrid th:nth-child(13),
body[data-active-app="app2"] #bulkGrid td:nth-child(13){  /* VIP(14)の左 */
  border-right: 1px solid rgba(0,245,255,.35) !important;
  box-shadow: 1px 0 4px rgba(0,245,255,.30);
}

/* ========== 行フォーカス：上下ライン強調（:focus-within） ========== */
body[data-active-app="app2"] #bulkGrid tr:focus-within td{
  border-top:    2.5px solid #00f5ff !important;
  border-bottom: 2.5px solid #00f5ff !important;
  box-shadow: inset 0 2px 10px rgba(0,245,255,.08),
              inset 0 -2px 10px rgba(0,245,255,.08);
  background: linear-gradient(180deg, rgba(0,245,255,.06), rgba(0,0,0,0)) !important;
}
body[data-active-app="app2"] #bulkGrid tr.btl-subrow:focus-within td{
  border-top:    2.5px solid #00f5ff !important;
  border-bottom: 2.5px solid #00f5ff !important;
  box-shadow: inset 0 2px 10px rgba(0,245,255,.10),
              inset 0 -2px 10px rgba(0,245,255,.10);
}

/* ========== 入力ありハイライト（JSで .is-filled / .cell-filled 付与） ========== */
body[data-active-app="app2"] #bulkGrid input.is-filled,
body[data-active-app="app2"] #bulkGrid select.is-filled,
body[data-active-app="app2"] #bulkGrid textarea.is-filled{
  background: rgba(0,245,255,.12) !important;
  border-color: #00eaff !important;
  box-shadow: inset 0 0 10px #00eaff33 !important;
  color: #eaf6ff !important;
}
body[data-active-app="app2"] #bulkGrid td.cell-filled{
  background: rgba(0,245,255,.06) !important;
}

/* === bulkGrid フォーカス強調（JSが付けるクラス用） === */
body[data-active-app="app2"] #bulkGrid tr.hl-row td{
  background: linear-gradient(180deg, rgba(0,245,255,.10), rgba(0,0,0,0)) !important;
  box-shadow: inset 0 2px 10px rgba(0,245,255,.10), inset 0 -2px 10px rgba(0,245,255,.10) !important;
}

body[data-active-app="app2"] #bulkGrid .hl-col{
  background: rgba(0,245,255,.08) !important;
}
body[data-active-app="app2"] #bulkGrid thead th.hl-col{
  background: rgba(0,245,255,.15) !important;
}

/* === APP2だけに限定（他画面のselectに影響しない） === */
body[data-active-app="app2"] select.bottleDetails {
  background-color: var(--form-bg, #0b0e13) !important;
  color: var(--form-fg, #eaf6ff) !important;
  border: 1px solid var(--form-border, #00f5ff55) !important;
  -webkit-text-fill-color: var(--form-fg, #eaf6ff) !important;
}

/* 開いた候補リスト側（効くブラウザのみ） */
body[data-active-app="app2"] select.bottleDetails option,
body[data-active-app="app2"] select.bottleDetails optgroup {
  background-color: var(--form-bg, #0b0e13) !important;
  color: var(--form-fg, #eaf6ff) !important;
}







/* =========================================================
   APP2：個別入力フォームと結果セクションを非表示
========================================================= */

/* 個別入力フォーム群を非表示 */
#app2-inputSection .group-basic,
#app2-inputSection .group-shimei,
#app2-inputSection .group-set,
#app2-inputSection .group-option {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden !important;
}

/* 結果セクションを非表示 */
#app2-resultSection {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden !important;
}

/* ナビ・サブナビの「結果」「個別」ボタンも非表示 */
#app2-nav [data-target="app2-resultSection"],
#app2-sideNav [data-target="app2-resultSection"],
#scrollToIndiv {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

/* 個別入力フォーム本体と結果を非表示 */
body[data-active-app="app2"] #app2-inputSection form,
body[data-active-app="app2"] #result {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}


/* =========================================================
   APP3：ドライバー代フォームのレイアウト整理
========================================================= */

/* ドライバー代フォーム行を横並び＋右寄せ整列 */
#app3 #laborGroup label:has(#driverFee) {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 5px !important;
}

/* ラベル部分（左側） */
#app3 #laborGroup label:has(#driverFee) > span {
  flex: 0 0 120px;
  text-align: left;
  margin-right: auto;
}

/* 入力欄：基本統一 */
#app3 #laborGroup label:has(#driverFee) input {
  width: 130px !important;
  margin: 0 !important;
  text-align: right;
  border-radius: 6px;
}

/* Safari対応：フォーム間のマージン除去 */
#app3 #laborGroup label:has(#driverFee) input + input {
  margin-left: 2px !important;
}


/* =========================================================
   APP3：スマホ時（～700px）ドライバー代フォーム幅指定
========================================================= */
@media (max-width:700px){

  /* driverExtra1 / driverExtra2 を細く */
  body[data-active-app="app3"] #driverExtra1,
  body[data-active-app="app3"] #driverExtra2 {
    width: 30px !important;
    max-width: 65px !important;
    min-width: 65px !important;
    flex: 0 0 65px !important;
    padding-inline: 3px !important;
    font-size: 14px !important;
    text-align: right !important;
  }

  /* driverFee は幅を維持 */
  body[data-active-app="app3"] #driverFee {
    width: 130px !important;
    max-width: 130px !important;
    min-width: 130px !important;
    flex: 0 0 130px !important;
    font-size: 15px !important;
    text-align: right !important;
  }
}


/* =========================================================
   APP3：共通フォーム右端揃え（PC/スマホ共通）
========================================================= */

/* 基準幅（SP時は自動切替） */
:root{
  --app3-input-w-pc: 240px;
  --app3-input-w-sp: 115px;
}
@media (max-width:700px){
  :root{ --app3-input-w-pc: var(--app3-input-w-sp); }
}

/* 各入力欄を右端ラインに合わせる */
body[data-active-app="app3"] #app3 .group label input,
body[data-active-app="app3"] #app3 .group label select,
body[data-active-app="app3"] #app3 .group label button {
  width: var(--app3-input-w-pc) !important;
  max-width: var(--app3-input-w-pc) !important;
  min-width: var(--app3-input-w-pc) !important;
  flex: 0 0 var(--app3-input-w-pc) !important;
  margin-left: auto !important;
  text-align: right !important;
}

/* =========================================================
   APP3：スマホ時 driverExtra1 / driverExtra2 の幅を強制的に狭くする最終指定
   （既存指定の上書き用）
========================================================= */
@media (max-width:700px){
  body[data-active-app="app3"] #laborGroup #driverExtra1,
  body[data-active-app="app3"] #laborGroup #driverExtra2 {
    width: 60px !important;
    max-width: 60px !important;
    min-width: 60px !important;
    flex: 0 0 60px !important;
    padding-inline: 2px !important;
    font-size: 14px !important;
    text-align: right !important;
  }

  /* 合計欄（driverFee）は幅を維持 */
  body[data-active-app="app3"] #laborGroup #driverFee {
    width: 115px !important;
    max-width: 115px !important;
    min-width: 115px !important;
    flex: 0 0 115px !important;
    text-align: right !important;
  }

  /* ===== APP3 ラベル（左側ヘッダー）文字サイズ調整 ===== */
body[data-active-app="app3"] #app3 .group label span,
body[data-active-app="app3"] #app3 .group label strong,
body[data-active-app="app3"] #app3 .group label b {
  font-size: 11px !important;
  min-width: 55px !important;
  max-width: 110px !important;
  line-height: 1.15 !important;
  flex-shrink: 1 !important;
  white-space: nowrap;
}

/* --- スマホ専用でもう少し小さくする --- */
@media (max-width:700px){
  body[data-active-app="app3"] #app3 .group label span,
  body[data-active-app="app3"] #app3 .group label strong,
  body[data-active-app="app3"] #app3 .group label b {
    font-size: 10px !important;
    min-width: 50px !important;
    line-height: 1.1 !important;
  }
}

/* === スマホ時のみプレースホルダー文字を小さく === */
@media (max-width:700px) {
  #driverExtra2::placeholder {
    font-size: 9px !important;
    opacity: 0.9; /* お好みで少し薄く */
  }
}

}



/* =========================================================
   APP3：総入客数・女子出勤人数・男子出勤人数の入力欄を狭める
   （他フォームには影響しない）
========================================================= */
body[data-active-app="app3"] #customersCount,
body[data-active-app="app3"] #femaleAttendance,
body[data-active-app="app3"] #maleAttendance {
  width: 60px !important;      /* ← 幅をかなりコンパクトに */
  max-width: 60px !important;
  min-width: 55px !important;
  flex: 0 0 60px !important;
  padding-inline: 3px !important;
  text-align: right !important;
  font-size: 15px !important;
  box-sizing: border-box !important;
}

/* スマホ時は少し広げる */
@media (max-width:700px){
  body[data-active-app="app3"] #customersCount,
  body[data-active-app="app3"] #femaleAttendance,
  body[data-active-app="app3"] #maleAttendance {
    width: 70px !important;
    max-width: 70px !important;
    min-width: 65px !important;
    flex: 0 0 70px !important;
    font-size: 14px !important;
  }
}





</style>






</head>
<body>

<div id="resetOverlay" style="display:none;">
  <canvas id="matrixCanvas"></canvas>
  <div id="resetFlash"></div>
</div>
  
<div class="tabs">
  <div class="tab active" data-target="app1">伝票入力</div>
  <div class="tab" data-target="app2">報酬計算</div>
  <div class="tab" data-target="app3">日計計算</div>
</div>

<!-- app1 用サブナビ -->
<nav id="app1-nav" class="subnav">
  <button data-target="editSection">編集</button>
  <button data-target="summarySection">集計</button>
  <button data-target="categorySection">CB</button>
</nav>

<!-- app2 用サブナビ（最初は非表示） -->
<nav id="app2-nav" class="subnav">
  <button data-target="app2-inputSection">目次</button>
  <button data-target="app2-resultSection">結果</button>
  <button data-target="app2-historySection">履歴</button>
</nav>

  <!-- app2 用サブナビ（最初は非表示） -->
  <nav id="app3-nav" class="subnav">
   <button data-target="app3-inputSection">記入</button>
   <button data-target="app3-profitSection">利益</button>
   <button data-target="app3-envelopeSection">封筒</button>
  </nav>

<div id="app1" class="content active">
 <section id="editSection">
 <div class="tab">

  <button class="tablinks" onclick="filterCategory('all')">すべて表示</button>
  <button class="tablinks" onclick="filterCashOnlyRows()">現金のみ抽出</button>
  <button class="tablinks" onclick="filterCardInputRows()">カード抽出</button>
  <button class="tablinks" onclick="filterCategory('UK')">UK</button>
  <button class="tablinks" onclick="filterCategory('K')">K</button>
  <button class="tablinks" onclick="filterCategory('AB')">AB</button>
  <button class="tablinks" onclick="filterCategory('LA')">LA</button>
  <button class="tablinks" onclick="filterCategory('PA')">PA</button>
  <button class="tablinks" onclick="filterCategory('BB')">BB</button>
  <button class="tablinks" onclick="filterCategory('MS')">MS</button>
  <button class="tablinks" onclick="filterCategory('GM')">GM</button>
  <button class="tablinks" onclick="filterCategory('B')">B</button>
  <button class="tablinks" onclick="filterCategory('JOE')">JOE</button>
  <button class="tablinks" onclick="filterCategory('KOSE')">KOSE</button>
  <button class="tablinks" onclick="filterCategory('HE')">HE</button>
  <button class="tablinks" onclick="filterCategory('PB')">PB</button>
  <button class="tablinks" onclick="filterCategory('X')">X</button>
  <button class="tablinks" onclick="filterCategory('Z')">Z</button>
</div>

<table>
  <tbody id="formRows">
    <tr class="row">
      <td><button class="delete-btn" onclick="deleteRow(this)">×</button></td>
      <td class="rowNumber">1</td>
      <td><input class="table-number" type="text" inputmode="numeric" pattern="\d*" placeholder="卓番" oninput="updateTotals()" /></td>
      <td><input class="honshi" type="text" inputmode="numeric" pattern="\d*" placeholder="本指" oninput="updateTotals()" /></td>
      <td>
        <select class="c" oninput="updateRowColor(this); updateTotals()">
          <option value="">-</option>
          <option value="UK">UK</option>
          <option value="K">K</option>
          <option value="AB">AB</option>
          <option value="LA">LA</option>
          <option value="PA">PA</option>
          <option value="BB">BB</option>
          <option value="MS">MS</option>
          <option value="GM">GM</option>
          <option value="B">B</option>
          <option value="JOE">JOE</option>
          <option value="KOSE">KOSE</option>
          <option value="HE">HE</option>
          <option value="PB">PB</option>
          <option value="X">X</option>
          <option value="Z">Z</option>
        </select>

        

      </td>
      <td><input class="amount" type="text" inputmode="numeric" pattern="\d*" placeholder="金額" oninput="updateTotals()" /></td>
      <td><input class="num" type="text" inputmode="numeric" pattern="\d*" placeholder="人数" oninput="updateTotals()" /></td>
      <td><input class="detail" type="text" placeholder="詳細" /></td>
      <td><input class="card" type="text" inputmode="numeric" pattern="\d*" placeholder="カード" oninput="updateTotals()" /></td>
      <td><input class="total" type="text" inputmode="numeric" pattern="\d*" placeholder="総合計" oninput="updateTotals()" /></td>
    </tr>
  </tbody>
</table>

<div class="ticket-toolbar">
  <button class="add-btn" onclick="addRow()">伝票<br>追加</button>

  <div class="search-box">
    <input type="text" id="searchAmount" placeholder="金額で検索" inputmode="numeric">
    <button onclick="searchByAmount()">検索</button>
    <button onclick="resetSearch()">リセット</button>
  </div>
</div>

</section>

<section id="summarySection">
 <p>総客数: <span id="totalCustomers">0</span></p>
 <p>現金合計: <span id="cashTotal">0</span></p>
 <p>カード合計: <span id="cardTotal">0</span></p>
 <p>総合計金額: <span id="totalAmount">0</span></p>
</section>

<section id="categorySection">
  <table>
  <thead>
    <tr>
      <th>カテゴリ</th>
      <th>人数</th>
      <th>バック金額</th>
    </tr>
  </thead>
  <tbody>
<tr><td><input type="checkbox"> UK</td><td id="UKcount">0</td><td><span id="UKtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('UK')">出力</button></td></tr>
<tr><td><input type="checkbox"> K</td><td id="Kcount">0</td><td><span id="Ktotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('K')">出力</button></td></tr>
<tr><td><input type="checkbox"> AB</td><td id="ABcount">0</td><td><span id="ABtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('AB')">出力</button></td></tr>
<tr><td><input type="checkbox"> LA</td><td id="LAcount">0</td><td><span id="LAtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('LA')">出力</button></td></tr>
<tr><td><input type="checkbox"> PA</td><td id="PAcount">0</td><td><span id="PAtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('PA')">出力</button></td></tr>
<tr><td><input type="checkbox"> BB</td><td id="BBcount">0</td><td><span id="BBtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('BB')">出力</button></td></tr>
<tr><td><input type="checkbox"> MS</td><td id="MScount">0</td><td><span id="MStotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('MS')">出力</button></td></tr>
<tr><td><input type="checkbox"> GM</td><td id="GMcount">0</td><td><span id="GMtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('GM')">出力</button></td></tr>
<tr><td><input type="checkbox"> B</td><td id="Bcount">0</td><td><span id="Btotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('B')">出力</button></td></tr>
<tr><td><input type="checkbox"> JOE</td><td id="JOEcount">0</td><td><span id="JOEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('JOE')">出力</button></td></tr>
<tr><td><input type="checkbox"> KOSE</td><td id="KOSEcount">0</td><td><span id="KOSEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('KOSE')">出力</button></td></tr>
<tr><td><input type="checkbox"> HE</td><td id="HEcount">0</td><td><span id="HEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('HE')">出力</button></td></tr>
<tr><td><input type="checkbox"> PB</td><td id="PBcount">0</td><td><span id="PBtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('PB')">出力</button></td></tr>
<tr><td><input type="checkbox"> X</td><td id="Xcount">0</td><td><span id="Xtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('X')">出力</button></td></tr>
<tr style="display: none;"><td><input type="checkbox"> Z</td><td id="Zcount">0</td><td><span id="Ztotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('Z')">出力</button></td></tr>
      <tr>
       <td><strong>合計</strong></td>
       <td id="totalCountCell">
       <button type="button" class="print-mini" onclick="printEnvelopeApp1('ALL')">出力</button>
       <span id="totalCountValue" class="count-value">1</span>
       </td>
    <td id="totalBackAmount">0</td>
  </tr>
  </tbody>
 </table>
 </section>
</div>

<!-- app2 サイドナビ（右固定） -->
<nav id="app2-sideNav" aria-label="app2 quick navigation">
  <div class="sideNav-title">SIDE NAV</div>
  <ul>
    <!-- data-target は “スクロール先のID” を指定 -->
    <li><button type="button" data-target="castName">氏名</button></li>
    <li><button type="button" data-target="f">FB</button></li>
    <li><button type="button" data-target="honshiri">指名</button></li>
    <li><button type="button" data-target="set40">SET</button></li>
    <li><button type="button" data-target="a">Drink</button></li>
    <li><button id="side-calc">計算</button></li>
    <li><button id="side-print" onclick="preparePrintApp2()">出力</button></li>
    <li><button type="button" data-target="app2-resultSection">結果</button></li>
    <li><button id="side-clear" class="red-btn">クリア</button></li>
    <li><button id="side-scroll-history">履歴</button></li>
  </ul>
</nav>


<div id="app2" class="content">

  <div style="text-align: center; margin-top: 30px;">

  <section id="app2-inputSection">

<!-- ▼ 履歴インデックス（テーブル版） -->
      <table id="historyIndexTable" class="history-index-table">
        <thead>
          <tr>
            <th>
              <div class="history-index-head">
                <span class="history-index-title">履歴</span>
                <span id="historyIndexCount" class="history-index-count">0人</span>
              </div>
          </th>
        </tr>
      </thead>
  <tbody id="historyIndexBody">
    <!-- JSでボタン行が入ります -->
  </tbody>
</table>

<!-- ▲ 履歴インデックス -->
<button type="button" id="toggleBulkInput" class="mini-btn" style="margin-left:8px;">一括入力</button>

<!-- ▼ 一括入力パネル（通常は非表示） -->
 <div class="group group-bulk" style="background:#2e2e2e">
<div id="bulkPanel" class="bulk-panel" hidden>
  <div class="bulk-toolbar">
    <div class="bulk-actions">
        <select id="bulkRows">
        <option>10</option>
        <option>15</option>
        <option>20</option>
        <option>25</option>
        <option>30</option> 
        <option>35</option>
        <option value="40" selected>40</option>
        </select>
      </label>
      <button type="button" id="bulkClear">クリア</button>
      <button type="button" id="bulkRegister">一括登録</button>
      <button type="button" id="bulkImportFromHistory">一括復元</button>
    </div>
  </div>

  <div class="bulk-grid-wrap">
    <table id="bulkGrid" class="bulk-grid" aria-label="一括入力グリッド">
      <thead>
        <tr>
          <th style="width:3em;">#</th>
          <th>氏名</th>
          <th style="width:8.5em;">体験/貸出</th>
          <th style="width:10em;">送迎（¥）</th>
        </tr>
      </thead>
      <tbody><!-- JSで行を生成 --></tbody>
    </table>
  </div>
</div>
</div>

    <form autocomplete="off" onsubmit="return confirmAndCalculate(event);">

      <div class="group group-freeback">
        <label>キャスト名:
         <input type="text" id="castName"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="名前を入力">
        </label>
        <label>体験及び貸出:
        <input type="checkbox" id="experienceAndRental"
          autocomplete="off" autocapitalize="off" spellcheck="false">
        </label>
        <label>送迎:
        <input type="text" inputmode="numeric" pattern="\d*"
          id="sendoffAmount"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="送迎金額">
        </label>
      </div>

      <div class="group group-basic">
       <h3>フリーバック</h3>
       <label>F1（¥1500）:
        <input type="text" inputmode="numeric" pattern="\d*"
          id="f"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="F1">
       </label>
       <label>F2（¥2000）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="f2"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="F2">
        </label>
          <label>場内（¥1000）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="jounai"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="場内">
        </label>
      </div>

      <div class="group group-shimei">
        <h3>指名・同伴・枝・HELP</h3>
        <label>本指（¥0）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="honshiri"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="本指">
        </label>
        <label>同伴（¥1500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="douhan"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="同伴">
        </label>
        <label>枝（¥500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="eda"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="枝">
        </label>
        <label>HELP（-¥1500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="help"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="HELP">
        </label>
      </div>

      <div class="group group-set">
        <h3>セット・VIP</h3>
        <label>SET40（¥5500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="set40"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="SET40">
        </label>
        <label>SET20（¥3500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="set20"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="SET20">
        </label>
        <label>VIP（¥2000）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="vip"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="VIP">
        </label>
      </div>

      <div class="group group-option">
        <h3>ドリンク・その他</h3>
        <label>A（¥500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="a"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="A">
        </label>
        <label>B（¥1000）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="b"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="B">
        </label>
        <label>C（¥1500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="c"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="C">
        </label>
        <label>D（¥2000）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="d"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="D">
        </label>
        <label>E（¥2500）:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="e"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="E">
        </label>

        <div id="bottleFormsContainer"></div>
        <button type="button" onclick="addBottleForm()">ボトル追加</button>
      </div>
    

      <div class="button-row" style="margin-top: 20px;">
      <button type="submit">計算する</button>
      </div>
      <div class="button-row" style="margin-top: 10px; justify-content: center;">



    </form>

  </section>

  <section id="app2-resultSection">

      <button type="button" class="red-btn" onclick="clearApp2Inputs()">入力をクリア</button>
      </div>

    <div class="result" id="result"></div>
      <div class="button-row" style="margin-top: 20px;">
      <button type="button" class="print-button" onclick="preparePrintApp2()">出力</button>
    </div>

      <div class="button-row" style="margin-top: 20px;">
      <button type="button" class="red-btn" onclick="clearApp2Inputs()">入力をクリア</button>
    </div>

    
  </section>

  <section id="app2-historySection">

    <div class="history">
      <h3>履歴</h3>
      <ul id="historyList"></ul>
      </div>


      <button id="deleteSelectedBtn" onclick="deleteSelectedHistory()">選択した履歴を削除</button>

      <div class="summary" id="summary">
        履歴の合計人数:<span id="summaryTotalPeople">0人</span> |
        合計金額:<span id="summaryTotalAmount">¥0</span> |
        合計源泉費:<span id="summaryTotalTax">¥0</span>
      </div>

    <div class="button-row" style="margin-top: 40px;"><button type="button" class="red-btn" onclick="resetApp('app2', true)">完全クリア</button>
    </div>

  </section>

</div>




<div id="app3" class="content">

    <div class="group" id="dateGroup">
  <label><span>日付:</span>
    <input type="date" id="workDate">
  </label>
</div>

<div class="group no-bg">
  <label>
    <span>開始時金庫金:</span>
    <input type="text" inputmode="numeric" pattern="\d*" id="startCash" oninput="updateCalculations()">
  </label>

  <!-- ▼追加金庫金 -->
  <label>
    <span>追加金庫金:</span>
    <input type="text" inputmode="numeric" pattern="\d*" id="extraSafeCash" oninput="updateCalculations()">
  </label>
</div>

  <table class="outer-table" style="width: 100%; border: 2px solid #333; border-collapse: collapse; margin-bottom: 20px;">
  <tr>
    <td style="padding: 10px;">


        <div class="mini-attendance-row">
        <label><span>総客:</span>
        <input type="number" id="customersCount" name="customersCount"
          class="num right compact" inputmode="numeric" pattern="\d*" readonly tabindex="-1">
        </label>

        <label><span>女子:</span>
         <input type="number" id="femaleAttendance" name="femaleAttendance"
           class="num right compact" inputmode="numeric" pattern="\d*" readonly tabindex="-1">
        </label>

        <label><span>男子:</span>
        <input type="number" id="maleAttendance" name="maleAttendance" class="num right compact" inputmode="numeric" pattern="\d*">
        </label>


      <section id="app3-inputSection">
      <div class="group" id="salesGroup">
        <label><span>現金売上:</span> <input type="text" id="cashSales" disabled></label>
        <label><span>カード売上:</span> <input type="text" id="cardSales" disabled></label>
        <label><span>売上合計:</span> <input type="text" id="totalSales" disabled></label>
      </div>

      <div class="group" id="laborGroup">
        <label><span>女子給与:</span> <input type="text" id="femaleSalary" disabled></label>
        <label><span>男子給与:</span> <input type="text" inputmode="numeric" pattern="\d*" id="maleSalary" oninput="updateCalculations()">
        </label>
        <label><span>キャッチバック:</span> <input type="text" id="catchBack" disabled></label>
        <label><span>スカウトバック:</span> <input type="text" inputmode="numeric" pattern="\d*" id="scoutBack" oninput="updateCalculations()">
        </label>
        <label><span>顧問料:</span> <input type="text" id="adviserFee" disabled></label>
        <label>
        <span>ドライバー代:</span>
        <input type="text" id="driverExtra1" placeholder="店舗負担分" disabled>
        <input type="text" id="driverExtra2" inputmode="numeric" pattern="\d*" placeholder="ドライバー代" oninput="updateCalculations()">
        <input type="text" id="driverFee" disabled placeholder="合計">
        </label>
        </label>
        <label><span>人件費合計:</span> <input type="text" id="totalLaborCosts" disabled>
        </label>
      </div>

      <div class="group" id="taxGroup">
        <label><span>女子源泉費:</span> <input type="text" id="femaleTax" disabled></label>
        <label><span>男子源泉費:</span> <input type="text" inputmode="numeric" pattern="\d*" id="maleTax" oninput="updateCalculations()"></label>
        <label><span>源泉費合計:</span> <input type="text" id="totalTax" disabled></label>
      </div>

      <div class="group" id="expensesGroup">
        <label><span>酒代:</span> <input type="text" inputmode="numeric" pattern="\d*" id="alcohol" oninput="updateCalculations()"></label>
        <label><span>領収書①:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt1" oninput="updateCalculations()"></label>
        <label><span>領収書②:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt2" oninput="updateCalculations()"></label>
        <label><span>領収書③:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt3" oninput="updateCalculations()"></label>
        <label><span>領収書④:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt4" oninput="updateCalculations()"></label>
        <label><span>領収書⑤:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt5" oninput="updateCalculations()"></label>
        <label><span>領収書合計:</span> <input type="text" id="receipt6" disabled></label>
        <label><span>経費合計:</span> <input type="text" id="totalExpenses" disabled></label>
      </div>
      </section>

      <section id="app3-profitSection">
      <div class="group" id="resultsGroup">
        <label><span>粗利益:</span> <input type="text" id="grossProfit" disabled></label>
        <label><span>現金残:</span> <input type="text" id="remainingCash" disabled></label>
      </div>
      </section>

     </td>
    </tr>
  </table>

  <table class="outer-table" style="width: 100%; border: 2px solid #333; border-collapse: collapse; margin-bottom: 20px;">
   <tr>
    <td style="padding: 10px; background-color: #3e3e5a;">

      <section id="app3-envelopeSection">
      <div class="group" id="extraGroup">
        <label><span>粗利益:</span> <input type="text" id="grossProfit_extra" disabled></label>
        <label><span>カード売上:</span> <input type="text" id="cardSales_extra" disabled></label>
        <label><span>現金残:</span> <input type="text" id="remainingCash_extra" disabled></label>
        <label><span>源泉費合計:</span> <input type="text" id="totalWithholdingTax" disabled></label>

        <div style="height: 1em;"></div>

        <label><span>合計 (現金残 + 源泉費):</span><input type="text" id="totalGrossPlusTax" disabled></label>
      </div>
      </section>

    </td>
  </tr>
 </table>

  <div class="group no-bg">
    <label><span>集計提出前金庫金:</span> <input type="text" inputmode="numeric" pattern="\d*" id="finalCash" oninput="updateCalculations()"></label>
    <label><span>現金誤差:</span> <input type="text" id="cashDifference" disabled></label>
  </div>

  <button type="button" onclick="resetApp('app3')" class="red-btn">リセット</button>
  <button type="button" onclick="resetAllApps()" class="red-btn">完全リセット</button>
  <div style="text-align: center; margin-top: 20px;">
  <button onclick="exportAsFilledHTML()">入力済みHTMLとして保存</button>
  <button id="exportExcelApp3" type="button" class="export-btn">Excelにエクスポート</button>
  <div style="text-align: center; margin-top: 40px; font-size: 12px; color: #888;">
  </div>

</div> <!-- app3を閉じる -->






































<script>

//<base script---------------------------------------------------------------------------------------------------------------->
  function updateAdviserFeeFromTotalCount() {
    const countEl = document.getElementById('totalCountValue');
    const adviserFeeInput = document.getElementById('adviserFee');

    if (!countEl || !adviserFeeInput) return;

    const count = parseInt(countEl.textContent.replace(/,/g, ''), 10) || 0;
    const fee = count * 1000;
    adviserFeeInput.value = fee;

    updateCalculations(); // 必要に応じて再計算
  }

  function observeTotalCountForAdviserFee() {
    const target = document.getElementById('totalCountValue');
    if (!target) return;

    const observer = new MutationObserver(() => {
      updateAdviserFeeFromTotalCount();
    });

    observer.observe(target, {
      childList: true,
      characterData: true,
      subtree: true,
    });
  }

document.addEventListener('gesturestart', function (e) {
  e.preventDefault();
});

let startY = 0;

document.addEventListener('touchstart', function (e) {
  startY = e.touches[0].clientY;
}, { passive: false });

document.addEventListener('touchmove', function (e) {
  const currentY = e.touches[0].clientY;

  // 上方向へスクロールしようとしていて、ページが一番上にいるとき
  if (currentY > startY && window.scrollY === 0) {
    e.preventDefault(); // iOS Safari でPull-to-Refreshを防止
  }
}, { passive: false });

// ---- 固定ヘッダ(タブ+可視サブナビ)込みで目的地へスクロール ----
function scrollToFixed(targetId) {
  const target = document.getElementById(targetId);
  if (!target) return;

  const tabsH = document.querySelector('.tabs')?.offsetHeight || 0;
  const visibleSub = Array.from(document.querySelectorAll('nav.subnav'))
    .find(n => getComputedStyle(n).display !== 'none');
  const subH = visibleSub?.offsetHeight || 0;

  // 念のためサブナビの top も加味（CSSでtop:80px）
  const subTop = visibleSub ? parseInt(getComputedStyle(visibleSub).top || '0', 10) : 0;

  const offset = tabsH + subH + subTop + 20;     // 余白+20
  const y = target.getBoundingClientRect().top + window.pageYOffset - offset;
  window.scrollTo({ top: y, behavior: 'smooth' });

  // 入力欄があるならフォーカス（任意）
  const focusable = target.matches('input,select,textarea,button')
      ? target
      : target.querySelector('input,select,textarea,button');
  focusable?.focus();
}

// 共通スクロール関数（サイド／サブナビ用）
function scrollWithOffset(targetId) {
  const target = document.getElementById(targetId);
  if (target) {
    const navHeight = 140; // タブ(80px) + サブナビ(50px) + 余白10px
    const y = target.getBoundingClientRect().top + window.pageYOffset - navHeight;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
}

/* ========= ナビスクロールを統一 ========= */

// CSS変数からタブ/サブナビ高さ(px)を取得
function _pxVar(name, fallback = 0){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v.endsWith('px') ? parseFloat(v) : (parseFloat(v) || fallback);
}
function _currentSubnavH(){
  const nav = document.querySelector(
    'body[data-active-app="app1"] #app1-nav,'+
    'body[data-active-app="app2"] #app2-nav,'+
    'body[data-active-app="app3"] #app3-nav'
  );
  return nav ? nav.offsetHeight : _pxVar('--subnav-h', 50);
}
function _scrollOffset(){
  return Math.round(_pxVar('--tabs-h', 56) + _currentSubnavH() + 70);
}

function _behavior(want='smooth'){
  return matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : want;
}

let _scrolling = false;
window.navScrollTo = function(targetId, behavior='smooth'){
  const el = document.getElementById(targetId);
  if (!el) return;

  const top = window.pageYOffset + el.getBoundingClientRect().top - _scrollOffset();
  const finalTop = Math.max(0, Math.floor(top));

  if (_scrolling) return;
  _scrolling = true;

  window.scrollTo({ top: finalTop, behavior: _behavior(behavior) });

  setTimeout(() => { _scrolling = false; }, 600);
};

// クリック時のハンドラ（サブナビ・サイドナビ）
['#app1-nav', '#app2-nav', '#app3-nav', '#app2-sideNav'].forEach(sel => {
  const nav = document.querySelector(sel);
  if (!nav) return;
  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-target]');
    if (!btn) return;
    e.preventDefault();
    navScrollTo(btn.getAttribute('data-target'), 'smooth');
  }, { passive:false });
});

// 履歴スクロールも navScrollTo に統一
document.getElementById('side-scroll-history')?.addEventListener('click', (e) => {
  e.preventDefault();
  navScrollTo('app2-historySection', 'smooth');
});

// アンカー直飛び防止
(() => {
  const style = document.createElement('style');
  style.textContent = `html { scroll-behavior: auto !important; }`;
  document.head.appendChild(style);
})();








































//<app1 script---------------------------------------------------------------------------------------------------------------->
//伝票検索機能
function searchByAmount() {
  const input = document.getElementById('searchAmount').value.replace(/,/g, '').trim();
  const rows = document.querySelectorAll('#formRows tr');
  let foundRow = null;

  rows.forEach(row => {
    const totalValue = row.querySelector('.total')?.value.replace(/,/g, '') || '';
    const shouldShow = (input === '' || totalValue.includes(input));

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }

    // スクロール用: 最初に見つかった行だけ記憶
    if (shouldShow && !foundRow) {
      foundRow = row;
    }
  });

  // 検索値が空欄でなければ、ヒット時はスクロール、なければダイアログ
  if (input !== '') {
    if (foundRow) {
      // スクロール（スムーズ・中央寄せ）
      foundRow.scrollIntoView({ behavior: "smooth", block: "center" });
      // ハイライトしたい場合は下記も追加OK
      // foundRow.classList.add('highlight');
    } else {
      window.alert("該当する伝票がありません。");
    }
  }
}


function resetSearch() {
  document.getElementById('searchAmount').value = '';
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    if (row.style.display === 'none') {
      row.style.display = '';
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });
}

function saveCheckboxStates() {
  const checkboxes = document.querySelectorAll("table input[type='checkbox']");
  const states = Array.from(checkboxes).map(cb => cb.checked);
  localStorage.setItem("checkboxStates", JSON.stringify(states));
}

function restoreCheckboxStates() {
  const states = JSON.parse(localStorage.getItem("checkboxStates"));
  if (!states) return;
  const checkboxes = document.querySelectorAll("table input[type='checkbox']");
  checkboxes.forEach((cb, index) => {
    cb.checked = states[index];
  });
}

let rowNumber = 2;

function createEmptyRow(number) {
  const tr = document.createElement('tr');
  tr.className = "row";
  tr.innerHTML = `
    <td><button class="delete-btn" onclick="deleteRow(this)">×</button></td>
    <td class="rowNumber">${number}</td>
    <td><input class="table-number" type="text" inputmode="numeric" placeholder="卓番" oninput="updateTotals()" /></td>
    <td><input class="honshi" type="text" inputmode="numeric" placeholder="本指" oninput="updateTotals()" /></td>
    <td>
      <select class="c" oninput="updateRowColor(this); updateTotals()">
        <option value="">-</option>
        <option value="UK">UK</option>
        <option value="K">K</option>
        <option value="AB">AB</option>
        <option value="LA">LA</option>
        <option value="PA">PA</option>
        <option value="BB">BB</option>
        <option value="MS">MS</option>
        <option value="GM">GM</option>
        <option value="B">B</option>
        <option value="JOE">JOE</option>
        <option value="KOSE">KOSE</option>
        <option value="HE">HE</option>
        <option value="PB">PB</option>
        <option value="X">X</option>
        <option value="Z">Z</option>
      </select>
    </td>
    <td><input class="amount" type="text" inputmode="numeric" placeholder="金額" oninput="updateTotals()" /></td>
    <td><input class="num" type="text" inputmode="numeric" placeholder="人数" oninput="updateTotals()" /></td>
    <td><input class="detail" type="text" placeholder="詳細" /></td>
    <td><input class="card" type="text" inputmode="numeric" placeholder="カード" oninput="updateTotals()" /></td>
    <td><input class="total" type="text" inputmode="numeric" placeholder="総合計" oninput="updateTotals()" /></td>
  `;
  return tr;
}


function addRow() {
  const table = document.getElementById("formRows");
  const newRow = createEmptyRow(rowNumber++);

  table.appendChild(newRow);

  // アニメーション
  requestAnimationFrame(() => newRow.classList.add('slide-in'));
  newRow.addEventListener('animationend', () => newRow.classList.remove('slide-in'));

  // スクロール
  const rect = newRow.getBoundingClientRect();
  const offset = 155;
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  window.scrollTo({ top: rect.top + scrollTop - offset, behavior: 'smooth' });

  attachCommaFormatApp1and3();
  saveForm();
  renumberRows();
}

/*app1 Enterで次のフォーム移動ロジック開始*/

// Enter → 次フィールド（現在アクティブなAPP内で、表示要素のみ）
document.addEventListener('keydown', function (e) {
  if (e.key !== 'Enter') return;

  const target = e.target;
  if (!(target instanceof HTMLElement)) return;
  if (!target.matches('input, select, textarea')) return;

  e.preventDefault();

  // いまのAPP ID（app1/app2/app3）を body 属性から取得
  const activeAppId = document.body.getAttribute('data-active-app') || '';
  // スコープは「その入力が属する .content」> それが無ければ activeApp > それも無ければ document
  const scope =
    target.closest('.content') ||
    document.getElementById(activeAppId) ||
    document.body;

  // 非表示(=offsetParentがnull)は除外して並び順どおりに移動
  const formElements = Array.from(
    scope.querySelectorAll('input:not([type=hidden]):not([disabled]), textarea:not([disabled]), select:not([disabled])')
  ).filter(el => el.offsetParent !== null);

  const index = formElements.indexOf(target);
  const next = formElements[index + 1];
  if (next) {
    next.focus();
    if (typeof next.select === 'function') next.select();
  }
});

/*app1 Enterで次のフォーム移動ロジック終了*/


function updateRowColor(select) {
  const row = select.closest("tr");
  row.className = "row";
  if (select.value) {
    row.classList.add("category-" + select.value);
  }
}

// グローバルにキャッチバック内訳を保持するオブジェクト
let catchbackDetails = {};

let _raf = 0;
function scheduleTotals(){
  if (_raf) return;
  _raf = requestAnimationFrame(()=>{ _raf = 0; updateTotals(); });
}

function updateTotals() {
  let totalCustomers = 0;
  let cardTotal = 0;
  let totalAmount = 0;

  const catchbackTotals = {};
  const categories = ["UK", "K", "AB", "LA", "PA", "BB", "MS", "GM", "B", "JOE", "KOSE", "HE", "PB", "X", "Z"];

  // 初期化
  categories.forEach(cat => {
    catchbackTotals[cat] = { amount: 0, count: 0 };
    catchbackDetails[cat] = [];   // ← 単価ごとの行データを配列で保持
  });

  // 各行を走査して集計
  document.querySelectorAll(".row").forEach(row => {
    const num    = parseInt(row.querySelector(".num")?.value.replace(/,/g, '')) || 0;
    const honshi = parseInt(row.querySelector(".honshi")?.value.replace(/,/g, '')) || 0;
    const amount = parseInt(row.querySelector(".amount")?.value.replace(/,/g, '')) || 0;
    const card   = parseInt(row.querySelector(".card")?.value.replace(/,/g, '')) || 0;
    const total  = parseInt(row.querySelector(".total")?.value.replace(/,/g, '')) || 0;
    const category = row.querySelector(".c")?.value;

    // 全体集計
    totalCustomers += num + honshi;
    cardTotal      += card;
    totalAmount    += total;

    // キャッチバック集計
    if (category && catchbackTotals[category]) {
      // 20% or 30% のバック計算
      const backAmount = (amount <= 5999) ? amount * num * 0.2 : amount * num * 0.3;

      if (category !== "Z") {  // Zは集計対象外
        catchbackTotals[category].amount += backAmount;
        catchbackTotals[category].count  += num;

        if (num > 0) {
          // ← 行ごとのデータをそのまま記録
          catchbackDetails[category].push({
            unit: amount,
            count: num
          });
        }
      }
    }
  });

  // 合計の再計算 & DOM反映
  let totalCount = 0;
  let totalBackAmount = 0;

  categories.forEach(cat => {
    if (cat !== "X") {
      totalCount += catchbackTotals[cat].count;
      totalBackAmount += catchbackTotals[cat].amount;
    } else {
      totalBackAmount += catchbackTotals[cat].amount;
    }

    document.getElementById(`${cat}count`).textContent =
      catchbackTotals[cat].count.toLocaleString();

    document.getElementById(`${cat}total`).textContent =
      Math.floor(catchbackTotals[cat].amount).toLocaleString();
  });

  // 全体合計の表示
  document.getElementById("totalCustomers").textContent = totalCustomers.toLocaleString();
  document.getElementById("cardTotal").textContent      = cardTotal.toLocaleString();
  document.getElementById("cashTotal").textContent      = (totalAmount - cardTotal).toLocaleString();
  document.getElementById("totalAmount").textContent    = totalAmount.toLocaleString();
  document.getElementById("totalCountValue").textContent= totalCount.toLocaleString();
  document.getElementById("totalBackAmount").textContent= Math.floor(totalBackAmount).toLocaleString();

  // 入力欄にも反映
  const cardSalesInput = document.getElementById("cardSales");
  if (cardSalesInput) cardSalesInput.value = formatNumber(cardTotal);

  const totalSalesInput = document.getElementById("totalSales");
  if (totalSalesInput) totalSalesInput.value = formatNumber(totalAmount);

  if (!window.catchbackDetails) window.catchbackDetails = {};
window.catchbackDetails = {}; // 初期化

document.querySelectorAll('#formRows tr').forEach(row => {
  const c = row.querySelector('.c')?.value || '';
  if (!c) return;

  const num  = parseInt((row.querySelector('.num')?.value || '0').replace(/,/g,''), 10);    // 本数
  const unit = parseInt((row.querySelector('.amount')?.value || '0').replace(/,/g,''), 10); // 単価（金額）
  const detail = row.querySelector('.detail')?.value || '';

  const amount = unit * num; // 合計金額

  (window.catchbackDetails[c] ||= []).push({
    unit,        // 単価
    count: num,  // 本数
    amount,      // 金額（unit × count）
    detail
  });
});

  saveForm();
}



function saveForm() {
  const formData = [];
  document.querySelectorAll(".row").forEach((row, index) => {
    const rowNumber = parseInt(row.querySelector(".rowNumber")?.textContent) || index + 1;

    const rowData = {
      rowNumber: rowNumber,
      honshi: row.querySelector(".honshi")?.value || "",
      category: row.querySelector(".c")?.value || "",
      amount: row.querySelector(".amount")?.value || "",
      num: row.querySelector(".num")?.value || "",
      detail: row.querySelector(".detail")?.value || "",
      card: row.querySelector(".card")?.value || "",
      total: row.querySelector(".total")?.value || "",
      checkboxes: {}
    };

    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      rowData.checkboxes[checkbox.parentElement.textContent.trim()] = checkbox.checked;
    });

    formData.push(rowData);
  });

  localStorage.setItem("formData", JSON.stringify(formData));
}


function restoreForm() {
  const savedData = localStorage.getItem("formData");
  if (savedData) {
    const formData = JSON.parse(savedData);
    const table = document.getElementById("formRows");

    // 最初の行以外を削除
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }

    formData.forEach((data, index) => {
      let row;
      if (index === 0) {
        row = table.rows[0];
      } else {
        row = table.rows[0].cloneNode(true);
        table.appendChild(row);
      }

      // セルの復元
      row.querySelector(".rowNumber").textContent = data.rowNumber || index + 1;
      row.querySelector(".honshi").value = data.honshi || "";
      row.querySelector(".c").value = data.category || "";
      row.querySelector(".amount").value = data.amount || "";
      row.querySelector(".num").value = data.num || "";
      row.querySelector(".detail").value = data.detail || "";
      row.querySelector(".card").value = data.card || "";
      row.querySelector(".total").value = data.total || "";

      updateRowColor(row.querySelector(".c"));

      // 削除ボタンが存在しない場合は追加
      if (!row.querySelector(".delete-btn")) {
        const deleteCell = document.createElement("td");
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "削除";
        deleteButton.className = "delete-btn";
        deleteButton.onclick = function () {
          deleteRow(this);
        };
        deleteCell.appendChild(deleteButton);
        row.appendChild(deleteCell);
      }
    });

    // 最大行番号を更新
    const maxRowNum = formData.reduce((max, data) => {
      const num = parseInt(data.rowNumber, 10);
      return (!isNaN(num) && num > max) ? num : max;
    }, 0);
    rowNumber = maxRowNum + 1;

    updateTotals();
  } else {
    rowNumber = 2; // データなしなら初期値に戻す
  }
}

function filterCategory(category) {
  currentCategory = category;
  localStorage.setItem("selectedCategory", category); // ← 保存

  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const select = row.querySelector('select.c');
    const value = select ? select.value : '';

    const shouldShow = (category === 'all' || value === category);

    if (shouldShow && row.style.display === 'none') {
      // 表示する必要あり→右からスライドイン
      row.style.display = '';
      row.classList.remove('slide-out-left');
      // スライドインアニメを付ける
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      // 非表示にする必要あり→左スライドで消す
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
  const activeBtn = Array.from(document.querySelectorAll('.tab button')).find(btn => {
    return btn.textContent === category || (category === 'all' && btn.textContent.includes('すべて表示'));
  });
  if (activeBtn) activeBtn.classList.add('active');
}

function filterCashOnlyRows() {
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const cardInput = row.querySelector('.card');
    const cardValue = parseInt(cardInput?.value || "0");
    const shouldShow = (!cardValue || cardValue === 0);

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  currentCategory = 'cashOnly';
  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
}


function filterCardInputRows() {
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const cardInput = row.querySelector('.card');
    const hasCardValue = cardInput && cardInput.value.trim() !== '';
    const shouldShow = hasCardValue;

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  currentCategory = 'cardInputOnly';
  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
}

function deleteRow(button) {
  const row = button.closest('tr');
  const formRows = document.getElementById('formRows');

  if (formRows.rows.length <= 1) {
    alert("これ以上削除できません");
    return;
  }

  if (confirm("この伝票を削除しますか？")) {
    // まずアニメーション用クラスを付ける
    row.classList.add('slide-out-left');

    // アニメーション終了後にDOMから削除
    row.addEventListener('animationend', function onAnimEnd() {
      row.removeEventListener('animationend', onAnimEnd); // 多重登録防止
      formRows.removeChild(row);
      renumberRows();
      updateTotals();
      saveForm();
    });
  }
}

function renumberRows() {
  const rows = document.querySelectorAll("#formRows tr");
  rows.forEach((row, index) => {
    const cell = row.querySelector(".rowNumber");
    if (cell) {
      cell.textContent = index + 1;
    }
  });
}








































//<app2 script---------------------------------------------------------------------------------------------------------------->

function createBottleForm(detail = '', split = '', quantity = '', amount = '') {
  const form = document.createElement('div');
  form.className = 'bottle-form';

  form.innerHTML = `
  <div class="left-group">
    <button type="button" class="delete-btn">×</button>
    <select class="bottleDetails">${window.BOTTLE_OPTIONS_HTML}</select>
    <input type="number" class="splitCount" placeholder="割">
    <input type="number" class="bottleQuantity" placeholder="数量">
  </div>
  <input type="number" class="bottleAmount" placeholder="金額">
`;

  const sel         = form.querySelector('.bottleDetails');
  const splitInput  = form.querySelector('.splitCount');
  const qtyInput    = form.querySelector('.bottleQuantity');
  const amountInput = form.querySelector('.bottleAmount');
  const delBtn      = form.querySelector('.delete-btn');

  // ★ 復元時に即保存しないようにする
  // if (typeof saveBottleForms === 'function') saveBottleForms(); ← 削除

  // 初期値を反映
  if (detail) {
    sel.value = detail;
    if (sel.value !== detail) {
      const tmp = document.createElement('option');
      tmp.value = detail;
      tmp.textContent = detail;
      const etcGroup = Array.from(sel.children).find(n => n.tagName === 'OPTGROUP' && n.label === 'その他');
      (etcGroup || sel).appendChild(tmp);
      sel.value = detail;
    }
  }
  if (split   !== undefined) splitInput.value  = split;
  if (quantity!== undefined) qtyInput.value    = quantity;
  if (amount  !== undefined) amountInput.value = amount;

// 品目変更時
sel.addEventListener('change', (e) => {
  if (window.BOTTLE_REFRESHING) return;
  const opt = sel.selectedOptions[0];
  if (!opt) return;

  if (opt.dataset.from === 'history') {
    // 履歴選択：従来どおり履歴の値を復元
    splitInput.value  = opt.dataset.split  || '';
    qtyInput.value    = opt.dataset.qty    || '';
    amountInput.value = opt.dataset.amount || '';
  } else {
    // 静的な品目選択：ユーザー操作のときだけ初期化
    if (!e.isTrusted) return;                 // ★合成change（復元後など）なら何もしない
    // ★保険：空欄のときだけ既定値を入れる（既存値は崩さない）
    if (splitInput.value === '') splitInput.value = '1';
    if (qtyInput.value   === '') qtyInput.value   = '1';
    updateBottleAmountForForm(form);          // 登録金額から算出
  }
  saveBottleForms?.();
});

// 入力イベント → 復元中は無視
['input','change','blur'].forEach(evt => {
  splitInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    updateBottleAmountForForm(form);   // ← 追加
    saveBottleForms?.();
  });
  qtyInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    updateBottleAmountForForm(form);   // ← 追加
    saveBottleForms?.();
  });
  amountInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    saveBottleForms?.();
  });
});

  // 削除ボタン
  delBtn.addEventListener('click', () => {
    if (confirm('このボトル明細を削除しますか？')) {
      form.remove();
      saveBottleForms?.();
      refreshBottleDropdownsFromHistory?.();
    }
  });

  return form;
}


let BOTTLE_REFRESHING = false;

// === APP2: ボトルの登録バック金額（ユーザー指定版） ===
const BOTTLE_BASE = Object.freeze({
  'リステル': 6000,
  'パリ': 7500,
  'マバム': 17500,
  'モエ白': 15000,
  'モエロゼ': 17500,
  'モエネク': 20000,
  'モエピカ': 22500,
  'ヴーヴ': 16000,
  'ヴーヴホワイト': 17500,
  'ヴーヴローズ': 19000,
  'ベルエ': 70000,
  'ベルエロゼ': 140000,
  'ソウメイ': 60000,
  'ドンペリ': 50000,
  'ドンペリルミナス': 60000,
  'ドンペリロゼ': 70000,
  'ドンペリルミナスロゼ': 85000,
  'ドンペリP2': 150000,
  'ドンペリゴールド': 250000,
  'アルマンド': 85000,
  'アルマンドロゼ': 140000,
  'アルマンドグリーン': 200000,
  'オリシャンR': 12500,
  'オリシャンB': 30000,
  '柚子小町': 5000,
  '黒霧島': 7500,
  '吉四六': 7500,
  '富乃宝山': 8500,
  '赤霧島': 10000,
  '知多': 20000,
  '山崎': 35000,
  'ベリンジャー': 10000,
  'テキカン': 35000,
  '枝': 200,

  // 空白（自動金額なしにしたい項目は 0 にしておく）
  'その他': 0,
  '保障補正': 0
});

// 入力→数値(,除去)の安全変換
function intSafe(v, d = 0){ const n = parseInt(String(v ?? '').toString().replace(/,/g,''),10); return Number.isFinite(n)? n : d; }
// 100円未満切り捨て（例: 3750 → 3700）
function floor100(yen){ return Math.floor(intSafe(yen)/100)*100; }

// sel(=select)から“品名”を取り出す（履歴選択時は base 名）
function getSelectedDetail(sel){
  const opt = sel?.selectedOptions?.[0];
  return (opt?.dataset?.base) || sel?.value || '';
}

// 登録金額・割・数量から金額を計算
// ルール: (登録金額/割) の “10円未満切り捨て” を単価とし、単価×数量
function computeBottleAmount(detail, split, qty){
  const base = BOTTLE_BASE[detail] ?? 0;
  const s = Math.max(1, intSafe(split, 1)); // 0割回避
  const q = Math.max(0, intSafe(qty, 0));
  const unit = floor100(base / s);
  return unit * q;
}

// フォーム1行の金額を再計算して反映
function updateBottleAmountForForm(form){
  const sel   = form.querySelector('.bottleDetails');
  const split = form.querySelector('.splitCount')?.value;
  const qty   = form.querySelector('.bottleQuantity')?.value;
  const amt   = computeBottleAmount(getSelectedDetail(sel), split, qty);
  const out   = form.querySelector('.bottleAmount');
  out.value = amt ? String(amt) : ''; // 未登録(0)は空に
}

// 履歴 → { 詳細名: [ { id, split, qty, amount }, ... ] }
let BOTTLE_HISTORY = {};


function buildBottleHistoryMap() {
  BOTTLE_HISTORY = {};
  const list = document.getElementById('historyList');
  if (!list) return;

  const items = Array.from(list.querySelectorAll('li'));
  const re = /ボトル:\s*¥([\d,]+)（([^/（）]*?)(?:\/割:([^\s/（）]+))?(?:\/数量:([^\s/（）]+))?）/g;

  const seen = new Set(); // 同一バリアント重複防止

  for (const li of items) {
    const html = li.innerHTML;
    let m;
    while ((m = re.exec(html)) !== null) {
      const amount = parseInt(m[1].replace(/,/g, ''), 10) || 0;
      const detail = (m[2] || '').trim();
      const split  = (m[3] || '').trim();
      const qty    = (m[4] || '').trim();
      if (!detail) continue;

      // バリアントID（品名＋割＋数量＋金額の組）
      const id = encodeURIComponent(detail) + '|' +
                 encodeURIComponent(split)  + '|' +
                 encodeURIComponent(qty)    + '|' +
                 amount;

      if (seen.has(id)) continue;
      seen.add(id);

      (BOTTLE_HISTORY[detail] ||= []).push({ id, split, qty, amount });
    }
  }
}

function refreshBottleDropdownsFromHistory() {
  buildBottleHistoryMap();

  BOTTLE_REFRESHING = true; // ←開始

  document.querySelectorAll('select.bottleDetails').forEach(sel => {
    // 退避
    const prevValue = sel.value;
    const form = sel.closest('.bottle-form');
    const prevSplit = form?.querySelector('.splitCount')?.value ?? '';
    const prevQty   = form?.querySelector('.bottleQuantity')?.value ?? '';
    const prevAmt   = form?.querySelector('.bottleAmount')?.value ?? '';

    // 履歴グループを先頭に
    let grp = Array.from(sel.children).find(n => n.tagName === 'OPTGROUP' && n.label === '履歴');
    if (!grp) {
      grp = document.createElement('optgroup');
      grp.label = '履歴';
      sel.insertBefore(grp, sel.firstChild);
    }
    grp.innerHTML = '';

    // 各品名の履歴を再構築
    Object.entries(BOTTLE_HISTORY).forEach(([detail, variants]) => {
      // 静的に存在しない品名だけ「（新規）」を追加
      const hasBlank = Array.from(sel.options).some(o => o.value === detail);
      if (!hasBlank) {
        const blankOpt = document.createElement('option');
        blankOpt.value = detail;
        blankOpt.textContent = `${detail}（新規）`;
        blankOpt.dataset.base = detail;
        grp.appendChild(blankOpt);
      }

      variants.forEach(v => {
        const opt = document.createElement('option');
        opt.value = `__HIST__${v.id}`;
        opt.textContent = `${detail}（${v.split !== '' ? "割:" + v.split : "割:-"}/${v.qty !== '' ? "数量:" + v.qty : "数量:-"}/¥${v.amount.toLocaleString()}）`;
        opt.dataset.from = 'history';
        opt.dataset.base = detail;
        opt.dataset.split = v.split;
        opt.dataset.qty = v.qty;
        opt.dataset.amount = v.amount;
        grp.appendChild(opt);
      });
    });

    // 選択を復元。失敗したら退避の入力値を戻す
    sel.value = prevValue;
    if (sel.value !== prevValue && form) {
      form.querySelector('.splitCount').value     = prevSplit;
      form.querySelector('.bottleQuantity').value = prevQty;
      form.querySelector('.bottleAmount').value   = prevAmt;
    }
  });

  BOTTLE_REFRESHING = false; // ←終了
}



function addBottleForm() {
  const container = document.getElementById('bottleFormsContainer');
  const newForm = createBottleForm(); // ←空のフォームを追加
  container.appendChild(newForm);
  refreshBottleDropdownsFromHistory();
  saveBottleForms(); // 保存
}

function saveBottleForms() {
  const bottleForms = [];
  document.querySelectorAll('.bottle-form').forEach(form => {
    const sel = form.querySelector('.bottleDetails');
    const opt = sel?.selectedOptions?.[0];

    const bottleDetails =
      (opt?.dataset?.base) || (sel?.value || ''); // 履歴選択でも「品名」だけ保存

    const splitCount = form.querySelector('.splitCount')?.value || '';
    const bottleQuantity = form.querySelector('.bottleQuantity')?.value || '';
    const bottleAmount = parseInt(
      (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, ''), 10
    ) || 0;

    bottleForms.push({ bottleDetails, splitCount, bottleQuantity, bottleAmount });
  });

  localStorage.setItem('bottleForms', JSON.stringify(bottleForms));
}



function loadBottleForms() {
  const bottleFormsData = JSON.parse(localStorage.getItem('bottleForms')) || [];
  const container = document.getElementById('bottleFormsContainer');
  if (!container) return;   // ← 念のため

  container.innerHTML = '';

  window.BOTTLE_REFRESHING = true; // ★復元フラグON
  bottleFormsData.forEach(data => {
    const form = createBottleForm(
      data.bottleDetails || '',
      data.splitCount || '',
      data.bottleQuantity || '',
      data.bottleAmount || 0
    );
    if (form) container.appendChild(form);
  });
  window.BOTTLE_REFRESHING = false; // ★復元フラグOFF
}

function renumberHistory() {
  const items = Array.from(document.querySelectorAll('#historyList li')).reverse(); // 下から順に1,2,3
  items.forEach((item, index) => {
    const castElem = item.querySelector('.castName');
    if (castElem) {
      let text = castElem.textContent.replace(/^\s*\d+\.\s*/, ' '); // 旧番号を削除
      const nameOnly = text.replace(/^\s*/, '').trim();
      castElem.innerHTML = `<strong></strong> ${index + 1}. ${nameOnly}`;
    }
  });
}


function calculate() {
   const historyList = document.getElementById('historyList');
  // 「体験及び貸出」のチェックボックスの状態を取得
  const isExperienceAndRentalChecked = document.getElementById('experienceAndRental').checked;
  let experienceText = isExperienceAndRentalChecked ? '体験及び貸出: 有り' : '体験及び貸出: 無し';

  const values = {
    f: 1500, f2: 2000, jounai: 1000, honshiri: 0, douhan: 1500,
    eda: 500, help: -1500, set40: 5500, set20: 3500, vip: 2000,
    a: 500, b: 1000, c: 1500, d: 2000, e: 2500
  };

  let total = 0;
  for (let key in values) {
    const count = parseInt(document.getElementById(key).value) || 0;
    total += count * values[key];
  }

   // 動的に追加されたボトルフォームから金額と詳細を取得
  const bottleForms = document.querySelectorAll('.bottle-form');
  bottleForms.forEach(form => {
    const bottleAmount = parseInt(
   (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, ''), 10
   ) || 0;
    const bottleDetails = form.querySelector('.bottleDetails').value || '詳細なし';
    total += bottleAmount;
  });

  const kousei = 1000;
  const gensen = Math.ceil((total * 0.1) / 100) * 100;

  let afterGensen = total - gensen;

  let actualKousei = 0;

  // 厚生費の引き方を変更
  if (!isExperienceAndRentalChecked) {
    if (afterGensen - kousei >= 5000) {
      actualKousei = kousei;
    } else {
      actualKousei = Math.max(0, afterGensen - 5000);
    }
  }

  const kouseiStoreCovered = (actualKousei === 0) ? 1000 : 0;
  const kouseiCastCovered = 0;

  let welfareText = `厚生費: ¥${actualKousei.toLocaleString()} (店舗負担:¥${kouseiStoreCovered.toLocaleString()})`;

  // 送迎金額の取得
  let sendoffAmount = parseInt(document.getElementById('sendoffAmount').value)||0;

  // 合計 = 小計 - 源泉費 - 厚生費
  let totalAmount = afterGensen - actualKousei;

    let adjustedSendoff = 0;

    if (!isExperienceAndRentalChecked) {
    adjustedSendoff = sendoffAmount;
    const tempFinalAmount = totalAmount - adjustedSendoff;

    if (tempFinalAmount < 5000) {
    const maxDeductible = totalAmount - 5000;
    adjustedSendoff = Math.max(0, maxDeductible);
    }
  }

  // 最終合計
  let finalAmount = totalAmount - adjustedSendoff;



  // 店舗負担・本人負担の計算
  const castCoveredAmount = adjustedSendoff;
  const storeCoveredAmount = sendoffAmount - adjustedSendoff;

  // 店舗負担合計をグローバルで加算（リセットしない）
  window.totalStoreCovered = (window.totalStoreCovered || 0) + Math.max(storeCoveredAmount, 0);

  let sendoffText = `送迎: ¥${sendoffAmount.toLocaleString()}(本人負担: ¥${castCoveredAmount.toLocaleString()}`;
  if (storeCoveredAmount > 0) {
  sendoffText += `店舗負担: ¥${storeCoveredAmount.toLocaleString()})`;
  } else {
  sendoffText += `)`; // ←これを追加すると安心
  }

  const labels = {
    f: 'F',
    f2: 'F2',
    jounai: '場内',
    honshiri: '本指',
    douhan: '同伴',
    eda: '枝',
    help: 'HELP',
    set40: 'SET40',
    set20: 'SET20',
    vip: 'VIP',
    a: 'A',
    b: 'B',
    c: 'C',
    d: 'D',
    e: 'E'
  };

  let detailsHTML = '<div class="details" style="font-size: 14px; margin-top: 10px;">';
 
  for (let key in values) {
    const count = parseInt(document.getElementById(key).value) || 0;
    if (count > 0) {
      const label = labels[key] || key.toUpperCase();
      const unitPrice = values[key];
      const subtotal = count * unitPrice;
      detailsHTML += `<div>${label} ×${count}（¥${unitPrice.toLocaleString()}）= ¥${subtotal.toLocaleString()}</div>`;
    }
  }

  // 追加された全ボトル明細
  bottleForms.forEach(form => {
    const sel = form.querySelector('.bottleDetails');
    const opt = sel?.selectedOptions?.[0];
    const bottleDetail = (opt?.dataset?.base) || (sel?.value) || '詳細なし';

    const split = form.querySelector('.splitCount')?.value || '';
    const quantity = form.querySelector('.bottleQuantity')?.value || '';
    const amountStr = (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, '');
    const bottleAmount = parseInt(amountStr, 10) || 0;

    if (bottleAmount > 0 || bottleDetail || split || quantity) {
      detailsHTML += `<div>ボトル:¥${bottleAmount.toLocaleString()}（${bottleDetail}`;
      if (split) detailsHTML +=`/割:${split}`;
      if (quantity) detailsHTML +=`/数量:${quantity}`;
      detailsHTML +=`）</div>`;
    }
  });

  detailsHTML += '</div>';

  const castName = document.getElementById('castName').value || '（名前なし）';

  // 10万を超える場合だけ表示（封筒印字専用）
  const congratsHTML =
  (finalAmount > 100000)
    ? `
      <div class="congrats-box print-only">
        <div class="congrats">～CONGRATULATIONS～</div>
        <div class="finalAmount print-highlight"><strong>最終合計: </strong>¥${finalAmount.toLocaleString()}</div>
      </div>
    `
    : `
      <div class="finalAmount print-highlight"><strong>最終合計: </strong>¥${finalAmount.toLocaleString()}</div>
    `;

  const resultText = `
  <div class="castName"><strong></strong> ${castName}</div>
  <div class="experienceAndRental">${experienceText}</div>
  <div class="subtotal"><strong>小計:</strong> ¥${total.toLocaleString()}</div>
  <div class="tax" style="font-size: 16px; font-weight: bold;">
    <strong>源泉費:</strong> ¥${gensen.toLocaleString()}
  </div>
  <div class="welfare" style="font-size: 16px; font-weight: bold;">
    <strong>${welfareText}</strong>
  </div>
  <div class="totalAmount" style="font-size:25px; font-weight:bold; display:inline-flex; align-items:baseline;">
    <strong>合計:</strong>&nbsp;¥${totalAmount.toLocaleString()}
    <span class="print-only" style="font-size:14px; margin-left:6px;">←領収書記入</span>
  </div>
  <div class="sendoff"><strong>${sendoffText}</strong></div>

  ${congratsHTML}

  ${detailsHTML}
  `;

  // 履歴に新しい項目を追加
  const existingItem = Array.from(historyList.children).find(item => {
  const nameElem = item.querySelector('.castName');
  if (!nameElem) return false;

  // 🔽 正規表現で先頭の番号（例: "1. "）を削除
  const nameText = nameElem.textContent.replace(/^\s*\d+\.\s*/, '').trim();
  
  return nameText === castName;
  });


  // detailsHTMLを囲んで非表示にする
  const detailsHiddenHTML = `<div class="details-html-container" style="display:none; font-size:14px; margin-top:5px;">${detailsHTML}</div>`;

  const fullHTML = `
  <div>
    <label><input type="checkbox" class="history-checkbox"> 削除対象</label>
    ${resultText.replace(detailsHTML, '')}
    ${detailsHiddenHTML}
    <div style="margin-top: 5px;">
      <button onclick="restoreFromHistory(this)" style="margin-right: 5px; font-size: 12px;">復元</button>
      <button onclick="moveHistoryItem(this, 'up')" style="font-size: 12px;">↑</button>
      <button onclick="moveHistoryItem(this, 'down')" style="font-size: 12px;">↓</button>
    </div>
  </div>
  `;

  if (existingItem) {
  existingItem.innerHTML = fullHTML;
  } else {
  const listItem = document.createElement('li');
  listItem.innerHTML = fullHTML;
  historyList.prepend(listItem);
  }

  renumberHistory();

  // サマリーを更新
  updateSummary();


  // 保存処理
  const inputElements = document.querySelectorAll('input[type="number"], input[type="text"]');
  const inputValues = {};
  inputElements.forEach(input => {
    inputValues[input.id] = input.value;
  });
  localStorage.setItem('inputs', JSON.stringify(inputValues));
  localStorage.setItem('historyList', historyList.innerHTML);
  localStorage.setItem('result', resultText);
    // 履歴に追加したので、ボトル候補を更新
  refreshBottleDropdownsFromHistory();

  // チェックボックスの状態も保存
  const checkboxStates = {
  experienceAndRental: document.getElementById('experienceAndRental').checked
   };
  localStorage.setItem('checkboxes', JSON.stringify(checkboxStates));

    // 🔽 ここを追加：ボトルフォームの内容も保存する
  saveBottleForms();

  document.getElementById("result").innerHTML = resultText;
const resultElem = document.getElementById("result");
if (resultElem) {
  const tabsEl = document.querySelector('.tabs');
  const tabsHeight = tabsEl ? tabsEl.offsetHeight : 0;

  const app2Nav = document.getElementById('app2-nav');
  const navHeight = app2Nav ? app2Nav.offsetHeight : 0;

  const extraOffset = 30;
  const totalOffset = tabsHeight + navHeight + extraOffset;

  const rect = resultElem.getBoundingClientRect();
  const targetY = rect.top + window.pageYOffset - totalOffset;
  window.scrollTo({ top: targetY, behavior: "smooth" });
}
}

  // === 全キャスト共通 店舗負担合計 =================================
  window.totalStoreCovered = 0;

function confirmAndCalculate(e){

  let subtotal = 0;
  let totalAmount = 0;   // ← 追加：定義漏れ修正
  let finalAmount = 0;   // ← 追加：定義漏れ修正

  // 送信を止める（Enter送信等も統一）
  if (e && typeof e.preventDefault === 'function') e.preventDefault();

  const castName   = document.getElementById('castName').value || '（名前なし）';
  const experience = document.getElementById('experienceAndRental').checked ? '有り' : '無し';
  const sendoff    = document.getElementById('sendoffAmount').value || '0';
  const labels = { f:'F', f2:'F2', jounai:'場内', honshiri:'本指', douhan:'同伴', eda:'枝', help:'HELP',
                   set40:'SET40', set20:'SET20', vip:'VIP', a:'A', b:'B', c:'C', d:'D', e:'E' };
  const mainItems = [];
  Object.keys(labels).forEach(key=>{
    const val = document.getElementById(key)?.value;
    if (parseInt(val)) mainItems.push(`${labels[key]} ×${val}`);
  });

  const bottles = [];
  document.querySelectorAll('.bottle-form').forEach(form=>{
    const sel = form.querySelector('.bottleDetails');
    const opt = sel?.selectedOptions?.[0];
    const det = (opt?.dataset?.base) || (sel?.value) || '';
    const spl = form.querySelector('.splitCount')?.value || '';
    const qty = form.querySelector('.bottleQuantity')?.value || '';
    const amtNum = parseInt((form.querySelector('.bottleAmount')?.value || '').replace(/,/g,''),10) || 0;
    if (det || spl || qty || amtNum) {
      const amt = amtNum.toLocaleString();
      bottles.push(`¥${amt}（${det}${spl!==''?'/割:'+spl:''}${qty!==''?'/数量:'+qty:''}）`);
    }
  });

  let msg = `内容を確認してください。\n\n`
          + `キャスト名:${castName}\n体験及び貸出:${experience}\n送迎金額:¥${sendoff}\n`
          + (mainItems.length ? `--- 伝票内訳 ---\n${mainItems.join('\n')}\n` : '')
          + (bottles.length   ? `--- ボトル明細 ---\n${bottles.join('\n')}\n`   : '');

  if (!window.confirm(msg)) return false;

  // 実計算（あなたの既存の calculate が #result を更新します）
  calculate();

  if (typeof updateCalculations === 'function') {
  updateCalculations();
}

  // 描画が反映された次のフレームで結果へスクロール
  requestAnimationFrame(()=> navScrollTo('app2-resultSection','smooth'));

  // 合計・最終金額を #result から抽出
  const resultText = document.querySelector('#result')?.innerText || '';
  const match = resultText.match(/合計[^\d]*(\d[\d,]*)/);
  if (match) {
    totalAmount = parseInt(match[1].replace(/,/g,''),10);
    finalAmount = totalAmount;
  }

  // 結果オブジェクト
  const entry = {
    time: new Date().toISOString(),
    cast: castName,
    subtotal: subtotal,
    total: totalAmount,
    final: finalAmount,
    payload: {
      f: document.getElementById('f')?.value || '',
      f2: document.getElementById('f2')?.value || '',
      // ...必要分
    }
  };

  // 🔴 以下3行を削除（app2Historyに依存しているため）
  // app2History.unshift(entry);
  // renderApp2History();
  // persistApp2History();

  return false; // 送信は常に抑止
}




function moveHistoryItem(button, direction) {
  const listItem = button.closest('li');
  if (!listItem) return;

  const parentList = listItem.parentNode;
  let targetItem = null;

  if (direction === 'up' && listItem.previousElementSibling) {
    targetItem = listItem.previousElementSibling;
    parentList.insertBefore(listItem, targetItem);
  } else if (direction === 'down' && listItem.nextElementSibling) {
    targetItem = listItem.nextElementSibling;
    parentList.insertBefore(targetItem, listItem);
  }

  // ↓ 移動後の要素に強制スクロール（DOM反映後に実行）
  requestAnimationFrame(() => {
    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  renumberHistory(); // ← 連番再振り
  localStorage.setItem('historyList', parentList.innerHTML);
  updateSummary();
}


function restoreFromHistory(button) {
  const historyItem = button.closest('li') || button.closest('div');
  if (!historyItem) return;

  // キャスト名の復元
  const castNameElem = historyItem.querySelector('.castName');
  const castName = castNameElem ? castNameElem.textContent.replace(/^\s*\d+\.\s*/, '').trim() : '';
  document.getElementById('castName').value = castName;

  // ラベル対応表を定義（calculate関数と同じ内容）
  const labels = {
    f: 'F',
    f2: 'F2',
    jounai: '場内',
    honshiri: '本指',
    douhan: '同伴',
    eda: '枝',
    help: 'HELP',
    set40: 'SET40',
    set20: 'SET20',
    vip: 'VIP',
    a: 'A',
    b: 'B',
    c: 'C',
    d: 'D',
    e: 'E'
  };

  // 数値入力欄を復元
  const inputIds = Object.keys(labels);
  inputIds.forEach(id => {
    const label = labels[id];
    const regex = new RegExp(`${label} ×(\\d+)`);
    const match = historyItem.textContent.match(regex);
    if (match) {
      document.getElementById(id).value = match[1];
    } else {
      document.getElementById(id).value = '';
    }
  });

  // 送迎金額を復元
  const sendoffMatch = (historyItem.textContent || '').match(/送迎:\s*¥([\d,]+)/);
  if (sendoffMatch) {
    document.getElementById('sendoffAmount').value = parseInt(sendoffMatch[1].replace(/,/g, ''), 10);
  } else {
    document.getElementById('sendoffAmount').value = 0;
  }

  // 体験及び貸出チェックボックスを復元（textContentかinnerHTMLにキーワードがあるか確認）
  const experienceElem = historyItem.querySelector('.experienceAndRental');
  const experienceText = experienceElem ? experienceElem.textContent : '';
  const experienceChecked = experienceText.includes('体験及び貸出: 有り');
  document.getElementById('experienceAndRental').checked = experienceChecked;

  // ボトル明細を復元
  const bottleRegex = /ボトル:\s*¥([\d,]+)（([^/（）]*?)(?:\/割:([^\s/（）]+))?(?:\/数量:([^\s/（）]+))?）/g;

  // 復元用のループ
  const bottles = [];
  let match;
  while ((match = bottleRegex.exec(historyItem.innerHTML)) !== null) {
  bottles.push({
    bottleAmount: parseInt(match[1].replace(/,/g, '')),
    bottleDetails: match[2] || '',
    splitCount: match[3] || '',
    bottleQuantity: match[4] || ''
  });
  }

  // 復元して配置
  const container = document.getElementById('bottleFormsContainer');
  container.innerHTML = '';
  bottles.forEach(data => {
  const bottleForm = createBottleForm(
    data.bottleDetails,
    data.splitCount,
    data.bottleQuantity,
    data.bottleAmount
  );
  container.appendChild(bottleForm);
  });

  // 保存処理（現在の復元状態を保存しておく）
  saveBottleForms();

    // ページ上部にスクロール
  window.scrollTo({ top: 0, behavior: 'smooth' });

}

function deleteSelectedHistory() {
  const historyList = document.getElementById('historyList');
  const items = historyList.querySelectorAll('li');

  const checkedItems = Array.from(items).filter(item => {
    const checkbox = item.querySelector('.history-checkbox');
    return checkbox && checkbox.checked;
  });

  if (checkedItems.length === 0) {
    alert('削除する履歴を選択してください');
    return;
  }

  const deletedNames = [];

  checkedItems.forEach(item => {
    const nameElem = item.querySelector('.castName');
    const name = nameElem ? nameElem.textContent.replace('', '').trim() : '不明';

    const confirmed = confirm(`「${name}」の履歴を削除しますか？`);
    if (confirmed) {
      deletedNames.push(name);
      item.remove();
    }
  });

  // 削除後の保存
  localStorage.setItem('historyList', historyList.innerHTML);
  updateSummary();
    // 履歴を削除したので、ボトル候補を更新
  refreshBottleDropdownsFromHistory();

  // 削除結果の表示
  if (deletedNames.length > 0) {
    const msg = deletedNames.map(name => `${name} の履歴は削除されました。`).join('\n');
    alert(msg);
  }
}

function updateSummary() {
  const historyItems = document.querySelectorAll('#historyList li');
  let totalPeople = 0;
  let totalAmount = 0;
  let totalGensen = 0;

  historyItems.forEach(item => {
    const text = item.innerText;
    const amountMatch = text.match(/合計:\s*¥([\d,]+)/);
    const gensenMatch = text.match(/源泉費:\s*¥([\d,]+)/);

    if (amountMatch) {
      const amount = parseInt(amountMatch[1].replace(/,/g, ''), 10);
      totalAmount += amount;
    }

    if (gensenMatch) {
      const gensen = parseInt(gensenMatch[1].replace(/,/g, ''), 10);
      totalGensen += gensen;
    }

    totalPeople += 1;
  });

  document.getElementById('summaryTotalPeople').innerText = `${totalPeople}人`;
  document.getElementById('summaryTotalAmount').innerText = `¥${totalAmount.toLocaleString()}`;
  document.getElementById('summaryTotalTax').innerText = `¥${totalGensen.toLocaleString()}`;

  // カンマ付きでセット
  document.getElementById('femaleSalary').value = totalAmount.toLocaleString();
  document.getElementById('femaleTax').value = totalGensen.toLocaleString();
}


function toggleDetails(button) {
  const container = button.nextElementSibling.nextElementSibling; 
  // ボタンのすぐ次のボタンの次のdiv（details-html-container）を取得
  if (container.style.display === 'none' || container.style.display === '') {
    container.style.display = 'block';
    button.textContent = '詳細を隠す';
  } else {
    container.style.display = 'none';
    button.textContent = '詳細を表示';
  }
}

function calculateBack() {
  const values = {
    f: 1500,
    f2: 2000,
    jounai: 1000,
    honshiri: 0,
    douhan: 1500,
    eda: 500,
    help: -1500,
    set40: 5500,
    set20: 3500,
    vip: 2000,
    a: 500,
    b: 1000,
    c: 1500,
    d: 2000,
    e: 2500
  };

  const inputs = {
    f: document.getElementById("f"),
    f2: document.getElementById("f2"),
    jounai: document.getElementById("jounai"),
    honshiri: document.getElementById("honshiri"),
    douhan: document.getElementById("douhan"),
    eda: document.getElementById("eda"),
    help: document.getElementById("help"),
    set40: document.getElementById("set40"),
    set20: document.getElementById("set20"),
    vip: document.getElementById("vip"),
    a: document.getElementById("a"),
    b: document.getElementById("b"),
    c: document.getElementById("c"),
    d: document.getElementById("d"),
    e: document.getElementById("e")
  };

  let total = 0;
  let detailLines = [];

  Object.keys(values).forEach(key => {
    const count = parseInt(inputs[key]?.value || 0);
    if (count > 0) {
      const unitPrice = values[key];
      const itemTotal = count * unitPrice;
      total += itemTotal;

      const sign = unitPrice < 0 ? "-" : "";
      detailLines.push(`${key.toUpperCase()} ×${count}（¥${Math.abs(unitPrice).toLocaleString()}）= ${sign}¥${Math.abs(itemTotal).toLocaleString()}`);
    }
  });

  document.getElementById("total").textContent = "¥" + total.toLocaleString();
  document.getElementById("detail").value = detailLines.join("\n");
}


function restoreCheckboxes() {
  const checkboxStates = JSON.parse(localStorage.getItem('checkboxes')) || {};
  document.getElementById('experienceAndRental').checked = checkboxStates.experienceAndRental || false;
}


document.addEventListener('DOMContentLoaded', () => {
  const exp = document.getElementById('experienceAndRental');
  if (exp) {
    exp.addEventListener('change', function () {
      if (this.checked) {
        const confirmed = confirm('「体験及び貸出」にチェックが入りました。');
        if (!confirmed) this.checked = false;
      }
    });
  }
});

// 統一された初期化処理
document.addEventListener('DOMContentLoaded', () => {

  // APP2
  loadBottleForms();
  restoreCheckboxes();
  restoreInputs(); 

  // APP1
  restoreForm();
  restoreCheckboxStates();
  document.querySelectorAll("table input[type='checkbox']").forEach(cb => {
    cb.addEventListener("change", saveCheckboxStates);
  });

  // APP3
  restoreApp3Data();
  attachApp3Listeners();

  // 顧問料自動反映
  observeTotalCountForAdviserFee(); // ←これを追加

  attachCommaFormatApp1and3();

    const historyList = document.getElementById('historyList');
  if (historyList) {
    historyList.innerHTML = localStorage.getItem('historyList') || '';
  }

  updateSummary();
  updateCalculations(); // 初期計算
  attachCommaFormatApp3();
  refreshBottleDropdownsFromHistory();
});

function restoreInputs() {
  const inputValues = JSON.parse(localStorage.getItem('inputs') || '{}');
  Object.entries(inputValues).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  });
}

// --- app2フォームの十字キー移動 ---
// #app2内でのみ有効
(function(){
  // 移動対象input,selectの共通セレクタ（動的増減対応）
  function getApp2Fields() {
    // app2内のフォーム全体（bottle-form含む）
    return Array.from(document.querySelectorAll(
      '#app2 section#app2-inputSection input:not([type=hidden]):not([disabled]), ' +
      '#app2 section#app2-inputSection select:not([disabled])'
    )).filter(el => el.offsetParent !== null); // 表示のみ
  }

  document.addEventListener('keydown', function(e) {
    // app2以外は無視
    if (!document.getElementById('app2').classList.contains('active')) return;

    // 矢印以外は無視
    if (!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) return;

    const target = e.target;
    // 対象がapp2内のinputかselectか
    if (!target.closest('#app2')) return;
    if (!['INPUT','SELECT'].includes(target.tagName)) return;

    // input/textareaの左右はカーソル移動優先
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && (target.selectionStart !== target.selectionEnd)) {
      // 入力値内でのキャレット移動を優先させる
      if ((e.key === 'ArrowLeft' && target.selectionStart > 0) ||
          (e.key === 'ArrowRight' && target.selectionStart < target.value.length)) {
        return; // 何もしない
      }
    }

    // ここでフォーム群取得
    const fields = getApp2Fields();
    const idx = fields.indexOf(target);
    if (idx === -1) return;

    // 配置を2次元配列化
    const fieldMap = [];
    let lastTop = null, row = [];
    fields.forEach(f=>{
      const top = f.getBoundingClientRect().top;
      if (lastTop !== null && Math.abs(top-lastTop) > 8) {
        fieldMap.push(row);
        row = [];
      }
      row.push(f);
      lastTop = top;
    });
    if (row.length) fieldMap.push(row);

    // 現在位置を特定
    let rowIdx = -1, colIdx = -1;
    fieldMap.forEach((row,i)=>{
      const j = row.indexOf(target);
      if(j>=0){ rowIdx=i; colIdx=j; }
    });
    if(rowIdx===-1||colIdx===-1) return;

    // 移動先を決定
    let next;
    if(e.key==='ArrowLeft'){
      next = fieldMap[rowIdx][colIdx-1];
    }
    if(e.key==='ArrowRight'){
      next = fieldMap[rowIdx][colIdx+1];
    }
    if(e.key==='ArrowUp'){
      for(let up=rowIdx-1;up>=0;up--){
        if(fieldMap[up][colIdx]){ next=fieldMap[up][colIdx]; break;}
      }
    }
    if(e.key==='ArrowDown'){
      for(let dn=rowIdx+1;dn<fieldMap.length;dn++){
        if(fieldMap[dn][colIdx]){ next=fieldMap[dn][colIdx]; break;}
      }
    }

    if(next){
      e.preventDefault();
      next.focus();
      if(typeof next.select==='function') next.select();
    }
  });
})();













































//<app3 script----------------------------------------------------------------------------------------------------------------->
    function formatNumber(num) {
    return num.toLocaleString('ja-JP');
    }

function get(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  const raw = String(el.value || '').replace(/,/g, '');
  const n = parseInt(raw, 10);
  return isNaN(n) ? 0 : n;
}

// ============================================================
// 履歴(#historyList)から店舗負担分の合計を算出
// 事前に LI に data-store-covered を付けていなくても、
// テキスト "店舗負担: ¥xxxx" からフォールバックで拾います。
// ============================================================
function getTotalStoreBurden() {
  try {
    const items = document.querySelectorAll('#historyList > li');
    let total = 0;
    items.forEach(li => {
      // 1) data属性があれば最優先
      const attr = li.getAttribute('data-store-covered');
      if (attr !== null && attr !== '') {
        const v = parseInt(attr, 10);
        if (!Number.isNaN(v)) { total += v; return; }
      }
      // 2) sendoff 行のテキストから拾う
      const txt = li.querySelector('.sendoff')?.textContent || '';
      const m = txt.match(/店舗負担:\s*¥?\s*([\d,]+)/);
      if (m) {
        const v = parseInt(m[1].replace(/,/g, ''), 10);
        if (!Number.isNaN(v)) total += v;
      }
    });
    return total;
  } catch (e) {
    console.warn('店舗負担合計の取得に失敗', e);
    return 0;
  }
}

function updateCalculations() {
  const cardTotalText = document.getElementById('cardTotal')?.textContent || '0';
  const cardTotal = parseInt(cardTotalText.replace(/,/g, ''), 10) || 0;

  const cardSalesInput = document.getElementById('cardSales');
  if (cardSalesInput) cardSalesInput.value = formatNumber(cardTotal);

  const summaryTaxText = document.getElementById('summaryTotalTax')?.innerText || '¥0';
  const summaryTaxValue = parseInt(summaryTaxText.replace(/[¥,]/g, ''), 10) || 0;
  const femaleTaxEl0 = document.getElementById('femaleTax');
  if (femaleTaxEl0) femaleTaxEl0.value = summaryTaxValue;

  // totalBackAmount → catchBack へ
  const totalBackAmountText =
    document.getElementById("totalBackAmount")?.textContent?.replace(/,/g, "") || "0";
  const totalBackAmount = parseInt(totalBackAmountText, 10) || 0;
  const catchBackEl = document.getElementById("catchBack");
  if (catchBackEl) catchBackEl.value = totalBackAmount.toLocaleString();

  const total = get('totalSales');
  const card = get('cardSales');
  const cash = total - card;
  const cashSalesEl = document.getElementById('cashSales');
  if (cashSalesEl) cashSalesEl.value = formatNumber(cash);

  const tax = get('femaleTax') + get('maleTax');
  const totalTaxEl = document.getElementById('totalTax');
  if (totalTaxEl) totalTaxEl.value = formatNumber(tax);

  const receiptTotal =
    get('receipt1') + get('receipt2') + get('receipt3') + get('receipt4') + get('receipt5');
  const r6 = document.getElementById('receipt6');
  if (r6) r6.value = formatNumber(receiptTotal);

  const expenses = get('alcohol') + receiptTotal;
  const totalExpEl = document.getElementById('totalExpenses');
  if (totalExpEl) totalExpEl.value = formatNumber(expenses);

  // === ここから追加：人件費合計 ===
  const labor =
    get('femaleSalary') +
    get('maleSalary') +
    get('catchBack') +
    get('scoutBack') +
    get('adviserFee') +
    get('driverFee');

  const totalLaborEl = document.getElementById('totalLaborCosts');
  if (totalLaborEl) totalLaborEl.value = formatNumber(labor);
  // ===============================

  const gross = total - labor - tax - expenses;
  const grossEl = document.getElementById('grossProfit');
  if (grossEl) grossEl.value = formatNumber(gross);

  const remaining = gross - card;
  const remainingEl = document.getElementById('remainingCash');
  if (remainingEl) remainingEl.value = formatNumber(remaining);

  const startCash = get('startCash');
  const finalCash = get('finalCash');
  const extraSafeCash = get('extraSafeCash');
  const difference = (finalCash - remaining - tax) - (startCash + extraSafeCash);
  const diffEl = document.getElementById('cashDifference');
  if (diffEl) diffEl.value = formatNumber(difference);

  // adviserFee 自動計算
  const adviserCountEl = document.getElementById('totalCountValue');
  const adviserFeeInput = document.getElementById('adviserFee');
  if (adviserCountEl && adviserFeeInput) {
    const count = parseInt(adviserCountEl.textContent.replace(/,/g, ''), 10) || 0;
    adviserFeeInput.value = (count * 1000).toLocaleString();
  }

  // 見た目用フォーマット
  const femaleSalaryEl = document.getElementById('femaleSalary');
  if (femaleSalaryEl) femaleSalaryEl.value = formatNumber(get('femaleSalary'));
  const femaleTaxEl = document.getElementById('femaleTax');
  if (femaleTaxEl) femaleTaxEl.value = formatNumber(get('femaleTax'));

  updateNegativeColor('grossProfit');
  updateNegativeColor('remainingCash');
  updateNegativeColor('cashDifference');

  updateExtraGroupFields();
  attachCommaFormatApp3();

  // ドライバー代
  (function(){
    const el = document.getElementById('driverExtra1');
    if (el) {
      const storeTotal = getTotalStoreBurden();
      el.value = Number.isNaN(storeTotal) ? '' : storeTotal.toLocaleString('ja-JP');
    }
  })();

  (function(){
    const extra1 = parseInt(document.getElementById('driverExtra1')?.value.replace(/[^0-9\-]/g, '') || 0, 10);
    const extra2 = parseInt(document.getElementById('driverExtra2')?.value.replace(/[^0-9\-]/g, '') || 0, 10);
    const sum = extra1 + extra2;
    const feeEl = document.getElementById('driverFee');
    if (feeEl) feeEl.value = Number.isNaN(sum) ? '' : sum.toLocaleString('ja-JP');
  })();

  saveToLocal();
}

function updateExtraGroupFields() {
  // それぞれの値を取得（必要に応じて変数は他から渡してください）
  let grossProfit = get('grossProfit');         // 粗利益
  let cardSales = get('cardSales');             // カード売上
  let remainingCash = get('remainingCash');     // 現金残
  let totalTax = get('totalTax');               // 源泉費合計

  // 合計計算：現金残 + 源泉費
  let totalGrossPlusTax = remainingCash + totalTax;

  // 各フィールドに値を表示（存在確認しながら安全に代入）
  let el;

  el = document.getElementById('grossProfit_extra');
  if (el) el.value = formatNumber(grossProfit);

  el = document.getElementById('cardSales_extra');
  if (el) el.value = formatNumber(cardSales);

  el = document.getElementById('remainingCash_extra');
  if (el) el.value = formatNumber(remainingCash);

  el = document.getElementById('totalWithholdingTax');
  if (el) el.value = formatNumber(totalTax);

  el = document.getElementById('totalGrossPlusTax');
  if (el) el.value = formatNumber(totalGrossPlusTax);
}


function updateNegativeColor(id) {
  const el = document.getElementById(id);
  if (!el) return; // 無ければ何もしない
  const v = parseInt((el.value || '0').replace(/,/g, ''), 10) || 0;
  el.classList.toggle('negative', v < 0);
}

function saveToLocal() {
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    // disabled 状態でも保存
    localStorage.setItem(input.id, input.value);
  });
}

function loadFromLocal() {
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    const saved = localStorage.getItem(input.id);
    if (saved !== null) input.value = saved;
  });
}


//業務内容を保存
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const todayStr = today.toISOString().slice(0, 10); // "YYYY-MM-DD"

  if (!localStorage.getItem("workStartDate")) {
    localStorage.setItem("workStartDate", todayStr);
  }
});

function saveApp3Data() {
  const fields = [
    'startCash', 'maleSalary', 'scoutBack', 'driverFee', 'maleTax',
    'alcohol', 'receipt1', 'receipt2', 'receipt3', 'receipt4', 'receipt5', 'finalCash'
  ];
  const data = {};
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
  localStorage.setItem('app3_inputs', JSON.stringify(data));
}

function restoreApp3Data() {
  const saved = localStorage.getItem('app3_inputs');
  if (!saved) return;
  const data = JSON.parse(saved);
  Object.entries(data).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  });
  updateCalculations(); // 計算更新
  attachCommaFormatApp1and3();
}

function attachApp3Listeners() {
  const fields = [
    'startCash', 'maleSalary', 'scoutBack', 'driverFee', 'maleTax',
    'alcohol', 'receipt1', 'receipt2', 'receipt3', 'receipt4', 'receipt5', 'finalCash'
  ];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', saveApp3Data);
    }
  });
}




function getCustomFileName() {
  // JSTに補正（サーバーUTCなら+9）
  const now = new Date();
  now.setHours(now.getHours() + 9);

  let fileDate = new Date(now);
  const hour = now.getHours();
  if (hour < 20) {
    fileDate.setDate(fileDate.getDate() - 1);
  }
  const y = fileDate.getFullYear();
  const m = String(fileDate.getMonth() + 1).padStart(2, '0');
  const d = String(fileDate.getDate()).padStart(2, '0');

  return `IBASD_${y}-${m}-${d}`;
}




// =========================
// 共通リセット関数
// =========================

// 特定アプリ(app1, app2, app3)をリセット
function resetApp(appId, full = false) {
  if (!confirm(full 
    ? "本当に完全クリアしますか？（履歴・保存データも削除）" 
    : "入力をクリアしますか？"
  )) return;

  if (appId === 'app1') {
    resetApp1(full);
  } else if (appId === 'app2') {          // ← これを追加
    resetApp2(full);
  } else if (appId === 'app3') {
    resetApp3(full);
  }

  window.scrollTo({ top: 0, behavior: 'smooth' });

}

function resetAllApps() {
  if (!confirm("app1〜app3のデータを全て削除しますか？")) return;

  const overlay = document.getElementById('resetOverlay');
  const canvas = document.getElementById('matrixCanvas');
  const flash = document.getElementById('resetFlash');
  overlay.style.display = 'flex';
  setTimeout(() => overlay.classList.add('active'), 20);

  startMatrixEffect(canvas);

  setTimeout(() => {
    flash.style.opacity = 1;
    setTimeout(() => {
      resetApp1(true);
      resetApp2(true);
      resetApp3(true);
      showApp('app1');
      window.scrollTo({top: 0, behavior: 'auto'});
      try { localStorage.removeItem('appScrollMap'); } catch(e) {}
      if (window.clearTabScrollMemory) window.clearTabScrollMemory();

      // ★ ここで全部一気に消す
      setTimeout(() => {
        flash.style.opacity = 0;
        stopMatrixEffect();
        overlay.classList.remove('active');
        overlay.style.display = 'none';
      }, 520); // flashフェードアウト分
    }, 400);  // 発光持続
  }, 1600);   // マトリックス演出

// ページ全体を最上段へ
window.scrollTo({ top: 0, behavior: 'auto' });

// contentWrapper のスクロールもリセット
const wrapper = document.getElementById("contentWrapper");
if (wrapper) wrapper.scrollTop = 0;

// APP1をアクティブに切替
document.body.setAttribute("data-active-app", "app1");

// コンテンツ切替
document.querySelectorAll(".content").forEach(el => el.classList.remove("active"));
document.getElementById("app1").classList.add("active");

// タブ切替
document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
document.querySelector('.tab[data-target="app1"]').classList.add("active");

}





// =========================
// app1用リセット
// =========================
function resetApp1(full) {
  const formRows = document.getElementById("formRows");
  if (!formRows) return;

  // 1行だけ残して削除
  while (formRows.rows.length > 1) formRows.deleteRow(1);

  // 最初の行の初期化
  formRows.querySelectorAll("input, select").forEach(el => el.value = '');
  document.querySelectorAll("table input[type='checkbox']").forEach(cb => cb.checked = false);

  // 合計リセット
document.getElementById("totalCustomers").textContent = "0";
document.getElementById("cashTotal").textContent = "0";
document.getElementById("cardTotal").textContent = "0";
document.getElementById("totalAmount").textContent = "0";
document.getElementById("totalCountCell").innerHTML =
  '<button type="button" class="print-mini" onclick="printEnvelopeApp1(\'ALL\')">出力</button>' +
  '<span id="totalCountValue" class="count-value">0</span>';
document.getElementById("totalBackAmount").textContent = "0";

  // カテゴリ別もリセット
  const categories = ["UK", "K", "AB", "LA", "PA", "BB", "MS", "GM", "B", "JOE", "KOSE", "HE", "PB", "X", "Z"];
  categories.forEach(cat => {
    document.getElementById(`${cat}count`).textContent = "0";
    document.getElementById(`${cat}total`).textContent = "0";
  });

  rowNumber = 2;
  updateTotals();

  if (full) {
    localStorage.removeItem("formData");
    localStorage.removeItem("checkboxStates");
  }
}


// =========================
// app2用リセット
// =========================
function resetApp2(full) {
  // === 通常フォームのクリア =========================================
  document.querySelectorAll('#app2 input[type="text"], #app2 input[type="number"]').forEach(el => el.value = '');
  const exp = document.getElementById('experienceAndRental');
  if (exp) exp.checked = false;
  const result = document.getElementById('result');
  if (result) result.innerHTML = '';
  const bottleForms = document.getElementById('bottleFormsContainer');
  if (bottleForms) bottleForms.innerHTML = '';

  // === 一括入力フォームのクリア（内包） ===============================
  (function clearBulkInputForm() {
    const grid = document.getElementById('bulkGrid');
    if (!grid) return;

    grid.querySelectorAll('.bulk-name, .bulk-send, .bulk-num').forEach(el => el.value = '');
    grid.querySelectorAll('.bulk-exp').forEach(el => (el.checked = false));
    grid.querySelectorAll('.btl-subrow').forEach(tr => tr.remove());
    grid.querySelectorAll('tr.bulk-mainrow').forEach(row => {
      row.dataset.bottleCount = '0';
      const minusBtn = row.querySelector('.btl-minus');
      if (minusBtn) minusBtn.setAttribute('disabled', 'true');
    });
  })();

  // === 完全クリア時（履歴/保存データも削除） =========================
  if (full) {
    const historyList = document.getElementById('historyList');
    if (historyList) historyList.innerHTML = '';

    // 通常フォーム関連ローカルデータ削除
    localStorage.removeItem('inputs');
    localStorage.removeItem('historyList');
    localStorage.removeItem('result');
    localStorage.removeItem('bottleForms');

    // ✅ 一括入力グリッド関連も削除
    localStorage.removeItem('app2_bulkGridData');
    localStorage.removeItem('app2_bulkPanelVisible');

    // グリッド本体もクリア
    const grid = document.getElementById('bulkGrid');
    if (grid) grid.querySelector('tbody')?.replaceChildren();

    if (typeof updateSummary === 'function') updateSummary();

    const countEl = document.getElementById('historyIndexCount');
    if (countEl) countEl.textContent = '0人';
    if (typeof window.createHistoryIndex === 'function') window.createHistoryIndex();
  }
}


// =========================
// app3用リセット
// =========================
function resetApp3(full) {
  document.querySelectorAll('#app3 input').forEach(el => {
    if (el.type !== 'button') el.value = '';
  });
  updateCalculations();

  if (full) {
    localStorage.removeItem('app3_inputs');
    localStorage.removeItem('app3_result');

    // ✅ 一括入力グリッド関連も完全に消去
    localStorage.removeItem('app2_bulkGridData');
    localStorage.removeItem('app2_bulkPanelVisible');

    // グリッド本体も空にする
    const grid = document.getElementById('bulkGrid');
    if (grid) grid.querySelector('tbody')?.replaceChildren();
  }

  attachCommaFormatApp1and3();
}

function clearApp2Inputs() {
  resetApp2(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById('side-clear')?.addEventListener('click', clearApp2Inputs);

function addComma(numStr) {
  if (!numStr) return '';
  // 数字とマイナス以外は除去
  let val = numStr.replace(/[^\d\-]/g, '');
  val = val.replace(/(?!^)-/g, '');
  if (val === '' || val === '-') return val;
  return parseInt(val, 10).toLocaleString('ja-JP');
}

// app1/app3内だけカンマ付与
function attachCommaFormatApp1and3() {
  // app1対象
  document.querySelectorAll(
    '#app1 input.amount, #app1 input.num, #app1 input.card, #app1 input.total, #app1 input.honshi, #app1 input.table-number'
  ).forEach(input => {
    if (input._commaFormatApplied) return;
    input._commaFormatApplied = true;

    input.addEventListener('input', function () {
      let val = this.value.replace(/,/g, '');
      if (val === '' || !/^-?\d*$/.test(val)) {
        this.value = '';
        return;
      }
      this.value = addComma(val);
    });
    input.addEventListener('focus', function () {
      this.value = this.value.replace(/,/g, '');
    });
    input.addEventListener('blur', function () {
      this.value = addComma(this.value);
    });
    // 初期値にも即時カンマ
    if (input.value) input.value = addComma(input.value);
  });

  // app3対象（#app3直下でinput[type="text"]の全部/disabled除外）
  document.querySelectorAll('#app3 input[type="text"]:not([disabled])')
    .forEach(input => {
      if (input._commaFormatApplied) return;
      input._commaFormatApplied = true;

      input.addEventListener('input', function () {
        let val = this.value.replace(/,/g, '');
        if (val === '' || !/^-?\d*$/.test(val)) {
          this.value = '';
          return;
        }
        this.value = addComma(val);
      });
      input.addEventListener('focus', function () {
        this.value = this.value.replace(/,/g, '');
      });
      input.addEventListener('blur', function () {
        this.value = addComma(this.value);
      });
      if (input.value) input.value = addComma(input.value);
    });
}

function attachCommaFormatApp3() {
  document.querySelectorAll(
    '#app3 input[type="text"], #app3 input[type="number"]'
  ).forEach(input => {
    if (input._commaFormatApplied) return;
    input._commaFormatApplied = true;

    input.addEventListener('input', function () {
      let val = this.value.replace(/,/g, '');
      if (val === '' || !/^-?\d*$/.test(val)) {
        this.value = '';
        return;
      }
      this.value = addComma(val);
    });

    input.addEventListener('focus', function () {
      this.value = this.value.replace(/,/g, '');
    });

    input.addEventListener('blur', function () {
      this.value = addComma(this.value);
    });
  });
}

// --- マトリックス風エフェクト ---
let matrixInterval, matrixStopFlag = false;

function startMatrixEffect(canvas) {
  const ctx = canvas.getContext('2d');
  let W = window.innerWidth;
  let H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
  let fontSize = 18;  // 少し小さく密度を増やす
  let columns = Math.floor(W / fontSize) + 2;
  let drops = [];
  for (let i = 0; i < columns; i++) drops[i] = Math.random() * H / fontSize;

  // 文字セット（カタカナ・ひらがな・英数大文字・英数小文字・数字）
  const chars = [
    ..."アイウエオカキクケコサシスセソタチツテトナニヌネノマミムメモヤユヨラリルレロワヲン",
    ..."あいうえおかきくけこさしすせそたちつてとなにぬねのまみむめもやゆよらりるれろわをん",
    ..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
  ];

  matrixStopFlag = false;

  function draw() {
    ctx.fillStyle = 'rgba(25,30,44,0.23)';
    ctx.fillRect(0, 0, W, H);

    ctx.font = fontSize + "px monospace";
    ctx.fillStyle = "#47f7ff";
    // 列ごとに複数行ドロップして密度UP
    for (let i = 0; i < columns; i++) {
      for (let d = 0; d < 2; d++) { // 1列あたり2個
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * fontSize, (drops[i] - d) * fontSize);
      }
      if (Math.random() > 0.975) drops[i] = 0;
      drops[i] += Math.random() * 1.3 + 0.7; // 速さランダム
    }
    if (!matrixStopFlag) matrixInterval = requestAnimationFrame(draw);
  }

  draw();
}

function stopMatrixEffect() {
  matrixStopFlag = true;
  if (matrixInterval) cancelAnimationFrame(matrixInterval);
  const canvas = document.getElementById('matrixCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

/* === CB表を [チェック][カテゴリ][本数][金額] に変換 === */
document.addEventListener('DOMContentLoaded', () => {
  const table = document.querySelector('#categorySection table');
  if (!table) return;

  /* ヘッダを差し替え */
  const thRow = table.querySelector('thead tr');
  if (thRow) thRow.innerHTML = '<th></th><th>カテゴリ</th><th>本数</th><th>金額</th>';

  /* 各行を4列化（1列目の「チェック＋カテゴリ名」を分離） */
  table.querySelectorAll('tbody tr').forEach(tr => {
    // すでに4列ならスキップ
    if (tr.children.length >= 4) return;

    const firstTd = tr.children[0];
    if (!firstTd) return;

    const isTotal = /合計/.test(firstTd.textContent);

    if (isTotal) {
      // 合計行はチェック列を空、カテゴリ列に「合計」
      const blank = document.createElement('td');          // [チェック]
      tr.insertBefore(blank, firstTd);                     // 先頭に空列を追加
      const catTd = document.createElement('td');          // [カテゴリ]
      catTd.innerHTML = firstTd.innerHTML;                 // 「合計」
      tr.replaceChild(catTd, firstTd);
      return;
    }

    // 通常行：チェックとカテゴリ名を分離
    const cb = firstTd.querySelector('input[type="checkbox"]');
    const nameText = firstTd.textContent.replace(/\s+/g, ' ').trim();

    // 先頭セルはチェックボックスだけに
    firstTd.innerHTML = '';
    if (cb) firstTd.appendChild(cb);

    // チェックの次に「カテゴリ名」セルを挿入
    const catTd = document.createElement('td');
    catTd.textContent = nameText; // 例：UK
    tr.insertBefore(catTd, tr.children[1]);
  });
 });



// 計算ボタン
document.getElementById('side-calc')?.addEventListener('click', () => {
  confirmAndCalculate(new Event('submit'));
});

/* ========= タブ切替：堅牢版（競合に強い） ================================================================================== */
/* ========= タブ切替 + 各APPのスクロール記憶 =============================================================================== */
(function () {
  const tabsRoot = document.querySelector('.tabs');
  if (!tabsRoot) return;

  const pagesById = new Map(['app1','app2','app3'].map(id => [id, document.getElementById(id)]));

  const SCROLL_KEY = 'appScrollMap';
  const loadMap = () => { try { return JSON.parse(localStorage.getItem(SCROLL_KEY)) || {}; } catch(_) { return {}; } };
  const saveMap = (m) => { try { localStorage.setItem(SCROLL_KEY, JSON.stringify(m)); } catch(_) {} };
  let scrollMap = loadMap();

  const getY = () => window.pageYOffset || document.documentElement.scrollTop || 0;
  const restoreY = (id) => {
    const y = Number(scrollMap[id] ?? 0);
    // レイアウト確定後に復帰
    requestAnimationFrame(() => window.scrollTo({ top: y, behavior: 'auto' }));
  };

  // スクロールのたびに「現在のAPP」の位置を保存（rAFスロットル）
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      ticking = false;
      const id = document.body.getAttribute('data-active-app');
      if (!id) return;
      scrollMap[id] = getY();
      saveMap(scrollMap);
    });
  }, { passive: true });

  function apply(targetId) {
    // 切替前に現在の位置を保存
    const prevId = document.body.getAttribute('data-active-app');
    if (prevId) {
      scrollMap[prevId] = getY();
      saveMap(scrollMap);
    }

    // ページ表示/非表示
    pagesById.forEach((el, id) => {
      const on = id === targetId;
      if (!el) return;
      el.style.display = on ? '' : 'none';
      el.classList.toggle('active', on);
      el.toggleAttribute('hidden', !on);
    });

    // タブの見た目/ARIA
    tabsRoot.querySelectorAll('.tab').forEach(t => {
      const on = t.dataset.target === targetId;
      t.classList.toggle('active', on);
      t.setAttribute('aria-selected', on ? 'true' : 'false');
      if (!t.hasAttribute('tabindex')) t.setAttribute('tabindex', on ? '0' : '-1');
      t.setAttribute('role', 'tab');
    });

    document.body.setAttribute('data-active-app', targetId);
    try { localStorage.setItem('selectedTab', targetId); } catch (e) {}

    // そのAPPの以前の位置へ復帰
    restoreY(targetId);
  }

  // 外からも呼べるように
  window.showApp = apply;

  // スクロール記憶を完全クリア（ローカル/メモリ両方）
window.clearTabScrollMemory = () => {
  scrollMap = {};
  saveMap(scrollMap);
};

  // クリック＆Enter/Spaceでタブ切替
  tabsRoot.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab || !tabsRoot.contains(tab)) return;
    const id = tab.dataset.target;
    if (id) apply(id);
  });

  tabsRoot.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const tab = e.target.closest('.tab');
    if (!tab) return;
    e.preventDefault();
    const id = tab.dataset.target;
    if (id) apply(id);
  });

  // 初期表示（保存 > 既存active > 先頭 > app1）
  const saved = localStorage.getItem('selectedTab');
  const fallbackTab = tabsRoot.querySelector('.tab.active') || tabsRoot.querySelector('.tab');
  const fallback = fallbackTab?.dataset.target || 'app1';
  apply(saved || fallback);

  // ページ離脱時の保険
  window.addEventListener('beforeunload', () => {
    const id = document.body.getAttribute('data-active-app');
    if (!id) return;
    scrollMap[id] = getY();
    saveMap(scrollMap);
  });
})();







// APP3保存と封筒印刷で共通利用する日付文字列生成関数
function getApp3StyleDate() {
  const d = new Date();
  // 5時より前なら前日扱い
  if (d.getHours() < 5) {
    d.setDate(d.getDate() - 1);
  }
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}/${m}/${day}`;
}


/* =========================================================
   APP1 だけで使うもの（顧問料：ALL／個別の封筒印刷）
   使い方：
     - 顧問料まとめ封筒 … printEnvelopeApp1('ALL')
     - カテゴリ封筒     … printEnvelopeApp1('UK') など
     - #resultをそのまま印刷 … preparePrintApp1()
========================================================= */

/* =========================================================
   APP1 印刷（安定版・全面作り直し）
   - preparePrintApp1: #result をそのまま印刷
   - printEnvelopeApp1:
       * 'ALL' → カテゴリごとの本数合計＋総人数＋金額
       * その他 → 従来の明細（単価×本数）＋Total
   - openPrintApp1: 90×205mm 封筒レイアウト、確実にプレビュー→元画面復帰
========================================================= */

(function(){
  const YEN = (v)=> Number(v||0).toLocaleString('ja-JP');

  // #result をそのまま印刷（既存互換）
  window.preparePrintApp1 = function () {
    const html = (document.getElementById('result')?.innerHTML || '').trim();
    if (!html) { alert('印刷する内容がありません。'); return; }

    const printCSS = `
      <style>
        @media print {
          @page { size: 90mm 205mm; margin: 0; }
          html, body {
            margin: 0; padding: 0; background: #fff;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
          }
          #result {
            width: 90mm !important; max-height: 205mm !important;
            margin: 0 auto !important; padding: 8mm 6mm !important;
            box-sizing: border-box; font-size: 10.5pt; line-height: 1.25;
          }
          #result, .envelope {
            page-break-before: avoid;
            page-break-after: avoid;
            page-break-inside: avoid;
          }
        }
      </style>`;

    openPrintApp1(printCSS + `<div id="result">${html}</div>`, { rotateOnMobile: true });
  };

  // 封筒印刷（ALL or 個別カテゴリ）
  window.printEnvelopeApp1 = function (category) {
    const dateStr = (typeof getApp3StyleDate === 'function')
      ? getApp3StyleDate()
      : (() => {
          const d = new Date();
          return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
        })();

    if (category === 'ALL') {
      if (!confirm('伝票の記入はすべて完了していますか？')) return;

      const CATS = ['UK','K','AB','LA','PA','BB','MS','GM','B','JOE','KOSE','HE','PB','X'];

      const perCat = CATS.map(key => {
        const arr = (window.catchbackDetails && window.catchbackDetails[key]) || [];
        const total = arr.reduce((s, d) => {
          const n = parseInt(String(d?.count ?? 0).replace(/,/g,''), 10);
          return s + (isNaN(n) ? 0 : n);
        }, 0);
        return { key, total };
      });

      const shown = perCat.filter(x => x.total > 0);
      const list  = shown.length ? shown : perCat;

      const grand  = list.reduce((s, x) => s + x.total, 0);
      const amount = grand * 1000;

      // openPrintApp1 は行テキストを再構成するので 1行ずつ渡す
      const lines = list.map(x => `${x.key} (計${x.total})`).join('\n');

      const innerAll = `
        <div class="envelope">
          <div class="print-date">${dateStr}</div>
          <div class="print-title">顧問料</div>
          <div style="text-align:center; font-size:26pt; margin:2mm 0 3mm;">￥${YEN(amount)}</div>
          <div style="text-align:center; font-size:14pt; margin-bottom:4mm;">（人数: ${grand}）</div>
          ${lines}
          <div style="text-align:center; font-size:14pt; margin-top:4mm;">Total ${grand}</div>
        </div>`;

      openPrintApp1(innerAll, { rotateOnMobile:true });
      return;
    }

    // 個別カテゴリ
    const arr = (window.catchbackDetails && window.catchbackDetails[category]) || [];
    const rows = arr.map(d =>
      `<div class="print-detail-row"><span>${d.unit}</span><span>×</span><span>${d.count}</span></div>`
    ).join('');

    const total = arr.reduce((s,d)=> s + Number(d.count||0), 0);
    const amountText = (document.getElementById(category + 'total')?.textContent || '0').trim();

    const innerCat = `
      <div class="envelope">
        <div class="print-date">${dateStr}</div>
        <div class="print-title">${category}</div>
        <div style="text-align:center; font-size:22pt; margin:5mm 0 6mm;">￥${amountText}</div>
        ${rows || '<div style="text-align:center;">0</div>'}
        <div style="text-align:center; font-size:12pt; margin-top:4mm;">Total ${total}</div>
      </div>`;

    openPrintApp1(innerCat, { rotateOnMobile:true });
  };

  // コア：印刷ウィンドウ生成・整形・復帰制御
  function openPrintApp1(innerHTML, opts = { rotateOnMobile:true }) {
    // ---- 行テキスト化して3行パターンを再構成 ----
    const tmpEl = document.createElement('div');
    tmpEl.innerHTML = innerHTML;
    const lines = (tmpEl.innerText.trim().split(/\r?\n/)).map(s => s.trim());

    let rebuilt = "";
    for (let i = 0; i < lines.length; i++) {
      const a = lines[i] || "";
      const b = lines[i + 1] || "";
      const c = lines[i + 2] || "";

      if (/^[A-Z]{1,6}$/.test(a) &&
          (/^\d{1,3}(?:,\d{3})*(?:\s*×\s*\d+)?$|^\d+$/.test(b)) &&
          c.includes("計")) {
        rebuilt += `
          <div class="cat-line">
            <span class="cat">${a}</span>
            <span class="val">${b}</span>
            <span class="cnt">${c}</span>
          </div>`;
        i += 2;
      } else if (a === "") {
        rebuilt += `<div class="group-sep"></div>`;
      } else {
        rebuilt += `<div class="misc">${a}</div>`;
      }
    }

    // ---- 子ウィンドウ生成（毎回ユニーク名）----
    const isSP = /iPhone|iPod|Android.*Mobile/i.test(navigator.userAgent);
    const winName = "app1print_" + Date.now();
    const w = window.open("", winName);
    if (!w) { alert("ポップアップがブロックされました。許可してください。"); return; }

    const doc = w.document;
    doc.open();
    doc.write(`
      <!doctype html>
      <html lang="ja">
      <head>
        <meta charset="utf-8">
        <title>APP1 出力</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          @page { size: 90mm 205mm; margin: 0; }
          html, body {
            margin: 0; padding: 0; background: #fff;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
          }
          #page {
            width: 90mm; height: 205mm;
            padding: 8mm 6mm; box-sizing: border-box;
            font-size: 11pt; line-height: 1.3;
          }
          .rotate180 #page { transform: rotate(180deg); transform-origin: 50% 50%; }
          .cat-line {
            display: grid; grid-template-columns: 3.2em 6em auto;
            column-gap: 8px; align-items: baseline;
          }
          .cat-line .cat { font-weight: 700; }
          .cat-line .val, .cat-line .cnt { text-align: right; }
          .cat-line .cnt { opacity: .9; }
          .group-sep { height: 0.8em; }
          .misc { margin: 2px 0; }
          #__app1Back {
            position: fixed; right: 8px; top: 8px; padding: .5em .8em;
            font-size: 12px; border: 1px solid #888; border-radius: 6px;
            background: #fff; cursor: pointer; z-index: 9999;
          }
          @media print { #__app1Back { display:none } }
        </style>
      </head>
      <body class="${isSP && opts.rotateOnMobile ? 'rotate180' : ''}">
        <div id="page">${rebuilt}</div>
        <button id="__app1Back">← 元の画面へ戻る</button>
        <script>
          (function(){
            function backToOpener(){
              try { if (window.opener && !window.opener.closed) window.opener.focus(); } catch(e){}
              try { window.close(); } catch(e){}
              try { if (window.opener && !window.opener.closed) window.opener.postMessage({type:'IBASD_PRINT_DONE'}, '*'); } catch(e){}
            }

            // 印刷キック（load 済みでも一回だけ）
            let kicked=false, printed=false;
            function kick(){
              if (kicked) return; kicked=true;
              try { window.focus(); window.print(); printed=true; } catch(e){}
            }
            if (document.readyState === 'complete') { setTimeout(kick, 80); }
            else {
              window.addEventListener('load', ()=> setTimeout(kick,120), {once:true});
              document.addEventListener('readystatechange', ()=> {
                if (document.readyState === 'complete') setTimeout(kick, 80);
              });
            }
            setTimeout(kick, 1500); // 最後の一押し

            // 必ず閉じて戻る：5重トリガ
            window.addEventListener('afterprint', backToOpener);
            window.addEventListener('focus', ()=> { if (printed) backToOpener(); });
            document.addEventListener('visibilitychange', ()=> { if (!document.hidden) backToOpener(); });
            try {
              const mql = matchMedia('print');
              const h = e => { if (!e.matches) backToOpener(); };
              (mql.addEventListener ? mql.addEventListener('change', h) : mql.addListener(h));
            } catch(e){}
            setTimeout(backToOpener, 12000); // タイムアウト保険

            // 手動戻る
            document.getElementById('__app1Back')?.addEventListener('click', backToOpener);
          })();
        <\/script>
      </body>
      </html>
    `);
    doc.close();

    // 親側：ユーザー操作直後の“第一弾”をここで試す
    try {
      w.__app1Printed = false;
      w.focus();
      w.print();           // ここで開けば最短
      w.__app1Printed = true;

      w.addEventListener('load', () => {
        if (!w.__app1Printed) {
          try { w.focus(); w.print(); w.__app1Printed = true; } catch(e){}
        }
      }, { once:true });
    } catch(e) {}

    // 親側ウォッチドッグ：子が閉じたら即フォーカス
    try {
      const wd = setInterval(() => {
        if (!w || w.closed) { clearInterval(wd); try { window.focus(); } catch(e){} }
      }, 700);

      window.addEventListener('message', (ev) => {
        if (ev && ev.data && ev.data.type === 'IBASD_PRINT_DONE') {
          try { window.focus(); } catch(e){}
        }
      }, { once:true });
    } catch(e){}
  }

})();




/* =========================================================
   APP2 だけで使うもの（#result を封筒サイズで出力）
   使い方：
     - #resultを封筒レイアウトで … preparePrintApp2('envelope')  ←既定
     - #resultそのまま            … preparePrintApp2('plain')
   ========================================================= */

window.preparePrintApp2 = function (mode = 'envelope') {
  if (typeof window.showApp === 'function') window.showApp('app2');
  if (typeof window.calculate === 'function') window.calculate();

  // 🔽 ここから追加：結果までスムーズスクロール
  setTimeout(() => {
    const resultEl = document.getElementById('result');
    if (resultEl) {
      resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 600); // 計算完了後に遅れてスクロール（500〜800msが目安）
  // 🔼 追加ここまで

  const html = (document.getElementById('result')?.innerHTML || '').trim();
  if (!html) {
    alert('印刷する内容がありません。先に「計算」で結果を出してください。');
    return;
  }

  // 封筒モードなら .envelope で包む
  const hasEnvelope = /class\s*=\s*["'][^"']*envelope/.test(html);
  const inner = (mode === 'envelope' && !hasEnvelope)
    ? `<div class="envelope">${html}</div>`
    : html;

  openPrintApp2(inner, { scale: 1.05, rotateOnMobile: true, trimBottomMM: 20 });
};


function openPrintApp2(innerHTML, opts = {}) {
  const { scale = 1.00, rotateOnMobile = true, trimBottomMM = 0 } = opts;
  const isSP = /iPhone|iPod|Android.*Mobile/i.test(navigator.userAgent);
  const rotate = rotateOnMobile && isSP;

  // ★ 最終合計をチェックして、条件を満たせば special クラスを付与
  const temp = document.createElement('div');
  temp.innerHTML = innerHTML;
  const finalEl = temp.querySelector('.finalAmount');
  if (finalEl) {
    const num = parseInt(finalEl.textContent.replace(/[^0-9]/g, ''), 10);
    if (num >= 100000) {
      finalEl.classList.add('rainbow-print');
    }
  }
  innerHTML = temp.innerHTML;

  const printHTML = `<!doctype html><html lang="ja"><head>
  <meta charset="utf-8"><title>print</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --scale:${scale}; }
    @page { size: 90mm 205mm; margin: 0; }
    html,body {
      margin:0; padding:0; background:#fff;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }

    #page { width:90mm; max-height:205mm; margin:0 auto; overflow:hidden; }
    .rotate180 #page { margin-bottom:-${trimBottomMM}mm; }

    #result {
      width:calc(90mm/var(--scale));
      min-height:calc(205mm/var(--scale));
      margin:0 auto; padding:0;
      box-sizing:border-box;
      transform:scale(var(--scale));
      transform-origin:top center;
    }
    .rotate180 #result {
      transform:rotate(180deg) scale(var(--scale));
      transform-origin:center center;
    }

.envelope {
  box-sizing: border-box;
  width: calc(84mm / var(--scale)); /* ← 86→84 にして左右3mmずつの余白を確保 */
  max-height: 205mm;
  margin: 0 auto;
  text-align: left;
  font-family: 'ＭＳ 明朝', serif;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: .02em;
  padding: calc(5mm / var(--scale)); /* padding もスケールで割って実効幅を維持 */
}
    .print-date  { text-align:left;  font-size:11pt; margin:4mm 0 0; }
    .print-title { text-align:center;font-size:14pt;margin:2mm 0 8mm;font-weight:700; }
    .receipt-row { display:flex; justify-content:space-between; align-items:baseline; }
    .receipt-row .label{ margin-right:5mm; white-space:nowrap; }
    .receipt-row .value{ font-weight:700; font-size:12pt; text-align:right; }
    .totalAmount{ font-size:18pt !important; font-weight:800; color:#0066cc; margin:3mm 0 2mm; }
    .finalAmount{ font-size:18pt !important; font-weight:900; color:#009944; margin:4mm 0 3mm; }
    .castName   { font-size:16pt !important; font-weight:700; }

      .castName {
    font-size: 18pt !important;
    font-weight: 800 !important;
    margin: 3mm 0 !important;   /* 名前上下の余白復活 */
  }

  .subtotal {
    font-size: 14pt !important;
    font-weight: 700 !important;
    color: #333 !important;
    margin-top: 2mm !important;
    margin-bottom: 2mm !important;
  }

  .totalAmount {
    font-size: 15pt !important;
    font-weight: 800 !important;
    color: #0066cc !important;
    margin-top: 3mm !important;
    margin-bottom: 2mm !important;
  }

  .finalAmount {
    font-size: 18pt !important;
    font-weight: 900 !important;
    color: #009944 !important;
    margin-top: 4mm !important;
    margin-bottom: 3mm !important;
  }

    /* 印刷だけ虹色 */
    @media print {
      @keyframes rainbowText {
        0%   { color: red; }
        20%  { color: orange; }
        40%  { color: yellow; }
        60%  { color: green; }
        80%  { color: blue; }
        100% { color: purple; }
      }

  .rainbow-print {
    background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900;
  }

#result .congrats.print-only {
  display: none;
  text-align: center;
  font-weight: bold;
  font-size: 14pt;

  /* ↓ ここを追加または調整 */
  margin-bottom: 2px;   /* 最終合計との間隔を小さくする */
}
@media print {
  #result .congrats.print-only {
    display: block;
  }

#result .congrats-box {
  border: 2px solid #000;
  padding: 6px 10px;
  margin: 6px 0;

  /* ここから追加/変更 */
  max-width: calc(100% - 4mm); /* ← 右端クリップ回避の安全幅 */
  margin-left: 2mm;
  margin-right: 2mm;
  /* ここまで */

  text-align: center;
  border-radius: 6px;
  display: block;
  box-sizing: border-box;
}

#result .congrats.print-only {
  font-weight: bold;
  font-size: 14pt;
  margin-bottom: 2px;       /* 最終合計との間隔を調整 */
}
}
       
    }
    
  </style>
  </head><body class="${rotate ? 'rotate180' : ''}">
    <div id="page"><div id="result">${innerHTML}</div></div>
    <script>
      function tryClose(){ try{ window.close(); }catch(e){} }
      window.onload = function(){
        try{ window.focus(); window.print(); }catch(e){}
        window.onafterprint = tryClose;
        window.addEventListener('focus', tryClose, { once:true });
        document.addEventListener('visibilitychange', function(){ if(!document.hidden) tryClose(); });
        setTimeout(tryClose, 2500);
      };
    <\/script>
  </body></html>`;

  try {
  let w = window.open('', 'PRINT_APP2', 'width=480,height=800');
  if (w && w.document) {
    w.document.open(); 
    w.document.write(printHTML); 
    w.document.close();
    return w; // ← return に修正！
  }
} catch(_) {}

try {
  const blob = new Blob([printHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const w = window.open(url,'_blank');
  return w; // ← こちらもreturn w
} catch(_) {}

}


























</script>

<script type="module">
/***  Firebase v10 ESM（CDN） ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, enableIndexedDbPersistence,
  doc, getDoc, setDoc, updateDoc, onSnapshot,
  serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/*** ←ここをコンソールの値で置き換え ***/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "ibasdbeta",
  storageBucket: "ibasdbeta.firebasestorage.app",
  messagingSenderId: "317393843615",
  appId: "1:317393843615:web:xxxxxxxxxxxxxxxx",
  measurementId: "G-XXXXXXXXXX"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{ /* 複数タブ時などは無視でOK */ });

/*** Firestore パス設計 ***/
const COLLECTION = "IBAS";
const CLIENT_ID = (() => {
  const k="ibas-client-id";
  return localStorage.getItem(k) || (localStorage.setItem(k,crypto.randomUUID()), localStorage.getItem(k));
})();

const monthKey = (d=new Date()) => d.toISOString().slice(0,7);
const docRefFor = (key = monthKey()) => doc(db, COLLECTION, key);

/*** 画面右上のオートセーブ表示 ***/
function ensureIndicator(){
  if(document.getElementById("syncIndicator")) return;
  const el = document.createElement("div");
  el.id = "syncIndicator";
  el.style.cssText = `
    position:fixed; top:8px; right:10px; z-index:3000;
    background:rgba(0,34,43,.95); color:#00f5ff; border:1px solid #00f5ff55;
    padding:6px 10px; border-radius:8px; font:14px/1.2 system-ui, sans-serif;
    box-shadow:0 2px 10px rgba(0,245,255,.2); display:none;`;
  el.textContent = "保存中…";
  document.body.appendChild(el);
}
function _showSaving(){ ensureIndicator(); const el=document.getElementById("syncIndicator"); el.style.display="block"; el.textContent="保存中…"; }
function _saved(){ const el=document.getElementById("syncIndicator"); if(!el) return; el.textContent="保存済み"; setTimeout(()=>{el.style.display="none"}, 900); }

/*** ==== 収集＆復元（あなたのUIに合わせ済み） ==== ***/
/* app1（伝票）：#formRows の動的行を保存/復元 */
function collectApp1State(){
  const rows = [...document.querySelectorAll('#formRows tr.row')].map(tr => ({
    table:  tr.querySelector('.table-number')?.value ?? "",
    honshi: tr.querySelector('.honshi')?.value ?? "",
    c:      tr.querySelector('.c')?.value ?? "",
    amount: tr.querySelector('.amount')?.value ?? "",
    num:    tr.querySelector('.num')?.value ?? "",
    detail: tr.querySelector('.detail')?.value ?? "",
    card:   tr.querySelector('.card')?.value ?? "",
    total:  tr.querySelector('.total')?.value ?? ""
  }));

  // ★ ここから追加：CB表のチェックボックスを拾う
  // 「UKtotal」「Ktotal」…の <span id="◯◯total"> をキーの元にして安定化
  const catChecks = {};
  document.querySelectorAll('#categorySection tbody tr').forEach(tr => {
    const cb = tr.querySelector('input[type="checkbox"]');
    if (!cb) return;
    const key =
      (tr.querySelector('span[id$="total"]')?.id || '')
        .replace(/total$/, '')              // "UKtotal" -> "UK"
      || (tr.textContent || '').trim().split(/\s+/)[0]; // 念のため保険
    if (key) catChecks[key] = !!cb.checked;
  });

  return { rows, catChecks };   // ★ 追加した catChecks も返す
}
function applyApp1State(state){
  if(!state || !state.rows) return;
  const tbody = document.getElementById('formRows');
  if(!tbody) return;

  // 既存行を空に
  tbody.innerHTML = "";

  // 行を追加して値を流し込む
  state.rows.forEach((r, idx)=>{
    if(typeof window.addRow === "function"){
      window.addRow();
    }else{
      // フォールバックで行を追加
      const tr = document.createElement('tr');
      tr.className = 'row';
      tr.innerHTML = `
        <td><button class="delete-btn" onclick="deleteRow(this)">×</button></td>
        <td class="rowNumber">${idx+1}</td>
        <td><input class="table-number" type="text"/></td>
        <td><input class="honshi" type="text"/></td>
        <td>
          <select class="c">
            <option value=""></option>
            <option>UK</option><option>K</option><option>AB</option><option>LA</option>
            <option>PA</option><option>BB</option><option>MS</option><option>GM</option>
            <option>B</option><option>JOE</option><option>KOSE</option><option>HE</option>
            <option>PB</option><option>X</option><option>Z</option>
          </select>
        </td>
        <td><input class="amount" type="text"/></td>
        <td><input class="num" type="text"/></td>
        <td><input class="detail" type="text"/></td>
        <td><input class="card" type="text"/></td>
        <td><input class="total" type="text"/></td>`;
      tbody.appendChild(tr);
    }

    // 追加した行を取得
    const tr = tbody.querySelector('tr.row:last-child');
    if(!tr) return;

    // 値を安全に代入するヘルパ
    const setVal = (sel, val) => {
      const el = tr.querySelector(sel);
      if (el) el.value = (val ?? "");
    };

    setVal('.table-number', r.table);
    setVal('.honshi',       r.honshi);
    setVal('.c',            r.c);
    setVal('.amount',       r.amount);
    setVal('.num',          r.num);
    setVal('.detail',       r.detail);
    setVal('.card',         r.card);
    setVal('.total',        r.total);
  });

    // ★ ここから追加：CB表のチェックを復元
  if (state.catChecks) {
    Object.entries(state.catChecks).forEach(([key, checked]) => {
      // "UK" → "#UKtotal" を探し、その行のチェックボックスに反映
      const span = document.querySelector(`#categorySection #${CSS.escape(key)}total`);
      const tr   = span?.closest('tr');
      const cb   = tr?.querySelector('input[type="checkbox"]');
      if (cb) cb.checked = !!checked;
    });
  }

  // 合計再計算
  if (typeof window.updateTotals === "function") {
    window.updateTotals();
  }
}

/* app2（報酬計算）：id を持つ input/select/textarea を丸ごと保存/復元＋ボトル明細 */
function collectApp2State(){
  const root = document.getElementById('app2');
  if(!root) return {};

  const fields = {};
  root.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
    fields[el.id] = (el.type === 'checkbox') ? !!el.checked : (el.value ?? "");
  });

  // 既存: ボトル明細
  const bottles = [...root.querySelectorAll('#bottleFormsContainer .bottle-form')].map(form => ({
    details: form.querySelector('.bottleDetails')?.value ?? "",
    split:   form.querySelector('.splitCount')?.value ?? "",
    qty:     form.querySelector('.bottleQuantity')?.value ?? "",
    amount:  form.querySelector('.bottleAmount')?.value ?? ""
  }));

  // ★追加: 履歴（HTMLそのまま）
  const historyRoot = document.getElementById('historyList');
  const historyHTML = historyRoot ? historyRoot.innerHTML : "";

  return { fields, bottles, historyHTML };
}

function applyApp2State(state){
  const root = document.getElementById('app2');
  if(!root || !state) return;

  if(state.fields){
    Object.entries(state.fields).forEach(([id, val])=>{
      const el = root.querySelector('#'+CSS.escape(id));
      if(!el) return;
      if(el.type === 'checkbox'){ el.checked = !!val; }
      else { el.value = val ?? ""; }
    });
  }

  if(Array.isArray(state.bottles)){
    const container = root.querySelector('#bottleFormsContainer');
    if(container){
      container.innerHTML = "";
      state.bottles.forEach(b=>{
        // 既存の追加関数があればそれを使う
        if(typeof window.addBottleForm === "function"){
          const el = window.addBottleForm();
          (el?.querySelector('.bottleDetails')||{}).value = b.details ?? "";
          (el?.querySelector('.splitCount')||{}).value    = b.split ?? "";
          (el?.querySelector('.bottleQuantity')||{}).value= b.qty ?? "";
          (el?.querySelector('.bottleAmount')||{}).value  = b.amount ?? "";
        }else{
          // フォールバック生成（既存実装に合わせる）
          const row = document.createElement('div');
          row.className = 'bottle-form';
          row.innerHTML = `
            <div class="left-group">
              <button type="button" class="delete-btn" onclick="this.closest('.bottle-form')?.remove()">×</button>
              <select class="bottleDetails"><option value=""></option></select>
            </div>
            <input class="splitCount" type="text"/>
            <input class="bottleQuantity" type="text"/>
            <input class="bottleAmount" type="text"/>`;
          container.appendChild(row);
          row.querySelector('.bottleDetails').value = b.details ?? "";
          row.querySelector('.splitCount').value    = b.split ?? "";
          row.querySelector('.bottleQuantity').value= b.qty ?? "";
          row.querySelector('.bottleAmount').value  = b.amount ?? "";
        }
      });
    }
  }

  // ★追加: 履歴HTMLの反映＋派生処理
  if (typeof state.historyHTML === "string") {
    const historyRoot = document.getElementById('historyList');
    if (historyRoot && historyRoot.innerHTML !== state.historyHTML) {
      historyRoot.innerHTML = state.historyHTML;
      try { localStorage.setItem('historyList', state.historyHTML); } catch(e){}
      if (typeof window.renumberHistory === "function") renumberHistory();
      if (typeof window.refreshBottleDropdownsFromHistory === "function") refreshBottleDropdownsFromHistory();
      if (typeof window.updateSummary === "function") updateSummary();
    }
  }
}


/* app3（ざっくり）：id付きの要素を一括保存/復元 */
function collectApp3State(){
  const root = document.getElementById('app3');
  if(!root) return {};
  const fields = {};
  root.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
    fields[el.id] = (el.type === 'checkbox') ? !!el.checked : (el.value ?? "");
  });
  return { fields };
}
function applyApp3State(state){
  const root = document.getElementById('app3');
  if(!root || !state || !state.fields) return;
  Object.entries(state.fields).forEach(([id, val])=>{
    const el = root.querySelector('#'+CSS.escape(id));
    if(!el) return;
    if(el.type === 'checkbox'){ el.checked = !!val; }
    else { el.value = val ?? ""; }
  });
}

/*** ==== 読み込み・保存・購読 ==== ***/
async function loadAllApps(key = monthKey()){
  const snap = await getDoc(docRefFor(key));
  const data = snap.exists() ? snap.data() : {};
  applyApp1State(data.app1);
  applyApp2State(data.app2);
  applyApp3State(data.app3);
}

async function saveAllApps(key = monthKey()){
  _showSaving();
  const payload = {
    app1: collectApp1State(),
    app2: collectApp2State(),
    app3: collectApp3State(),
    updatedAt: serverTimestamp(),
    lastAuthor: CLIENT_ID
  };
  await setDoc(docRefFor(key), payload, { merge:true });
  _saved();
}

/* 他端末からの更新を受け取り反映（自端末の直後の書き込みはスキップ） */
function subscribeRemote(key = monthKey()){
  return onSnapshot(docRefFor(key), snap=>{
    if(!snap.exists()) return;
    const data = snap.data();
    if(data?.lastAuthor === CLIENT_ID) return; // 自分の書き込みは無視
    applyApp1State(data.app1 || {});
    applyApp2State(data.app2 || {});
    applyApp3State(data.app3 || {});
  });
}

/*** ==== オートセーブ（デバウンス） ==== ***/
let _saveTimer = null;
function scheduleAutosave(){
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=> saveAllApps(monthKey()), 800);
}

// ===== 同期ヘルパ =====
function saveNow(reason=""){ 
  try{ console.debug("[SYNC] now:", reason); }catch(_){}
  return saveAllApps(monthKey());
}

// 関数をラップして「実行後」に同期するユーティリティ
function wrapAndSync(name, {immediate=false} = {}){
  const fn = window[name];
  if(typeof fn !== "function") return;
  window[name] = async function(...args){
    const ret = fn.apply(this, args);
    try { if (ret && typeof ret.then === "function") await ret; } catch(e){}
    if (immediate) { await saveNow(name); } else { scheduleAutosave(); }
    return ret;
  };
}

// 各APPのクリア系関数（存在するものだけ動く）
["clearApp1","clearApp2","clearApp3","resetAllApps","clearAll"].forEach(n=>{
  wrapAndSync(n, { immediate:true });
});

// APP2 計算実行（フォーム onsubmit から呼ばれる想定）
wrapAndSync("confirmAndCalculate", { immediate:true });

// APP1 伝票フィルタ
wrapAndSync("filterCategory",      { immediate:false });
wrapAndSync("filterCashOnlyRows",  { immediate:false });
wrapAndSync("filterCardInputRows", { immediate:false });
wrapAndSync("resetSearch",         { immediate:false });

(function observeApp2History(){
  const historySection = document.getElementById("app2-historySection");
  if (!historySection) return;

  let debounceTimer = null;

  const observer = new MutationObserver(() => {
    clearTimeout(debounceTimer);
    // 100ms デバウンスで両方の処理を安全に呼ぶ
    debounceTimer = setTimeout(() => {
      scheduleAutosave();
      createHistoryIndex();
    }, 100);
  });

  observer.observe(historySection, {
    childList: true,
    subtree: true,
    characterData: true
  });
})();

function attachAutosave(){
  ['input','change'].forEach(evt=>{
    document.body.addEventListener(evt, scheduleAutosave, { capture:true });
  });
}

/*** ==== ユーティリティ（エラーで出ていた clearAllRemote も定義） ==== ***/
async function clearAllRemote(key = monthKey()){
  await setDoc(docRefFor(key), {
    app1: {}, app2: {}, app3: {},
    updatedAt: serverTimestamp(),
    lastAuthor: CLIENT_ID
  }, { merge:true });
}
window.clearAllRemote = clearAllRemote;
window.saveAllApps   = saveAllApps;   // 手動保存したい時用
window.loadAllApps   = loadAllApps;   // 手動読込したい時用

/*** ==== 起動 ==== ***/
window.addEventListener('DOMContentLoaded', async ()=>{
  ensureIndicator();
  await loadAllApps(monthKey());  // ①ページを開いたら即読み込み
  attachAutosave();               // ②入力のたびに自動保存（800msデバウンス）
  subscribeRemote(monthKey());    // ③他端末の更新を即時反映
});

// ===== app2 履歴のローカル状態 =====
let app2History = [];

// HTMLエスケープ（XSS/レイアウト崩れ対策）
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// 履歴の描画
function renderApp2History(){
  const ul = document.getElementById('app2-historyList');
  if(!ul) return;
  ul.innerHTML = app2History.map(e => {
    const when = new Date(e.time||Date.now()).toLocaleString();
  return `<li class="history-item">
            <span class="history-name">${escapeHtml(e.cast||'（名前なし）')}</span>｜${when}
            ｜小計:${e.subtotal?.toLocaleString?.() ?? e.subtotal}
            ｜合計:${e.total?.toLocaleString?.() ?? e.total}
            ｜最終:${e.final?.toLocaleString?.() ?? e.final}
          </li>`;
  }).join('');
}

// Firebase へ履歴を保存（saveRemote があればそれを使う）
async function persistApp2History(){
  // ① 既存の saveRemote(appId, stateObj) がある場合
  if (typeof saveRemote === 'function'){
    await saveRemote('app2', { history: app2History });
    return;
  }
  // ② ない場合のフォールバック（useFirebase を使う前提）
  if (typeof useFirebase === 'function'){
    const fb = await useFirebase();
    if(!fb) return;
    const { db, doc, setDoc, serverTimestamp } = fb;
    await setDoc(
      doc(db, 'apps', 'app2'),              // ← コレクション/ドキュメントは環境に合わせて
      { history: app2History, updatedAt: serverTimestamp() },
      { merge: true }
    );
  }
}

// リアルタイム購読（他端末の更新を即反映）
async function startApp2Realtime(){
  if (typeof useFirebase !== 'function') return;
  const fb = await useFirebase();
  if(!fb) return;
  const { db, doc, onSnapshot } = fb;
  const ref = doc(db, 'apps', 'app2');      // ← 保存先に合わせて同じ参照にする
  onSnapshot(ref, (snap) => {
    const data = snap.data();
    if (!data || !Array.isArray(data.history)) return;
    // 自分の直後保存で重複しにくいよう簡単な等価チェック
    const jsonLocal  = JSON.stringify(app2History);
    const jsonRemote = JSON.stringify(data.history);
    if (jsonLocal !== jsonRemote){
      app2History = data.history;
      renderApp2History();
    }
  });
}

// 初期ロード（ページ表示時に一度だけ取り込み）
async function loadApp2HistoryOnce(){
  if (typeof useFirebase !== 'function') return renderApp2History();
  const fb = await useFirebase();
  if(!fb) return renderApp2History();
  const { db, doc, getDoc } = fb;
  const ref = doc(db, 'apps', 'app2');      // ← 保存先に合わせる
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : null;
  app2History = Array.isArray(data?.history) ? data.history : [];
  renderApp2History();
}

document.addEventListener('DOMContentLoaded', () => {
  loadApp2HistoryOnce();  // 一度だけ読み込む
  startApp2Realtime();    // 以後はリアルタイム反映
});


/* 入力済みHTMLとして保存 v2.9
   - 値焼き込み（id/name優先＋APP1は行×クラス、カテゴリ表チェックは出現順）
   - タブ <div.tab data-target="appX"> → <a class="tab" href="#appX">
   - :target で .content を切替（JS不要）。初期は app1 を表示
   - 既存のopacity/transformアニメは上書きで無効化（見えない事故防止）
   - 保存物は編集不可（disabled/readonly）＋ <script> 全削除
*/
window.exportAsFilledHTML = function(){
  const doc = document;
  const cloned = doc.documentElement.cloneNode(true);
  const $all = (root, sel) => Array.from(root.querySelectorAll(sel));
  const esc  = (window.CSS && CSS.escape) ? CSS.escape : s=>String(s).replace(/[^a-zA-Z0-9_\-]/g,'\\$&');
  const byId = (root, id) => id ? root.querySelector('#'+esc(id)) : null;

  // ===== 1) 値の焼き込み（id/name 優先） =====
  // input
  $all(doc,'input').forEach(oi=>{
    const ci = (oi.id && byId(cloned,oi.id)) || (oi.name && cloned.querySelector(`[name="${esc(oi.name)}"]`));
    if(!ci) return;
    const type=(oi.getAttribute('type')||'text').toLowerCase();
    if(type==='checkbox'||type==='radio'){
      if(oi.checked) ci.setAttribute('checked',''); else ci.removeAttribute('checked');
      if(type==='radio' && oi.name){
        $all(cloned,`input[type="radio"][name="${esc(oi.name)}"]`).forEach(r=>{ if(r!==ci) r.removeAttribute('checked'); });
      }
    }else{
      ci.setAttribute('value', oi.value ?? '');
    }
    ci.setAttribute('disabled','disabled'); ci.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>ci.removeAttribute(a));
  });
  // textarea
  $all(doc,'textarea').forEach(ot=>{
    const ct = (ot.id && byId(cloned,ot.id)) || (ot.name && cloned.querySelector(`[name="${esc(ot.name)}"]`));
    if(!ct) return;
    ct.textContent = ot.value ?? '';
    ct.setAttribute('disabled','disabled'); ct.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>ct.removeAttribute(a));
  });
  // select
  $all(doc,'select').forEach(os=>{
    const cs = (os.id && byId(cloned,os.id)) || (os.name && cloned.querySelector(`[name="${esc(os.name)}"]`));
    if(!cs) return;
    const val = os.value ?? '';
    $all(cs,'option').forEach(opt=>{ if(opt.value===val) opt.setAttribute('selected',''); else opt.removeAttribute('selected'); });
    cs.setAttribute('disabled','disabled'); cs.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>cs.removeAttribute(a));
  });

  // ===== 2) APP1 伝票行（#formRows tr.row）を行×クラスで焼き込み =====
  const oRows = $all(doc,'#formRows tr.row');
  const cRows = $all(cloned,'#formRows tr.row');
  const fields = ['.table-number','.honshi','.c','.amount','.num','.detail','.card','.total'];
  oRows.forEach((tr,i)=>{
    const ctr = cRows[i]; if(!ctr) return;
    fields.forEach(sel=>{
      const oi = tr.querySelector(sel);
      const ci = ctr.querySelector(sel);
      if(!oi || !ci) return;
      if (ci.tagName === 'SELECT') {
        const val = oi.value ?? '';
        $all(ci,'option').forEach(opt=>{ if(opt.value===val) opt.setAttribute('selected',''); else opt.removeAttribute('selected'); });
      } else {
        const type=(oi.getAttribute('type')||'text').toLowerCase();
        if(type==='checkbox'||type==='radio'){
          if(oi.checked) ci.setAttribute('checked',''); else ci.removeAttribute('checked');
        }else{
          ci.setAttribute('value', oi.value ?? '');
        }
      }
      ci.setAttribute('disabled','disabled'); ci.setAttribute('readonly','readonly');
      ['onclick','onchange','oninput','onsubmit'].forEach(a=>ci.removeAttribute(a));
    });
  });

  // ===== 3) カテゴリ表チェック（#categorySection）を出現順で固定 =====
  const oCbs = $all(doc,'#categorySection input[type="checkbox"]');
  const cCbs = $all(cloned,'#categorySection input[type="checkbox"]');
  oCbs.forEach((o,i)=>{
    const c = cCbs[i]; if(!c) return;
    if(o.checked) c.setAttribute('checked',''); else c.removeAttribute('checked');
    c.setAttribute('disabled','disabled');
    ['onclick','onchange'].forEach(a=>c.removeAttribute(a));
  });

  // ===== 4) タブをアンカー式に変換（JS不要の切替） =====
  const tabsBar = cloned.querySelector('.tabs');
  if(tabsBar){
    $all(tabsBar,'.tab').forEach(old=>{
      if(old.tagName.toLowerCase()==='a') return;
      const target = old.getAttribute('data-target') || 'app1';
      const label  = (old.textContent||'').trim() || target;
      const a = document.createElement('a');
      a.className = old.className.replace(/\bactive\b/g,'').trim();
      a.setAttribute('href','#'+target);
      a.setAttribute('role','tab');
      a.textContent = label;
      old.replaceWith(a);
    });
  }

  // ===== 5) 保存版用CSSを追加（:target で切替 & アニメ無効化） =====
  const head  = cloned.querySelector('head') || cloned.getElementsByTagName('head')[0];
  const style = document.createElement('style');
  style.textContent = `
    /* 保存版バッジ＆操作不可 */
    body[data-frozen="1"] * { caret-color: transparent; }
    [disabled], input[readonly], select[disabled], textarea[disabled]{ opacity:.85; pointer-events:none; }
    .frozen-banner{
      position:fixed; top:8px; right:8px; z-index:99999;
      padding:6px 10px; font:12px/1 system-ui,-apple-system,Segoe UI,Roboto,"M PLUS 2",sans-serif;
      background:rgba(0,245,255,.14); border:1px solid rgba(0,245,255,.55);
      border-radius:8px; color:#00f5ff; backdrop-filter: blur(6px);
    }
    /* 既存のアニメを打ち消して“表示優先” */
    .content{ opacity:1 !important; transform:none !important; }

    /* JSなしのAPP切替：デフォ非表示、:targetだけ表示 */
    .content{ display:none !important; }
    .content:target{ display:block !important; }
    /* ハッシュ無しの初期表示はapp1 */
    :root #app1{ display:block !important; }
  `;
  head.appendChild(style);

  // ===== 6) バナー付与・初期表示の保険 =====
  const body = cloned.querySelector('body') || cloned.getElementsByTagName('body')[0];
  if(body){
    body.setAttribute('data-frozen','1');
    const banner = document.createElement('div');
    banner.className = 'frozen-banner';
    banner.textContent = 'このファイルは入力済みの保存版（編集不可）';
    body.appendChild(banner);
  }
  ['app1','app2','app3'].forEach(id=>{
    const el = byId(cloned,id);
    if(el){ el.removeAttribute('hidden'); el.style.visibility='visible'; }
  });

  // ===== 7) クリック不可（証跡用） =====
  $all(cloned,'button').forEach(b=>{ b.setAttribute('disabled','disabled'); b.removeAttribute('onclick'); b.type='button'; });
  $all(cloned,'form').forEach(f=>{ f.setAttribute('onsubmit','return false;'); });

  // ===== 8) <script> 全削除（完全静的化） =====
  $all(cloned,'script').forEach(s=> s.remove());

  // ===== 9) ダウンロード =====
  const htmlText = '<!DOCTYPE html>\n' + cloned.outerHTML;
  const blob = new Blob([htmlText], { type:'text/html' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  try{
    const base = (typeof window.getCustomFileName==='function') ? window.getCustomFileName()
               : 'IBASD_' + new Date().toISOString().slice(0,10);
    a.href = url; a.download = base + '.html'; a.click();
  } finally {
    URL.revokeObjectURL(url);
  }
};


/* 合計ユーティリティ（存在しなければ定義） */
if (typeof window.subtotal !== 'function') {
  window.subtotal = function(values){
    let s = 0; for (const v of (values||[])) s += (Number(v)||0); return s;
  };
}

// ====== 履歴インデックス生成 ======
// CSS変数(px)を取得（フォールバック付）
function getVarPx(name, fallback = 0){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : fallback;
}

// 固定ヘッダ（タブ＋サブナビ）の総高さを取得
function getNavOffsetPx(){
  const tabs = document.querySelector('.tabs')?.offsetHeight ?? getVarPx('--tabs-h', 56);
  const sub  = document.querySelector('#app2-nav')?.offsetHeight ?? getVarPx('--subnav-h', 50);
  return tabs + sub + 10; // 仕上げの余白10px
}

// オフセット付きスムーススクロール
function scrollWithOffset(targetEl){
  const y = targetEl.getBoundingClientRect().top + window.scrollY - getNavOffsetPx();
  window.scrollTo({ top: y, behavior: 'smooth' });
}

// インデックス置き場（テーブル）を確保 or 作成（app2-inputSection の直前）
function ensureHistoryIndexTable(){
  let table = document.getElementById('historyIndexTable');
  if (table) return table;

  const inputSection = document.getElementById('app2-inputSection'); // ←ここを基準に差し込み
  if (!inputSection) return null;

  table = document.createElement('table');
  table.id = 'historyIndexTable';
  table.className = 'history-index-table';
table.innerHTML = `
  <thead>
    <tr>
      <th>
        <button id="historyIndexToggle" class="history-index-toggle" type="button">
          <span class="history-index-title">履歴</span>
          <span id="historyIndexCount" class="history-index-count">0人</span>
          <span class="caret">▾</span>
        </button>
      </th>
    </tr>
  </thead>
  <tbody id="historyIndexBody"></tbody>
`;

  // app2-inputSection の「直前」に追加（フォームの上に出す）
  inputSection.parentNode.insertBefore(table, inputSection);
  return table;
}

document.addEventListener('click', (e)=>{
  if (e.target.closest('#historyIndexToggle')) {
    const tbl = document.getElementById('historyIndexTable');
    tbl?.classList.toggle('collapsed');
  }
});

// テーブル版：履歴から氏名ボタンを生成（列数は画面幅で変化）
function createHistoryIndex(){
  const historySection = document.getElementById('app2-historySection');
  if (!historySection) return;

  const table = ensureHistoryIndexTable();
  if (!table) return;

  const tbody = table.querySelector('#historyIndexBody');
  if (!tbody) return;

// 1) 履歴アイテムを拾う（推奨: .history-item、旧: #historyList > li）
let items = historySection.querySelectorAll('.history-item');
if (items.length === 0) {
  const list = document.getElementById('historyList');
  if (list) items = list.querySelectorAll('li');
}
if (!items || items.length === 0){
  tbody.innerHTML = '';
  return;
}

// ★ ここを追加：新しい登録が下に付く前提で、逆順にして「新→旧」の順で処理
items = Array.from(items).reverse();

// 2) {name, el} の配列を作る（.history-name / .castName / <b>）
const map = new Map();
items.forEach(item => {
  const nameEl = item.querySelector('.history-name')
              || item.querySelector('.castName')
              || item.querySelector('b');
  const raw  = nameEl?.textContent?.trim() || '';
  const base = stripLeadingSerial(raw);   // ★ 連番を除去した表示名
  if (base && !map.has(base)) map.set(base, item);
});

const pairs = Array.from(map, ([name, el]) => ({ name, el }));

  const countEl = document.getElementById('historyIndexCount');
  if (countEl) countEl.textContent = `${pairs.length}人`;


// 3) レイアウト：モバイルは横スクロールのチップ1行 / PCは表グリッド
const isMobile = window.matchMedia('(max-width:700px)').matches;
tbody.innerHTML = '';

if (isMobile) {
  const tr = document.createElement('tr');
  const td = document.createElement('td');
  const wrap = document.createElement('div');
  wrap.className = 'history-chip-row'; // ← CSSで横スクロール

  pairs.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'idx-btn';
    btn.type = 'button';
    btn.textContent = p.name;
    btn.addEventListener('click', () => scrollWithOffset(p.el));
    wrap.appendChild(btn);
  });

  td.appendChild(wrap);
  tr.appendChild(td);
  tbody.appendChild(tr);
} else {
  const COLS = 6; // PC列数
  for (let i = 0; i < pairs.length; i += COLS){
    const tr = document.createElement('tr');
    for (let c = 0; c < COLS; c++){
      const td = document.createElement('td');
      const p = pairs[i + c];
      if (p){
        const btn = document.createElement('button');
        btn.className = 'idx-btn';
        btn.type = 'button';
        btn.textContent = p.name;
        btn.addEventListener('click', () => scrollWithOffset(p.el));
        td.appendChild(btn);
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

}

// 公開しておく（必要なら手動再生成で呼べる）
window.createHistoryIndex = createHistoryIndex;

// 初期化：履歴変化を監視して自動再生成＋初回実行
document.addEventListener('DOMContentLoaded', () => {
  const historySection = document.getElementById('app2-historySection');
  if (historySection){
    const mo = new MutationObserver(() => createHistoryIndex());
    mo.observe(historySection, { childList:true, subtree:true });
  }
  createHistoryIndex();
});

// 先頭の連番「1. 」「１）」「#3 」などを削除
function stripLeadingSerial(s){
  if (!s) return '';
  return s.replace(
    /^\s*(?:No\.|#)?\s*[0-9０-９]+\s*[\)\]）.．、:：-]?\s*/u,
    ''
  ).trim();
}

document.addEventListener('DOMContentLoaded', () => {
  addOutputButtonsNextToRestore();
  const his = document.getElementById('app2-historySection');
  if (his) {
    const mo = new MutationObserver(() => addOutputButtonsNextToRestore());
    mo.observe(his, { childList: true, subtree: true });
  }
});

function addOutputButtonsNextToRestore() {
  const historySection = document.getElementById('app2-historySection');
  if (!historySection) return;

  let items = historySection.querySelectorAll('.history-item');
  if (items.length === 0) {
    const list = document.getElementById('historyList');
    if (list) items = list.querySelectorAll('li');
  }
  if (!items.length) return;

  items.forEach(item => {
    if (item.querySelector('.output-btn')) return;

    // 復元ボタン探す
    const restoreBtn = Array.from(item.querySelectorAll('button'))
      .find(b => b.textContent.includes('復元'));
    if (!restoreBtn) return;

    // 出力ボタン生成
    const outBtn = document.createElement('button');
    outBtn.className = 'output-btn';
    outBtn.textContent = '出力';
    outBtn.style.marginLeft = '8px';

    outBtn.addEventListener('click', async e => {
      e.stopPropagation();

      // 1️⃣ 該当の復元ボタンをクリック
      restoreBtn.click();

      // 2️⃣ 復元処理が終わるまで少し待つ（非同期処理対策）
      await new Promise(res => setTimeout(res, 800));

      // 3️⃣ 既存の出力処理（preparePrintApp2）を呼ぶ
      if (typeof window.preparePrintApp2 === 'function') {
        preparePrintApp2('envelope');
      } else {
        alert('出力機能が見つかりません。');
      }
    });

    // 復元の右横に設置
    restoreBtn.insertAdjacentElement('afterend', outBtn);

    // 並びはCSSに任せる（親にクラスを付与）
    const parent = restoreBtn.parentElement;
    parent.classList.add('history-actions');

    // ついでに ↑/↓ ボタンがあれば統一クラスを付与
    const upBtn   = Array.from(parent.querySelectorAll('button')).find(b => b.textContent.trim() === '↑');
    const downBtn = Array.from(parent.querySelectorAll('button')).find(b => b.textContent.trim() === '↓');
    [restoreBtn, outBtn, upBtn, downBtn].forEach(b => b && b.classList.add('history-action'));
    });
}

// 自動再適用
document.addEventListener('DOMContentLoaded', () => {
  addOutputButtonsNextToRestore();
  const his = document.getElementById('app2-historySection');
  if (his) {
    const mo = new MutationObserver(() => addOutputButtonsNextToRestore());
    mo.observe(his, { childList: true, subtree: true });
  }
});

document.addEventListener('DOMContentLoaded', () => {
  // ← 既存の addOutputButtonsNextToRestore() と MutationObserver はそのままでOK

  const sel = document.getElementById('bulkRows');
  if (!sel) return;

  sel.addEventListener('change', () => {
    // ★ 復元中フラグON（合成change対策）
    window.BULK_RESTORING = true;

    const snapshot = (typeof snapshotBulkGrid === 'function') ? snapshotBulkGrid() : [];
    const nextN = parseInt(sel.value || '40', 10) || 40;

    if (typeof buildGrid === 'function') buildGrid(nextN);

    if (typeof restoreBulkGrid === 'function') {
      restoreBulkGrid((snapshot || []).slice(0, nextN));
    }

    // ★ 再発火は input のみ。select には触れない
    document.querySelectorAll('#bulkGrid input')
      .forEach(el => el.dispatchEvent(new Event('input', {bubbles:true})));

    // ★ フラグOFF
    window.BULK_RESTORING = false;
  });
});

window.sortHistoryIndex = function() {
  const container = document.querySelector('.history-index-table');
  if (!container) return;

  // ボタン要素を全部取得（表題行は除外）
  const buttons = Array.from(container.querySelectorAll('.idx-btn'));

  // 50音順ソート（濁音・半濁音・小文字も考慮）
  buttons.sort((a, b) => {
    const aText = a.textContent
      .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60)) // カナ→ひらがな
      .replace(/[ﾞﾟ]/g, ""); // 濁点除去
    const bText = b.textContent
      .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60))
      .replace(/[ﾞﾟ]/g, "");
    return aText.localeCompare(bText, 'ja');
  });

  // 並べ替え反映（タイトル以外を削除して再追加）
  const title = container.querySelector('.history-index-title');
  container.querySelectorAll('.idx-btn').forEach(btn => btn.remove());
  buttons.forEach(btn => container.appendChild(btn));
  
  // 成功時の軽い視覚フィードバック（オプション）
  title.style.textShadow = '0 0 8px #00f5ff';
  setTimeout(() => title.style.textShadow = '', 800);
};

/* 金額フォーマット（既存にあるなら差し替えてOK） */
function fmtYen(n){
  if(n == null || n === "") return "¥0";
  const x = Number(n);
  return "¥" + (isFinite(x) ? x.toLocaleString() : String(n));
}

/* 既存の履歴UIを「氏名・小計・合計」だけにトリミング */
function slimHistoryUI(){
  const root = document.querySelector('#app2-historySection') || document;
  const items = root.querySelectorAll('.history-item');
  if(!items.length) return;

  items.forEach(it => {
    // 1) 本文候補（実装違いに強めにしてある）
    const body = it.querySelector('.history-details, .history-body, .history-text, pre, .details, .history') || it;

    // 2) 元テキストを行に分割
    const lines = body.innerText
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);

    // 3) 必要行を抽出（氏名／小計／合計(最終合計も拾う)）
    //   - 氏名：明確に「氏名:」「名前:」が無い場合、"1. XXX" や先頭の人名らしき行を拾う
    let nameLine =
      lines.find(s => /^氏名[:：]/.test(s)) ||
      lines.find(s => /^名前[:：]/.test(s)) ||
      lines.find(s => /^\d+\s*[\.、]\s*\S+/.test(s)) ||   // 例: "1. TEST"
      lines.find(s => /対象|様|さん/.test(s));

    // 小計
    let subtotalLine = lines.find(s => /^小計[:：]/.test(s));

    // 合計（「最終合計」「合　¥123,456」等にも対応）
    let totalLine =
      lines.find(s => /^(最終)?合計[:：]/.test(s)) ||
      lines.find(s => /^合\s*¥/.test(s));

    // 4) もしテキストから拾えない場合、データ属性がある想定もフォールバック
    //    （history要素に dataset があるなら使う）
    const ds = it.dataset || {};
    const n = ds.name || ds.customerName;
    const sub = ds.subtotal || ds.subTotal;
    const fin = ds.final || ds.total || ds.finalAmount;

    if(!nameLine && n) nameLine = '氏名：' + n;
    if(!subtotalLine && sub != null) subtotalLine = '小計：' + fmtYen(sub);
    if(!totalLine && fin != null) totalLine = '合計：' + fmtYen(fin);

    // 5) 表示HTMLを差し替え（現行の雰囲気を壊さず左右2カラム風）
    const frag = document.createElement('div');
    frag.className = 'history-summary';
    frag.innerHTML = [
      nameLine ? `<div class="history-summary-row"><span class="label">氏名</span><span class="value">${(nameLine.replace(/^氏名[:：]\s*/,'')).replace(/^\d+\s*[\.、]\s*/,'')}</span></div>` : '',
      subtotalLine ? `<div class="history-summary-row"><span class="label">小計</span><span class="value">${subtotalLine.replace(/^小計[:：]\s*/,'')}</span></div>` : '',
      totalLine ? `<div class="history-summary-row"><span class="label">合計</span><span class="value">${totalLine.replace(/^(最終)?合計[:：]\s*/,'').replace(/^合\s*/,'')}</span></div>` : ''
    ].join('');

    body.innerHTML = '';        // 旧テキストを消す
    body.appendChild(frag);     // 新サマリーを入れる

    // 6) アクションボタンを「復元・出力」に整理
    const act = it.querySelector('.history-actions');
    if(act){
      // 不要（↑/↓）は削除
      act.querySelectorAll('[data-role="up"],[data-role="down"],.history-action--up,.history-action--down')
         .forEach(el => el.remove());

      // 「復元」「出力」がなければ追加（クラス名やハンドラは既存に合わせて！）
      const hasRestore = act.querySelector('[data-role="restore"], .history-restore');
      const hasExport  = act.querySelector('[data-role="export"], .history-export, .output-btn');

      if(!hasRestore){
        const b = document.createElement('button');
        b.className = 'history-restore';
        b.textContent = '復元';
        b.addEventListener('click', () => {
          const id = it.dataset.id || it.getAttribute('data-id');
          window.restoreHistory && window.restoreHistory(id, it);
        });
        act.appendChild(b);
      }
      if(!hasExport){
        const b = document.createElement('button');
        b.className = 'history-export output-btn';
        b.textContent = '出力';
        b.addEventListener('click', () => {
          const id = it.dataset.id || it.getAttribute('data-id');
          window.exportHistory && window.exportHistory(id, it);
        });
        act.appendChild(b);
      }

      // 2列グリッドを適用
      act.style.display = 'grid';
      act.style.gridTemplateColumns = 'repeat(2, 1fr)';
      act.style.gap = '8px';
    }
  });
}

/* 初期化：描画が済んだあとに一度実行
   - 自前の renderHistory() をお持ちなら、その直後でもOK */
window.addEventListener('DOMContentLoaded', () => setTimeout(slimHistoryUI, 0));

(function(){
  const nav = document.getElementById('app2-nav');
  if (!nav) return;

  // 既存のボタン群に一括・個別ボタンを追加
  const bulkBtn = document.createElement('button');
  bulkBtn.id = 'scrollToBulk';
  bulkBtn.textContent = '一括';

  const indivBtn = document.createElement('button');
  indivBtn.id = 'scrollToIndiv';
  indivBtn.textContent = '個別';

  // nav 内に重複防止して追加
  if (!document.getElementById('scrollToBulk')) {
    nav.insertBefore(bulkBtn, nav.children[1] || null);
  }
  if (!document.getElementById('scrollToIndiv')) {
    nav.insertBefore(indivBtn, nav.children[2] || null);
  }

  // スクロールイベント
  bulkBtn.addEventListener('click', () => {
    const grid = document.getElementById('bulkGrid');
    if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  indivBtn.addEventListener('click', () => {
    const firstForm = document.querySelector('#app2 .group, #app2 .bottle-form');
    if (firstForm) firstForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  // グリッドが存在しない場合は非表示にする
  function updateButtonVisibility() {
    const gridVisible = !!document.getElementById('bulkGrid');
    bulkBtn.style.display = gridVisible ? '' : 'none';
    indivBtn.style.display = gridVisible ? '' : 'none';
  }

  // 初期化
  updateButtonVisibility();
  const observer = new MutationObserver(updateButtonVisibility);
  observer.observe(document.body, { childList: true, subtree: true });
})();



//app2個別一括スクロール関数開始

(function(){
  const nav = document.getElementById('app2-nav');
  if (!nav) return;

  // ===== 画面に見えているか判定 =====
  function isVisible(el){
    if (!el) return false;
    const cs = getComputedStyle(el);
    if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
    const r = el.getBoundingClientRect();
    return r.width > 0 && r.height > 0;
  }

  // ===== 固定ヘッダ＋微調整付きスクロール =====
  function getBaseOffset(){
    const tabs  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tabs-h'))   || 56;
    const sub   = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--subnav-h')) || 50;
    return tabs + sub + 10; // 既定の余白
  }
  function scrollToAnchor(anchorEl, extraAdjust = 0){
    if (!anchorEl) return;
    const top = anchorEl.getBoundingClientRect().top + window.scrollY - (getBaseOffset() - extraAdjust);
    window.scrollTo({ top, behavior: 'smooth' });
  }

  // ===== ボタン生成（重複防止） =====
  function ensureButton(id, label, index){
    let btn = document.getElementById(id);
    if (!btn){
      btn = document.createElement('button');
      btn.id = id; btn.type = 'button'; btn.textContent = label;
      nav.insertBefore(btn, nav.children[index] || null);
    }
    return btn;
  }
  const bulkBtn  = ensureButton('scrollToBulk',  '一括', 1);
  const indivBtn = ensureButton('scrollToIndiv', '個別', 2);

  // ===== 微調整値（PC/SPで少し変える） =====
  const mq = window.matchMedia('(max-width:700px)');
  function getAdjust(){
    const sp = mq.matches;
    return {
      bulk : sp ? 10 : 6,   // ← SS1 の“表ヘッダがちょうど出る”感じ
      indiv: sp ? 18 : 14   // ← SS2 の“個別フォームの見出しが収まる”感じ
    };
  }

    // ===== クリック挙動 =====
  bulkBtn.addEventListener('click', () => {
    const gridHead = document.querySelector('#bulkGrid thead') || document.getElementById('bulkGrid');
    scrollToAnchor(gridHead, getAdjust().bulk);
  });

  indivBtn.addEventListener('click', () => {
    // キャスト名フィールドを基準にスクロール
    const castInput = document.getElementById('castName');
    if (castInput) {
      // オフセット計算を統一関数から取得
      const offset = getBaseOffset() + 25;  // 上に少し余白を残して止まるよう調整
      const y = castInput.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: y, behavior: 'smooth' });
    } else {
      // フォールバック（旧ロジック）
      const firstIndiv = document.querySelector('#app2 .group, #app2 .bottle-form');
      scrollToAnchor(firstIndiv, getAdjust().indiv);
    }
  });

  // ===== 表示制御（App2かつ #bulkGrid が可視のときだけ） =====
  function updateButtons(){
    const isApp2 = document.body.getAttribute('data-active-app') === 'app2';
    const grid   = document.getElementById('bulkGrid');
    const show   = isApp2 && isVisible(grid);
    bulkBtn.style.display  = show ? '' : 'none';
    indivBtn.style.display = show ? '' : 'none';
  }
  updateButtons();

  // 監視（タブ切替・表示切替・スタイル変更）
  const mo = new MutationObserver(updateButtons);
  mo.observe(document.body, {
    childList: true, subtree: true, attributes: true,
    attributeFilter: ['data-active-app','class','style']
  });
  mq.addEventListener?.('change', () => {}); // 端末幅で補正値が切替るが、スクロール時に都度取得するので処理は不要

  window.addEventListener('resize', updateButtons);
  document.addEventListener('click', (e)=>{
    if (e.target.closest('#app2') && (e.target.matches('button,[role="button"]'))) {
      requestAnimationFrame(updateButtons);
    }
  });
})();

//個別一括スクロール関数終了




//app2一括入力JS開始
(function(){

// === カラム定義 ============================================================
const COLS = [
  { key:'name', type:'text', header:'氏名', cls:'bulk-name' },
  { key:'exp', type:'check', header:'体/貸', cls:'bulk-exp' },
  { key:'send', type:'num', header:'送迎', cls:'bulk-send' },
  { key:'f', type:'num', header:'F1' },
  { key:'f2', type:'num', header:'F2' },
  { key:'jounai', type:'num', header:'場内' },
  { key:'honshiri', type:'num', header:'本指' },
  { key:'douhan', type:'num', header:'同伴' },
  { key:'eda', type:'num', header:'枝' },
  { key:'help', type:'num', header:'HE' },
  { key:'set40', type:'num', header:'40' },
  { key:'set20', type:'num', header:'20' },
  { key:'vip', type:'num', header:'VIP' },
  { key:'a', type:'num', header:'A' },
  { key:'b', type:'num', header:'B' },
  { key:'c', type:'num', header:'C' },
  { key:'d', type:'num', header:'D' },
  { key:'e', type:'num', header:'E' },
  { key:'btl_detail', type:'text', header:'品名' },
  { key:'btl_split', type:'num', header:'割' },
  { key:'btl_qty', type:'num', header:'数量' },
  { key:'btl_amount', type:'num', header:'金額' }
];

// === ボトルオプション抽出（簡略版・副作用なし） ===========================
function getBottleOptionsHTML() {
  // 通常フォームに既にセレクトがある場合はそれを優先（同一ソースに揃う）
  const inPage = document.querySelector('#bottleFormsContainer select.bottleDetails');
  if (inPage && inPage.innerHTML.trim()) {
    return inPage.innerHTML;
  }
  // 無いときはフォールバック（↑の定数）を必ず返す
  return BOTTLE_OPTIONS_HTML;
}

// === サブ行追加・削除 =======================================================
function getBottleSubrows(mainTr){
  const arr = [];
  let n = mainTr.nextElementSibling;
  while(n && n.classList.contains('btl-subrow')){
    arr.push(n);
    n = n.nextElementSibling;
  }
  return arr;
}

function addBottleSubrow(mainTr) {
  const grid = document.getElementById('bulkGrid');
  const cols = grid?.tHead?.rows?.[0]?.cells?.length || 0;

  // 「退」列がまだ存在しない場合でも位置がズレないように補正
  const hasLeaveCol = !!grid.querySelector('.bulk-leave-head');
  const start = cols - (hasLeaveCol ? 5 : 4);  // ← ← ← 修正版

  const tr = document.createElement('tr');
  tr.className = 'btl-subrow';

  let html = '';
  for (let i = 0; i < start; i++) html += '<td class="btl-pad"></td>';
  html += `
    <td class="btl-detail">
      <select class="bottleDetails">${getBottleOptionsHTML()}</select>
      <input class="bottleFreeText" type="text" placeholder="品名（その他）" style="display:none;">
    </td>
    <td><input class="splitCount" inputmode="numeric" placeholder="割"></td>
    <td><input class="bottleQuantity" inputmode="numeric" placeholder="数"></td>
    <td><input class="bottleAmount" inputmode="numeric" placeholder="金額"></td>
  `;
  tr.innerHTML = html;
  mainTr.insertAdjacentElement('afterend', tr);
}


// === サブ行削除を行う共通関数 ===
function removeBottleSubrow(mainTr, targetSub = null) {
  const tbody = mainTr.parentElement;
  if (!tbody) return;

  // サブ行をすべて取得
  const subs = [];
  let cur = mainTr.nextElementSibling;
  while (cur && cur.classList.toString().includes('btl-subrow')) {
    subs.push(cur);
    cur = cur.nextElementSibling;
  }

  if (subs.length === 0) return;

  // targetSubがあればそれを、なければ最後を削除
  const target = targetSub && subs.includes(targetSub) ? targetSub : subs.at(-1);
  if (target) target.remove();

  // カウント更新とマイナスボタン制御
  const remain = subs.length - 1;
  mainTr.dataset.bottleCount = String(Math.max(remain, 0));
  const minusBtn = mainTr.querySelector('.btl-minus');
  if (minusBtn) {
    if (remain <= 0) minusBtn.disabled = true;
    else minusBtn.disabled = false;
  }
}
// === テーブル構築 ===========================================================
function buildGrid(n){
  const grid  = document.getElementById('bulkGrid');
  const thead = grid.querySelector('thead');
  const tbody = grid.querySelector('tbody');
  if(!thead || !tbody) return;

  grid.querySelector('colgroup')?.remove();

  const widths = [
    "2.8%","9%","3%","5%",
    "4%","4%","4%","4%","4%","4%","4%",
    "3.5%","3.5%","4%","3.5%","3.5%","3.5%","3.5%","3.5%",
    "12%","4%","4%","8%"
  ];
  const cg = document.createElement('colgroup');
  widths.forEach(w => { const c = document.createElement('col'); c.style.width = w; cg.appendChild(c); });
  grid.insertBefore(cg, grid.firstChild);

  thead.innerHTML = '';
  const trh = document.createElement('tr');
  const thNo = document.createElement('th'); thNo.textContent = '#'; trh.appendChild(thNo);
  COLS.forEach(c => { const th = document.createElement('th'); th.textContent = c.header; trh.appendChild(th); });
  thead.appendChild(trh);

  tbody.innerHTML = '';
  for (let i = 1; i <= n; i++){
    const tr = document.createElement('tr');
    tr.className = 'bulk-mainrow';
    let html = `
      <td>${i}</td>
      <td><input class="bulk-name" placeholder="氏名"></td>
      <td style="text-align:center;"><input type="checkbox" class="bulk-exp"></td>
      <td><input class="bulk-send" inputmode="numeric" placeholder="送迎"></td>
    `;
    const placeholders = {
  f: 'F1', f2: 'F2',
  jounai: '場内', honshiri: '本指', douhan: '同伴', eda: '枝', help: 'HE',
  set40: '40', set20: '20', vip: 'VIP',
  a: 'A', b: 'B', c: 'C', d: 'D', e: 'E'
};
['f','f2','jounai','honshiri','douhan','eda','help','set40','set20','vip','a','b','c','d','e']
  .forEach(k => {
    const ph = placeholders[k] || '';
    html += `<td><input data-k="${k}" class="bulk-num" inputmode="numeric" placeholder="${ph}"></td>`;
  });
    html += `
      <td class="btl-anchor">
        <div class="btl-toolbar">
          <button type="button" class="btl-plus mini-btn">＋</button>
          <button type="button" class="btl-minus mini-btn">－</button>
        </div>
      </td>
      <td></td><td></td><td></td>
    `;
    tr.innerHTML = html;
    tbody.appendChild(tr);
  }
  window.scrollTo({ top: 0, behavior: 'smooth' });
  applyApp2MobileView();
}

// === 一括登録 ===============================================================
async function bulkRegister(){
  const tb=document.querySelector('#bulkGrid tbody');
  if(!tb) return alert('内部テーブルが見つかりません');
  const mains=[...tb.querySelectorAll('.bulk-mainrow')];
  const rows=mains.map(m=>{
    const nums={};
    ['f','f2','jounai','honshiri','douhan','eda','help','set40','set20','vip','a','b','c','d','e']
      .forEach(k=>nums[k]=parseInt(m.querySelector(`[data-k="${k}"]`)?.value||0));
    const bottles=[];
    let n=m.nextElementSibling;
    while(n&&n.classList.contains('btl-subrow')){
      bottles.push({
        detail:n.querySelector('.bottleDetails')?.selectedOptions[0]?.textContent||'',
        split:n.querySelector('.splitCount')?.value||'',
        qty:n.querySelector('.bottleQuantity')?.value||'',
        amount:parseInt((n.querySelector('.bottleAmount')?.value||'0').replace(/,/g,''))||0
      });
      n=n.nextElementSibling;
    }
    return {
      name:m.querySelector('.bulk-name')?.value||'',
      exp:m.querySelector('.bulk-exp')?.checked||false,
      send:parseInt(m.querySelector('.bulk-send')?.value||0),
      nums,bottles
    };
  }).filter(r=>r.name||r.exp||r.send||Object.values(r.nums).some(v=>v>0)||r.bottles.length);
  if(!rows.length) return alert('入力がありません');
  if(!confirm(`${rows.length}人分を登録しますか？`)) return;
  for(const r of rows){
    setValue('castName',r.name);
    setChecked('experienceAndRental',r.exp);
    setValue('sendoffAmount',r.send);
    Object.entries(r.nums).forEach(([id,val])=>setValue(id,val));
    const cont=document.getElementById('bottleFormsContainer');
    if(cont){
      cont.innerHTML='';
      r.bottles.forEach(b=>{
        const f=createBottleForm(b.detail,b.split,b.qty,b.amount);
        cont.appendChild(f);
      });
    }
    if(typeof calculate==='function') calculate();
  }
  alert('一括登録完了');
}

function setValue(id,val){
  const el=document.getElementById(id);
  if(el){ el.value=val; el.dispatchEvent(new Event('input',{bubbles:true})); }
}
function setChecked(id,v){
  const el=document.getElementById(id);
  if(el){ el.checked=!!v; el.dispatchEvent(new Event('change',{bubbles:true})); }
}


// === 初期化 ================================================================
document.addEventListener('DOMContentLoaded',()=>{

  const panel=document.getElementById('bulkPanel');
  const toggle=document.getElementById('toggleBulkInput');
  const sel=document.getElementById('bulkRows');
  const clearBt=document.getElementById('bulkClear');
  const regBt=document.getElementById('bulkRegister');
  const grid=document.getElementById('bulkGrid');
  if(panel) panel.hidden=true;

  toggle?.addEventListener('click', () => {
    panel.hidden = !panel.hidden;
    if (!panel.hidden) {
      document.body.classList.add('bulk-wide');
      buildGrid(parseInt(sel?.value || 40, 10));
      window.scrollTo({ top: 0, behavior: 'smooth' });
      panel.setAttribute('tabindex', '-1');
      panel.focus({ preventScroll: false });
    } else {
      document.body.classList.remove('bulk-wide');
    }
  });

  sel?.addEventListener('change',()=>buildGrid(parseInt(sel.value||40,10)));
  clearBt?.addEventListener('click',()=>{
    document.querySelectorAll('.bulk-num,.bulk-name,.bulk-send').forEach(e=>e.value='');
    document.querySelectorAll('.bulk-exp').forEach(e=>e.checked=false);
    document.querySelectorAll('.btl-subrow').forEach(e=>e.remove());
  });

  regBt?.addEventListener('click',bulkRegister);

  grid?.addEventListener('click', e => {
  console.log('grid click detected', e.target);
    let main = e.target.closest('tr.bulk-mainrow');
    if (!main) {
      const sub = e.target.closest('tr.btl-subrow');
      if (sub) {
        let prev = sub.previousElementSibling;
        while (prev && !prev.classList.contains('bulk-mainrow')) prev = prev.previousElementSibling;
        main = prev;
      }
    }
    if (!main) return;

    // ＋ボタン → 追加
    if (e.target.closest('.btl-plus')) {
      addBottleSubrow(main);
      return;
    }

    // −ボタン → クリックした行を優先して削除
    if (e.target.closest('.btl-minus')) {
  console.log('--- Minus clicked ---');
  const sub = e.target.closest('tr.btl-subrow');
  console.log('sub:', sub);
  let mainTr = e.target.closest('tr.bulk-mainrow');
  console.log('mainTr initial:', mainTr);

  if (!mainTr && sub) {
    let prev = sub.previousElementSibling;
    while (prev && !prev.classList.contains('bulk-mainrow')) prev = prev.previousElementSibling;
    mainTr = prev;
  }
  console.log('mainTr resolved:', mainTr);

  if (mainTr) {
    console.log('Call removeBottleSubrow', mainTr, sub);
    removeBottleSubrow(mainTr, sub);
  } else {
    console.warn('mainTr not found');
  }
  return;
}

  }); // ← grid click をここで閉じる

  window.addEventListener('resize', applyApp2MobileView);
}); // ← DOMContentLoaded を閉じる

/* ==========================================================
   一括入力パネル：表示状態・内容の保持（完全版）
========================================================== */
document.addEventListener('DOMContentLoaded', () => {

  const PANEL_KEY = 'app2_bulkPanelVisible';
  const GRID_KEY  = 'app2_bulkGridData';
  const panel = document.getElementById('bulkPanel');
  const toggle = document.getElementById('toggleBulkInput');
  const grid = document.getElementById('bulkGrid');
  const sel = document.getElementById('bulkRows');

  if (!panel || !grid || !toggle) return;

  /* --- 一括入力グリッドの内容保存 --- */
  function saveBulkGridState() {
    const mains = [...grid.querySelectorAll('.bulk-mainrow')];
    const rows = mains.map(tr => {
      const row = {
        name: tr.querySelector('.bulk-name')?.value || '',
        exp: tr.querySelector('.bulk-exp')?.checked || false,
        send: tr.querySelector('.bulk-send')?.value || '',
        nums: {},
        bottles: []
      };
      tr.querySelectorAll('[data-k]').forEach(el => {
        row.nums[el.dataset.k] = el.value || '';
      });
      // サブ行（ボトル）
      let n = tr.nextElementSibling;
      while (n && n.classList.contains('btl-subrow')) {
        row.bottles.push({
          detail: n.querySelector('.bottleDetails')?.value || '',
          split: n.querySelector('.splitCount')?.value || '',
          qty: n.querySelector('.bottleQuantity')?.value || '',
          amount: n.querySelector('.bottleAmount')?.value || ''
        });
        n = n.nextElementSibling;
      }
      return row;
    });
    localStorage.setItem(GRID_KEY, JSON.stringify(rows));
  }

  /* --- 一括入力グリッドの復元 --- */
  function restoreBulkGridState() {
    const data = JSON.parse(localStorage.getItem(GRID_KEY) || '[]');
    if (!data.length) return;
    buildGrid(data.length);
    const mains = [...grid.querySelectorAll('.bulk-mainrow')];
    data.forEach((r, i) => {
      const tr = mains[i];
      if (!tr) return;
      tr.querySelector('.bulk-name').value = r.name || '';
      tr.querySelector('.bulk-exp').checked = !!r.exp;
      tr.querySelector('.bulk-send').value = r.send || '';
      for (const k in r.nums) {
        const el = tr.querySelector(`[data-k="${k}"]`);
        if (el) el.value = r.nums[k] || '';
      }
      if (r.bottles?.length) {
        r.bottles.forEach(b => {
          addBottleSubrow(tr);
          const last = tr.nextElementSibling;
          if (last?.classList.contains('btl-subrow')) {
            last.querySelector('.bottleDetails').value = b.detail || '';
            last.querySelector('.splitCount').value = b.split || '';
            last.querySelector('.bottleQuantity').value = b.qty || '';
            last.querySelector('.bottleAmount').value = b.amount || '';
          }
        });
      }
    });
  }

  /* --- 表示状態保存 --- */
  function savePanelState(visible) {
    localStorage.setItem(PANEL_KEY, visible ? '1' : '0');
  }

  /* --- 開閉ボタン押下時 --- */
  toggle.addEventListener('click', () => {
    const nowHidden = panel.hidden;
    savePanelState(!nowHidden);
    if (!nowHidden) {
      // 展開時に復元
      restoreBulkGridState();
    } else {
      // 格納時に保存
      saveBulkGridState();
    }
  });

  /* --- 入力変化で自動保存 --- */
  grid.addEventListener('input', e => {
    if (e.target.closest('.bulk-mainrow, .btl-subrow')) saveBulkGridState();
  });

  /* --- ページ再開時の復元 --- */
  const show = localStorage.getItem(PANEL_KEY) === '1';
  if (show) {
    panel.hidden = false;
    document.body.classList.add('bulk-wide');
    restoreBulkGridState();
  }

});


})(); // ← IIFE を閉じる



// 一括入力用のフォールバック選択肢（通常フォームが無くても出る）
// これだけを唯一のソースにする（<select>は含めない）
window.BOTTLE_OPTIONS_HTML = `
  <option value="">選択してください</option>
  <optgroup label="リステル等">
    <option value="リステル">リステル</option>
    <option value="パリ">パリ</option>
    <option value="マバム">マバム</option>
  </optgroup>
  <optgroup label="モエ">
    <option value="モエ白">モエ白</option>
    <option value="モエロゼ">モエロゼ</option>
    <option value="モエネク">モエネク</option>
    <option value="モエピカ">モエピカ</option>
  </optgroup>
  <optgroup label="ヴーヴ">
    <option value="ヴーヴ">ヴーヴ</option>
    <option value="ヴーヴホワイト">ヴーヴホワイト</option>
    <option value="ヴーヴローズ">ヴーヴローズ</option>
  </optgroup>
  <optgroup label="ベルエ">
    <option value="ベルエ">ベルエ</option>
    <option value="ベルエロゼ">ベルエロゼ</option>
  </optgroup>
  <optgroup label="ソウメイ">
    <option value="ソウメイ">ソウメイ</option>
  </optgroup>
  <optgroup label="ドンペリ">
    <option value="ドンペリ">ドンペリ</option>
    <option value="ドンペリルミナス">ドンペリルミナス</option>
    <option value="ドンペリロゼ">ドンペリロゼ</option>
    <option value="ドンペリルミナスロゼ">ドンペリルミナスロゼ</option>
    <option value="ドンペリP2">ドンペリP2</option>
    <option value="ドンペリゴールド">ドンペリゴールド</option>
  </optgroup>
  <optgroup label="アルマンド">
    <option value="アルマンド">アルマンド</option>
    <option value="アルマンドロゼ">アルマンドロゼ</option>
    <option value="アルマンドグリーン">アルマンドグリーン</option>
  </optgroup>
  <optgroup label="オリシャン">
    <option value="オリシャンR">オリシャンR</option>
    <option value="オリシャンB">オリシャンB</option>
  </optgroup>
  <optgroup label="焼酎・リキュール等">
    <option value="柚子小町">柚子小町</option>
    <option value="黒霧島">黒霧島</option>
    <option value="吉四六">吉四六</option>
    <option value="富乃宝山">富乃宝山</option>
    <option value="赤霧島">赤霧島</option>
  </optgroup>
  <optgroup label="ウイスキー">
    <option value="知多">知多</option>
    <option value="山崎">山崎</option>
  </optgroup>
  <optgroup label="ワイン">
    <option value="ベリンジャー">ベリンジャー</option>
  </optgroup>
  <optgroup label="テキーラ">
    <option value="テキカン">テキカン</option>
  </optgroup>
  <optgroup label="その他">
    <option value="枝">枝</option>
    <option value="その他">その他</option>
    <option value="保障補正">保障補正</option>
  </optgroup>
`;

// === 金額変換ユーティリティ ==========================================
// 入力 → 数値変換（カンマ除去・数値化）
function intSafe(v, d = 0) {
  const n = parseInt(String(v ?? '').toString().replace(/,/g,''), 10);
  return Number.isFinite(n) ? n : d;
}

// 100円未満切り捨て（例: 3750 → 3700）
function floor100(yen) {
  return Math.floor(intSafe(yen) / 100) * 100;
}

// === ボトル自動入力ルール ============================================
// キー：セレクトの value
// 値：{ split: 割人数, qty: 数量, amt: 金額 }
const bottleRules = {
  // --- リステル等 ---
  "リステル": { split: 1, qty: 1, amt: 6000 },
  "パリ": { split: 1, qty: 1, amt: 7500 },
  "マバム": { split: 1, qty: 1, amt: 17500 },

  // --- モエ ---
  "モエ白": { split: 1, qty: 1, amt: 15000 },
  "モエロゼ": { split: 1, qty: 1, amt: 17500 },
  "モエネク": { split: 1, qty: 1, amt: 20000 },
  "モエピカ": { split: 1, qty: 1, amt: 22500 },

  // --- ヴーヴ ---
  "ヴーヴ": { split: 1, qty: 1, amt: 16000 },
  "ヴーヴホワイト": { split: 1, qty: 1, amt: 17500 },
  "ヴーヴローズ": { split: 1, qty: 1, amt: 19000 },

  // --- ベルエ ---
  "ベルエ": { split: 1, qty: 1, amt: 70000 },
  "ベルエロゼ": { split: 1, qty: 1, amt: 140000 },

  // --- ソウメイ ---
  "ソウメイ": { split: 1, qty: 1, amt: 60000 },

  // --- ドンペリ ---
  "ドンペリ": { split: 1, qty: 1, amt: 50000 },
  "ドンペリルミナス": { split: 1, qty: 1, amt: 60000 },
  "ドンペリロゼ": { split: 1, qty: 1, amt: 70000 },
  "ドンペリルミナスロゼ": { split: 1, qty: 1, amt: 85000 },
  "ドンペリP2": { split: 1, qty: 1, amt: 150000 },
  "ドンペリゴールド": { split: 1, qty: 1, amt: 250000 },

  // --- アルマンド ---
  "アルマンド": { split: 1, qty: 1, amt: 85000 },
  "アルマンドロゼ": { split: 1, qty: 1, amt: 140000 },
  "アルマンドグリーン": { split: 1, qty: 1, amt: 200000 },

  // --- オリシャン ---
  "オリシャンR": { split: 1, qty: 1, amt: 12500 },
  "オリシャンB": { split: 1, qty: 1, amt: 30000 },

  // --- 焼酎・リキュール等 ---
  "柚子小町": { split: 1, qty: 1, amt: 5000 },
  "黒霧島": { split: 1, qty: 1, amt: 7500 },
  "吉四六": { split: 1, qty: 1, amt: 7500 },
  "富乃宝山": { split: 1, qty: 1, amt: 8500 },
  "赤霧島": { split: 1, qty: 1, amt: 10000 },

  // --- ウイスキー ---
  "知多": { split: 1, qty: 1, amt: 20000 },
  "山崎": { split: 1, qty: 1, amt: 35000 },

  // --- ワイン ---
  "ベリンジャー": { split: 1, qty: 1, amt: 10000 },

  // --- テキーラ ---
  "テキカン": { split: 1, qty: 5, amt: 35000 },

  // --- その他 ---
  "枝": { split: 1, qty: 1, amt: 200 },
  "その他": { split: 1, qty: 1, amt: 0 },
  "保障補正": { split: 1, qty: 1, amt: 0 },
};

// --- 履歴オプションを生成して追加する関数 ---
function appendBottleHistoryOptions(selectEl, historyList){
  const grp = document.createElement('optgroup');
  grp.label = '最近の登録（履歴）';

  historyList.forEach(item => {
    const o = document.createElement('option');
    const s = parseInt(item.splitCount || 1, 10);
    const q = parseInt(item.bottleQuantity || 1, 10);
    const a = parseInt(item.bottleAmount || 0, 10);
    o.textContent = `${item.bottleDetails}${s ? ` / 割${s}` : ''}${q ? ` / 数${q}` : ''}${a ? ` / ￥${a.toLocaleString()}` : ''}`;
    o.value = `hist:${item.bottleDetails}:${s||''}:${q||''}:${a||''}`;
    o.dataset.base  = item.bottleDetails || '';
    o.dataset.split = String(s || '');
    o.dataset.qty   = String(q || '');
    o.dataset.amt   = String(a || '');
    grp.appendChild(o);
  });

  [...selectEl.querySelectorAll('optgroup[label="最近の登録（履歴）"]')].forEach(n=>n.remove());
  selectEl.insertBefore(grp, selectEl.firstChild);
}


// === 自動入力処理本体 ================================================
function applySelectRule(selectEl) {
  const tr = selectEl.closest('.btl-subrow') || selectEl.closest('.bottle-form');
  const splitEl = tr.querySelector('.splitCount');
  const qtyEl   = tr.querySelector('.bottleQuantity');
  const amtEl   = tr.querySelector('.bottleAmount');

  const opt  = selectEl.selectedOptions && selectEl.selectedOptions[0];
  const val  = selectEl.value;
  const rule = bottleRules[val];

  // 1) 履歴由来オプション
  if (opt && (opt.dataset.split || opt.dataset.qty || opt.dataset.amt || opt.dataset.base)) {
    const baseName = opt.dataset.base || val;
    if (splitEl) splitEl.value = opt.dataset.split ?? '';
    if (qtyEl)   qtyEl.value   = opt.dataset.qty   ?? '';
    const savedAmt = parseInt(opt.dataset.amt || '0', 10) || 0;

    if (savedAmt) {
      amtEl.value = savedAmt ? savedAmt.toLocaleString() : '';
    } else {
      const base = bottleRules[baseName]?.amt ?? 0;
      const s = Math.max(1, parseInt(splitEl.value || '1', 10) || 1);
      const q = Math.max(1, parseInt(qtyEl.value   || '1', 10) || 1);
      const per   = Math.floor(base / s);
      const total = per * q;
      amtEl.value = total ? total.toLocaleString() : '';
    }

  } else if (rule) {
    // 2) 通常オプション
    if (splitEl && splitEl.value === '') splitEl.value = rule.split ?? '';
    if (qtyEl   && qtyEl.value   === '') qtyEl.value   = rule.qty   ?? '';
    if (amtEl)  { const v = Math.floor(rule.amt ?? 0).toLocaleString();
              if (amtEl.value === '') amtEl.value = v; }

  } else {
    // 3) その他
    if (splitEl) splitEl.value = '';
    if (qtyEl)   qtyEl.value   = '';
    if (amtEl)   amtEl.value   = '';
  }

  // 入力イベントを発火
  splitEl?.dispatchEvent(new Event('input',  { bubbles:true }));
  qtyEl  ?.dispatchEvent(new Event('input',  { bubbles:true }));
  amtEl  ?.dispatchEvent(new Event('input',  { bubbles:true }));
}

// === 一括入力フォーム用：金額再計算 ======================================
function updateBottleAmountForRow(tr) {
  const sel   = tr.querySelector('.bottleDetails');
  const split = intSafe(tr.querySelector('.splitCount')?.value || 1, 1);
  const qty   = intSafe(tr.querySelector('.bottleQuantity')?.value || 1, 1);
  const amtEl = tr.querySelector('.bottleAmount');

  const val = sel?.value || '';
  const base = bottleRules[val]?.amt ?? 0;
  const perPerson = floor100(base / Math.max(1, split));
  const total = perPerson * Math.max(1, qty);

  amtEl.value = total ? total.toLocaleString() : '';
}

// === 割・数量の変更で金額を自動再計算（グリッド版） ===
document.addEventListener('input', e => {
  if (!e.target || !e.target.closest('#bulkGrid')) return;
  if (e.target.classList.contains('splitCount') ||
      e.target.classList.contains('bottleQuantity')) {
    const tr = e.target.closest('.btl-subrow');
    if (tr) updateBottleAmountForRow(tr);
  }
});

// 予備：セレクト変更でも確実に再計算（既存と重複しても無害）
document.addEventListener('change', e => {
  if (!e.target || !e.target.closest('#bulkGrid')) return;
  if (e.target.classList.contains('splitCount') ||
      e.target.classList.contains('bottleQuantity')) {
    const tr = e.target.closest('.btl-subrow');
    if (tr) updateBottleAmountForRow(tr);
  }
});


// === ボトル選択時に自動入力 + 金額自動計算 ===============================
document.addEventListener('change', e => {
  if (e.target.classList.contains('bottleDetails')) {
    applySelectRule(e.target);

    const tr = e.target.closest('.btl-subrow');
    if (tr) updateBottleAmountForRow(tr);
  }
});

// ====== グリッド移動（Enter=縦 / Tab=横）完全停止版 ======
(function(){
  const grid = document.getElementById('bulkGrid');
  if (!grid) return;

  const isInvisible = (node) => node?.offsetParent === null;
  const isDisabledLike = (node) => !node || node.disabled || node.readOnly || isInvisible(node);
  const isBottleSpacerRow = (tr) =>
    tr?.classList?.contains('btl-subrow') || tr?.dataset?.rowType === 'bottle-subrow';

  function onGridNav(e){
  const key = e.key;
  if (e.isComposing) return;
  // ← Enter は新ナビが処理するので素通り
  if (key === 'Enter') return;
  // ここからは Tab 専用
  if (key !== 'Tab') return;

  const el = e.target;
  if (!(el instanceof HTMLElement)) return;
  if (!/^(INPUT|SELECT|TEXTAREA)$/.test(el.tagName)) return;
  if (!grid.contains(el)) return;

  // 同一行の左右（Tab/Shift+Tab）のみ面倒を見る
  const currentRow = el.closest('tr');
  if (!currentRow) return;

  const rowInputs = Array.from(currentRow.querySelectorAll('input, select, textarea'));
  const colIdx = rowInputs.indexOf(el);
  if (colIdx === -1) return;

  e.preventDefault(); // ここでだけ既定の Tab を止める

  const delta = e.shiftKey ? -1 : 1;
  const nextInRow = rowInputs[colIdx + delta];

  // 非表示/無効はスキップせず“何もしない”＝他ハンドラを止めない
  if (nextInRow && !nextInRow.disabled && nextInRow.offsetParent !== null) {
    nextInRow.focus();
    nextInRow.select?.();
    // ここはフォーカス済みなので他へ流さないでOK
    return;
  }

  // 見つからない/フォーカスできない場合は何もしない（他ハンドラに譲る）
  return;
}

  // capture=true で最優先捕捉し、他ハンドラより先に制御
  document.addEventListener('keydown', onGridNav, true);
})();




// === スマホ表示：氏名・体/貸・送迎 だけ表示（一本化） ==================
(function(){
  function applyApp2MobileView(){
    const grid = document.getElementById('bulkGrid');
    if (!grid || !grid.tHead || !grid.tBodies[0]) return;

    const isMobile = window.innerWidth <= 768;

    // ✅ モバイルでは colgroup を外して、隠した列の幅配分をリセット
    const cg = grid.querySelector('colgroup');
    if (isMobile && cg) cg.remove();

    // サブ行（ボトル行）はスマホで隠す
    grid.querySelectorAll('tbody tr.btl-subrow')
      .forEach(tr => tr.style.display = isMobile ? 'none' : '');

    const ths  = Array.from(grid.tHead.rows[0].cells || []);
    const rows = Array.from(grid.tBodies[0].rows || []);

    for (let i = 0; i < ths.length; i++){
      const colIndex = i + 1; // 1-based
      const show = !isMobile || (colIndex === 2 || colIndex === 3 || colIndex === 4);

      if (ths[i]) ths[i].style.display = show ? 'table-cell' : 'none';

      rows.forEach(tr => {
        if (tr.classList.contains('btl-subrow')) return;
        const td = tr.cells[i];
        if (td) td.style.display = show ? 'table-cell' : 'none';
      });
    }

    // 見た目補助
    const wrap = grid.closest('.bulk-grid-wrap');
    if (wrap) wrap.style.overflowX = isMobile ? 'hidden' : '';
    grid.style.tableLayout = 'fixed';
    grid.style.width = '100%';
    grid.style.borderCollapse = 'collapse';
  }

  // グローバルに公開（buildGrid 直後でも呼べるように）
  window.applyApp2MobileView = applyApp2MobileView;

  // 初期 & リサイズで適用
  document.addEventListener('DOMContentLoaded', applyApp2MobileView);
  window.addEventListener('load', applyApp2MobileView);
  window.addEventListener('resize', applyApp2MobileView);
})();


// =====================================================
// 履歴 → 一括入力へ一括復元（ボトル含む）
//  - くるくるオーバーレイ＋進捗%/件数バッジ付き
// =====================================================
document.addEventListener('click', async (e) => {
  if (!e.target || e.target.id !== 'bulkImportFromHistory') return;

  // ---------- 1) 表示部品の用意：中央HUD & 小バッジ ----------
  const ensureHUD = () => {
    let hud = document.getElementById('bulkHUD');
    if (!hud) {
      hud = document.createElement('div');
      hud.id = 'bulkHUD';
      hud.innerHTML = `
        <div class="bulkHUD-inner">
          <div class="bulkHUD-spinner"></div>
          <div class="bulkHUD-title">復元中...</div>
          <div class="bulkHUD-count" id="bulkHUDCount">0/0（0%）</div>
          <div class="bulkHUD-bar">
            <div class="bulkHUD-bar-fill" id="bulkHUDBar"></div>
          </div>
        </div>`;
      document.body.appendChild(hud);

      // HUDのスタイルをインラインで注入（CSS未読でも出る）
      const s = document.createElement('style');
      s.textContent = `
#bulkHUD{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  background:rgba(0,0,0,.60); z-index:999999;
}
#bulkHUD.show{ display:flex; animation:bulkHUDfade .15s ease-out; }
@keyframes bulkHUDfade{ from{opacity:0} to{opacity:1} }

#bulkHUD .bulkHUD-inner{
  min-width: min(640px, 86vw);
  max-width: 90vw;
  padding: 28px 26px 24px;
  border-radius: 16px;
  background: linear-gradient(180deg,#0b1a2a,#132a3f 60%,#0d1830);
  box-shadow: 0 10px 36px rgba(0,0,0,.45), 0 0 30px rgba(0,245,255,.20) inset;
  border: 1.5px solid rgba(0,245,255,.35);
  color: #d7faff;
  text-align: center;
  font-family: 'Orbitron',system-ui,sans-serif;
}

#bulkHUD .bulkHUD-title{
  font-size: clamp(18px, 2.2vw, 22px);
  letter-spacing:.08em;
  color:#9ee9ff; margin-top:8px; margin-bottom:6px;
  text-shadow: 0 0 10px rgba(0,245,255,.35);
}

#bulkHUD .bulkHUD-count{
  font-size: clamp(22px, 3vw, 28px);
  font-weight:700; letter-spacing:.04em;
  margin-bottom: 14px; color:#fff;
}

#bulkHUD .bulkHUD-bar{
  width: 100%; height: 18px; border-radius: 999px;
  background: rgba(0,245,255,.15);
  border: 1px solid rgba(0,245,255,.35);
  box-shadow: inset 0 0 10px rgba(0,245,255,.28);
  overflow: hidden;
}
#bulkHUD .bulkHUD-bar-fill{
  width:0%; height:100%;
  background: linear-gradient(90deg,#00f5ff,#62ffd0 70%);
  box-shadow: 0 0 18px rgba(0,245,255,.65);
  transition: width .12s ease;
}

#bulkHUD .bulkHUD-spinner{
  margin: 4px auto 10px;
  width: clamp(56px, 8vw, 72px); height: clamp(56px, 8vw, 72px);
  border: 4px solid rgba(0,245,255,.22);
  border-top-color:#00f5ff; border-radius:50%;
  animation: bulkSpin 1s linear infinite;
}
@keyframes bulkSpin { to { transform: rotate(360deg); } }

#bulkHUD.done .bulkHUD-title{ color:#b6ffd8; }
#bulkHUD.done .bulkHUD-count{ color:#b6ffd8; text-shadow:0 0 8px rgba(0,255,160,.35); }
#bulkHUD.done .bulkHUD-bar-fill{
  background: linear-gradient(90deg,#20ffb8,#c7ffd7);
  box-shadow: 0 0 18px rgba(32,255,184,.65);
}
      `;
      document.head.appendChild(s);
    }
    return hud;
  };

  const ensureBadge = (btn) => {
    let badge = document.getElementById('bulkRestoreProgress');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'bulkRestoreProgress';
      Object.assign(badge.style, {
        marginLeft:'8px', padding:'2px 8px', borderRadius:'999px',
        fontSize:'12px', background:'rgba(0,245,255,.15)',
        border:'1px solid rgba(0,245,255,.45)',
        boxShadow:'0 0 8px rgba(0,245,255,.35) inset', color:'#cfefff'
      });
      btn.insertAdjacentElement('afterend', badge);
    }
    return badge;
  };

  const hud   = ensureHUD();
  const badge = ensureBadge(e.target);

  // HUD表示（描画機会を与えてから重処理へ）
  hud.classList.remove('done'); hud.classList.add('show');
  hud.style.display = 'flex';
  await new Promise(r => setTimeout(r, 50)); // ← 描画確定のためのワンショット

  try {
    window.BULK_RESTORING = true;

    // ===== 設定 =====
    const FILL_OLD_TO_NEW = true;
    const RESTORE_WAIT_MS = 700;

    // ===== ユーティリティ =====
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    const setVal = (el, v, kind='input') => { if(!el) return; el.value = v ?? ''; el.dispatchEvent(new Event(kind,{bubbles:true})); };
    const clearSubrows = (mainRow) => {
      while (mainRow.nextElementSibling && mainRow.nextElementSibling.classList.contains('btl-subrow')) {
        mainRow.nextElementSibling.remove();
      }
    };
    const addAndGetSubrow = (mainRow) => {
  const grid = document.getElementById('bulkGrid');
  const cols = grid?.tHead?.rows?.[0]?.cells?.length || 0;

  // ★ 修正点：「退」列を考慮した調整
  // 新規追加と同じく cols - 5 に統一
  const pads = Math.max(0, cols - 5);

  const tr = document.createElement('tr');
  tr.className = 'btl-subrow';

  for (let i = 0; i < pads; i++) {
    const td = document.createElement('td');
    td.className = 'btl-pad';
    tr.appendChild(td);
  }

  tr.insertAdjacentHTML('beforeend', `
    <td class="btl-detail">
      <select class="bottleDetails">${(window.BOTTLE_OPTIONS_HTML || '<option value=""></option>')}</select>
      <input class="bottleFreeText" type="text" style="display:none;">
    </td>
    <td><input class="splitCount" inputmode="numeric" placeholder="割"></td>
    <td><input class="bottleQuantity" inputmode="numeric" placeholder="数"></td>
    <td><input class="bottleAmount" inputmode="numeric" placeholder="金額"></td>
  `);

  let anchor = mainRow;
  while (anchor.nextElementSibling && anchor.nextElementSibling.classList.contains('btl-subrow')) {
    anchor = anchor.nextElementSibling;
  }
  anchor.insertAdjacentElement('afterend', tr);
  return tr;
};


    // ===== 1) 履歴ノード =====
    let items = document.querySelectorAll('#app2-historySection .history-item');
    if (!items.length) {
      const list = document.getElementById('historyList');
      if (list) items = list.querySelectorAll('li');
    }
    items = Array.from(items);
    if (!items.length) throw new Error('復元できる履歴がありません。');
    if (FILL_OLD_TO_NEW) items.reverse();

    const total = items.length; let done = 0;
    const hudCount = document.getElementById('bulkHUDCount');
    const hudBar   = document.getElementById('bulkHUDBar');
    const updateProgress = () => {
      const pct = total ? Math.floor((done/total)*100) : 0;
      const label = `復元中...｜${done}/${total}（${pct}%）`;
      if (hudCount) hudCount.textContent = `${done}/${total}（${pct}%）`;
      if (hudBar)   hudBar.style.width = pct + '%';
      if (badge)    badge.textContent  = label;
    };
    updateProgress();

    // ===== 2) 行数合わせ =====
    const need = items.length;
    const rowsSel = document.getElementById('bulkRows');
    if (rowsSel) rowsSel.value = String(Math.max(need, parseInt(rowsSel.value||'0',10)||0));
    if (typeof buildGrid === 'function') buildGrid(need);
    const tbody = document.querySelector('#bulkGrid tbody');
    if (!tbody) throw new Error('一括入力テーブルが見つかりません。');

    // ===== 3) 復元ループ =====
    const QUANT_IDS = ['f','f2','jounai','honshiri','douhan','eda','help','set40','set20','vip','a','b','c','d','e'];
    let rowIndex = 0;
    for (const it of items) {
      const row = tbody.querySelectorAll('tr.bulk-mainrow')[rowIndex];
      if (!row) break;

      const restoreBtn = Array.from(it.querySelectorAll('button')).find(b => b.textContent.includes('復元'));
      if (!restoreBtn) { rowIndex++; continue; }

      restoreBtn.click();
      await sleep(RESTORE_WAIT_MS);

      setVal(row.querySelector('.bulk-name'), document.getElementById('castName')?.value, 'input');
      const exp = row.querySelector('.bulk-exp');
      if (exp) { exp.checked = !!document.getElementById('experienceAndRental')?.checked; exp.dispatchEvent(new Event('change', {bubbles:true})); }
      setVal(row.querySelector('.bulk-send'), document.getElementById('sendoffAmount')?.value, 'input');
      QUANT_IDS.forEach(id => { const v = document.getElementById(id)?.value || ''; const input = row.querySelector(`[data-k="${id}"]`); if (input) setVal(input, v, 'input'); });

      clearSubrows(row);
      const forms = Array.from(document.querySelectorAll('#bottleFormsContainer .bottle-form'));
      for (const f of forms) {
        const d = f.querySelector('.bottleDetails')?.value || '';
        const s = f.querySelector('.splitCount')?.value  || '';
        const q = f.querySelector('.bottleQuantity')?.value || '';
        const a = f.querySelector('.bottleAmount')?.value || '';
        if (!d && !s && !q && !a) continue;
        const sub = addAndGetSubrow(row); if (!sub) continue;
        const sel = sub.querySelector('.bottleDetails'); if (sel) sel.value = d;
        setVal(sub.querySelector('.splitCount'), s, 'input');
        setVal(sub.querySelector('.bottleQuantity'), q, 'input');
        setVal(sub.querySelector('.bottleAmount'), a, 'input');
        if (typeof updateBottleAmountForRow === 'function') updateBottleAmountForRow(sub);
      }

      rowIndex++; done++;
      updateProgress();
      await new Promise(r => requestAnimationFrame(r)); // ← 描画更新を保証
    }

    // 仕上げ
    document.querySelectorAll('#bulkGrid input')
      .forEach(el => el.dispatchEvent(new Event('input', { bubbles:true })));

    // 完了演出
    hud.classList.add('done');
    if (hudCount) hudCount.textContent = `${done}/${total}（100%）`;
    if (badge) {
      badge.textContent = `復元完了｜${done}/${total}（100%）`;
      badge.style.background = 'rgba(0,255,160,.18)';
      badge.style.borderColor = 'rgba(0,255,160,.5)';
      badge.style.boxShadow = '0 0 10px rgba(0,255,160,.35) inset';
      setTimeout(()=>badge.remove(), 2500);
    }
  } catch (err) {
    console.error(err);
    if (badge) {
      badge.textContent = '復元エラー';
      badge.style.background = 'rgba(255,80,80,.18)';
      badge.style.borderColor = 'rgba(255,80,80,.5)';
      badge.style.boxShadow = '0 0 10px rgba(255,80,80,.35) inset';
    }
  } finally {
    // HUDは少し残してからフェードアウト
    setTimeout(()=>{
      const hud = document.getElementById('bulkHUD');
      if (hud) hud.style.display = 'none';
      window.BULK_RESTORING = false;
    }, 600);
  }
});


(function () {
  const grid = document.getElementById('bulkGrid');
  if (!grid) return;

  const clearHighlight = () => {
    grid.querySelectorAll('tr.hl-row').forEach(el => el.classList.remove('hl-row'));
    grid.querySelectorAll('.hl-col').forEach(el => el.classList.remove('hl-col'));
  };

  grid.addEventListener('focusin', (e) => {
    const td = e.target.closest('td');
    if (!td || !grid.contains(td)) return;

    clearHighlight();

    // 行をハイライト
    const tr = td.parentElement;
    tr.classList.add('hl-row');

    // 列インデックスを取得
    const idx = td.cellIndex;
    if (idx < 0) return;

    // ヘッダの同列をハイライト
    const th = grid.tHead && grid.tHead.rows && grid.tHead.rows[0] && grid.tHead.rows[0].cells[idx];
    if (th) th.classList.add('hl-col');

    // 本文の同列をハイライト
    grid.tBodies[0] && Array.from(grid.tBodies[0].rows).forEach(r => {
      const c = r.cells[idx];
      if (c) c.classList.add('hl-col');
    });
  });

  // グリッド外へフォーカスが抜けたら消す（内部移動はfocusinで上書き）
  grid.addEventListener('focusout', () => {
    setTimeout(() => {
      if (!grid.contains(document.activeElement)) clearHighlight();
    }, 0);
  });
})();

function addAndGetSubrow(mainRow){
  if (typeof addBottleSubrow === 'function') addBottleSubrow(mainRow);
  if (typeof getBottleSubrows === 'function') {
    const subs = getBottleSubrows(mainRow);
    return subs[subs.length - 1] || null;
  }
  return null;
}

/* =========================================================
   一括入力グリッド：選択→まとめて出力
   - # 列にチェックボックス追加（見出しに全選択）
   - 選択行だけ通常フォームへ流し込んで既存の出力ボタンを順にClick
   --------------------------------------------------------- */

(function(){
  const QUANT_IDS = ['f','f2','jounai','honshiri','douhan','eda','help','set40','set20','vip','a','b','c','d','e'];
  const WAIT_BETWEEN_PRINT_MS = 500;   // 1件出力→次までの待機（必要なら調整）

  // 1) ツールバー（ボタン）をグリッド上に追加
  function ensureToolbar(){
    if (document.getElementById('bulkPrintToolbar')) return;
    const gridWrap = document.querySelector('#bulkGrid')?.closest('.bulk-grid-wrap') || document.querySelector('#bulkGrid')?.parentElement;
    if (!gridWrap) return;
    const bar = document.createElement('div');
    bar.id = 'bulkPrintToolbar';
    bar.style.display = 'flex';
    bar.style.gap = '8px';
    bar.style.margin = '8px 0';

    bar.innerHTML = `
      <button type="button" id="bulkPrintSelected" class="btn">選択行を出力</button>
      <button type="button" id="bulkToggleChecks" class="btn">選択反転</button>
    `;
    gridWrap.insertAdjacentElement('beforebegin', bar);
  }

  // 2) #列をチェックボックス化（見出し=全選択、各行=個別選択）
  function installCheckboxColumn(){
    const grid = document.getElementById('bulkGrid');
    if (!grid) return;

    // ヘッダ
    const th0 = grid.tHead?.rows?.[0]?.cells?.[0];
    if (th0 && !th0.querySelector('input[type="checkbox"]')) {
      th0.style.width = '3em';
      th0.innerHTML = `<input type="checkbox" id="bulkCheckAll" aria-label="全選択">`;
    }

    // 各メイン行
    const rows = grid.tBodies?.[0]?.querySelectorAll('tr.bulk-mainrow') || [];
    rows.forEach((tr, i) => {
      const td0 = tr.cells?.[0];
      if (!td0) return;
      if (!td0.querySelector('input[type="checkbox"]')) {
        td0.innerHTML = `<input type="checkbox" class="bulk-check" aria-label="行${i+1}を選択">`;
      }
      // ← 追加：生成直後に活性/選択状態を更新
      updateRowCheckState(tr);
    });
  }

  // 3) グリッドの内容を通常フォームへ流し込む（既存IDへセット）
  function pushBulkRowToNormalForm(mainRow){
    if (!mainRow) return;

    // 氏名
    const name = mainRow.querySelector('.bulk-name')?.value ?? '';
    const nameEl = document.getElementById('castName');
    if (nameEl) { nameEl.value = name; nameEl.dispatchEvent(new Event('input', {bubbles:true})); }

    // 体験/貸出
    const exp = !!mainRow.querySelector('.bulk-exp')?.checked;
    const expEl = document.getElementById('experienceAndRental');
    if (expEl) { expEl.checked = exp; expEl.dispatchEvent(new Event('change', {bubbles:true})); }

    // 送迎
    const send = mainRow.querySelector('.bulk-send')?.value ?? '';
    const sendEl = document.getElementById('sendoffAmount');
    if (sendEl) { sendEl.value = send; sendEl.dispatchEvent(new Event('input', {bubbles:true})); }

    // 数値系（F, F2, …）
    QUANT_IDS.forEach(id => {
      const v = mainRow.querySelector(`[data-k="${id}"]`)?.value ?? '';
      const dest = document.getElementById(id);
      if (dest) { dest.value = v; dest.dispatchEvent(new Event('input', {bubbles:true})); }
    });

    // ボトルサブ行 → 通常フォームへ再構成
    // 既存のフォーム側コンテナを前提（ない場合はスキップ）
    const container = document.getElementById('bottleFormsContainer');
    if (container) {
      // 既存クリア
      container.querySelectorAll('.bottle-form').forEach(el => el.remove());

      // 一括サブ行を走査
      let anchor = mainRow.nextElementSibling;
      while (anchor && anchor.classList.contains('btl-subrow')) {
        const detail = anchor.querySelector('.bottleDetails')?.value ?? '';
        const split  = anchor.querySelector('.splitCount')?.value ?? '';
        const qty    = anchor.querySelector('.bottleQuantity')?.value ?? '';
        const amt    = anchor.querySelector('.bottleAmount')?.value ?? '';

        // 既存の新規追加API/関数があればそれを使う（なければ素直にDOM生成）
        const form = document.createElement('div');
        form.className = 'bottle-form';
        form.innerHTML = `
          <div class="left-group">
            <select class="bottleDetails">${window.BOTTLE_OPTIONS_HTML || '<option value=""></option>'}</select>
          </div>
          <input class="splitCount" inputmode="numeric">
          <input class="bottleQuantity" inputmode="numeric">
          <input class="bottleAmount" inputmode="numeric">
        `;
        container.appendChild(form);

        const sel = form.querySelector('.bottleDetails');
        const sEl = form.querySelector('.splitCount');
        const qEl = form.querySelector('.bottleQuantity');
        const aEl = form.querySelector('.bottleAmount');

        if (sel) { sel.value = detail; sel.dispatchEvent(new Event('change', {bubbles:true})); }
        if (sEl) { sEl.value = split;  sEl.dispatchEvent(new Event('input',  {bubbles:true})); }
        if (qEl) { qEl.value = qty;    qEl.dispatchEvent(new Event('input',  {bubbles:true})); }
        if (aEl) { aEl.value = amt;    aEl.dispatchEvent(new Event('input',  {bubbles:true})); }

        anchor = anchor.nextElementSibling;
      }
    }
  }

  // 4) まとめて出力（選択行を順に通常フォームへ流し→既存の出力ボタンをClick）

async function printSelectedRows() {
  const grid = document.getElementById('bulkGrid');
  if (!grid) return alert('一括入力テーブルが見つかりません。');

  const selected = Array.from(grid.tBodies?.[0]?.querySelectorAll('tr.bulk-mainrow') || [])
    .filter(tr => {
      const on = tr.querySelector('.bulk-check')?.checked;
      return on && !isBulkRowEmpty(tr);
    });

  if (!selected.length) return alert('出力する行をチェックしてください。');

  const WAIT_BETWEEN_PRINT_MS = 400; // ウィンドウ閉後の安全マージン

  for (const row of selected) {
    // 1) グリッド → 通常フォームへ反映
    pushBulkRowToNormalForm(row);

    // 2) 印刷ウィンドウを開く（preparePrintApp2 → openPrintApp2がwindow.openを返すように改修済み前提）
    let win = null;
    try {
      if (typeof window.preparePrintApp2 === 'function') {
        // preparePrintApp2が内部でopenPrintApp2を呼び出しwindowを返すよう改修済みとする
        win = await window.preparePrintApp2();
      }
    } catch (e) {
      console.error('印刷呼び出しエラー:', e);
    }

    // 3) ウィンドウが閉じるまで待つ
    await waitForWindowClose(win);

    // 4) 少し間を空けて次へ
    await new Promise(r => setTimeout(r, WAIT_BETWEEN_PRINT_MS));
  }

  alert('すべての印刷が完了しました。');
}

/**
 * 印刷ウィンドウが閉じられるまで待つPromise
 */
function waitForWindowClose(win) {
  return new Promise(resolve => {
    if (!win || win.closed) return resolve();
    const timer = setInterval(() => {
      if (win.closed) {
        clearInterval(timer);
        resolve();
      }
    }, 300);
  });
}


  // 5) イベント束ね
  function bindEvents(){
    // 全選択
    document.addEventListener('change', e => {
      if (e.target && e.target.id === 'bulkCheckAll') {
        const on = !!e.target.checked;
        document.querySelectorAll('#bulkGrid .bulk-check').forEach(cb => {
        if (!cb.disabled) cb.checked = on;  // 空行(=disabled)は触らない
        });
      }
    });
    // 反転
    document.addEventListener('click', e => {
      if (e.target && e.target.id === 'bulkToggleChecks') {
        document.querySelectorAll('#bulkGrid .bulk-check').forEach(cb => { cb.checked = !cb.checked; });
      }
    });
    // 選択出力
    document.addEventListener('click', e => {
      if (e.target && e.target.id === 'bulkPrintSelected') {
        printSelectedRows();
      }
    });

    // グリッドが再構築されたらチェック列を再注入（行数変更・再描画に対応）
    const mo = new MutationObserver(() => installCheckboxColumn());
    const tbody = document.querySelector('#bulkGrid tbody');
    if (tbody) mo.observe(tbody, { childList: true, subtree: false });

    // tbody内の入力変化で、その行の状態を更新
document.addEventListener('input',  (e) => {
  if (!e.target || !e.target.closest('#bulkGrid')) return;
  const row = e.target.closest('tr.bulk-mainrow') || e.target.closest('tr')?.previousElementSibling;
  if (row && row.classList.contains('bulk-mainrow')) updateRowCheckState(row);
});
document.addEventListener('change', (e) => {
  if (!e.target || !e.target.closest('#bulkGrid')) return;
  const row = e.target.closest('tr.bulk-mainrow') || e.target.closest('tr')?.previousElementSibling;
  if (row && row.classList.contains('bulk-mainrow')) updateRowCheckState(row);
});

  }

  // 初期化
  function init(){
    ensureToolbar();
    installCheckboxColumn();
    bindEvents();
  }

  // DOMReady後に一度実行、既にグリッドがある/後から生成の両方に対応
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

// ===== 空行判定：氏名/体験/送迎/数量群/ボトルのどれも入ってなければ空 =====
function isBulkRowEmpty(mainRow){
  if (!mainRow) return true;

  // 氏名・送迎・体験(貸出)チェック
  const name = mainRow.querySelector('.bulk-name')?.value?.trim() || '';
  const send = mainRow.querySelector('.bulk-send')?.value?.trim() || '';
  const exp  = mainRow.querySelector('.bulk-exp')?.checked ? '1' : '';

  // F〜Eなど数量系
  const ids = (window.QUANT_IDS && Array.isArray(window.QUANT_IDS))
    ? window.QUANT_IDS
    : ['f','f2','jounai','honshiri','douhan','eda','help','set40','set20','vip','a','b','c','d','e'];

  let anyQuant = false;
  ids.forEach(k => {
    const v = mainRow.querySelector(`[data-k="${k}"]`)?.value?.trim() || '';
    if (v !== '') anyQuant = true;
  });

  // ボトル（直後の .btl-subrow 連鎖に何か入っているか）
  let anchor = mainRow.nextElementSibling;
  let anyBottle = false;
  while (anchor && anchor.classList.contains('btl-subrow')) {
    const d = anchor.querySelector('.bottleDetails')?.value?.trim() || '';
    const s = anchor.querySelector('.splitCount')?.value?.trim() || '';
    const q = anchor.querySelector('.bottleQuantity')?.value?.trim() || '';
    const a = anchor.querySelector('.bottleAmount')?.value?.trim() || '';
    if (d || s || q || a) { anyBottle = true; break; }
    anchor = anchor.nextElementSibling;
  }

  return !(name || send || exp || anyQuant || anyBottle);
}

// チェックボックスの活性/選択を空行に合わせて更新
function updateRowCheckState(mainRow){
  const cb = mainRow.querySelector('.bulk-check');
  if (!cb) return;
  const empty = isBulkRowEmpty(mainRow);
  cb.disabled = empty;
  if (empty) cb.checked = false;       // 空行は強制で外す
  mainRow.classList.toggle('bulk-empty', empty); // 見た目用（任意CSSで淡色化可）
}

//一括入力グリッドで入力のあるフォームのみ色を変えるJS開始

(function(){
  const grid = document.getElementById('bulkGrid');
  if (!grid) return;

  // 入力があるか判定（0 は入力あり扱い）
  function hasValue(el){
    if (el.type === 'checkbox') return el.checked;
    const v = (el.value ?? '').toString().trim();
    return v !== '';
  }

  function updateFilledState(el){
    const filled = hasValue(el);
    el.classList.toggle('is-filled', filled);
    const td = el.closest('td');
    if (td) td.classList.toggle('cell-filled', filled);
  }

  function scanAll(){
    grid.querySelectorAll('input, select, textarea').forEach(updateFilledState);
  }

  // 入力中の即時反映
  grid.addEventListener('input', (e)=>{
    if (e.target.matches('#bulkGrid input, #bulkGrid textarea')) updateFilledState(e.target);
  });
  grid.addEventListener('change', (e)=>{
    if (e.target.matches('#bulkGrid select, #bulkGrid input[type="checkbox"]')) updateFilledState(e.target);
  });

  // 初期スキャン
  scanAll();

  // 行の追加/復元にも追従
  const mo = new MutationObserver((mut)=>{
    for (const m of mut){
      m.addedNodes?.forEach(node=>{
        if (node.nodeType === 1){
          if (node.matches?.('input,select,textarea')) updateFilledState(node);
          node.querySelectorAll?.('input,select,textarea').forEach(updateFilledState);
        }
      });
    }
  });
  mo.observe(grid.tBodies[0] || grid, { childList: true, subtree: true });

  // 外から呼べる再スキャン（履歴一括復元の完了後などに）
  window.rescanBulkFilledState = scanAll;
})();

// === 入力フォームを選択した瞬間に中の文字を全選択する ===
document.addEventListener('focusin', (e) => {
  const el = e.target;
  if (!(el instanceof HTMLElement)) return;

  // input, textarea のみ対象（select はユーザー操作の都合で除外）
  if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
    // 数値入力でもフォーカス直後に全選択
    el.select?.();
  }
});

//一括入力グリッドで入力のあるフォームのみ色を変えるJS終了


/* ============================================================
   APP2 一括入力：右端に「退」チェック列を追加
   - 行の退勤フラグ（.bulk-leave）を導入
   - 退勤行はグレーアウト＆選択不可（印刷対象から除外）
   - 一括登録で「氏名→退勤フラグ」をlocalStorageへ保存
   - 一括復元時に退勤フラグを復元
   貼り付け位置：既存JSの一番最後（他関数を上書きしない）
============================================================ */

/* ==== 1) 見た目（CSS）をJSで挿入 ==== */
(function injectBulkLeaveStyles(){
  if (document.getElementById('bulk-leave-styles')) return;
  const css = `
    #bulkGrid thead th.bulk-leave-head { width:3.2em;text-align:center; }
    #bulkGrid tbody td.bulk-leave-cell { text-align:center; }
    #bulkGrid input.bulk-leave { transform:scale(1.05);cursor:pointer; }

    /* グレーアウト見た目（操作可・変更不可） */
    #bulkGrid tr.bulk-mainrow.is-leave td,
    #bulkGrid tr.btl-subrow.is-leave td {
    opacity: .45 !important;
    filter: grayscale(0.9);
    }


    /* 読み取り専用スタイル */
    #bulkGrid input[readonly],
    #bulkGrid select[data-readonly="1"] {
    background: rgba(100, 100, 100, 0.2) !important;
    color: #ccc !important;
    cursor: not-allowed !important;
    }

    /* ★例外：退チェック＆マイナスボタンは常に操作可 */
    #bulkGrid tr.is-leave input.bulk-leave,
    #bulkGrid tr.bulk-mainrow.is-leave .btl-minus,
    #bulkGrid tr.btl-subrow.is-leave   .btl-minus{
      pointer-events:auto!important;
    }
  `.trim();
  const s=document.createElement('style');
  s.id='bulk-leave-styles';
  s.textContent=css;
  document.head.appendChild(s);
})();

/* ==== 退勤列セットアップ ==== */
(function setupBulkLeaveColumn(){
  const grid=document.getElementById('bulkGrid');
  if(!grid) return;

  function ensureLeaveHead(){
    const thRow=grid.tHead?.rows?.[0];
    if(!thRow||thRow.querySelector('.bulk-leave-head'))return;
    const th=document.createElement('th');
    th.className='bulk-leave-head';
    th.textContent='退';
    th.style.width = '3%';
    thRow.appendChild(th);
  }

  function getSubrows(mainTr){
    const subs=[];
    let cur=mainTr.nextElementSibling;
    while(cur&&cur.classList.contains('btl-subrow')){
      subs.push(cur);
      cur=cur.nextElementSibling;
    }
    return subs;
  }


  /* ✅改修版：退勤ON/OFFで「選択可・変更不可」制御 */
function applyRowLeaveState(mainTr, isLeave) {
  const subs = getSubrows(mainTr);
  const all = [mainTr, ...subs];
  all.forEach(tr => tr.classList.toggle('is-leave', !!isLeave));

  // 退勤チェック自身の制御
  const sel = mainTr.querySelector('.bulk-check');
  if (sel) {
    if (isLeave) { sel.checked = false; sel.disabled = true; }
    else { sel.disabled = false; }
  }

  // 各入力要素の制御
  const allEls = [
    ...mainTr.querySelectorAll('input, select, button'),
    ...subs.flatMap(s => Array.from(s.querySelectorAll('input, select, button')))
  ];

  allEls.forEach(el => {
    const isMinus = el.classList.contains('btl-minus');
    const isLeaveCheck = el.classList.contains('bulk-leave');

    if (isLeave) {
      // --- 退勤中 ---
      if (el.tagName === 'INPUT' && !isLeaveCheck) {
        el.readOnly = true;        // ← 入力禁止だがフォーカス可
      } else if (el.tagName === 'SELECT') {
        el.dataset.readonly = '1'; // ← セレクト専用フラグ
        el.addEventListener('mousedown', preventSelectChange, { once: true });
      } else if (!isLeaveCheck && !isMinus) {
        el.disabled = true;        // ボタン類などは無効化
      }
    } else {
      // --- 通常 ---
      if (el.tagName === 'INPUT') el.readOnly = false;
      if (el.tagName === 'SELECT') delete el.dataset.readonly;
      el.disabled = false;
    }
  });
}

/* セレクト変更抑止 */
function preventSelectChange(e) {
  if (e.currentTarget.dataset.readonly === '1') {
    e.preventDefault();
    e.stopImmediatePropagation();
    return false;
  }
}


  function ensureLeaveCell(mainTr){
    if(mainTr.querySelector('td.bulk-leave-cell'))return;
    const td=document.createElement('td');
    td.className='bulk-leave-cell';
    td.innerHTML=`<input type="checkbox" class="bulk-leave" aria-label="退勤行">`;
    mainTr.appendChild(td);
  }

  const tbody=grid.tBodies?.[0];
  if(!tbody)return;
  ensureLeaveHead();

  const process=()=>{ ensureLeaveHead(); tbody.querySelectorAll('tr.bulk-mainrow').forEach(r=>ensureLeaveCell(r)); };
  process();
  new MutationObserver(process).observe(tbody,{childList:true,subtree:false});

  document.addEventListener('change',e=>{
    if(!e.target?.classList?.contains('bulk-leave'))return;
    const tr=e.target.closest('tr.bulk-mainrow');
    if(!tr)return;
    applyRowLeaveState(tr,e.target.checked);
  });

  window._bulkLeave={applyRowLeaveState,getSubrows,isLeave:tr=>!!tr?.classList?.contains('is-leave')};
})();

// 退行などで data-readonly="1" の <select> はキー操作でも値を変えさせない
document.addEventListener('keydown', (e) => {
  const el = e.target;
  if (!(el instanceof HTMLElement)) return;
  if (el.tagName !== 'SELECT') return;
  if (el.dataset.readonly !== '1') return;

  // 値が変わり得るキーをブロック（上下/左右/確定など）
  const k = e.key;
  const block = [
    'ArrowUp','ArrowDown','ArrowLeft','ArrowRight',
    'PageUp','PageDown','Home','End','Enter',' '
  ];
  if (block.includes(k)) {
    e.preventDefault();
    e.stopImmediatePropagation();
  }
}, true);


/* ============================================================
   共通：app2ナビゲーション（Enter / 矢印キー 両対応）
   - 退勤行・操作禁止セルを自動スキップ
============================================================ */

/* 有効フィールド取得関数 */
function getApp2ActiveFields(current) {
  const app2  = document.getElementById('app2');
  const grid  = document.getElementById('bulkGrid');
  if (!app2) return [];

  const inGrid = !!(current && grid && grid.contains(current));
  const scope  = inGrid ? grid : app2;

  const all = Array.from(scope.querySelectorAll('input, select, textarea'));
  return all.filter(el => {
    if (!el.offsetParent) return false;        // 非表示は除外
    if (el.disabled) return false;             // disabled は除外（退行で一部ボタン等）
    // ※ readonly / data-readonly は “フォーカスOK” にするため除外しない
    return true;
  });
}

// === 幾何学ベースの次候補探索（列ズレに強い） ===
// 幾何学ベース（左右 or 通常フォーム用／グリッド外）
// ※ 上下でもグリッド外ではこれを使う
function findNextByGeometry(fields, current, dir) {
  const rect = current.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top  + rect.height/ 2;

  let best = null, bestScore = Infinity;
  const vertical = (dir === 'down' || dir === 'up');
  const sign     = (dir === 'down') ? +1 : -1;

  for (const el of fields) {
    if (el === current) continue;
    const r  = el.getBoundingClientRect();
    const ex = r.left + r.width / 2;
    const ey = r.top  + r.height/ 2;

    if (vertical) {
      const dy = ey - cy;
      if (sign * dy <= 0) continue;     // 進行方向のみ
      const dx = Math.abs(ex - cx);
      const score = dy * 1000 + dx;     // 縦優先
      if (score < bestScore) { best = el; bestScore = score; }
    } else {
      // 左右は同じ行近傍のみ
      const dy = Math.abs(ey - cy);
      if (dy > 8) continue;
      const dx = ex - cx;
      if ((dir === 'right' && dx <= 0) || (dir === 'left' && dx >= 0)) continue;
      const score = Math.abs(dx);
      if (score < bestScore) { best = el; bestScore = score; }
    }
  }
  return best;
}

// 移動の入口：現在地に応じて探索範囲と手法を切り替え
function moveFocus(dir, current) {
  const grid = document.getElementById('bulkGrid');
  const inGrid = !!(grid && current && grid.contains(current));

  if (inGrid && (dir === 'down' || dir === 'up')) {
    // ← グリッド内の上下は “同列維持” アルゴリズムを必ず使用
    moveFocusGridVertical(current, dir);
    return;
  }

  // それ以外は近傍幾何学
  const fields = getApp2ActiveFields(current);
  const next = findNextByGeometry(fields, current, dir);
  if (next) {
    next.focus();
    next.select?.();
  }
}


// === 共通移動 ===
// グリッド行→次の「メイン行」へ（btl-subrow と退行を自動スキップ）
function moveFocusGridVertical(current, dir /* 'down' | 'up' */) {
  const grid = document.getElementById('bulkGrid');
  if (!grid) return;

  const curTr  = current.closest('tr');
  if (!curTr) return;

  // 現行行の列スロットを決める
  const rowSlots = Array.from(curTr.querySelectorAll('input, select, textarea'));
  const colIdx   = rowSlots.indexOf(current);
  if (colIdx < 0) return;

  // メイン行のみを縦走査対象にする（←ここは据え置き）
  const allRows = Array.from(grid.tBodies?.[0]?.rows || [])
    .filter(tr => tr.classList.contains('bulk-mainrow'));

  const r0 = allRows.indexOf(curTr);
  if (r0 < 0) return;

  const step = (dir === 'up') ? -1 : +1;
  let r = r0 + step;

  while (r >= 0 && r < allRows.length) {
    const tr = allRows[r];

    // ★退行でもフォーカス可能にするため “スキップしない”
    const cand = Array.from(tr.querySelectorAll('input, select, textarea'))[colIdx];

    // フォーカス可能なら移動（readonly/data-readonlyでもOK）
    if (cand && cand.offsetParent && !cand.disabled) {
      cand.focus();
      cand.select?.();
      return;
    }
    r += step;
  }
}



// === イベント統合（capture=true で最優先） ===
(function attachGridNavOnce(){
  if (window.__app2NavInstalled) return;
  window.__app2NavInstalled = true;

  document.addEventListener('keydown', (e) => {
    // app2 以外・対象外要素は無視
    const app2 = document.getElementById('app2');
    if (!app2 || !app2.classList.contains('active')) return;
    const target = e.target;
    if (!target || !target.closest('#app2')) return;
    if (!['INPUT','SELECT','TEXTAREA'].includes(target.tagName)) return;

    // Enter は常に “下へ” ＋ submit を完全阻止
    if (e.key === 'Enter') {
      e.preventDefault();
      e.stopPropagation();
      moveFocus('down', target);
      return;
    }

    // 矢印
    let dir = null;
    if (e.key === 'ArrowDown') dir = 'down';
    else if (e.key === 'ArrowUp') dir = 'up';
    else if (e.key === 'ArrowLeft') dir = 'left';
    else if (e.key === 'ArrowRight') dir = 'right';
    if (!dir) return;

    e.preventDefault();
    moveFocus(dir, target);
  }, true);
})();


//app2一括入力JS終了












/* ============================================================
   110万 Over ぷちゅん演出（target未定義対策・完全版）
   - #totalAmount が出現するまで待機してから初期化
   - 変数はローカルに閉じ込め、グローバル汚染を防止
   ============================================================ */

  window.CONGRATS_SFX_URL = './seven-flash.m4a?v=2';   // 同階層に保存
  // 任意の予備（あれば）
  // window.CONGRATS_SFX_FALLBACK = './seven-flash.mp3';

(function(){
  const THRESHOLD = 1100000,
        TARGET_SEL = '#totalAmount',
        IDLE_MS = 400,
        AUTO_CLOSE_MS = 4200;

  /* ========= 設定（音源URL） ========= */
  const SFX_URLS = [
    window.CONGRATS_SFX_URL      || './seven-flash.m4a',
    window.CONGRATS_SFX_FALLBACK || ''
  ].filter(Boolean);

  /* ========= オーディオ（WebAudio優先 / HTMLAudioフォールバック） ========= */
  let interacted = false;
  let audioCtx = null;     // WebAudio
  let audioBuf = null;     // デコード済みバッファ
  let htmlAudio = null;    // フォールバック

  // 初回ユーザー操作で解錠 & WebAudio 準備
  const userGestureGate = (() => {
    let resolveOnce;
    const p = new Promise(r => (resolveOnce = r));

    const unlock = async () => {
      interacted = true;
      window.removeEventListener('pointerdown', unlock, true);
      window.removeEventListener('keydown', unlock, true);
      window.removeEventListener('touchstart', unlock, true);

      try {
        // WebAudio context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // 事前デコード（先頭のURLで試行→失敗なら次）
        for (const u of SFX_URLS) {
          try {
            const res = await fetch(cacheBust(u));
            const buf = await res.arrayBuffer();
            audioBuf = await audioCtx.decodeAudioData(buf);
            console.info('[SFX] WebAudio decoded:', u);
            break;
          } catch (e) { /* 次の候補へ */ }
        }
      } catch (e) {
        console.warn('[SFX] WebAudio init failed, fallback to <audio>', e?.message);
      }

      // 失敗していたら <audio> 準備
      if (!audioBuf) {
        htmlAudio = await prepareHtmlAudio(SFX_URLS);
      }
      resolveOnce();
    };

    window.addEventListener('pointerdown', unlock, true);
    window.addEventListener('keydown',    unlock, true);
    window.addEventListener('touchstart', unlock, true);
    return () => p;
  })();

  const cacheBust = (u) => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();

  async function prepareHtmlAudio(urls) {
    for (const u of urls) {
      try {
        const el = new Audio();
        el.preload = 'auto';
        el.src = u;
        await onceCanPlay(el, 3500);
        el.id = 'congratsSfx';
        el.style.display = 'none';
        document.body.appendChild(el);
        console.info('[SFX] HTMLAudio ready:', u);
        return el;
      } catch { /* 次の候補 */ }
    }
    console.warn('[SFX] no playable HTMLAudio source');
    return null;
  }

  function onceCanPlay(el, timeout=3500){
    return new Promise((res, rej) => {
      const ok = () => { cleanup(); res(); };
      const ng = () => { cleanup(); rej(new Error('load-failed')); };
      const to = setTimeout(ng, timeout);
      const cleanup = () => {
        clearTimeout(to);
        el.removeEventListener('canplaythrough', ok);
        el.removeEventListener('canplay', ok);
        el.removeEventListener('error', ng);
      };
      el.addEventListener('canplaythrough', ok, {once:true});
      el.addEventListener('canplay', ok, {once:true});
      el.addEventListener('error', ng, {once:true});
      try { el.load(); } catch {}
    });
  }

  // ★ T0で発音：overlayを見せる直前に呼ぶ
  async function playSfxNow(){
    // ユーザー操作待ち（ロック解除）
    await userGestureGate();

    try {
      if (audioBuf && audioCtx) {
        const src = audioCtx.createBufferSource();
        src.buffer = audioBuf;
        src.connect(audioCtx.destination);
        src.start(0); // ← ゼロ起動
        return;
      }
      if (htmlAudio) {
        htmlAudio.currentTime = 0;
        await htmlAudio.play();
        return;
      }
      // どちらも準備できてない場合の最後のあがき
      htmlAudio = await prepareHtmlAudio(SFX_URLS);
      await htmlAudio?.play();
    } catch (e) {
      console.warn('[SFX] play failed:', e?.message);
    }
  }

  /* ========= スタイル（CRT消灯→滲み上がり） ========= */
  (function ensureStyle(){
    if (document.getElementById('crtCongratsStyle')) return;
    const st = document.createElement('style'); st.id='crtCongratsStyle';
    st.textContent = `
#crtCongratsOverlay{position:fixed;inset:0;z-index:2147483647;display:none;align-items:center;justify-content:center;flex-direction:column;background:#000;color:#fff;text-align:center;font-family:'Orbitron',system-ui,ui-sans-serif,sans-serif;}
#crtCongratsOverlay.show{display:flex;}
#crtCongratsOverlay .crt-line{position:absolute;left:0;right:0;top:50%;height:2px;background:#fff;box-shadow:0 0 20px #fff,0 0 40px rgba(255,255,255,.6);transform-origin:center center;animation:tubeOff .9s ease-in forwards;}
@keyframes tubeOff{0%{transform:scaleY(1) scaleX(1);opacity:1}60%{transform:scaleY(.06) scaleX(1);opacity:1}100%{transform:scaleY(.06) scaleX(0);opacity:0}}
#crtCongratsOverlay .msg{position:relative;z-index:2;opacity:0;filter:blur(12px);transform:translateY(8px);animation:msgGlowIn .9s cubic-bezier(.2,.65,.2,1) .95s forwards;}
#crtCongratsOverlay .msg .title{font-size:clamp(28px,6vw,56px);letter-spacing:.06em;margin-bottom:.25em;color:#bfffe9;text-shadow:0 0 18px rgba(0,245,255,.35),0 0 36px rgba(0,245,255,.2);}
#crtCongratsOverlay .msg .sub{font-size:clamp(16px,3.5vw,28px);letter-spacing:.04em;color:#eaffff;text-shadow:0 0 12px rgba(0,245,255,.25),0 0 26px rgba(0,245,255,.18);}
@keyframes msgGlowIn{0%{opacity:0;filter:blur(12px);transform:translateY(8px)}60%{opacity:1;filter:blur(5px);transform:translateY(2px)}100%{opacity:1;filter:blur(0);transform:translateY(0)}}
#crtCongratsOverlay.hide{animation:ovFade .3s ease-out forwards;}
@keyframes ovFade{to{opacity:0}}
`;
    document.head.appendChild(st);
  })();

  function ensureOverlay(){
    let ov = document.getElementById('crtCongratsOverlay');
    if (ov) return ov;
    ov = document.createElement('div');
    ov.id = 'crtCongratsOverlay';
    ov.innerHTML = `
      <div class="crt-line"></div>
      <div class="msg"><div class="title">Congratulations</div><div class="sub">1,100,000 yen Over</div></div>`;
    ov.addEventListener('click', ()=>{ ov.classList.add('hide'); setTimeout(()=>ov.remove(),320); });
    document.body.appendChild(ov);
    return ov;
  }

  // ★ 音→overlay表示（同時スタート）
  async function showOverlayT0(){
    const ov = ensureOverlay();
    // 1) 先に音を鳴らす（ゼロ起動）
    playSfxNow();
    // 2) 見せる（CSSアニメ発火）
    ov.classList.remove('hide');
    ov.classList.add('show');
    // 3) 自動クローズ
    setTimeout(()=>{ if(!ov.isConnected) return; ov.classList.add('hide'); setTimeout(()=>ov.remove(),320); }, AUTO_CLOSE_MS);
  }

  /* ========= #totalAmount 監視（超えた“瞬間”＋入力アイドル待ち） ========= */
  const parseAmount = (txt) => {
    const n = parseInt((txt||'').toString().replace(/[^\d\-]/g,''),10);
    return Number.isNaN(n) ? 0 : n;
  };

  function initWith(amtEl){
    let fired=false, lastVal=parseAmount(amtEl.textContent), timer=null;

    const isEditing = () => {
      const ae = document.activeElement;
      return ae && (/^(INPUT|TEXTAREA|SELECT)$/i.test(ae.tagName) || ae.isContentEditable);
    };

    const reset = () => { if(timer){ clearTimeout(timer); timer=setTimeout(tryFire, IDLE_MS); } };
    function tryFire(){
      if (isEditing()){ timer = setTimeout(tryFire, 200); return; }
      document.removeEventListener('input',  reset, true);
      document.removeEventListener('keydown', reset, true);
      fired = true;
      showOverlayT0();   // ← ここで音とアニメ同時
    }
    function schedule(){
      if (fired) return;
      if (timer) clearTimeout(timer);
      document.addEventListener('input',  reset, true);
      document.addEventListener('keydown', reset, true);
      timer = setTimeout(tryFire, IDLE_MS);
    }

    const mo = new MutationObserver(() => {
      const v = parseAmount(amtEl.textContent);
      if (!fired && v > THRESHOLD && lastVal <= THRESHOLD) schedule();
      lastVal = v;
    });
    mo.observe(amtEl, {childList:true, characterData:true, subtree:true});

    if (lastVal > THRESHOLD) setTimeout(schedule, 200);
  }

  function waitForAmountEl(){
    const el = document.querySelector(TARGET_SEL);
    if (el){ initWith(el); return; }
    const mo = new MutationObserver(()=>{
      const x = document.querySelector(TARGET_SEL);
      if (x){ mo.disconnect(); initWith(x); }
    });
    mo.observe(document.documentElement||document.body, {childList:true, subtree:true});
    setTimeout(()=>mo.disconnect(), 10000);
  }

  // 起動
  waitForAmountEl();

  // デバッグ：手動同時発火（コンソールで）
  window.__congratsTest = () => showOverlayT0();
})();

  //110万Overでぷちゅん演出終了




//EXCELエクスポート関連コード開始-------------------------------------------------------------------------

// ==== 0) SheetJS(XLSX) ローダー（1回だけ） ===========================
async function ensureXlsxReady(){
  if (window.XLSX) return;
  const srcs = ["./xlsx.full.min.js","https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"];
  for (const src of srcs){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script'); s.src=src;
        s.onload=res; s.onerror=()=>rej(); document.head.appendChild(s);
      });
      if (window.XLSX) return;
    }catch{}
  }
  throw new Error("XLSXを読み込めませんでした。");
}

// ==== 1) APP3 → 各店月計.xlsx 列マッピング ==========================
// ← これに置き換え
const COLMAP = {
  totalCustomers: "B",   // 入客
  historyIndexCount: "C",// 女
  maleAttendance: "D",   // 男子出勤人数
  cashSales: "E",        // 現金
  cardSales: "F",        // カード
  totalSales: "G",       // 総売上
  femaleSalary: "H",     // 女子給
  maleSalary: "I",       // 男子給
  catchBack: "J",         // キャッチバック
  scoutBack: "K",        // スカウトバック
  adviserFee: "L",       // 顧問
  driverFee: "M",        // Driver
  totalLaborCosts: "N",  // 人件費合計
  femaleTax: "O",        // 女子源泉費
  maleTax: "P",          // 男子源泉費
  totalTax: "Q",         // 源泉費合計
  alcohol: "R",          // 酒代
  receipt6: "S",          // 領収書
  totalExpenses: "Y",   // 経費合計
  grossProfit: "U",     // 純/粗利（表記に合わせて）
  remainingCash: "V"    // 現残
};


// ==== 2) 探索ディレクトリ（http/Live Server時のみ有効） ============
const SEARCH_DIRS = ["./","./excel/"];

// ==== 3) ファイル選択（フォールバック用） ==========================
function pickXlsxFile() {
  return new Promise((resolve) => {
    const input = document.createElement("input");
    input.type = "file"; input.accept = ".xlsx";
    input.onchange = () => resolve(input.files?.[0] || null);
    input.click();
  });
}

function readWorkDate(){
  const el =
    document.getElementById('workDate') ||
    document.querySelector('input[name="workDate"]') ||
    document.querySelector('#dateGroup input[type="date"]');
  if (!el) return '';

  // type="date"に最適
  if ('valueAsDate' in el && el.valueAsDate instanceof Date && !isNaN(el.valueAsDate)) {
    const d = el.valueAsDate;
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  // 文字でも拾う
  let v = (el.value || el.getAttribute('value') || el.textContent || '').trim();
  if (!v) return '';
  v = v.replace(/\./g,'/').replace(/-/g,'/'); // 区切り統一
  const m = v.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if (!m) return '';
  const y = m[1];
  const mm = String(parseInt(m[2],10)).padStart(2,'0');
  const dd = String(parseInt(m[3],10)).padStart(2,'0');
  return `${y}-${mm}-${dd}`;
}


// ==== 4) 月次ブック取得：fetchで見つかれば使用 / ダメなら選択 ====
// File System Access API対応：選んだファイルは本当の上書き保存も可能(HTTPS/localhost/対応ブラウザ)
async function ensureWorkbook(yyyy, mm){
  await ensureXlsxReady();

  const isFile = location.protocol === 'file:';
  const candidates = [`${yyyy}年${mm}月PA月計.xlsx`, `${Number(mm)}月PA月計.xlsx`];

  // (A) http(s)で動かしている場合は、既定パスから自動探索
  if (!isFile) {
    for (const dir of SEARCH_DIRS) {
      for (const base of candidates) {
        try {
          const resp = await fetch(dir + base);
          if (resp.ok) {
            const buf = await resp.arrayBuffer();
            return { wb: XLSX.read(buf, {type:"array"}), pickedName: base, fileHandle: null };
          }
        } catch {}
      }
    }
  }

  // (B) 見つからない or file:// → ユーザーに選んでもらう
  // 可能なら File System Access API を使用（上書き保存可）
  if ('showOpenFilePicker' in window && window.isSecureContext) {
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: 'Excel', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'] } }],
        excludeAcceptAllOption: false, multiple: false
      });
      const file = await handle.getFile();
      const buf = await file.arrayBuffer();
      return { wb: XLSX.read(buf, {type:"array"}), pickedName: file.name, fileHandle: handle };
    } catch {
      return {}; // キャンセル
    }
  } else {
    // 非対応 or 非セキュア環境(file://) → input=file フォールバック（保存はダウンロード）
    const file = await pickXlsxFile();
    if (!file) return {};
    const buf = await file.arrayBuffer();
    return { wb: XLSX.read(buf, {type:"array"}), pickedName: file.name, fileHandle: null };
  }
}

// ==== 5) メイン：A列「日」に合わせて上書き/末尾追記 ================
async function exportApp3MonthlyWrite(){
  const $ = (id)=>document.getElementById(id);
  const workDate = readWorkDate();  // ← 強化版で取得
  if (!workDate){
    alert("対象日付を入力してください。");
    console.debug('debug workDate elements:',
      document.getElementById('workDate'),
      document.querySelector('input[name="workDate"]'),
      document.querySelector('#dateGroup input[type="date"]'));
    return;
    }

  // 日付正規化
  const d = new Date(workDate.replace(/\./g,"/").replace(/-/g,"/"));
  if (isNaN(d)) { alert("日付形式が不正です。"); return; }
  const yyyy = d.getFullYear();
  const mm   = String(d.getMonth()+1).padStart(2,"0");
  const dd   = d.getDate();

  // ブック取得
  const { wb, pickedName, fileHandle } = await ensureWorkbook(yyyy, mm);
  if (!wb) return;

  // シート取得（先頭シート。固定名があれば変更OK）
  const wsName = wb.SheetNames[0];
  const ws = wb.Sheets[wsName];
  if (!ws["!ref"]) ws["!ref"] = "A1:A1";

  // A列スキャン：1..31 / 文字日付 / シリアル を同一日扱いで照合
  const range = XLSX.utils.decode_range(ws["!ref"]);
  let targetRow = null;

  for (let r = 1; r <= range.e.r; r++) { // 1行目は見出し → 2行目から
    const ref = "A" + (r + 1);
    const cell = ws[ref];
    if (!cell || cell.v == null) continue;

    let Y, M, D;
    if (typeof cell.v === "number" && cell.v < 32) {       // 日だけ(数値)
      Y = yyyy; M = Number(mm); D = cell.v;
    } else if (typeof cell.v === "string" && /^\d{1,2}$/.test(cell.v.trim())) { // 日だけ(文字)
      Y = yyyy; M = Number(mm); D = parseInt(cell.v.trim(),10);
    } else if (typeof cell.v === "string") {               // "2025/11/02" "2025-11-02"
      const c = new Date(String(cell.v).replace(/\./g,"/").replace(/-/g,"/"));
      if (!isNaN(c)) { Y=c.getFullYear(); M=c.getMonth()+1; D=c.getDate(); }
    } else if (typeof cell.v === "number") {               // Excelシリアル
      const excelEpoch = new Date(1899,11,30);
      const dt = new Date(excelEpoch.getTime() + cell.v*86400000);
      Y=dt.getFullYear(); M=dt.getMonth()+1; D=dt.getDate();
    }

    if (Y===yyyy && M===Number(mm) && D===dd) { targetRow = r + 1; break; }
  }

  // 見つからなければ末尾に追加（A列は「日」数値を書き込む）
  if (!targetRow) {
    targetRow = range.e.r + 2;  // 末尾+1（見出しが1行目のため+2）
    ws["A" + targetRow] = { v: dd, t: "n" };
    ws["!ref"] = XLSX.utils.encode_range({ s:{c:0, r:0}, e:{c:28, r:targetRow-1} });
  }

  // 値転記（"1人" や "¥1,234" でもOK：数値だけ抽出）
  for (const [id, col] of Object.entries(COLMAP)) {
    const el = $(id);
    if (!el) continue;
    const raw = (el.value ?? el.textContent ?? "0").toString().replace(/[^\d.-]/g,"");
    const num = parseFloat(raw) || 0;
    ws[col + targetRow] = { v: num, t: "n" };
  }

  // 保存：File System Access API なら本当に上書き。非対応はダウンロード保存。
  const outName = pickedName || `${yyyy}年${mm}月PA月計.xlsx`;
  try {
    if (fileHandle && 'createWritable' in fileHandle) {
      const writable = await fileHandle.createWritable();
      const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      await writable.write(wbout);
      await writable.close();
      alert(`上書き保存しました：${outName}`);
    } else {
      XLSX.writeFile(wb, outName); // 新規DL保存
      // alert(`Excelを書き出しました：${outName}`);
    }
  } catch (e) {
    console.error(e);
    alert('Excelの書き出しに失敗しました。コンソールを確認してください。');
  }
}

// ==== 6) ボタンクリック紐付け（重複防止） ==========================
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('exportExcelApp3');
  if (btn && !btn.dataset.bound) {
    btn.addEventListener('click', exportApp3MonthlyWrite);
    btn.dataset.bound = "1";
  }
});

// === APP3 追加フォーム連動（完全隔離・衝突防止版） ===
(function(){
  // ローカルユーティリティ（他と名前が被らない）
  function debounce_loc(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function toInt_loc(v){ const n=parseInt(String(v).replace(/[^\d-]/g,''),10); return isNaN(n)?0:n; }
  const saveNow_loc = ()=>{ 
    if (typeof window.autosave === 'function') window.autosave();
    if (typeof window.saveRemote === 'function') window.saveRemote();
  };
  const saveLater_loc = debounce_loc(saveNow_loc, 300);

  function initMaleAttendance(){
    const el = document.getElementById('maleAttendance');
    if (!el) return;
    if (window.state) window.state.maleAttendance = toInt_loc(el.value);
    const onChange = () => {
      const val = toInt_loc(el.value);
      if (window.state) window.state.maleAttendance = val;
      if (typeof window.updateCalculations === 'function') window.updateCalculations();
      saveLater_loc();
    };
    el.addEventListener('input', onChange);
    el.addEventListener('change', onChange);
  }

  function bindSpanToInput(spanId, inputId, stateKey){
  const sp = document.getElementById(spanId);
  const ip = document.getElementById(inputId);
  if (!sp || !ip) return;

  const read = () => parseInt((sp.textContent||'').replace(/[^\d]/g,''),10) || 0;
  const apply = () => {
    const v = read();
    ip.value = v;
    if (window.state && stateKey) window.state[stateKey] = v;
    if (typeof window.updateCalculations === 'function') window.updateCalculations();
    // ←★ ここを追加して、すぐ保存（ローカル or Firestore）を確定
    if (typeof saveLater_loc === 'function') saveLater_loc();
  };

  // 初期反映＋監視
  apply();
  const mo = new MutationObserver(apply);
  mo.observe(sp, { childList:true, characterData:true, subtree:true, attributes:true });
}


  // DOM準備後に初期化（DOMContentLoadedが過ぎていても即実行）
  const start = () => {
    initMaleAttendance();
    bindSpanToInput('totalCustomers', 'customersCount', 'customersCount');
    bindSpanToInput('historyIndexCount', 'femaleAttendance', 'femaleAttendance');
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, { once:true });
  } else {
    start();
  }
})();

//EXCELエクスポート関連コード終了-------------------------------------------------------------------------


</script>

</body>
</html>
