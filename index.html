<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<!-- Safariã«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã‚’å®£è¨€ -->
<meta name="color-scheme" content="dark light">
<meta name="theme-color" content="#121826" media="(prefers-color-scheme: dark)">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=M+PLUS+2:wght@400;500;700&display=swap" rel="stylesheet">
<title>IBASD  Ver. 6.6.0</title>
<style>

  html, body {
  background-color: #121826 !important;
  color: #eaf6ff; /* æ—¢å­˜ã®æ–‡å­—è‰²ã¨çµ±ä¸€ */
}

*, *::before, *::after { box-sizing: border-box; }
html, body { overflow-x: hidden; }
html { scrollbar-gutter: stable; }

  #resetOverlay {
  position: fixed;
  z-index: 99999;
  left: 0; top: 0; width: 100%; height: 100vh;
  background: #191924;
  opacity: 0;
  transition: opacity 0.8s;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
}
#resetOverlay.active {
  opacity: 1;
  pointer-events: auto;
}

#matrixCanvas {
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 100vh;
  z-index: 2;
  pointer-events: none;
}

#resetFlash {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100vh;
  background: white;
  opacity: 0;
  z-index: 3;
  transition: opacity 0.5s;
  pointer-events: none;
}

body {
  background: linear-gradient(135deg, #191924, #212c4a 80%);
  color: #eaf6ff;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  font-size: 20px;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  letter-spacing: 0.02em;
}

body[data-active-app="app1"],
body[data-active-app="app2"],
body[data-active-app="app3"]{
  padding-top: var(--tabs-h);
}

/* --- ã‚¿ãƒ–ãƒãƒ¼ --- */
.tabs {
  display: flex;
  background: rgba(24, 24, 48, 0.78);
  backdrop-filter: blur(8px);
  position: fixed;
  top: 0;
  z-index: 2000;
  border-bottom: 1.5px solid #0ff7ff55;
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  box-shadow: 0 4px 32px #161a2899;
}
.tab {
  flex: 1;
  padding: 16px 0;
  text-align: center;
  color: #97e4f5;
  cursor: pointer;
  user-select: none;
  border-bottom: 3px solid transparent;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  font-size: 20px;
  letter-spacing: 0.07em;
  transition: background 0.25s, border-bottom-color 0.3s, color 0.3s;
}
.tab:hover {
  background: rgba(0,255,255,0.08);
}
.tab.active {
  background: rgba(16,16,48,0.8);
  border-bottom-color: #00f5ff;
  color: #00f5ff;
  font-weight: 600;
  text-shadow: 0 0 8px #00f5ff55;
}

/* --- å…±é€šã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- */
.content {
  background: rgba(30, 38, 60, 0.78);
  color: #eaf6ff;
  padding: 30px 5vw 80px 5vw;
  padding-top: calc(var(--tabs-h) + var(--subnav-h) - 50px ) !important;
  min-height: 300px;
  width: 100%;
  max-width: none !important;
  margin: 0 !important;
  box-sizing: border-box;
  text-align: left;
}

/* --- ãƒœã‚¿ãƒ³ --- */
button {
  background: linear-gradient(90deg, #202056 60%, #009be6 120%);
  color: #eaf6ff;
  border: 1.5px solid #00eaff;
  border-radius: 10px;
  padding: 12px 28px;
  font-size: 18px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  box-shadow: 0 0 10px #00eaff44;
  margin: 3px 6px;
  cursor: pointer;
  transition: all 0.2s;
  outline: none;
  letter-spacing: 0.09em;
  text-align: center;
  min-width: 80px;
}
button:hover, .tab.active {
  background: linear-gradient(90deg, #00f5ff 20%, #2636b3 80%);
  color: #fff;
  box-shadow: 0 0 18px #00f5ffbb;
  transform: translateY(-2px) scale(1.02);
}

/* --- ãƒ†ãƒ¼ãƒ–ãƒ« --- */
table {
  border-radius: 16px;
  border-collapse: separate;
  border-spacing: 0;
  background: rgba(20,28,40,0.82);
  box-shadow: 0 0 24px #00eaff33;
  overflow: hidden;
  width: 100%;
  margin-bottom: 26px;
}
tbody {
  border-radius: 14px;
  overflow: hidden;
}
th, td {
  border-bottom: 1.5px solid #00f5ff55;
  padding: 10px 7px;
  text-align: left; /* â†å·¦æƒãˆ */
  background: rgba(24,30,50,0.85);
  font-size: 17px;
}
th {
  color: #00f5ff;
  font-size: 18px;
  background: linear-gradient(90deg,#23467a 40%,#197b91 100%);
  font-weight: bold;
  letter-spacing: 0.05em;
}
tr:last-child td {
  border-bottom: none;
}
tr.row:hover td {
  background: rgba(0,245,255,0.09);
}

/* --- å„ãƒ•ã‚©ãƒ¼ãƒ /ã‚°ãƒ«ãƒ¼ãƒ— --- */
.group {
  padding: 24px 24px 16px 24px;
  margin: 18px 0;
  border-radius: 18px;
  background: rgba(10, 20, 40, 0.87);
  box-shadow: 0 2px 18px #00eaff12;
}

.group h3, .group-title {
  text-align: left !important;
  font-size: 22px;
  margin: 0 0 18px 0;
  padding-left: 3px;
  color: #fff;
  letter-spacing: 0.02em;
}

/* --- labelã®æ¨ªä¸¦ã³ï¼‹å³å¯„ã›ãƒ•ã‚©ãƒ¼ãƒ  --- */
.group label {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 0;
  margin-bottom: 12px;
  width: 100%;
}

.group label > span,
.group label > strong,
.group label > b {
  min-width: 140px;
  max-width: 210px;
  text-align: left;
  letter-spacing: 0.03em;
  font-size: 17px;
  flex-shrink: 0;
}

.group label input,
.group label select,
.group label button {
  margin-left: auto;
  flex: 1 1 120px;
  min-width: 120px;
  max-width: 260px;
  width: 150px;
  text-align: right;
  box-sizing: border-box;
}

.group label input[type="checkbox"] {
  flex: 0 0 auto;
  margin-left: 15px;
  width: auto;
}

.group label button {
  min-width: 100px;
  max-width: 180px;
  width: 120px;
}

/* --- å…¥åŠ›æ¬„ --- */
input, select, textarea {
  background: rgba(38, 56, 77, 0.72);
  color: #00f5ff;
  border: 1.5px solid #25f1ff77;
  border-radius: 7px;
  font-size: 17px;
  padding: 9px 14px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  margin: 3px 0;
  outline: none;
  box-shadow: 0 1px 8px #00eaff44;
  transition: border 0.2s, background 0.19s;
}
input:focus, select:focus, textarea:focus {
  border-color: #00eaff;
  background: rgba(42, 86, 120, 0.95);
  color: #fff;
}

/* --- ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œå‰Šé™¤ãƒœã‚¿ãƒ³ --- */
.delete-btn {
  background: linear-gradient(90deg, #f73378 40%, #0ff 160%);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 18px;
  box-shadow: 0 0 12px #00eaff99;
  cursor: pointer;
  transition: background 0.23s, box-shadow 0.19s, transform 0.12s;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
}
.delete-btn:hover {
  background: #ff007c;
  color: #fff;
  box-shadow: 0 0 24px #f7337888, 0 0 10px #0ff;
  transform: scale(1.07);
}

/* --- å›ºå®šãƒŠãƒ“ --- */
#app1-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

#app1-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app1-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}

#app1-nav, #app2-nav, #app3-nav { display: none; }

body[data-active-app="app1"] #app1-nav { display: flex !important; }
body[data-active-app="app2"] #app2-nav { display: flex !important; }
body[data-active-app="app3"] #app3-nav { display: flex !important; }

/* app3 ã§ã¯ã©ã¡ã‚‰ã‚‚éè¡¨ç¤º */
body[data-active-app="app3"] #app1-nav,
body[data-active-app="app3"] #app2-nav { display: none !important; }
body {
  padding-bottom: 86px;
}

/* --- å±¥æ­´ --- */
.history {
  margin-top: 38px;
  background: rgba(0,34,43,0.23);
  border-radius: 10px;
  box-shadow: 0 2px 12px #00f5ff12;
}
.history h3 {
  color: #00f5ff;
  margin-bottom: 8px;
}
.history li {
  margin-bottom: 10px;
  background: rgba(33,90,104,0.14);
  border-radius: 8px;
  box-shadow: 0 1px 8px #00eaff33;
  padding: 9px 15px;
  color: #97e4f5;
}

/* èµ¤ç³»ãƒªã‚»ãƒƒãƒˆãƒ»ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³å…±é€šã‚¯ãƒ©ã‚¹ */
.red-btn, .clear-btn, .reset-btn {
  background: linear-gradient(90deg, #f73378 30%, #d80032 100%);
  color: #fff !important;
  border: 1.5px solid #d80032;
  box-shadow: 0 0 12px #ff006288;
}
.red-btn:hover, .clear-btn:hover, .reset-btn:hover {
  background: linear-gradient(90deg, #f44 10%, #b00020 90%);
  color: #fff;
  box-shadow: 0 0 20px #ff2e62aa;
  transform: scale(1.05);
}

/* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚°ãƒ­ãƒ¼ --- */
.tab, button, .group, input, select, textarea {
  transition: box-shadow 0.23s, background 0.23s, color 0.18s, border 0.16s;
}
input:focus, select:focus {
  box-shadow: 0 0 12px #00f5ff77;
}

::-webkit-input-placeholder { color: #60ecffcc; }
::-moz-placeholder          { color: #60ecffcc; }
:-ms-input-placeholder      { color: #60ecffcc; }
::placeholder              { color: #60ecffcc; }

 #result {
  background: #1e1e1e;
  color: #fff;
  padding: 22px 18px 12px 18px;
  border-radius: 12px;
  margin-top: 24px;
  box-shadow: 0 0 8px rgba(0,0,0,0.08);
  font-size: 22px;
  font-family: Arial, sans-serif;
  border: none;
  letter-spacing: normal;
}

.subtotal, .totalAmount, .finalAmount {
  background: none !important;
  color: #fff !important;
  font-size: inherit !important;
  text-shadow: none !important;
  margin-bottom: 0;
  padding: 0;
}

.finalAmount, .print-highlight {
  color: #00eaff !important;
  font-size: 28px !important;
  font-weight: bold;
  background: none !important;
}

.subtotal {
  color: #36ffe7 !important;
}

.totalAmount {
  color: #feffb3 !important;
}

/* çµæœå…¨ä½“ */
#result {
  background: linear-gradient(180deg,#142944 90%,#123);
  border-radius: 18px;
  color: #43eaff;
  padding: 32px 34px 18px 34px;
  margin-top: 22px;
  font-family: 'Orbitron','Segoe UI',Arial,sans-serif;
  font-size: 22px;
  box-shadow: 0 0 24px #00f5ff1c;
  border: none;
  text-align: left;
  letter-spacing: 0.02em;
}

#result .right-note{
  float: right;
  color: #fff4b7;
  font-size: 15px;
  opacity: .95;

  /* â†ã“ã“1è¡Œã ã‘è¿½åŠ ã—ã¦å·¦ã«å¯„ã›ã‚‹ */
  margin-right: 3mm;  /* æ•°å€¤ã‚’2ã€œ5mmã§å¾®èª¿æ•´ */
}

/* app1ã®ä¼ç¥¨å…¥åŠ›éƒ¨åˆ†ã ã‘èª¿æ•´ã™ã‚‹ä¾‹ */

#app1 table, #app1 .row, #app1 input, #app1 select {
  /* ä¼ç¥¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„å„è¡Œã€å…¥åŠ›æ¬„ã®è£…é£¾ */
  background: rgba(30, 30, 40, 0.85);
  color: #f6ffe8;
  font-size: 18px;
  border-radius: 10px;
  box-shadow: 0 2px 12px #0ff3;
  border: none;
  margin-bottom: 8px;
}

#app1 th, #app1 td {
  background: rgba(24,30,50,0.85);
  color: #81e1ff;
  font-size: 17px;
  border-bottom: 1.5px solid #00f5ff33;
  padding: 8px 5px;
}

#app1 tr.row:hover td {
  background: rgba(0,245,255,0.13);
}

#app1 input[type="text"], #app1 input[type="number"], #app1 select {
  background: #18344c;
  color: #fff;
  border: 1.5px solid #25f1ff44;
  border-radius: 5px;
  font-size: 17px;
  padding: 6px 11px;
  margin: 2px 0;
  outline: none;
  box-shadow: 0 1px 8px #00eaff22;
}

#app1 input[type="text"]:focus, #app1 input[type="number"]:focus {
  border-color: #00eaff;
  background: #225a7a;
  color: #fff;
}

#app1 .delete-btn {
  background: linear-gradient(90deg, #f73378 40%, #0ff 160%);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 26px;
  height: 26px;
  font-size: 15px;
  box-shadow: 0 0 12px #00eaff44;
  cursor: pointer;
  margin: 0 auto;
}

#app1 input[type="text"],
#app1 input[type="number"],
#app1 select {
  text-align: right !important;
}


/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿æ™‚ã®è¿‘æœªæ¥çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.content {
  opacity: 0;
  transform: scale(0.96) translateY(10px);
  transition: opacity 0.4s ease, transform 0.4s ease;
}

.content.active {
  opacity: 1;
  transform: scale(1) translateY(0);
}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes slideInRow {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
.row.slide-in {
  animation: slideInRow 0.5s ease-out;
}

@keyframes slideOutLeft {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-120%);
  }
}
.row.slide-out-left {
  animation: slideOutLeft 0.32s cubic-bezier(.77,.17,.3,1.11) forwards;
}

@keyframes slideInRight {
  0% {
    opacity: 0;
    transform: translateX(120%);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}
.row.slide-out-left {
  animation: slideOutLeft 0.28s cubic-bezier(.77,.17,.3,1.11) forwards;
}
.row.slide-in-right {
  animation: slideInRight 0.28s cubic-bezier(.77,.17,.3,1.11) forwards;
}

#app2-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

#app2-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app2-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}

#app3-nav {
  left: 0;
  right: 0;
  margin: 0 auto;
  z-index: 1900;
  background: rgba(0,34,43,0.95);
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

/* app3 ã‚µãƒ–ãƒŠãƒ“ãƒœã‚¿ãƒ³ */
#app3-nav button {
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 9px 28px;
  margin: 0 16px;
  font-size: 19px;
  font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px #00f5ff66;
  transition: background 0.25s, box-shadow 0.19s;
}
#app3-nav button:hover {
  background: #00f5ff;
  color: #121212;
  box-shadow: 0 2px 22px #00f5ff88;
}



/* ã©ã®ç«¯æœ«ã§ã‚‚æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å°ã˜ã‚‹ & å¹…è¨ˆç®—ã‚’å®‰å®šã•ã›ã‚‹ */
*, *::before, *::after { box-sizing: border-box; }
html, body { overflow-x: hidden; }



/* 100vw ã§ã¯ã¿å‡ºã™ã®ã‚’é˜²ãï¼ˆPCæ™‚ã®æ¨ªã‚ºãƒ¬å¯¾ç­–ï¼‰ */
.tabs    { width: 100%; }   /* ã‚‚ã¨ã‚‚ã¨ width:100vw ãªã‚‰ä¸Šæ›¸ã */
.content { width: 100%; }   /* ã‚‚ã¨ã‚‚ã¨ width:100vw ãªã‚‰ä¸Šæ›¸ã */


/* ===== PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ(å…±é€š)ï¼šå¾“æ¥ã©ãŠã‚Šæ¨ªä¸¦ã³ ===== */
.ticket-toolbar{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
}
.ticket-toolbar .add-btn{
  padding: 12px 24px;
  line-height: 1;
}
.ticket-toolbar .search-box{
  display: flex;
  align-items: center;
  gap: 8px;
}
.ticket-toolbar .search-box #searchAmount{
  width: 160px;
  text-align: right;
}



/* === CBè¡¨ 4åˆ—ã®è¦‹ãŸç›®ã‚’æ•´ãˆã‚‹ === */
#categorySection th, #categorySection td { text-align: left; }
#categorySection th:nth-child(1), #categorySection td:nth-child(1) {
  width: 56px; text-align: center;
}
#categorySection th:nth-child(3), #categorySection td:nth-child(3),
#categorySection th:nth-child(4), #categorySection td:nth-child(4) {
  text-align: right;
}
/* ãƒã‚§ãƒƒã‚¯ã‚’å°‘ã—å¤§ãã */
#categorySection input[type="checkbox"] { transform: scale(1.15); }


/* === CBè¡¨ï¼šãƒã‚§ãƒƒã‚¯åˆ—ã‚’ç´°ãã€æ®‹ã‚Š3åˆ—ã‚’å‡ç­‰å‰²ã‚Šã« === */
#categorySection table{
  table-layout: fixed;                 /* â† å¹…æŒ‡å®šã‚’ãã£ã¡ã‚ŠåŠ¹ã‹ã›ã‚‹ */
  width: 100%;
}

/* ä½™ç™½ã¨æŠ˜è¿”ã—ã‚’æ•´ãˆã‚‹ï¼ˆãƒ˜ãƒƒãƒ€ãŒç¸¦ã«å‰²ã‚Œãªã„ã‚ˆã†ã«ï¼‰ */
#categorySection th, #categorySection td{
  padding: 8px 6px;
  white-space: nowrap;
}

/* 1åˆ—ç›®ï¼šãƒã‚§ãƒƒã‚¯ã ã‘ã€‚æ¥µç´°ï¼‹ä¸­å¤®å¯„ã› */
#categorySection th:nth-child(1),
#categorySection td:nth-child(1){
  width: 40px;                         /* â† ã“ã“ã§ç´°ã */
  text-align: center;
  padding-left: 4px; padding-right: 4px;
}
#categorySection td:nth-child(1) input[type="checkbox"]{
  /* å¤§ãã™ãã‚‹ã¨å¹…ã‚’é£Ÿã†ã®ã§æ§ãˆã‚ã« */
  transform: scale(1.0);
  margin: 0 auto; display: block;
}

/* æ®‹ã‚Š3åˆ—ã‚’å®Œå…¨å‡ç­‰å‰²ã‚Šï¼ˆcalc ã§æ®‹ã‚Šå¹…ã‚’3åˆ†å‰²ï¼‰ */
#categorySection th:nth-child(2),
#categorySection td:nth-child(2),
#categorySection th:nth-child(3),
#categorySection td:nth-child(3),
#categorySection th:nth-child(4),
#categorySection td:nth-child(4){
  width: calc((100% - 40px) / 3);      /* â† 40px ã¯ãƒã‚§ãƒƒã‚¯åˆ—ã®å¹…ã¨ä¸€è‡´ã•ã›ã‚‹ */
}

/* ä½“è£ï¼šã‚«ãƒ†ã‚´ãƒªã¯å·¦ã€æ•°å€¤ã¯å³ã§æƒãˆã‚‹ */
#categorySection th:nth-child(2), #categorySection td:nth-child(2){ text-align: left;  }
#categorySection th:nth-child(3), #categorySection td:nth-child(3),
#categorySection th:nth-child(4), #categorySection td:nth-child(4){ text-align: right; }


/* === app2 ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼ˆå³ç«¯å›ºå®šï¼‰ === */
#app2-sideNav{
  position: fixed;
  top: 140px;
  right: 23px;                 /* å³ç«¯ã«å°‘ã—ä½™ç™½ */
  width: 210px;
  padding: 12px 10px;
  background: rgba(10,20,40,0.92);
  backdrop-filter: blur(8px);

  /* â† ã“ã“ã‚’å¤‰æ›´ï¼šå·¦ã ã‘ã®ç½«ç·šâ†’å…¨é¢ãƒœãƒ¼ãƒ€ãƒ¼ï¼‹è§’ä¸¸ */
  border: 1.5px solid rgba(0,245,255,.35);
  border-radius: 14px;

  /* å½±ã‚‚â€œé¢â€ã§å›ã™ï¼ˆå³å´ãŒåˆ‡ã‚Œã¦è¦‹ãˆãªã„ï¼‰ */
  box-shadow:
    0 6px 28px rgba(0,245,255,.18),
    0 2px 10px rgba(0,0,0,.35);

  z-index: 1200;
  overflow: hidden;            /* å†…å´ã®ã‚°ãƒ­ãƒ¼ç”¨ã«ãƒã‚¹ã‚¯ */
}

#app2-sideNav .sideNav-title {
  font-size: 16px;
  font-weight: bold;
  color: #00f5ff;
  text-align: center;
  margin-bottom: 10px;
  letter-spacing: .05em;
}

#app2-sideNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#app2-sideNav li { margin-bottom: 8px; }

#app2-sideNav button {
  width: 100%;
  padding: 9px 10px;
  font-size: 15px;
  background: rgba(20,40,70,.85);
  border: 1px solid rgba(0,234,255,.35);
  border-radius: 10px;
  color: #eaf6ff;
  cursor: pointer;
  transition: background .2s, color .2s, transform .12s;

  /* â˜…ã“ã‚Œã‚’è¿½åŠ  */
  text-align: center;      /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
  justify-content: center; /* flexè¦ç´ åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ä¸­å¤®æƒãˆ */
}

/* === ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã ã‘èµ¤ã«ã™ã‚‹ === */
#app2-sideNav #side-clear {
  background: linear-gradient(90deg, #f73378 30%, #d80032 100%) !important;
  color: #fff !important;
  border: 1.5px solid #d80032 !important;
  box-shadow: 0 0 12px #ff006288 !important;
}
#app2-sideNav #side-clear:hover {
  background: linear-gradient(90deg, #f44 10%, #b00020 90%) !important;
  box-shadow: 0 0 20px #ff2e62aa !important;
  transform: scale(1.05);
}

#app2-sideNav button:hover {
  background: #00f5ff;
  color: #111;
  transform: translateY(-1px);
}

/* æ°åã®ä¸Š */
#app2-sideNav li:first-of-type button {
  border-top: 2px solid #00f5ff !important;
  margin-top: 8px !important;
  padding-top: 8px !important;
}

/* Drink ã®ä¸‹ */
#app2-sideNav button[data-target="a"] {
  border-bottom: 2px solid #00f5ff !important;
  margin-bottom: 8px !important;
  padding-bottom: 8px !important;
}

/* è¨ˆç®— ã®ä¸Š */
#side-calc {
  border-top: 2px solid #00f5ff !important;
  margin-top: 8px !important;
  padding-top: 8px !important;
}

/* ã‚¯ãƒªã‚¢ ã®ä¸‹ */
#side-clear {
  border-bottom: 2px solid #00f5ff !important;
  margin-bottom: 8px !important;
  padding-bottom: 8px !important;
}

/* å±¥æ­´ ã®ä¸Šä¸‹ */
#side-scroll-history {
  border-top: 2px solid #00f5ff !important;
  border-bottom: 2px solid #00f5ff !important;
  margin-top: 10px !important;
  margin-bottom: 10px !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}


/* ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã®ã¶ã‚“ app2 ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¸®å° */
#app2 {
  width: calc(100% - 140px) !important;
  max-width: none !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  box-sizing: border-box;
}

/* æ—¢å®šã¯éè¡¨ç¤ºã«ã™ã‚‹ */
#app2-sideNav { display: none; }

body[data-active-app="app2"] #app2-sideNav {
  display:block !important;
  position:fixed;
  top:140px;
  right:8px;
  width:100px;
  padding:8px;
  border-radius:10px;
  z-index:1200;
}

/* APP1ã¨APP3ã®æ™‚ã¯éè¡¨ç¤ºï¼ˆä¿é™ºï¼‰ */
body[data-active-app="app1"] #app2-sideNav,
body[data-active-app="app3"] #app2-sideNav {
  display:none !important;
}

/* å†…å´ã®è–„ã„ç¸å–ã‚Šï¼‹å¤–å‘¨ã‚°ãƒ­ãƒ¼ */
#app2-sideNav::before{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  box-shadow:
    inset 0 0 0 1px rgba(0,245,255,.25),
    0 0 32px rgba(0,245,255,.15);
  pointer-events: none;
}

#app2-sideNav::after{
  content: "";
  position: absolute;
  inset: -10px;                /* å¤–å´ã«ã‚‚å°‘ã—å…‰ã‚’å›ã™ */
  border-radius: inherit;
  background:
    radial-gradient(120px 60px at 90% 10%, rgba(0,245,255,.25), transparent 70%),
    radial-gradient(120px 60px at 10% 90%, rgba(0,245,255,.18), transparent 70%);
  filter: blur(16px);
  opacity: .5;
  pointer-events: none;
}

/* ãƒœã‚¿ãƒ³ç­‰ã®ä¸­èº«ã¯ãã®ã¾ã¾ã§OKï¼ˆå¿…è¦ãªã‚‰ãŠå¥½ã¿ã§ï¼‰ */
#app2-sideNav .sideNav-title{
  font-size: 16px; font-weight: 700; letter-spacing: .05em;
  color: #00f5ff; text-align: center; margin-bottom: 10px;
}
#app2-sideNav ul{ list-style: none; margin: 0; padding: 0; }
#app2-sideNav li{ margin-bottom: 8px; }
#app2-sideNav button{
  width: 100%; min-width: 0;
  padding: 9px 10px; font-size: 15px;
  background: rgba(20,40,70,.85);
  border: 1px solid rgba(0,234,255,.35);
  border-radius: 10px; color: #eaf6ff;
  transition: background .2s, color .2s, transform .12s;
}
#app2-sideNav button:hover{ background:#00f5ff; color:#111; transform: translateY(-1px); }

/* === app2 ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼šãƒœã‚¿ãƒ³ä¸­å¤®å¯„ã›ã‚’å¼·åˆ¶ === */
#app2-sideNav ul{
  display: flex;
  flex-direction: column;
  gap: 10px;              /* lié–“ã®ã™ãé–“ã‚’ä¸€å®šã« */
  align-items: stretch;   /* ãƒœã‚¿ãƒ³ã¯åˆ—å¹…ã„ã£ã±ã„ã« */
}

#app2-sideNav li{
  margin: 0; padding: 0;
  text-align: center;     /* å¿µã®ãŸã‚ */
}

#app2-sideNav button{
  display: flex;                /* ä¸­å¤®å¯„ã›ã®ç¢ºå®ŸåŒ– */
  align-items: center;
  justify-content: center;      /* â† æ°´å¹³ä¸­å¤® */
  text-align: center !important;/* â† ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤®ï¼ˆä¸Šæ›¸ãï¼‰ */
  width: 100%;
  margin: 0;                    /* ä½™è¨ˆãªæŠ¼ã—å‡ºã—ã‚’ãƒªã‚»ãƒƒãƒˆ */
  padding-inline: 12px;         /* å·¦å³ãƒãƒ©ãƒ³ã‚¹ */
}

:root{
  --ff-orbi-jp: 'Orbitron', 'M PLUS 2', 'Noto Sans JP', 'Yu Gothic UI', 'Meiryo', sans-serif;
  --subnav-bg: rgba(0, 34, 43, 0.95);
  --tabs-h: 56px;
  --subnav-h: 50px;

  /* â˜… è¿½åŠ ï¼šã‚¹ãƒãƒ›æ™‚ã®ã‚µã‚¤ãƒ‰ãƒŠãƒ“å¹…ã¨ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ */
  --side-nav-w: 100px;
  --side-nav-gap: 12px;
}

/* ã¾ãš body ã«çµ±ä¸€ */
html, body { font-family: var(--ff-orbi-jp) !important; }

/* è¦ç´ ã”ã¨ã®ãƒãƒ©ãƒãƒ©æŒ‡å®šã‚’ä¸Šæ›¸ãã—ã¦ç¶™æ‰¿ã•ã›ã‚‹ */
button, .tab, input, select, textarea,
.content, .group, table, th, td,
#result, #app1-nav button, #app2-nav button {
  font-family: inherit !important;
}

.group label > span,
.group label > strong,
.group label > b {
  font-family: inherit !important;
}

#app1-nav,
#app2-nav,
#app2-sideNav{
  background: var(--subnav-bg) !important;
}

/* ã‚«ãƒ†ã‚´ãƒªè¡¨ã®é‡‘é¡æ¨ªã®ãƒŸãƒ‹ãƒœã‚¿ãƒ³ */
#categorySection .print-mini{
  padding: 3px 8px;
  font-size: 12px;
  line-height: 1.2;
  min-width: 0;
  margin-left: 8px;
}

/* app2/app3 ã® .content ã§ã¯ transform ã‚’æ®ºã—ã¦å›ºå®šåŒ–ã‚’å®ˆã‚‹ */
body[data-active-app="app2"] #app2,
body[data-active-app="app2"] #app2.active,
body[data-active-app="app3"] #app3,
body[data-active-app="app3"] #app3.active {
  transform: none !important;
}

/* åˆè¨ˆè¡Œã®äººæ•°ã‚»ãƒ«ã‚’å³å¯„ã› */
#totalCount {
  text-align: right !important;
  white-space: nowrap;
}
#totalCount .count-value {
  display: inline-block;
  margin-right: 6px; /* æ•°å­—ã¨ãƒœã‚¿ãƒ³ã®é–“éš” */
}
#totalCount button {
  vertical-align: middle; /* æ•°å­—ã¨é«˜ã•ã‚’æƒãˆã‚‹ */
}

/* ã‚µãƒ–ãƒŠãƒ“å…±é€šï¼ˆPC/ã‚¹ãƒãƒ›å…±é€šã§ã‚¿ãƒ–ç›´ä¸‹ï¼‰ */
.subnav{
  position: fixed;
  left: 0; right: 0;
  top: var(--tabs-h);          /* â† ã‚¿ãƒ–ã®ç›´ä¸‹ */
  height: var(--subnav-h);
  z-index: 1900;
  display: none;               /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã¿è¡¨ç¤ºï¼ˆä¸‹ã§åˆ‡æ›¿ï¼‰ */
  justify-content: center;
  align-items: center;
  background: rgba(0,34,43,0.95);
  box-shadow: 0 2px 12px #00f5ff44;
  border-bottom: 2px solid #00f5ff33;
}

/* ãƒœã‚¿ãƒ³å…±é€š */
.subnav button{
  background: linear-gradient(90deg, #009be6 40%, #072259 100%);
  color: #fff; border: none; border-radius: 8px;
  padding: 9px 28px; margin: 0 16px; font-size: 19px;
  letter-spacing: 0.07em; box-shadow: 0 2px 8px #00f5ff66;
  transition: background .25s, box-shadow .19s;
}
.subnav button:hover{
  background:#00f5ff; color:#121212; box-shadow:0 2px 22px #00f5ff88;
}

/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã«å¿œã˜ã¦è©²å½“ã‚µãƒ–ãƒŠãƒ“ã ã‘è¡¨ç¤º */
#app1-nav, #app2-nav, #app3-nav{ display:none; }
body[data-active-app="app1"] #app1-nav{ display:flex !important; }
body[data-active-app="app2"] #app2-nav{ display:flex !important; }
body[data-active-app="app3"] #app3-nav{ display:flex !important; }

#app1-nav, #app2-nav, #app3-nav{
  position: fixed;
  left: 0; right: 0;
  height: var(--subnav-h);
}


/* å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ */
#app2 .bottle-form {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  gap: 10px;   /* å°‘ã—åºƒã‚ã« */
}

/* å·¦ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ï¼‹è©³ç´°ã‚»ãƒ¬ã‚¯ãƒˆï¼‰ */
#app2 .bottle-form .left-group {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1 1 auto;   /* å·¦ã‚°ãƒ«ãƒ¼ãƒ—ã¯æ®‹ã‚Šå¹…ã‚’ä½¿ã† */
}

#app2 .bottle-form .delete-btn {
  flex: 0 0 28px;
  width: 28px;
  height: 28px;
  font-size: 15px;
  margin-right: 4px; /* ã‚»ãƒ¬ã‚¯ãƒˆã¨å°‘ã—é–“éš” */
}

/* ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆè©³ç´°æ¬„ã‚’å¤§ãã‚ã«ï¼‰ */
#app2 .bottle-form select.bottleDetails {
  flex: 1 1 220px;   /* â†è©³ç´°ã‚’åºƒã‚ */
  max-width: 260px;
  min-width: 180px;
}

/* å‰²äººæ•°ãƒ»æ•°é‡ãƒ»é‡‘é¡ã‚’ç­‰å¹…ã§å³ã«å¯„ã›ã‚‹ */
#app2 .bottle-form input.splitCount,
#app2 .bottle-form input.bottleQuantity,
#app2 .bottle-form input.bottleAmount {
  flex: 0 0 90px;    /* ç­‰å¹…ã§æƒãˆã‚‹ */
  width: 90px;
  text-align: right;
}

/* é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒ ã ã‘ã¯å°‘ã—å¤§ãã‚ï¼ˆä»–ãƒ‰ãƒªãƒ³ã‚¯æ¬„ã¨æƒãˆã‚‹ï¼‰ */
#app2 .bottle-form input.bottleAmount {
  flex: 0 0 250px !important;  /* â† å¹…ã‚’å¼·åˆ¶ */
  width: 140px;
  min-width: 140px;
}




/* å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ */
.history-index-table {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)) !important;
  gap: 12px 16px !important;             /* è¡Œã¨åˆ—ã®ã™ãé–“ */
  justify-content: center !important;    /* ä¸­å¤®å¯„ã› */
  align-items: center !important;
  padding: 16px 12px !important;
  background: rgba(20,28,40,0.82) !important;
  border-radius: 12px !important;
  box-shadow: 0 0 18px #00eaff22 !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç„¡è¦–ã—ã¦ãƒœã‚¿ãƒ³ã ã‘ã‚°ãƒªãƒƒãƒ‰å†…ã«ä¸¦ã¹ã‚‹ */
.history-index-table thead,
.history-index-table tbody,
.history-index-table tr,
.history-index-table td {
  display: contents !important;
}

/* ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ãƒ»é–“éš”çµ±ä¸€ */
.history-index-table .idx-btn {
  display: block !important;
  width: 100% !important;
  max-width: 120px !important;
  margin: 0 !important;
  padding: 8px 10px !important;
  text-align: center !important;
  border: 1px solid #00eaff !important;
  border-radius: 8px !important;
  background: rgba(0,245,255,.08) !important;
  color: #00f5ff !important;
  cursor: pointer !important;
  transition: transform .15s, background .15s, color .15s !important;
}
.history-index-table .idx-btn:hover {
  background: #00f5ff !important;
  color: #111 !important;
  transform: translateY(-2px) scale(1.03) !important;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ã‚µãƒ–ãƒŠãƒ“ã«æ½œã‚‰ãªã„ã‚ˆã†ä¸Šä½™ç™½ã‚’ç¢ºä¿ */
#app2-historySection .history-item{
  scroll-margin-top: calc(var(--tabs-h) + var(--subnav-h) + 10px);
}

/* è¦‹å‡ºã—ã®å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼†å³ç«¯ã‚«ã‚¦ãƒ³ã‚¿ */
.history-index-table .history-index-head{
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.history-index-table .history-index-count{
  font-size: 14px;
  color: #eaf6ff;
  opacity: .95;
}

/* å…±é€šï¼šè¦‹å‡ºã—è¡Œã‚’ãƒœã‚¿ãƒ³åŒ–ï¼ˆå·¦å³ã«ã‚¿ã‚¤ãƒˆãƒ«/äººæ•°/â–¼ï¼‰ */
.history-index-toggle{
  width:100%;
  display:flex; align-items:center; justify-content:space-between;
  background: transparent; border: none; color: inherit; padding: 10px 12px;
  font: inherit; cursor: pointer;
}
.history-index-toggle .caret{ opacity:.9; }


/* =========================================================
   MOBILE (<=700px) â€” çµ±åˆç‰ˆï¼ˆapp1/app2/app3ï¼‰
   ã“ã‚Œ1ã¤ã§OKã€‚æ—¢å­˜ã® max-width:700px ãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤ã—ã¦OKã€‚
========================================================= */
@media (max-width:700px){

  /* ---------- å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ/ã‚¿ã‚¤ãƒ ---------- */
  .tabs{ font-size:15px; }
  .tab{ font-size:15px; padding:9px 0; }
  .content{
    padding: calc(var(--tabs-h) + var(--subnav-h) - 40px ) 12px 110px 12px !important;
  }
  th, td{ font-size:15px; }
  #app1 .group{ padding:12px 6px 8px 6px; margin:10px 0; border-radius:12px; }
  #app1 .group label{ flex-direction:column; align-items:stretch; margin-bottom:8px; gap:6px; }
  #app1 .group label > span,
  #app1 .group label > strong,
  #app1 .group label > b{ min-width:unset; max-width:unset; width:100%; }
  #app1 .group label input,
  #app1 .group label select,
  #app1 .group label button{ margin-left:0; width:100%; min-width:unset; max-width:unset; }

  /* ---------- app1ï¼šä¼ç¥¨ï¼ã‚«ãƒ¼ãƒ‰åŒ–ã€ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ•´åˆ— ---------- */
  #app1 table, #app1 tbody, #app1 tr, #app1 td{
    display:block; width:100% !important;
  }
  #app1 tr.row{
    position:relative;
    margin:14px 0; padding:12px 12px 10px;
    border-radius:12px;
    background:rgba(25,35,55,.9);
    box-shadow:0 2px 12px #00f5ff44;
    overflow:hidden;
  }
  #app1 td{ border:none !important; padding:6px 2px !important; }
  #app1 td:first-child, #app1 td.rowNumber{
    display:inline-block; width:auto; padding-right:8px !important;
  }
  #app1 .delete-btn{
    position:absolute; top:8px; right:8px; float:none; width:32px; height:32px;
  }
  #app1 input, #app1 select{
    width:100% !important; max-width:100% !important;
    text-align:left !important; margin-top:4px;
  }

  /* ä¼ç¥¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼š2Ã—2ã‚°ãƒªãƒƒãƒ‰ */
  .ticket-toolbar{
    display:grid !important;
    grid-template-columns:110px 1fr;
    grid-template-rows:auto auto;
    gap:10px 12px; align-items:stretch;
  }
  .ticket-toolbar .add-btn{
    grid-row:1 / span 2; grid-column:1;
    padding:12px 0; width:100%; min-width:0; font-size:16px; line-height:1.2;
  }
  .ticket-toolbar .search-box{
    grid-column:2; display:grid; grid-template-columns:1fr 1fr; grid-template-rows:auto auto; gap:8px 10px;
  }
  .ticket-toolbar .search-box #searchAmount{
    grid-column:1 / -1; width:100%; text-align:right; padding:10px 12px; font-size:14px;
  }
  .ticket-toolbar .search-box button{ width:100%; padding:10px 0; font-size:14px; margin:0; }

  /* ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ï¼ˆeditSectionï¼‰ï¼š1è¡Œç›®ã¶ã¡æŠœã + 2è¡Œç›®2ã¤ + ä»¥é™3åˆ— */
  #editSection > .tab{
    display:grid !important;
    grid-template-columns:repeat(3, 1fr);
    gap:10px; padding:8px 6px;
    background:transparent; border:0; box-shadow:none; flex:none; text-align:initial;
  }
  #editSection > .tab .tablinks{
    min-width:0; width:100%; margin:0; padding:10px 0;
    font-size:14px; line-height:1.15; border-radius:10px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #editSection > .tab .tablinks:nth-child(1){ grid-column:1 / -1; } /* å…¨è¡¨ç¤º */
  #editSection > .tab .tablinks:nth-child(2){ grid-column:1; }      /* ç¾é‡‘æŠ½å‡º */
  #editSection > .tab .tablinks:nth-child(3){ grid-column:2; }      /* ã‚«ãƒ¼ãƒ‰æŠ½å‡º */

  /* app1ï¼šã‚«ãƒ†ã‚´ãƒªé›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€Œã‚«ãƒ¼ãƒ‰åŒ–ã›ãšã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¾ã¾ */
  #categorySection table{ display:table !important; }
  #categorySection thead{ display:table-header-group !important; }
  #categorySection tbody{ display:table-row-group !important; }
  #categorySection tr{ display:table-row !important; }
  #categorySection th, #categorySection td{
    display:table-cell !important; font-size:14px;
  }

  /* ---------- app2ï¼šã‚µã‚¤ãƒ‰ãƒŠãƒ“éè¡¨ç¤º + ãƒŠãƒ“/ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ ---------- */

  #app2-sideNav {
  display:block !important;
  position:fixed;
  top:82px !important;
  right:4px !important;
  width:100px;   /* â†ã‚¹ãƒãƒ›ç”¨ã«ç¸®ã‚ã‚‹ */
  padding:8px;
  border-radius:10px;
  z-index:1200;
}

#app2{
  width: 100% !important;
  max-width: none !important;
  margin-right: 0 !important;
  padding-right: calc(var(--side-nav-w) + var(--side-nav-gap)) !important; /* ã‚µã‚¤ãƒ‰ãƒŠãƒ“åˆ†ã®é€ƒã’ */
  box-sizing: border-box !important;
}



  #app2-nav{ padding:4px 6px !important; }
  #app2-nav button{
    display:inline-flex; align-items:center; justify-content:center;
    height:32px; padding:0 10px; font-size:14px; line-height:1;
    min-width:0; margin:2px 4px; white-space:nowrap;
  }
  

  /* app2/app3ï¼šãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ã®è–„å‹åŒ–ï¼ˆiOSã‚ºãƒ¼ãƒ å›é¿ã§16pxç¶­æŒï¼‰ */
  #app2 input[type="text"], #app2 input[type="number"], #app2 select,
  #app3 input[type="text"], #app3 input[type="number"], #app3 select{
    font-size:16px !important;
    height:34px !important; line-height:32px !important;
    padding-block:2px !important; padding-inline:10px !important;
    box-sizing:border-box !important;
  }
  #app2 textarea, #app3 textarea{
    font-size:16px !important; min-height:64px !important;
    padding:6px 10px !important; line-height:1.25 !important;
  }
  #app2 .group button, #app3 .group button, #app2 .button-row button{
    height:34px; padding:0 12px; font-size:14px; line-height:1; min-width:0;
  }
  #app2 input[type="checkbox"], #app3 input[type="checkbox"]{ transform:scale(.95); }

  /* ---------- app3ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã®ä½™ç™½å¾®èª¿æ•´ï¼ˆã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ ---------- */
  #app3 .group{ padding:10px 10px 8px !important; margin:10px 0 !important; }
  #app3 .group h3{ font-size:18px; margin:0 0 10px; }

  #app1-nav button, #app2-nav button, #app3-nav button {
    height: 32px;                /* ãƒœã‚¿ãƒ³ã‚‚è–„å‹ã« */
    padding: 0 10px;
    font-size: 14px;
    line-height: 1;
    margin: 2px 4px;
    border-radius: 6px;
  }

 /* ---------- app2 å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼šæ¨ªå¹…ãƒ»é«˜ã•ã‚’ã•ã‚‰ã«èª¿æ•´ ---------- */
  #app2 .group label {
    flex-direction: row;
    justify-content: space-between;
    gap: 4px;                     /* ã™ãé–“ã‚’ã•ã‚‰ã«ç¸®å° */
    margin-bottom: 5px;
  }

/* ---------- app2 å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼šæ¨ªå¹…ãƒ»é«˜ã•ã‚’ã•ã‚‰ã«åœ§ç¸® ---------- */
#app2 .group label > span,
#app2 .group label > strong,
#app2 .group label > b {
  min-width: 65px !important;   /* â† ãƒ©ãƒ™ãƒ«å¹…ã‚’ã•ã‚‰ã«å°ã•ã */
  font-size: 12px !important;   /* â† ãƒ•ã‚©ãƒ³ãƒˆã‚‚å°ã•ã */
  line-height: 1.2 !important;
}

#app2 .group label input,
#app2 .group label select {
  max-width: 100px !important;  /* â† å…¥åŠ›æ¬„ã‚’ã•ã‚‰ã«ç´°ã‚ã« */
  height: 24px !important;      /* â† é«˜ã•ã‚’åœ§ç¸® */
  font-size: 12px !important;
  padding: 1px 5px !important;  /* â† å†…å´ä½™ç™½ã‚‚æœ€å°åŒ– */
  line-height: 20px !important;
  box-sizing: border-box !important;
}

  #app2 .group {
    padding: 6px 5px;
    margin: 5px 0;
    border-radius: 6px;
  }

  #app2 .group h3,
#app2 .group .group-title {
  font-size: 15px !important;   /* â† è¡¨é¡Œã‚’å°ã•ã‚ã« */
  margin-bottom: 8px !important;
  line-height: 1.3 !important;
}


  /* app2 å„é …ç›®åï¼ˆãƒ©ãƒ™ãƒ«å·¦å´ï¼‰ */
  body[data-active-app="app2"] #app2 .group label span,
  body[data-active-app="app2"] #app2 .group label strong,
  body[data-active-app="app2"] #app2 .group label b {
    font-size: 11px !important;   /* â† ãƒ•ã‚©ãƒ³ãƒˆã‚’å°ã•ã */
    min-width: 50px !important;   /* â† æ¨ªå¹…ã‚’ã•ã‚‰ã«å°ã•ã */
    max-width: 100px !important;  /* â† ã¯ã¿å‡ºã—é˜²æ­¢ */
    line-height: 1.2 !important;
    flex-shrink: 1 !important;    /* â† ç¸®å°ã‚’è¨±å¯ */
    white-space: nowrap;          /* â† æ”¹è¡Œã›ãšã«åã‚ã‚‹ */
  }

  :root{
    --tabs-h: 40px;   /* SPæƒ³å®šï¼ˆ.tab: padding 9px / fs 15pxï¼‰*/
    --subnav-h: 40px; /* SPã®ã‚µãƒ–ãƒŠãƒ“å®Ÿé«˜ */
  }

    #app2 .bottle-form {
    flex-wrap: wrap;
    gap: 6px;
    padding: 5px;
  }

  #app2 .bottle-form .left-group {
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
  }

  #app2 .bottle-form select.bottleDetails {
    flex: 1 1 100%;
    max-width: 100%;
  }

  #app2 .bottle-form input.splitCount,
  #app2 .bottle-form input.bottleQuantity,
  #app2 .bottle-form input.bottleAmount {
    flex: 1 1 30%;
    min-width: 70px;
    max-width: 100%;
  }

  #app2 .bottle-form input.bottleAmount {
    margin-left: 0; /* ã‚¹ãƒãƒ›ã§ã¯é€šå¸¸ä¸¦ã³ */
  }

    #app2 .bottle-form .delete-btn {
    order: -1;              /* â† å…ˆé ­ã«æŒã£ã¦ãã‚‹ */
    margin: 0 auto 6px;     /* ä¸­å¤®ã«é…ç½® */
    display: block;
  }

  /* æŠ˜ã‚ŠãŸãŸã¿ï¼ˆãƒœãƒ‡ã‚£ã®é«˜ã•ã‚’ã‚¢ãƒ‹ãƒ¡ã§å‡ºã—å…¥ã‚Œï¼‰ */
  #historyIndexTable tbody{
    display:block;                 /* é«˜ã•ã‚¢ãƒ‹ãƒ¡ã®ãŸã‚blockåŒ– */
    max-height: 180px;             /* å±•é–‹æ™‚ã®ä¸Šé™ï¼ˆå¥½ã¿ã§ï¼‰ */
    overflow: hidden;
    transition: max-height .25s ease;
  }
  #historyIndexTable.collapsed tbody{
    max-height: 0;
  }

}

@media (min-width:700px){
  #app1 table{ table-layout:fixed; width:100%; }
  #app1 th, #app1 td{ padding:6px 6px; vertical-align:middle; }

  /* 10åˆ—å‰²å½“ */
  #app1 tr.row > td:nth-child(1){ width:50px;  text-align:center; }  /* å‰Šé™¤ */
  #app1 tr.row > td:nth-child(2){ width:40px;  text-align:center; }  /* è¡Œç•ªå· */
  #app1 tr.row > td:nth-child(3){ width:70px;  }                     /* å“ç•ª */
  #app1 tr.row > td:nth-child(4){ width:70px;  }                     /* æœ¬æŒ‡ */
  #app1 tr.row > td:nth-child(5){ width:90px;  }                     /* åŒºåˆ† */
  #app1 tr.row > td:nth-child(6){ width:120px; text-align:right; }   /* é‡‘é¡ */
  #app1 tr.row > td:nth-child(7){ width:60px;  text-align:center; }  /* äººæ•° */
  #app1 tr.row > td:nth-child(8){ width:90px;  }                     /* è©³ç´° */
  #app1 tr.row > td:nth-child(9){ width:100px; }                     /* ã‚«ãƒ¼ãƒ‰ */
  #app1 tr.row > td:nth-child(10){ width:120px; text-align:right; }  /* ç·åˆè¨ˆ */

  #app1 input, #app1 select{
    width:100% !important; max-width:100% !important;
    height:32px; padding:4px 6px; font-size:15px; box-sizing:border-box;
  }



  body[data-active-app="app2"] #app2-sideNav {
    width: 130px !important;
    right: 10px !important;
  }

body[data-active-app="app2"] #app2 {
  margin-right: 0 !important;
}

    .subnav {
    top: calc(var(--tabs-h) + 4px) !important;   /* å¥½ã¿ã§ 2ã€œ6px èª¿æ•´ */
    padding-top: 4px; height: calc(var(--subnav-h) + 4px);
  }

}

@media (max-width: 700px) {
  /* ã‚¹ãƒãƒ›æ™‚ï¼šå±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‹­ã‚ã‚‹ */
  /* å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåŒ– */
  #historyIndexTable {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: flex-END !important; /* â† å·¦å¯„ã›ã«å¤‰æ›´ */
    align-items: flex-start !important; /* â† stretchã‚’flex-startã«å¤‰æ›´ï¼ˆã“ã‚ŒãŒè‚ï¼‰ */
    gap: 6px !important;
    padding: 6px 4px !important;
    width: 100% !important;
    background: rgba(20,28,40,0.82) !important;
    border: 1px solid rgba(0,245,255,0.25) !important;
    border-radius: 10px !important;
    box-shadow: 0 0 18px #00eaff22 !important;
    box-sizing: border-box !important;
  }

  #historyIndexTable tr,
  #historyIndexTable td,
  #historyIndexBody {
    display: contents !important; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œ/åˆ—æ§‹é€ ã‚’ç„¡è¦–ã—ã¦ä¸¦ã¹ã‚‹ */
  }

  /* å±¥æ­´ãƒœã‚¿ãƒ³ã‚’3åˆ—ä¸¦ã³ï¼‹ä¸­å¤®å¯„ã› */
  #historyIndexTable .idx-btn {
    flex: 0 0 calc(33.333% - 6px) !important;  /* â† 3åˆ—ç¶­æŒã—ã¤ã¤å·¦å¯„ã› */
    display: block !important;
    height: auto !important;          /* â† é«˜ã•ã‚’è‡ªå‹•ã« */
    line-height: 1.4 !important;      /* â† ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤®ã«è¦‹ãˆã‚‹ã‚ˆã†ã« */
    box-sizing: border-box !important;
    text-align: center !important;
    padding: 6px 0 !important;        /* â† æŠ¼ã—ã‚„ã™ã */
    font-size: 13px !important;
    white-space: nowrap !important;
    border: 1px solid #00eaff !important;
    border-radius: 8px !important;
    background: rgba(0,245,255,.08) !important;
    color: #00f5ff !important;
    transition: transform .15s, background .15s, color .15s !important;
  }

    #historyIndexTable .idx-btn:hover {
    background: #00f5ff !important;
    color: #111 !important;
    transform: translateY(-2px) scale(1.03) !important;
  }

  /* å…¨ä½“èª¿æ•´ */
  #historyIndexTable .history-chip-row {
    display: contents !important; /* flexå†…ã§çµ±åˆ */
  }
  
}



#app2-historySection .history-item {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

/* å‡ºåŠ›ãƒœã‚¿ãƒ³ï¼šå¾©å…ƒãƒœã‚¿ãƒ³ã¨åŒã˜å½¢çŠ¶ãƒ»èµ¤æ–‡å­— */
#app2-historySection .output-btn {
  background: linear-gradient(90deg, #00f5ff55 30%, #197b91 100%); /* å¾©å…ƒã¨åŒã˜èƒŒæ™¯ */
  color: #ff4d4d; /* ğŸ”´ èµ¤æ–‡å­— */
  border: 1px solid #00f5ff; /* æ ã‚‚åŒä¸€ */
  border-radius: 10px;
  font-size: 14px;
  padding: 6px 14px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 0 8px rgba(0, 245, 255, 0.3);
}

#app2-historySection .output-btn:hover {
  background: #00f5ff;
  color: #d40000; /* hoverã§æ¿ƒã„èµ¤æ–‡å­— */
  box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
}




</style>






</head>
<body>

<div id="resetOverlay" style="display:none;">
  <canvas id="matrixCanvas"></canvas>
  <div id="resetFlash"></div>
</div>
  
<div class="tabs">
  <div class="tab active" data-target="app1">ä¼ç¥¨å…¥åŠ›</div>
  <div class="tab" data-target="app2">å ±é…¬è¨ˆç®—</div>
  <div class="tab" data-target="app3">æ—¥è¨ˆè¨ˆç®—</div>
</div>

<!-- app1 ç”¨ã‚µãƒ–ãƒŠãƒ“ -->
<nav id="app1-nav" class="subnav">
  <button data-target="editSection">ç·¨é›†</button>
  <button data-target="summarySection">é›†è¨ˆ</button>
  <button data-target="categorySection">CB</button>
</nav>

<!-- app2 ç”¨ã‚µãƒ–ãƒŠãƒ“ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
<nav id="app2-nav" class="subnav">
  <button data-target="app2-inputSection">ç›®æ¬¡</button>
  <button data-target="app2-resultSection">çµæœ</button>
  <button data-target="app2-historySection">å±¥æ­´</button>
</nav>

  <!-- app2 ç”¨ã‚µãƒ–ãƒŠãƒ“ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
  <nav id="app3-nav" class="subnav">
   <button data-target="app3-inputSection">è¨˜å…¥</button>
   <button data-target="app3-profitSection">åˆ©ç›Š</button>
   <button data-target="app3-envelopeSection">å°ç­’</button>
  </nav>

<div id="app1" class="content active">
 <section id="editSection">
 <div class="tab">

  <button class="tablinks" onclick="filterCategory('all')">ã™ã¹ã¦è¡¨ç¤º</button>
  <button class="tablinks" onclick="filterCashOnlyRows()">ç¾é‡‘ã®ã¿æŠ½å‡º</button>
  <button class="tablinks" onclick="filterCardInputRows()">ã‚«ãƒ¼ãƒ‰æŠ½å‡º</button>
  <button class="tablinks" onclick="filterCategory('UK')">UK</button>
  <button class="tablinks" onclick="filterCategory('K')">K</button>
  <button class="tablinks" onclick="filterCategory('AB')">AB</button>
  <button class="tablinks" onclick="filterCategory('LA')">LA</button>
  <button class="tablinks" onclick="filterCategory('PA')">PA</button>
  <button class="tablinks" onclick="filterCategory('BB')">BB</button>
  <button class="tablinks" onclick="filterCategory('MS')">MS</button>
  <button class="tablinks" onclick="filterCategory('GM')">GM</button>
  <button class="tablinks" onclick="filterCategory('B')">B</button>
  <button class="tablinks" onclick="filterCategory('JOE')">JOE</button>
  <button class="tablinks" onclick="filterCategory('KOSE')">KOSE</button>
  <button class="tablinks" onclick="filterCategory('HE')">HE</button>
  <button class="tablinks" onclick="filterCategory('PB')">PB</button>
  <button class="tablinks" onclick="filterCategory('X')">X</button>
  <button class="tablinks" onclick="filterCategory('Z')">Z</button>
</div>

<table>
  <tbody id="formRows">
    <tr class="row">
      <td><button class="delete-btn" onclick="deleteRow(this)">Ã—</button></td>
      <td class="rowNumber">1</td>
      <td><input class="table-number" type="text" inputmode="numeric" pattern="\d*" placeholder="å“ç•ª" oninput="updateTotals()" /></td>
      <td><input class="honshi" type="text" inputmode="numeric" pattern="\d*" placeholder="æœ¬æŒ‡" oninput="updateTotals()" /></td>
      <td>
        <select class="c" oninput="updateRowColor(this); updateTotals()">
          <option value="">-</option>
          <option value="UK">UK</option>
          <option value="K">K</option>
          <option value="AB">AB</option>
          <option value="LA">LA</option>
          <option value="PA">PA</option>
          <option value="BB">BB</option>
          <option value="MS">MS</option>
          <option value="GM">GM</option>
          <option value="B">B</option>
          <option value="JOE">JOE</option>
          <option value="KOSE">KOSE</option>
          <option value="HE">HE</option>
          <option value="PB">PB</option>
          <option value="X">X</option>
          <option value="Z">Z</option>
        </select>

        

      </td>
      <td><input class="amount" type="text" inputmode="numeric" pattern="\d*" placeholder="é‡‘é¡" oninput="updateTotals()" /></td>
      <td><input class="num" type="text" inputmode="numeric" pattern="\d*" placeholder="äººæ•°" oninput="updateTotals()" /></td>
      <td><input class="detail" type="text" placeholder="è©³ç´°" /></td>
      <td><input class="card" type="text" inputmode="numeric" pattern="\d*" placeholder="ã‚«ãƒ¼ãƒ‰" oninput="updateTotals()" /></td>
      <td><input class="total" type="text" inputmode="numeric" pattern="\d*" placeholder="ç·åˆè¨ˆ" oninput="updateTotals()" /></td>
    </tr>
  </tbody>
</table>

<div class="ticket-toolbar">
  <button class="add-btn" onclick="addRow()">ä¼ç¥¨<br>è¿½åŠ </button>

  <div class="search-box">
    <input type="text" id="searchAmount" placeholder="é‡‘é¡ã§æ¤œç´¢" inputmode="numeric">
    <button onclick="searchByAmount()">æ¤œç´¢</button>
    <button onclick="resetSearch()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

</section>

<section id="summarySection">
 <p>ç·å®¢æ•°: <span id="totalCustomers">0</span></p>
 <p>ç¾é‡‘åˆè¨ˆ: <span id="cashTotal">0</span></p>
 <p>ã‚«ãƒ¼ãƒ‰åˆè¨ˆ: <span id="cardTotal">0</span></p>
 <p>ç·åˆè¨ˆé‡‘é¡: <span id="totalAmount">0</span></p>
</section>

<section id="categorySection">
  <table>
  <thead>
    <tr>
      <th>ã‚«ãƒ†ã‚´ãƒª</th>
      <th>äººæ•°</th>
      <th>ãƒãƒƒã‚¯é‡‘é¡</th>
    </tr>
  </thead>
  <tbody>
<tr><td><input type="checkbox"> UK</td><td id="UKcount">0</td><td><span id="UKtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('UK')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> K</td><td id="Kcount">0</td><td><span id="Ktotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('K')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> AB</td><td id="ABcount">0</td><td><span id="ABtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('AB')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> LA</td><td id="LAcount">0</td><td><span id="LAtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('LA')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> PA</td><td id="PAcount">0</td><td><span id="PAtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('PA')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> BB</td><td id="BBcount">0</td><td><span id="BBtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('BB')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> MS</td><td id="MScount">0</td><td><span id="MStotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('MS')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> GM</td><td id="GMcount">0</td><td><span id="GMtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('GM')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> B</td><td id="Bcount">0</td><td><span id="Btotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('B')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> JOE</td><td id="JOEcount">0</td><td><span id="JOEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('JOE')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> KOSE</td><td id="KOSEcount">0</td><td><span id="KOSEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('KOSE')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> HE</td><td id="HEcount">0</td><td><span id="HEtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('HE')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> PB</td><td id="PBcount">0</td><td><span id="PBtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('PB')">å‡ºåŠ›</button></td></tr>
<tr><td><input type="checkbox"> X</td><td id="Xcount">0</td><td><span id="Xtotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('X')">å‡ºåŠ›</button></td></tr>
<tr style="display: none;"><td><input type="checkbox"> Z</td><td id="Zcount">0</td><td><span id="Ztotal">0</span><button type="button" class="print-mini" onclick="printEnvelopeApp1('Z')">å‡ºåŠ›</button></td></tr>
      <tr>
       <td><strong>åˆè¨ˆ</strong></td>
       <td id="totalCountCell">
       <button type="button" class="print-mini" onclick="printEnvelopeApp1('ALL')">å‡ºåŠ›</button>
       <span id="totalCountValue" class="count-value">1</span>
       </td>
    <td id="totalBackAmount">0</td>
  </tr>
  </tbody>
 </table>
 </section>
</div>

<!-- app2 ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼ˆå³å›ºå®šï¼‰ -->
<nav id="app2-sideNav" aria-label="app2 quick navigation">
  <div class="sideNav-title">SIDE NAV</div>
  <ul>
    <!-- data-target ã¯ â€œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å…ˆã®IDâ€ ã‚’æŒ‡å®š -->
    <li><button type="button" data-target="castName">æ°å</button></li>
    <li><button type="button" data-target="f">FB</button></li>
    <li><button type="button" data-target="honshiri">æŒ‡å</button></li>
    <li><button type="button" data-target="set40">SET</button></li>
    <li><button type="button" data-target="a">Drink</button></li>
    <li><button id="side-calc">è¨ˆç®—</button></li>
    <li><button id="side-print" onclick="preparePrintApp2()">å‡ºåŠ›</button></li>
    <li><button type="button" data-target="app2-resultSection">çµæœ</button></li>
    <li><button id="side-clear" class="red-btn">ã‚¯ãƒªã‚¢</button></li>
    <li><button id="side-scroll-history">å±¥æ­´</button></li>
  </ul>
</nav>


<div id="app2" class="content">

  <div style="text-align: center; margin-top: 30px;">

  <section id="app2-inputSection">

<!-- â–¼ å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç‰ˆï¼‰ -->
<table id="historyIndexTable" class="history-index-table">
<thead>
  <tr>
    <th>
      <div class="history-index-head">
        <span class="history-index-title">å±¥æ­´</span>
        <span id="historyIndexCount" class="history-index-count">0äºº</span>
      </div>
    </th>
  </tr>
</thead>
  <tbody id="historyIndexBody">
    <!-- JSã§ãƒœã‚¿ãƒ³è¡ŒãŒå…¥ã‚Šã¾ã™ -->
  </tbody>
</table>
<!-- â–² å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ -->

    <form autocomplete="off" onsubmit="return confirmAndCalculate(event);">

      <div class="group" style="background:#2e2e2e">
        <label>ã‚­ãƒ£ã‚¹ãƒˆå:
         <input type="text" id="castName"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="åå‰ã‚’å…¥åŠ›">
        </label>
        <label>ä½“é¨“åŠã³è²¸å‡º:
        <input type="checkbox" id="experienceAndRental"
          autocomplete="off" autocapitalize="off" spellcheck="false">
        </label>
        <label>é€è¿:
        <input type="text" inputmode="numeric" pattern="\d*"
          id="sendoffAmount"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="é€è¿é‡‘é¡">
        </label>
      </div>

      <div class="group group-basic">
       <h3>ãƒ•ãƒªãƒ¼ãƒãƒƒã‚¯</h3>
       <label>F1ï¼ˆÂ¥1500ï¼‰:
        <input type="text" inputmode="numeric" pattern="\d*"
          id="f"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="F1">
       </label>
       <label>F2ï¼ˆÂ¥2000ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="f2"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="F2">
        </label>
          <label>å ´å†…ï¼ˆÂ¥1000ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="jounai"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="å ´å†…">
        </label>
      </div>

      <div class="group group-shimei">
        <h3>æŒ‡åãƒ»åŒä¼´ãƒ»æãƒ»HELP</h3>
        <label>æœ¬æŒ‡ï¼ˆÂ¥0ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="honshiri"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="æœ¬æŒ‡">
        </label>
        <label>åŒä¼´ï¼ˆÂ¥1500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="douhan"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="åŒä¼´">
        </label>
        <label>æï¼ˆÂ¥500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="eda"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="æ">
        </label>
        <label>HELPï¼ˆ-Â¥1500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="help"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="HELP">
        </label>
      </div>

      <div class="group group-set">
        <h3>ã‚»ãƒƒãƒˆãƒ»VIP</h3>
        <label>SET40ï¼ˆÂ¥5500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="set40"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="SET40">
        </label>
        <label>SET20ï¼ˆÂ¥3500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="set20"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="SET20">
        </label>
        <label>VIPï¼ˆÂ¥2000ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="vip"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="VIP">
        </label>
      </div>

      <div class="group group-option">
        <h3>ãƒ‰ãƒªãƒ³ã‚¯ãƒ»ãã®ä»–</h3>
        <label>Aï¼ˆÂ¥500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="a"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="A">
        </label>
        <label>Bï¼ˆÂ¥1000ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="b"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="B">
        </label>
        <label>Cï¼ˆÂ¥1500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="c"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="C">
        </label>
        <label>Dï¼ˆÂ¥2000ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="d"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="D">
        </label>
        <label>Eï¼ˆÂ¥2500ï¼‰:
          <input type="text" inputmode="numeric" pattern="\d*"
          id="e"
          autocomplete="off" autocapitalize="off" spellcheck="false"
          placeholder="E">
        </label>

        <div id="bottleFormsContainer"></div>
        <button type="button" onclick="addBottleForm()">ãƒœãƒˆãƒ«è¿½åŠ </button>
      </div>
    

      <div class="button-row" style="margin-top: 20px;">
      <button type="submit">è¨ˆç®—ã™ã‚‹</button>
      </div>
      <div class="button-row" style="margin-top: 10px; justify-content: center;">



    </form>

  </section>

  <section id="app2-resultSection">

      <button type="button" class="red-btn" onclick="clearApp2Inputs()">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
      </div>

    <div class="result" id="result"></div>
      <div class="button-row" style="margin-top: 20px;">
      <button type="button" class="print-button" onclick="preparePrintApp2()">å‡ºåŠ›</button>
    </div>

      <div class="button-row" style="margin-top: 20px;">
      <button type="button" class="red-btn" onclick="clearApp2Inputs()">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    
  </section>

  <section id="app2-historySection">

    <div class="history">
      <h3>å±¥æ­´</h3>
      <ul id="historyList"></ul>
      </div>


      <button id="deleteSelectedBtn" onclick="deleteSelectedHistory()">é¸æŠã—ãŸå±¥æ­´ã‚’å‰Šé™¤</button>

      <div class="summary" id="summary">
        å±¥æ­´ã®åˆè¨ˆäººæ•°:<span id="summaryTotalPeople">0äºº</span> |
        åˆè¨ˆé‡‘é¡:<span id="summaryTotalAmount">Â¥0</span> |
        åˆè¨ˆæºæ³‰è²»:<span id="summaryTotalTax">Â¥0</span>
      </div>

    <div class="button-row" style="margin-top: 40px;"><button type="button" class="red-btn" onclick="resetApp('app2', true)">å®Œå…¨ã‚¯ãƒªã‚¢</button>
    </div>

  </section>

</div>




<div id="app3" class="content">

<div class="group no-bg">
    <label><span>é–‹å§‹æ™‚é‡‘åº«é‡‘:</span> <input type="text" inputmode="numeric" pattern="\d*" id="startCash" oninput="updateCalculations()"></label>
  </div>

  <table class="outer-table" style="width: 100%; border: 2px solid #333; border-collapse: collapse; margin-bottom: 20px;">
  <tr>
    <td style="padding: 10px;">

      <section id="app3-inputSection">
      <div class="group" id="salesGroup">
        <label><span>ç¾é‡‘å£²ä¸Š:</span> <input type="text" id="cashSales" disabled></label>
        <label><span>ã‚«ãƒ¼ãƒ‰å£²ä¸Š:</span> <input type="text" id="cardSales" disabled></label>
        <label><span>å£²ä¸Šåˆè¨ˆ:</span> <input type="text" id="totalSales" disabled></label>
      </div>

      <div class="group" id="laborGroup">
        <label><span>å¥³å­çµ¦ä¸:</span> <input type="text" id="femaleSalary" disabled></label>
        <label><span>ç”·å­çµ¦ä¸:</span> <input type="text" inputmode="numeric" pattern="\d*" id="maleSalary" oninput="updateCalculations()">
        </label>
        <label><span>ã‚­ãƒ£ãƒƒãƒãƒãƒƒã‚¯:</span> <input type="text" id="catchBack" disabled></label>
        <label><span>ã‚¹ã‚«ã‚¦ãƒˆãƒãƒƒã‚¯:</span> <input type="text" inputmode="numeric" pattern="\d*" id="scoutBack" oninput="updateCalculations()">
        </label>
        <label><span>é¡§å•æ–™:</span> <input type="text" id="adviserFee" disabled></label>
        <label><span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ä»£:</span> <input type="text" inputmode="numeric" pattern="\d*" id="driverFee" oninput="updateCalculations()">
        </label>
        <label><span>äººä»¶è²»åˆè¨ˆ:</span> <input type="text" id="totalLaborCosts" disabled>
        </label>
      </div>

      <div class="group" id="taxGroup">
        <label><span>å¥³å­æºæ³‰è²»:</span> <input type="text" id="femaleTax" disabled></label>
        <label><span>ç”·å­æºæ³‰è²»:</span> <input type="text" inputmode="numeric" pattern="\d*" id="maleTax" oninput="updateCalculations()"></label>
        <label><span>æºæ³‰è²»åˆè¨ˆ:</span> <input type="text" id="totalTax" disabled></label>
      </div>

      <div class="group" id="expensesGroup">
        <label><span>é…’ä»£:</span> <input type="text" inputmode="numeric" pattern="\d*" id="alcohol" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸â‘ :</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt1" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸â‘¡:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt2" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸â‘¢:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt3" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸â‘£:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt4" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸â‘¤:</span> <input type="text" inputmode="numeric" pattern="\d*" id="receipt5" oninput="updateCalculations()"></label>
        <label><span>é ˜åæ›¸åˆè¨ˆ:</span> <input type="text" id="receipt6" disabled></label>
        <label><span>çµŒè²»åˆè¨ˆ:</span> <input type="text" id="totalExpenses" disabled></label>
      </div>
      </section>

      <section id="app3-profitSection">
      <div class="group" id="resultsGroup">
        <label><span>ç²—åˆ©ç›Š:</span> <input type="text" id="grossProfit" disabled></label>
        <label><span>ç¾é‡‘æ®‹:</span> <input type="text" id="remainingCash" disabled></label>
      </div>
      </section>

     </td>
    </tr>
  </table>

  <table class="outer-table" style="width: 100%; border: 2px solid #333; border-collapse: collapse; margin-bottom: 20px;">
   <tr>
    <td style="padding: 10px; background-color: #3e3e5a;">

      <section id="app3-envelopeSection">
      <div class="group" id="extraGroup">
        <label><span>ç²—åˆ©ç›Š:</span> <input type="text" id="grossProfit_extra" disabled></label>
        <label><span>ã‚«ãƒ¼ãƒ‰å£²ä¸Š:</span> <input type="text" id="cardSales_extra" disabled></label>
        <label><span>ç¾é‡‘æ®‹:</span> <input type="text" id="remainingCash_extra" disabled></label>
        <label><span>æºæ³‰è²»åˆè¨ˆ:</span> <input type="text" id="totalWithholdingTax" disabled></label>

        <div style="height: 1em;"></div>

        <label><span>åˆè¨ˆ (ç¾é‡‘æ®‹ + æºæ³‰è²»):</span><input type="text" id="totalGrossPlusTax" disabled></label>
      </div>
      </section>

    </td>
  </tr>
 </table>

  <div class="group no-bg">
    <label><span>é›†è¨ˆæå‡ºå‰é‡‘åº«é‡‘:</span> <input type="text" inputmode="numeric" pattern="\d*" id="finalCash" oninput="updateCalculations()"></label>
    <label><span>ç¾é‡‘èª¤å·®:</span> <input type="text" id="cashDifference" disabled></label>
  </div>

  <button type="button" onclick="resetApp('app3')" class="red-btn">ãƒªã‚»ãƒƒãƒˆ</button>
  <button type="button" onclick="resetAllApps()" class="red-btn">å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <div style="text-align: center; margin-top: 20px;">
  <button onclick="exportAsFilledHTML()">å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜</button>
  <div style="text-align: center; margin-top: 40px; font-size: 12px; color: #888;">
  </div>

</div> <!-- app3ã‚’é–‰ã˜ã‚‹ -->






































<script>

//<base script---------------------------------------------------------------------------------------------------------------->
  function updateAdviserFeeFromTotalCount() {
    const countEl = document.getElementById('totalCountValue');
    const adviserFeeInput = document.getElementById('adviserFee');

    if (!countEl || !adviserFeeInput) return;

    const count = parseInt(countEl.textContent.replace(/,/g, ''), 10) || 0;
    const fee = count * 1000;
    adviserFeeInput.value = fee;

    updateCalculations(); // å¿…è¦ã«å¿œã˜ã¦å†è¨ˆç®—
  }

  function observeTotalCountForAdviserFee() {
    const target = document.getElementById('totalCountValue');
    if (!target) return;

    const observer = new MutationObserver(() => {
      updateAdviserFeeFromTotalCount();
    });

    observer.observe(target, {
      childList: true,
      characterData: true,
      subtree: true,
    });
  }

document.addEventListener('gesturestart', function (e) {
  e.preventDefault();
});

let startY = 0;

document.addEventListener('touchstart', function (e) {
  startY = e.touches[0].clientY;
}, { passive: false });

document.addEventListener('touchmove', function (e) {
  const currentY = e.touches[0].clientY;

  // ä¸Šæ–¹å‘ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã‚ˆã†ã¨ã—ã¦ã„ã¦ã€ãƒšãƒ¼ã‚¸ãŒä¸€ç•ªä¸Šã«ã„ã‚‹ã¨ã
  if (currentY > startY && window.scrollY === 0) {
    e.preventDefault(); // iOS Safari ã§Pull-to-Refreshã‚’é˜²æ­¢
  }
}, { passive: false });

// ---- å›ºå®šãƒ˜ãƒƒãƒ€(ã‚¿ãƒ–+å¯è¦–ã‚µãƒ–ãƒŠãƒ“)è¾¼ã¿ã§ç›®çš„åœ°ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ----
function scrollToFixed(targetId) {
  const target = document.getElementById(targetId);
  if (!target) return;

  const tabsH = document.querySelector('.tabs')?.offsetHeight || 0;
  const visibleSub = Array.from(document.querySelectorAll('nav.subnav'))
    .find(n => getComputedStyle(n).display !== 'none');
  const subH = visibleSub?.offsetHeight || 0;

  // å¿µã®ãŸã‚ã‚µãƒ–ãƒŠãƒ“ã® top ã‚‚åŠ å‘³ï¼ˆCSSã§top:80pxï¼‰
  const subTop = visibleSub ? parseInt(getComputedStyle(visibleSub).top || '0', 10) : 0;

  const offset = tabsH + subH + subTop + 20;     // ä½™ç™½+20
  const y = target.getBoundingClientRect().top + window.pageYOffset - offset;
  window.scrollTo({ top: y, behavior: 'smooth' });

  // å…¥åŠ›æ¬„ãŒã‚ã‚‹ãªã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆä»»æ„ï¼‰
  const focusable = target.matches('input,select,textarea,button')
      ? target
      : target.querySelector('input,select,textarea,button');
  focusable?.focus();
}

// å…±é€šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢æ•°ï¼ˆã‚µã‚¤ãƒ‰ï¼ã‚µãƒ–ãƒŠãƒ“ç”¨ï¼‰
function scrollWithOffset(targetId) {
  const target = document.getElementById(targetId);
  if (target) {
    const navHeight = 140; // ã‚¿ãƒ–(80px) + ã‚µãƒ–ãƒŠãƒ“(50px) + ä½™ç™½10px
    const y = target.getBoundingClientRect().top + window.pageYOffset - navHeight;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
}

/* ========= ãƒŠãƒ“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’çµ±ä¸€ ========= */

// CSSå¤‰æ•°ã‹ã‚‰ã‚¿ãƒ–/ã‚µãƒ–ãƒŠãƒ“é«˜ã•(px)ã‚’å–å¾—
function _pxVar(name, fallback = 0){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return v.endsWith('px') ? parseFloat(v) : (parseFloat(v) || fallback);
}
function _currentSubnavH(){
  const nav = document.querySelector(
    'body[data-active-app="app1"] #app1-nav,'+
    'body[data-active-app="app2"] #app2-nav,'+
    'body[data-active-app="app3"] #app3-nav'
  );
  return nav ? nav.offsetHeight : _pxVar('--subnav-h', 50);
}
function _scrollOffset(){
  return Math.round(_pxVar('--tabs-h', 56) + _currentSubnavH() + 70);
}

function _behavior(want='smooth'){
  return matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : want;
}

let _scrolling = false;
window.navScrollTo = function(targetId, behavior='smooth'){
  const el = document.getElementById(targetId);
  if (!el) return;

  const top = window.pageYOffset + el.getBoundingClientRect().top - _scrollOffset();
  const finalTop = Math.max(0, Math.floor(top));

  if (_scrolling) return;
  _scrolling = true;

  window.scrollTo({ top: finalTop, behavior: _behavior(behavior) });

  setTimeout(() => { _scrolling = false; }, 600);
};

// ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚µãƒ–ãƒŠãƒ“ãƒ»ã‚µã‚¤ãƒ‰ãƒŠãƒ“ï¼‰
['#app1-nav', '#app2-nav', '#app3-nav', '#app2-sideNav'].forEach(sel => {
  const nav = document.querySelector(sel);
  if (!nav) return;
  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-target]');
    if (!btn) return;
    e.preventDefault();
    navScrollTo(btn.getAttribute('data-target'), 'smooth');
  }, { passive:false });
});

// å±¥æ­´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ navScrollTo ã«çµ±ä¸€
document.getElementById('side-scroll-history')?.addEventListener('click', (e) => {
  e.preventDefault();
  navScrollTo('app2-historySection', 'smooth');
});

// ã‚¢ãƒ³ã‚«ãƒ¼ç›´é£›ã³é˜²æ­¢
(() => {
  const style = document.createElement('style');
  style.textContent = `html { scroll-behavior: auto !important; }`;
  document.head.appendChild(style);
})();








































//<app1 script---------------------------------------------------------------------------------------------------------------->
//ä¼ç¥¨æ¤œç´¢æ©Ÿèƒ½
function searchByAmount() {
  const input = document.getElementById('searchAmount').value.replace(/,/g, '').trim();
  const rows = document.querySelectorAll('#formRows tr');
  let foundRow = null;

  rows.forEach(row => {
    const totalValue = row.querySelector('.total')?.value.replace(/,/g, '') || '';
    const shouldShow = (input === '' || totalValue.includes(input));

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨: æœ€åˆã«è¦‹ã¤ã‹ã£ãŸè¡Œã ã‘è¨˜æ†¶
    if (shouldShow && !foundRow) {
      foundRow = row;
    }
  });

  // æ¤œç´¢å€¤ãŒç©ºæ¬„ã§ãªã‘ã‚Œã°ã€ãƒ’ãƒƒãƒˆæ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€ãªã‘ã‚Œã°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  if (input !== '') {
    if (foundRow) {
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãƒ»ä¸­å¤®å¯„ã›ï¼‰
      foundRow.scrollIntoView({ behavior: "smooth", block: "center" });
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãŸã„å ´åˆã¯ä¸‹è¨˜ã‚‚è¿½åŠ OK
      // foundRow.classList.add('highlight');
    } else {
      window.alert("è©²å½“ã™ã‚‹ä¼ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
  }
}


function resetSearch() {
  document.getElementById('searchAmount').value = '';
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    if (row.style.display === 'none') {
      row.style.display = '';
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });
}

function saveCheckboxStates() {
  const checkboxes = document.querySelectorAll("table input[type='checkbox']");
  const states = Array.from(checkboxes).map(cb => cb.checked);
  localStorage.setItem("checkboxStates", JSON.stringify(states));
}

function restoreCheckboxStates() {
  const states = JSON.parse(localStorage.getItem("checkboxStates"));
  if (!states) return;
  const checkboxes = document.querySelectorAll("table input[type='checkbox']");
  checkboxes.forEach((cb, index) => {
    cb.checked = states[index];
  });
}

let rowNumber = 2;

function createEmptyRow(number) {
  const tr = document.createElement('tr');
  tr.className = "row";
  tr.innerHTML = `
    <td><button class="delete-btn" onclick="deleteRow(this)">Ã—</button></td>
    <td class="rowNumber">${number}</td>
    <td><input class="table-number" type="text" inputmode="numeric" placeholder="å“ç•ª" oninput="updateTotals()" /></td>
    <td><input class="honshi" type="text" inputmode="numeric" placeholder="æœ¬æŒ‡" oninput="updateTotals()" /></td>
    <td>
      <select class="c" oninput="updateRowColor(this); updateTotals()">
        <option value="">-</option>
        <option value="UK">UK</option>
        <option value="K">K</option>
        <option value="AB">AB</option>
        <option value="LA">LA</option>
        <option value="PA">PA</option>
        <option value="BB">BB</option>
        <option value="MS">MS</option>
        <option value="GM">GM</option>
        <option value="B">B</option>
        <option value="JOE">JOE</option>
        <option value="KOSE">KOSE</option>
        <option value="HE">HE</option>
        <option value="PB">PB</option>
        <option value="X">X</option>
        <option value="Z">Z</option>
      </select>
    </td>
    <td><input class="amount" type="text" inputmode="numeric" placeholder="é‡‘é¡" oninput="updateTotals()" /></td>
    <td><input class="num" type="text" inputmode="numeric" placeholder="äººæ•°" oninput="updateTotals()" /></td>
    <td><input class="detail" type="text" placeholder="è©³ç´°" /></td>
    <td><input class="card" type="text" inputmode="numeric" placeholder="ã‚«ãƒ¼ãƒ‰" oninput="updateTotals()" /></td>
    <td><input class="total" type="text" inputmode="numeric" placeholder="ç·åˆè¨ˆ" oninput="updateTotals()" /></td>
  `;
  return tr;
}


function addRow() {
  const table = document.getElementById("formRows");
  const newRow = createEmptyRow(rowNumber++);

  table.appendChild(newRow);

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  requestAnimationFrame(() => newRow.classList.add('slide-in'));
  newRow.addEventListener('animationend', () => newRow.classList.remove('slide-in'));

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const rect = newRow.getBoundingClientRect();
  const offset = 155;
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  window.scrollTo({ top: rect.top + scrollTop - offset, behavior: 'smooth' });

  attachCommaFormatApp1and3();
  saveForm();
  renumberRows();
}



// Enter â†’ æ¬¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªAPPå†…ã§ã€è¡¨ç¤ºè¦ç´ ã®ã¿ï¼‰
document.addEventListener('keydown', function (e) {
  if (e.key !== 'Enter') return;

  const target = e.target;
  if (!(target instanceof HTMLElement)) return;
  if (!target.matches('input, select, textarea')) return;

  e.preventDefault();

  // ã„ã¾ã®APP IDï¼ˆapp1/app2/app3ï¼‰ã‚’ body å±æ€§ã‹ã‚‰å–å¾—
  const activeAppId = document.body.getAttribute('data-active-app') || '';
  // ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã€Œãã®å…¥åŠ›ãŒå±ã™ã‚‹ .contentã€> ãã‚ŒãŒç„¡ã‘ã‚Œã° activeApp > ãã‚Œã‚‚ç„¡ã‘ã‚Œã° document
  const scope =
    target.closest('.content') ||
    document.getElementById(activeAppId) ||
    document.body;

  // éè¡¨ç¤º(=offsetParentãŒnull)ã¯é™¤å¤–ã—ã¦ä¸¦ã³é †ã©ãŠã‚Šã«ç§»å‹•
  const formElements = Array.from(
    scope.querySelectorAll('input:not([type=hidden]):not([disabled]), textarea:not([disabled]), select:not([disabled])')
  ).filter(el => el.offsetParent !== null);

  const index = formElements.indexOf(target);
  const next = formElements[index + 1];
  if (next) {
    next.focus();
    if (typeof next.select === 'function') next.select();
  }
});


function updateRowColor(select) {
  const row = select.closest("tr");
  row.className = "row";
  if (select.value) {
    row.classList.add("category-" + select.value);
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚­ãƒ£ãƒƒãƒãƒãƒƒã‚¯å†…è¨³ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let catchbackDetails = {};

let _raf = 0;
function scheduleTotals(){
  if (_raf) return;
  _raf = requestAnimationFrame(()=>{ _raf = 0; updateTotals(); });
}

function updateTotals() {
  let totalCustomers = 0;
  let cardTotal = 0;
  let totalAmount = 0;

  const catchbackTotals = {};
  const categories = ["UK", "K", "AB", "LA", "PA", "BB", "MS", "GM", "B", "JOE", "KOSE", "HE", "PB", "X", "Z"];

  // åˆæœŸåŒ–
  categories.forEach(cat => {
    catchbackTotals[cat] = { amount: 0, count: 0 };
    catchbackDetails[cat] = [];   // â† å˜ä¾¡ã”ã¨ã®è¡Œãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã§ä¿æŒ
  });

  // å„è¡Œã‚’èµ°æŸ»ã—ã¦é›†è¨ˆ
  document.querySelectorAll(".row").forEach(row => {
    const num    = parseInt(row.querySelector(".num")?.value.replace(/,/g, '')) || 0;
    const honshi = parseInt(row.querySelector(".honshi")?.value.replace(/,/g, '')) || 0;
    const amount = parseInt(row.querySelector(".amount")?.value.replace(/,/g, '')) || 0;
    const card   = parseInt(row.querySelector(".card")?.value.replace(/,/g, '')) || 0;
    const total  = parseInt(row.querySelector(".total")?.value.replace(/,/g, '')) || 0;
    const category = row.querySelector(".c")?.value;

    // å…¨ä½“é›†è¨ˆ
    totalCustomers += num + honshi;
    cardTotal      += card;
    totalAmount    += total;

    // ã‚­ãƒ£ãƒƒãƒãƒãƒƒã‚¯é›†è¨ˆ
    if (category && catchbackTotals[category]) {
      // 20% or 30% ã®ãƒãƒƒã‚¯è¨ˆç®—
      const backAmount = (amount <= 5999) ? amount * num * 0.2 : amount * num * 0.3;

      if (category !== "Z") {  // Zã¯é›†è¨ˆå¯¾è±¡å¤–
        catchbackTotals[category].amount += backAmount;
        catchbackTotals[category].count  += num;

        if (num > 0) {
          // â† è¡Œã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¨˜éŒ²
          catchbackDetails[category].push({
            unit: amount,
            count: num
          });
        }
      }
    }
  });

  // åˆè¨ˆã®å†è¨ˆç®— & DOMåæ˜ 
  let totalCount = 0;
  let totalBackAmount = 0;

  categories.forEach(cat => {
    if (cat !== "X") {
      totalCount += catchbackTotals[cat].count;
      totalBackAmount += catchbackTotals[cat].amount;
    } else {
      totalBackAmount += catchbackTotals[cat].amount;
    }

    document.getElementById(`${cat}count`).textContent =
      catchbackTotals[cat].count.toLocaleString();

    document.getElementById(`${cat}total`).textContent =
      Math.floor(catchbackTotals[cat].amount).toLocaleString();
  });

  // å…¨ä½“åˆè¨ˆã®è¡¨ç¤º
  document.getElementById("totalCustomers").textContent = totalCustomers.toLocaleString();
  document.getElementById("cardTotal").textContent      = cardTotal.toLocaleString();
  document.getElementById("cashTotal").textContent      = (totalAmount - cardTotal).toLocaleString();
  document.getElementById("totalAmount").textContent    = totalAmount.toLocaleString();
  document.getElementById("totalCountValue").textContent= totalCount.toLocaleString();
  document.getElementById("totalBackAmount").textContent= Math.floor(totalBackAmount).toLocaleString();

  // å…¥åŠ›æ¬„ã«ã‚‚åæ˜ 
  const cardSalesInput = document.getElementById("cardSales");
  if (cardSalesInput) cardSalesInput.value = formatNumber(cardTotal);

  const totalSalesInput = document.getElementById("totalSales");
  if (totalSalesInput) totalSalesInput.value = formatNumber(totalAmount);

  if (!window.catchbackDetails) window.catchbackDetails = {};
window.catchbackDetails = {}; // åˆæœŸåŒ–

document.querySelectorAll('#formRows tr').forEach(row => {
  const c = row.querySelector('.c')?.value || '';
  if (!c) return;

  const num  = parseInt((row.querySelector('.num')?.value || '0').replace(/,/g,''), 10);    // æœ¬æ•°
  const unit = parseInt((row.querySelector('.amount')?.value || '0').replace(/,/g,''), 10); // å˜ä¾¡ï¼ˆé‡‘é¡ï¼‰
  const detail = row.querySelector('.detail')?.value || '';

  const amount = unit * num; // åˆè¨ˆé‡‘é¡

  (window.catchbackDetails[c] ||= []).push({
    unit,        // å˜ä¾¡
    count: num,  // æœ¬æ•°
    amount,      // é‡‘é¡ï¼ˆunit Ã— countï¼‰
    detail
  });
});

  saveForm();
}



function saveForm() {
  const formData = [];
  document.querySelectorAll(".row").forEach((row, index) => {
    const rowNumber = parseInt(row.querySelector(".rowNumber")?.textContent) || index + 1;

    const rowData = {
      rowNumber: rowNumber,
      honshi: row.querySelector(".honshi")?.value || "",
      category: row.querySelector(".c")?.value || "",
      amount: row.querySelector(".amount")?.value || "",
      num: row.querySelector(".num")?.value || "",
      detail: row.querySelector(".detail")?.value || "",
      card: row.querySelector(".card")?.value || "",
      total: row.querySelector(".total")?.value || "",
      checkboxes: {}
    };

    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      rowData.checkboxes[checkbox.parentElement.textContent.trim()] = checkbox.checked;
    });

    formData.push(rowData);
  });

  localStorage.setItem("formData", JSON.stringify(formData));
}


function restoreForm() {
  const savedData = localStorage.getItem("formData");
  if (savedData) {
    const formData = JSON.parse(savedData);
    const table = document.getElementById("formRows");

    // æœ€åˆã®è¡Œä»¥å¤–ã‚’å‰Šé™¤
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }

    formData.forEach((data, index) => {
      let row;
      if (index === 0) {
        row = table.rows[0];
      } else {
        row = table.rows[0].cloneNode(true);
        table.appendChild(row);
      }

      // ã‚»ãƒ«ã®å¾©å…ƒ
      row.querySelector(".rowNumber").textContent = data.rowNumber || index + 1;
      row.querySelector(".honshi").value = data.honshi || "";
      row.querySelector(".c").value = data.category || "";
      row.querySelector(".amount").value = data.amount || "";
      row.querySelector(".num").value = data.num || "";
      row.querySelector(".detail").value = data.detail || "";
      row.querySelector(".card").value = data.card || "";
      row.querySelector(".total").value = data.total || "";

      updateRowColor(row.querySelector(".c"));

      // å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
      if (!row.querySelector(".delete-btn")) {
        const deleteCell = document.createElement("td");
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "å‰Šé™¤";
        deleteButton.className = "delete-btn";
        deleteButton.onclick = function () {
          deleteRow(this);
        };
        deleteCell.appendChild(deleteButton);
        row.appendChild(deleteCell);
      }
    });

    // æœ€å¤§è¡Œç•ªå·ã‚’æ›´æ–°
    const maxRowNum = formData.reduce((max, data) => {
      const num = parseInt(data.rowNumber, 10);
      return (!isNaN(num) && num > max) ? num : max;
    }, 0);
    rowNumber = maxRowNum + 1;

    updateTotals();
  } else {
    rowNumber = 2; // ãƒ‡ãƒ¼ã‚¿ãªã—ãªã‚‰åˆæœŸå€¤ã«æˆ»ã™
  }
}

function filterCategory(category) {
  currentCategory = category;
  localStorage.setItem("selectedCategory", category); // â† ä¿å­˜

  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const select = row.querySelector('select.c');
    const value = select ? select.value : '';

    const shouldShow = (category === 'all' || value === category);

    if (shouldShow && row.style.display === 'none') {
      // è¡¨ç¤ºã™ã‚‹å¿…è¦ã‚ã‚Šâ†’å³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³
      row.style.display = '';
      row.classList.remove('slide-out-left');
      // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ã‚’ä»˜ã‘ã‚‹
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      // éè¡¨ç¤ºã«ã™ã‚‹å¿…è¦ã‚ã‚Šâ†’å·¦ã‚¹ãƒ©ã‚¤ãƒ‰ã§æ¶ˆã™
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
  const activeBtn = Array.from(document.querySelectorAll('.tab button')).find(btn => {
    return btn.textContent === category || (category === 'all' && btn.textContent.includes('ã™ã¹ã¦è¡¨ç¤º'));
  });
  if (activeBtn) activeBtn.classList.add('active');
}

function filterCashOnlyRows() {
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const cardInput = row.querySelector('.card');
    const cardValue = parseInt(cardInput?.value || "0");
    const shouldShow = (!cardValue || cardValue === 0);

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  currentCategory = 'cashOnly';
  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
}


function filterCardInputRows() {
  const rows = document.querySelectorAll('#formRows tr');
  rows.forEach(row => {
    const cardInput = row.querySelector('.card');
    const hasCardValue = cardInput && cardInput.value.trim() !== '';
    const shouldShow = hasCardValue;

    if (shouldShow && row.style.display === 'none') {
      row.style.display = '';
      row.classList.remove('slide-out-left');
      row.classList.add('slide-in-right');
      row.addEventListener('animationend', function onAnimEnd() {
        row.classList.remove('slide-in-right');
        row.removeEventListener('animationend', onAnimEnd);
      });
    } else if (!shouldShow && row.style.display !== 'none') {
      row.classList.remove('slide-in-right');
      row.classList.add('slide-out-left');
      row.addEventListener('animationend', function onAnimEnd() {
        row.style.display = 'none';
        row.classList.remove('slide-out-left');
        row.removeEventListener('animationend', onAnimEnd);
      });
    }
  });

  currentCategory = 'cardInputOnly';
  document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
}

function deleteRow(button) {
  const row = button.closest('tr');
  const formRows = document.getElementById('formRows');

  if (formRows.rows.length <= 1) {
    alert("ã“ã‚Œä»¥ä¸Šå‰Šé™¤ã§ãã¾ã›ã‚“");
    return;
  }

  if (confirm("ã“ã®ä¼ç¥¨ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    // ã¾ãšã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹
    row.classList.add('slide-out-left');

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«DOMã‹ã‚‰å‰Šé™¤
    row.addEventListener('animationend', function onAnimEnd() {
      row.removeEventListener('animationend', onAnimEnd); // å¤šé‡ç™»éŒ²é˜²æ­¢
      formRows.removeChild(row);
      renumberRows();
      updateTotals();
      saveForm();
    });
  }
}

function renumberRows() {
  const rows = document.querySelectorAll("#formRows tr");
  rows.forEach((row, index) => {
    const cell = row.querySelector(".rowNumber");
    if (cell) {
      cell.textContent = index + 1;
    }
  });
}








































//<app2 script---------------------------------------------------------------------------------------------------------------->

function createBottleForm(detail = '', split = '', quantity = '', amount = '') {
  const form = document.createElement('div');
  form.className = 'bottle-form';

  form.innerHTML = `
  <div class="left-group">
    <button type="button" class="delete-btn">Ã—</button>
    <select class="bottleDetails">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <optgroup label="ãƒªã‚¹ãƒ†ãƒ«ç­‰">
        <option value="ãƒªã‚¹ãƒ†ãƒ«">ãƒªã‚¹ãƒ†ãƒ«</option>
        <option value="ãƒ‘ãƒª">ãƒ‘ãƒª</option>
        <option value="ãƒãƒãƒ ">ãƒãƒãƒ </option>
      </optgroup>
      <optgroup label="ãƒ¢ã‚¨">
        <option value="ãƒ¢ã‚¨ç™½">ãƒ¢ã‚¨ç™½</option>
        <option value="ãƒ¢ã‚¨ãƒ­ã‚¼">ãƒ¢ã‚¨ãƒ­ã‚¼</option>
        <option value="ãƒ¢ã‚¨ãƒã‚¯">ãƒ¢ã‚¨ãƒã‚¯</option>
        <option value="ãƒ¢ã‚¨ãƒ”ã‚«">ãƒ¢ã‚¨ãƒ”ã‚«</option>
      </optgroup>
      <optgroup label="ãƒ´ãƒ¼ãƒ´">
        <option value="ãƒ´ãƒ¼ãƒ´">ãƒ´ãƒ¼ãƒ´</option>
        <option value="ãƒ´ãƒ¼ãƒ´ãƒ›ãƒ¯ã‚¤ãƒˆ">ãƒ´ãƒ¼ãƒ´ãƒ›ãƒ¯ã‚¤ãƒˆ</option>
        <option value="ãƒ´ãƒ¼ãƒ´ãƒ­ãƒ¼ã‚º">ãƒ´ãƒ¼ãƒ´ãƒ­ãƒ¼ã‚º</option>
      </optgroup>
      <optgroup label="ãƒ™ãƒ«ã‚¨">
        <option value="ãƒ™ãƒ«ã‚¨">ãƒ™ãƒ«ã‚¨</option>
        <option value="ãƒ™ãƒ«ã‚¨ãƒ­ã‚¼">ãƒ™ãƒ«ã‚¨ãƒ­ã‚¼</option>
      </optgroup>
      <optgroup label="ã‚½ã‚¦ãƒ¡ã‚¤">
        <option value="ã‚½ã‚¦ãƒ¡ã‚¤">ã‚½ã‚¦ãƒ¡ã‚¤</option>
      </optgroup>
      <optgroup label="ãƒ‰ãƒ³ãƒšãƒª">
        <option value="ãƒ‰ãƒ³ãƒšãƒª">ãƒ‰ãƒ³ãƒšãƒª</option>
        <option value="ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹">ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹</option>
        <option value="ãƒ‰ãƒ³ãƒšãƒªãƒ­ã‚¼">ãƒ‰ãƒ³ãƒšãƒªãƒ­ã‚¼</option>
        <option value="ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹ãƒ­ã‚¼">ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹ãƒ­ã‚¼</option>
        <option value="ãƒ‰ãƒ³ãƒšãƒªP2">ãƒ‰ãƒ³ãƒšãƒªP2</option>
        <option value="ãƒ‰ãƒ³ãƒšãƒªã‚´ãƒ¼ãƒ«ãƒ‰">ãƒ‰ãƒ³ãƒšãƒªã‚´ãƒ¼ãƒ«ãƒ‰</option>
      </optgroup>
      <optgroup label="ã‚¢ãƒ«ãƒãƒ³ãƒ‰">
        <option value="ã‚¢ãƒ«ãƒãƒ³ãƒ‰">ã‚¢ãƒ«ãƒãƒ³ãƒ‰</option>
        <option value="ã‚¢ãƒ«ãƒãƒ³ãƒ‰ãƒ­ã‚¼">ã‚¢ãƒ«ãƒãƒ³ãƒ‰ãƒ­ã‚¼</option>
        <option value="ã‚¢ãƒ«ãƒãƒ³ãƒ‰ã‚°ãƒªãƒ¼ãƒ³">ã‚¢ãƒ«ãƒãƒ³ãƒ‰ã‚°ãƒªãƒ¼ãƒ³</option>
      </optgroup>
      <optgroup label="ã‚ªãƒªã‚·ãƒ£ãƒ³">
        <option value="ã‚ªãƒªã‚·ãƒ£ãƒ³R">ã‚ªãƒªã‚·ãƒ£ãƒ³R</option>
        <option value="ã‚ªãƒªã‚·ãƒ£ãƒ³B">ã‚ªãƒªã‚·ãƒ£ãƒ³B</option>
      </optgroup>
      <optgroup label="ç„¼é…ãƒ»ãƒªã‚­ãƒ¥ãƒ¼ãƒ«ç­‰">
        <option value="æŸšå­å°ç”º">æŸšå­å°ç”º</option>
        <option value="é»’éœ§å³¶">é»’éœ§å³¶</option>
        <option value="å‰å››å…­">å‰å››å…­</option>
        <option value="å¯Œä¹ƒå®å±±">å¯Œä¹ƒå®å±±</option>
        <option value="èµ¤éœ§å³¶">èµ¤éœ§å³¶</option>
      </optgroup>
      <optgroup label="ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼">
        <option value="çŸ¥å¤š">çŸ¥å¤š</option>
        <option value="å±±å´">å±±å´</option>
      </optgroup>
      <optgroup label="ãƒ¯ã‚¤ãƒ³">
        <option value="ãƒ™ãƒªãƒ³ã‚¸ãƒ£ãƒ¼">ãƒ™ãƒªãƒ³ã‚¸ãƒ£ãƒ¼</option>
      </optgroup>
      <optgroup label="ãƒ†ã‚­ãƒ¼ãƒ©">
        <option value="ãƒ†ã‚­ã‚«ãƒ³">ãƒ†ã‚­ã‚«ãƒ³</option>
      </optgroup>
      <optgroup label="ãã®ä»–">
        <option value="æ">æ</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
        <option value="ä¿éšœè£œæ­£">ä¿éšœè£œæ­£</option>
      </optgroup>
    </select>
    <input type="number" class="splitCount" placeholder="å‰²">
    <input type="number" class="bottleQuantity" placeholder="æ•°é‡">
  </div>
  <input type="number" class="bottleAmount" placeholder="é‡‘é¡">
`;

  const sel         = form.querySelector('.bottleDetails');
  const splitInput  = form.querySelector('.splitCount');
  const qtyInput    = form.querySelector('.bottleQuantity');
  const amountInput = form.querySelector('.bottleAmount');
  const delBtn      = form.querySelector('.delete-btn');

  // â˜… å¾©å…ƒæ™‚ã«å³ä¿å­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
  // if (typeof saveBottleForms === 'function') saveBottleForms(); â† å‰Šé™¤

  // åˆæœŸå€¤ã‚’åæ˜ 
  if (detail) {
    sel.value = detail;
    if (sel.value !== detail) {
      const tmp = document.createElement('option');
      tmp.value = detail;
      tmp.textContent = detail;
      const etcGroup = Array.from(sel.children).find(n => n.tagName === 'OPTGROUP' && n.label === 'ãã®ä»–');
      (etcGroup || sel).appendChild(tmp);
      sel.value = detail;
    }
  }
  if (split   !== undefined) splitInput.value  = split;
  if (quantity!== undefined) qtyInput.value    = quantity;
  if (amount  !== undefined) amountInput.value = amount;

// å“ç›®å¤‰æ›´æ™‚
sel.addEventListener('change', () => {
  if (window.BOTTLE_REFRESHING) return;
  const opt = sel.selectedOptions[0];
  if (!opt) return;

  if (opt.dataset.from === 'history') {
    // å±¥æ­´é¸æŠï¼šå¾“æ¥ã©ãŠã‚Šå±¥æ­´ã®å€¤ã‚’å¾©å…ƒ
    splitInput.value  = opt.dataset.split  || '';
    qtyInput.value    = opt.dataset.qty    || '';
    amountInput.value = opt.dataset.amount ?? 0;
  } else {
    // é™çš„ãªå“ç›®é¸æŠï¼šç™»éŒ²é‡‘é¡ã§åˆæœŸåŒ–ï¼ˆå‰²=1 / æ•°é‡=1ï¼‰
    splitInput.value = '1';
    qtyInput.value   = '1';
    updateBottleAmountForForm(form);  // â† ç™»éŒ²é‡‘é¡ã‹ã‚‰ç®—å‡º
  }
  saveBottleForms?.();
});

// å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ â†’ å¾©å…ƒä¸­ã¯ç„¡è¦–
['input','change','blur'].forEach(evt => {
  splitInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    updateBottleAmountForForm(form);   // â† è¿½åŠ 
    saveBottleForms?.();
  });
  qtyInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    updateBottleAmountForForm(form);   // â† è¿½åŠ 
    saveBottleForms?.();
  });
  amountInput.addEventListener(evt, () => {
    if (window.BOTTLE_REFRESHING) return;
    saveBottleForms?.();
  });
});

  // å‰Šé™¤ãƒœã‚¿ãƒ³
  delBtn.addEventListener('click', () => {
    if (confirm('ã“ã®ãƒœãƒˆãƒ«æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      form.remove();
      saveBottleForms?.();
      refreshBottleDropdownsFromHistory?.();
    }
  });

    // ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã‚’è¿½åŠ  =====
  setTimeout(() => {
    form.scrollIntoView({
      behavior: "smooth",
      block: "center"  // ä¸­å¤®ã‚ãŸã‚Šã«è¡¨ç¤º
    });
  }, 50);

  return form;
}


let BOTTLE_REFRESHING = false;

// === APP2: ãƒœãƒˆãƒ«ã®ç™»éŒ²ãƒãƒƒã‚¯é‡‘é¡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šç‰ˆï¼‰ ===
const BOTTLE_BASE = Object.freeze({
  'ãƒªã‚¹ãƒ†ãƒ«': 6000,
  'ãƒ‘ãƒª': 7500,
  'ãƒãƒãƒ ': 17500,
  'ãƒ¢ã‚¨ç™½': 15000,
  'ãƒ¢ã‚¨ãƒ­ã‚¼': 17500,
  'ãƒ¢ã‚¨ãƒã‚¯': 20000,
  'ãƒ¢ã‚¨ãƒ”ã‚«': 22500,
  'ãƒ´ãƒ¼ãƒ´': 16000,
  'ãƒ´ãƒ¼ãƒ´ãƒ›ãƒ¯ã‚¤ãƒˆ': 17500,
  'ãƒ´ãƒ¼ãƒ´ãƒ­ãƒ¼ã‚º': 19000,
  'ãƒ™ãƒ«ã‚¨': 70000,
  'ãƒ™ãƒ«ã‚¨ãƒ­ã‚¼': 140000,
  'ã‚½ã‚¦ãƒ¡ã‚¤': 60000,
  'ãƒ‰ãƒ³ãƒšãƒª': 50000,
  'ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹': 60000,
  'ãƒ‰ãƒ³ãƒšãƒªãƒ­ã‚¼': 70000,
  'ãƒ‰ãƒ³ãƒšãƒªãƒ«ãƒŸãƒŠã‚¹ãƒ­ã‚¼': 85000,
  'ãƒ‰ãƒ³ãƒšãƒªP2': 150000,
  'ãƒ‰ãƒ³ãƒšãƒªã‚´ãƒ¼ãƒ«ãƒ‰': 250000,
  'ã‚¢ãƒ«ãƒãƒ³ãƒ‰': 85000,
  'ã‚¢ãƒ«ãƒãƒ³ãƒ‰ãƒ­ã‚¼': 140000,
  'ã‚¢ãƒ«ãƒãƒ³ãƒ‰ã‚°ãƒªãƒ¼ãƒ³': 200000,
  'ã‚ªãƒªã‚·ãƒ£ãƒ³R': 12500,
  'ã‚ªãƒªã‚·ãƒ£ãƒ³B': 30000,
  'æŸšå­å°ç”º': 5000,
  'é»’éœ§å³¶': 7500,
  'å‰å››å…­': 7500,
  'å¯Œä¹ƒå®å±±': 8500,
  'èµ¤éœ§å³¶': 10000,
  'çŸ¥å¤š': 20000,
  'å±±å´': 35000,
  'ãƒ™ãƒªãƒ³ã‚¸ãƒ£ãƒ¼': 10000,
  'ãƒ†ã‚­ã‚«ãƒ³': 35000,
  'æ': 200,

  // ç©ºç™½ï¼ˆè‡ªå‹•é‡‘é¡ãªã—ã«ã—ãŸã„é …ç›®ã¯ 0 ã«ã—ã¦ãŠãï¼‰
  'ãã®ä»–': 0,
  'ä¿éšœè£œæ­£': 0
});

// å…¥åŠ›â†’æ•°å€¤(,é™¤å»)ã®å®‰å…¨å¤‰æ›
function intSafe(v, d = 0){ const n = parseInt(String(v ?? '').toString().replace(/,/g,''),10); return Number.isFinite(n)? n : d; }
// 100å††æœªæº€åˆ‡ã‚Šæ¨ã¦ï¼ˆä¾‹: 3750 â†’ 3700ï¼‰
function floor100(yen){ return Math.floor(intSafe(yen)/100)*100; }

// sel(=select)ã‹ã‚‰â€œå“åâ€ã‚’å–ã‚Šå‡ºã™ï¼ˆå±¥æ­´é¸æŠæ™‚ã¯ base åï¼‰
function getSelectedDetail(sel){
  const opt = sel?.selectedOptions?.[0];
  return (opt?.dataset?.base) || sel?.value || '';
}

// ç™»éŒ²é‡‘é¡ãƒ»å‰²ãƒ»æ•°é‡ã‹ã‚‰é‡‘é¡ã‚’è¨ˆç®—
// ãƒ«ãƒ¼ãƒ«: (ç™»éŒ²é‡‘é¡/å‰²) ã® â€œ10å††æœªæº€åˆ‡ã‚Šæ¨ã¦â€ ã‚’å˜ä¾¡ã¨ã—ã€å˜ä¾¡Ã—æ•°é‡
function computeBottleAmount(detail, split, qty){
  const base = BOTTLE_BASE[detail] ?? 0;
  const s = Math.max(1, intSafe(split, 1)); // 0å‰²å›é¿
  const q = Math.max(0, intSafe(qty, 0));
  const unit = floor100(base / s);
  return unit * q;
}

// ãƒ•ã‚©ãƒ¼ãƒ 1è¡Œã®é‡‘é¡ã‚’å†è¨ˆç®—ã—ã¦åæ˜ 
function updateBottleAmountForForm(form){
  const sel   = form.querySelector('.bottleDetails');
  const split = form.querySelector('.splitCount')?.value;
  const qty   = form.querySelector('.bottleQuantity')?.value;
  const amt   = computeBottleAmount(getSelectedDetail(sel), split, qty);
  const out   = form.querySelector('.bottleAmount');
  out.value = amt ? String(amt) : ''; // æœªç™»éŒ²(0)ã¯ç©ºã«
}

// å±¥æ­´ â†’ { è©³ç´°å: [ { id, split, qty, amount }, ... ] }
let BOTTLE_HISTORY = {};


function buildBottleHistoryMap() {
  BOTTLE_HISTORY = {};
  const list = document.getElementById('historyList');
  if (!list) return;

  const items = Array.from(list.querySelectorAll('li'));
  const re = /ãƒœãƒˆãƒ«:\s*Â¥([\d,]+)ï¼ˆ([^/ï¼ˆï¼‰]*?)(?:\/å‰²:([^\s/ï¼ˆï¼‰]+))?(?:\/æ•°é‡:([^\s/ï¼ˆï¼‰]+))?ï¼‰/g;

  const seen = new Set(); // åŒä¸€ãƒãƒªã‚¢ãƒ³ãƒˆé‡è¤‡é˜²æ­¢

  for (const li of items) {
    const html = li.innerHTML;
    let m;
    while ((m = re.exec(html)) !== null) {
      const amount = parseInt(m[1].replace(/,/g, ''), 10) || 0;
      const detail = (m[2] || '').trim();
      const split  = (m[3] || '').trim();
      const qty    = (m[4] || '').trim();
      if (!detail) continue;

      // ãƒãƒªã‚¢ãƒ³ãƒˆIDï¼ˆå“åï¼‹å‰²ï¼‹æ•°é‡ï¼‹é‡‘é¡ã®çµ„ï¼‰
      const id = encodeURIComponent(detail) + '|' +
                 encodeURIComponent(split)  + '|' +
                 encodeURIComponent(qty)    + '|' +
                 amount;

      if (seen.has(id)) continue;
      seen.add(id);

      (BOTTLE_HISTORY[detail] ||= []).push({ id, split, qty, amount });
    }
  }
}

function refreshBottleDropdownsFromHistory() {
  buildBottleHistoryMap();

  BOTTLE_REFRESHING = true; // â†é–‹å§‹

  document.querySelectorAll('select.bottleDetails').forEach(sel => {
    // é€€é¿
    const prevValue = sel.value;
    const form = sel.closest('.bottle-form');
    const prevSplit = form?.querySelector('.splitCount')?.value ?? '';
    const prevQty   = form?.querySelector('.bottleQuantity')?.value ?? '';
    const prevAmt   = form?.querySelector('.bottleAmount')?.value ?? '';

    // å±¥æ­´ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å…ˆé ­ã«
    let grp = Array.from(sel.children).find(n => n.tagName === 'OPTGROUP' && n.label === 'å±¥æ­´');
    if (!grp) {
      grp = document.createElement('optgroup');
      grp.label = 'å±¥æ­´';
      sel.insertBefore(grp, sel.firstChild);
    }
    grp.innerHTML = '';

    // å„å“åã®å±¥æ­´ã‚’å†æ§‹ç¯‰
    Object.entries(BOTTLE_HISTORY).forEach(([detail, variants]) => {
      // é™çš„ã«å­˜åœ¨ã—ãªã„å“åã ã‘ã€Œï¼ˆæ–°è¦ï¼‰ã€ã‚’è¿½åŠ 
      const hasBlank = Array.from(sel.options).some(o => o.value === detail);
      if (!hasBlank) {
        const blankOpt = document.createElement('option');
        blankOpt.value = detail;
        blankOpt.textContent = `${detail}ï¼ˆæ–°è¦ï¼‰`;
        blankOpt.dataset.base = detail;
        grp.appendChild(blankOpt);
      }

      variants.forEach(v => {
        const opt = document.createElement('option');
        opt.value = `__HIST__${v.id}`;
        opt.textContent = `${detail}ï¼ˆ${v.split !== '' ? "å‰²:" + v.split : "å‰²:-"}/${v.qty !== '' ? "æ•°é‡:" + v.qty : "æ•°é‡:-"}/Â¥${v.amount.toLocaleString()}ï¼‰`;
        opt.dataset.from = 'history';
        opt.dataset.base = detail;
        opt.dataset.split = v.split;
        opt.dataset.qty = v.qty;
        opt.dataset.amount = v.amount;
        grp.appendChild(opt);
      });
    });

    // é¸æŠã‚’å¾©å…ƒã€‚å¤±æ•—ã—ãŸã‚‰é€€é¿ã®å…¥åŠ›å€¤ã‚’æˆ»ã™
    sel.value = prevValue;
    if (sel.value !== prevValue && form) {
      form.querySelector('.splitCount').value     = prevSplit;
      form.querySelector('.bottleQuantity').value = prevQty;
      form.querySelector('.bottleAmount').value   = prevAmt;
    }
  });

  BOTTLE_REFRESHING = false; // â†çµ‚äº†
}



function addBottleForm() {
  const container = document.getElementById('bottleFormsContainer');
  const newForm = createBottleForm(); // â†ç©ºã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
  container.appendChild(newForm);
  refreshBottleDropdownsFromHistory();
  saveBottleForms(); // ä¿å­˜
}

function saveBottleForms() {
  const bottleForms = [];
  document.querySelectorAll('.bottle-form').forEach(form => {
    const sel = form.querySelector('.bottleDetails');
    const opt = sel?.selectedOptions?.[0];

    const bottleDetails =
      (opt?.dataset?.base) || (sel?.value || ''); // å±¥æ­´é¸æŠã§ã‚‚ã€Œå“åã€ã ã‘ä¿å­˜

    const splitCount = form.querySelector('.splitCount')?.value || '';
    const bottleQuantity = form.querySelector('.bottleQuantity')?.value || '';
    const bottleAmount = parseInt(
      (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, ''), 10
    ) || 0;

    bottleForms.push({ bottleDetails, splitCount, bottleQuantity, bottleAmount });
  });

  localStorage.setItem('bottleForms', JSON.stringify(bottleForms));
}



function loadBottleForms() {
  const bottleFormsData = JSON.parse(localStorage.getItem('bottleForms')) || [];
  const container = document.getElementById('bottleFormsContainer');
  if (!container) return;   // â† å¿µã®ãŸã‚

  container.innerHTML = '';

  window.BOTTLE_REFRESHING = true; // â˜…å¾©å…ƒãƒ•ãƒ©ã‚°ON
  bottleFormsData.forEach(data => {
    const form = createBottleForm(
      data.bottleDetails || '',
      data.splitCount || '',
      data.bottleQuantity || '',
      data.bottleAmount || 0
    );
    if (form) container.appendChild(form);
  });
  window.BOTTLE_REFRESHING = false; // â˜…å¾©å…ƒãƒ•ãƒ©ã‚°OFF
}

function renumberHistory() {
  const items = Array.from(document.querySelectorAll('#historyList li')).reverse(); // ä¸‹ã‹ã‚‰é †ã«1,2,3
  items.forEach((item, index) => {
    const castElem = item.querySelector('.castName');
    if (castElem) {
      let text = castElem.textContent.replace(/^\s*\d+\.\s*/, ' '); // æ—§ç•ªå·ã‚’å‰Šé™¤
      const nameOnly = text.replace(/^\s*/, '').trim();
      castElem.innerHTML = `<strong></strong> ${index + 1}. ${nameOnly}`;
    }
  });
}

function calculate() {
   const historyList = document.getElementById('historyList');
  // ã€Œä½“é¨“åŠã³è²¸å‡ºã€ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
  const isExperienceAndRentalChecked = document.getElementById('experienceAndRental').checked;
  let experienceText = isExperienceAndRentalChecked ? 'ä½“é¨“åŠã³è²¸å‡º: æœ‰ã‚Š' : 'ä½“é¨“åŠã³è²¸å‡º: ç„¡ã—';

  const values = {
    f: 1500, f2: 2000, jounai: 1000, honshiri: 0, douhan: 1500,
    eda: 500, help: -1500, set40: 5500, set20: 3500, vip: 2000,
    a: 500, b: 1000, c: 1500, d: 2000, e: 2500
  };

  let total = 0;
  for (let key in values) {
    const count = parseInt(document.getElementById(key).value) || 0;
    total += count * values[key];
  }

   // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸãƒœãƒˆãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é‡‘é¡ã¨è©³ç´°ã‚’å–å¾—
  const bottleForms = document.querySelectorAll('.bottle-form');
  bottleForms.forEach(form => {
    const bottleAmount = parseInt(
   (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, ''), 10
   ) || 0;
    const bottleDetails = form.querySelector('.bottleDetails').value || 'è©³ç´°ãªã—';
    total += bottleAmount;
  });

  const kousei = 1000;
  const gensen = Math.ceil((total * 0.1) / 100) * 100;

  let afterGensen = total - gensen;

  let actualKousei = 0;

  // åšç”Ÿè²»ã®å¼•ãæ–¹ã‚’å¤‰æ›´
  if (!isExperienceAndRentalChecked) {
    if (afterGensen - kousei >= 5000) {
      actualKousei = kousei;
    } else {
      actualKousei = Math.max(0, afterGensen - 5000);
    }
  }

const kouseiStoreCovered = (actualKousei === 0) ? 1000 : 0;
const kouseiCastCovered = 0;

let welfareText = `åšç”Ÿè²»: Â¥${actualKousei.toLocaleString()} (åº—èˆ—è² æ‹…:Â¥${kouseiStoreCovered.toLocaleString()})`;

  // é€è¿é‡‘é¡ã®å–å¾—
  let sendoffAmount = parseInt(document.getElementById('sendoffAmount').value)||0;

// åˆè¨ˆ = å°è¨ˆ - æºæ³‰è²» - åšç”Ÿè²»
let totalAmount = afterGensen - actualKousei;

let adjustedSendoff = 0;

if (!isExperienceAndRentalChecked) {
  adjustedSendoff = sendoffAmount;
  const tempFinalAmount = totalAmount - adjustedSendoff;

  if (tempFinalAmount < 5000) {
    const maxDeductible = totalAmount - 5000;
    adjustedSendoff = Math.max(0, maxDeductible);
  }
}

// æœ€çµ‚åˆè¨ˆ
let finalAmount = totalAmount - adjustedSendoff;

// åº—èˆ—è² æ‹…ãƒ»æœ¬äººè² æ‹…ã®è¨ˆç®—
const castCoveredAmount = adjustedSendoff;
const storeCoveredAmount = sendoffAmount - adjustedSendoff;

let sendoffText = `é€è¿: Â¥${sendoffAmount.toLocaleString()}(æœ¬äººè² æ‹…: Â¥${castCoveredAmount.toLocaleString()}`;
if (storeCoveredAmount > 0) {
  sendoffText += `åº—èˆ—è² æ‹…: Â¥${storeCoveredAmount.toLocaleString()})`;
} else {
  sendoffText += `)`; // â†ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã¨å®‰å¿ƒ
}

  const labels = {
    f: 'F',
    f2: 'F2',
    jounai: 'å ´å†…',
    honshiri: 'æœ¬æŒ‡',
    douhan: 'åŒä¼´',
    eda: 'æ',
    help: 'HELP',
    set40: 'SET40',
    set20: 'SET20',
    vip: 'VIP',
    a: 'A',
    b: 'B',
    c: 'C',
    d: 'D',
    e: 'E'
  };

  let detailsHTML = '<div class="details" style="font-size: 14px; margin-top: 10px;">';
 
  for (let key in values) {
    const count = parseInt(document.getElementById(key).value) || 0;
    if (count > 0) {
      const label = labels[key] || key.toUpperCase();
      const unitPrice = values[key];
      const subtotal = count * unitPrice;
      detailsHTML += `<div>${label} Ã—${count}ï¼ˆÂ¥${unitPrice.toLocaleString()}ï¼‰= Â¥${subtotal.toLocaleString()}</div>`;
    }
  }

// è¿½åŠ ã•ã‚ŒãŸå…¨ãƒœãƒˆãƒ«æ˜ç´°
bottleForms.forEach(form => {
  const sel = form.querySelector('.bottleDetails');
  const opt = sel?.selectedOptions?.[0];
  const bottleDetail = (opt?.dataset?.base) || (sel?.value) || 'è©³ç´°ãªã—';

  const split = form.querySelector('.splitCount')?.value || '';
  const quantity = form.querySelector('.bottleQuantity')?.value || '';
  const amountStr = (form.querySelector('.bottleAmount')?.value || '').replace(/,/g, '');
  const bottleAmount = parseInt(amountStr, 10) || 0;

  if (bottleAmount > 0 || bottleDetail || split || quantity) {
    detailsHTML += `<div>ãƒœãƒˆãƒ«:Â¥${bottleAmount.toLocaleString()}ï¼ˆ${bottleDetail}`;
    if (split) detailsHTML +=`/å‰²:${split}`;
    if (quantity) detailsHTML +=`/æ•°é‡:${quantity}`;
    detailsHTML +=`ï¼‰</div>`;
  }
});

detailsHTML += '</div>';

  const castName = document.getElementById('castName').value || 'ï¼ˆåå‰ãªã—ï¼‰';

  // 10ä¸‡ã‚’è¶…ãˆã‚‹å ´åˆã ã‘è¡¨ç¤ºï¼ˆå°ç­’å°å­—å°‚ç”¨ï¼‰
const congratsHTML =
  (finalAmount > 100000)
    ? `
      <div class="congrats-box print-only">
        <div class="congrats">ï½CONGRATULATIONSï½</div>
        <div class="finalAmount print-highlight"><strong>æœ€çµ‚åˆè¨ˆ: </strong>Â¥${finalAmount.toLocaleString()}</div>
      </div>
    `
    : `
      <div class="finalAmount print-highlight"><strong>æœ€çµ‚åˆè¨ˆ: </strong>Â¥${finalAmount.toLocaleString()}</div>
    `;

const resultText = `
  <div class="castName"><strong></strong> ${castName}</div>
  <div class="experienceAndRental">${experienceText}</div>
  <div class="subtotal"><strong>å°è¨ˆ:</strong> Â¥${total.toLocaleString()}</div>
  <div class="tax" style="font-size: 16px; font-weight: bold;">
    <strong>æºæ³‰è²»:</strong> Â¥${gensen.toLocaleString()}
  </div>
  <div class="welfare" style="font-size: 16px; font-weight: bold;">
    <strong>${welfareText}</strong>
  </div>
  <div class="totalAmount" style="font-size:25px; font-weight:bold; display:inline-flex; align-items:baseline;">
    <strong>åˆè¨ˆ:</strong>&nbsp;Â¥${totalAmount.toLocaleString()}
    <span class="print-only" style="font-size:14px; margin-left:6px;">â†é ˜åæ›¸è¨˜å…¥</span>
  </div>
  <div class="sendoff"><strong>${sendoffText}</strong></div>

  ${congratsHTML}

  ${detailsHTML}
`;

  // å±¥æ­´ã«æ–°ã—ã„é …ç›®ã‚’è¿½åŠ 
const existingItem = Array.from(historyList.children).find(item => {
  const nameElem = item.querySelector('.castName');
  if (!nameElem) return false;

  // ğŸ”½ æ­£è¦è¡¨ç¾ã§å…ˆé ­ã®ç•ªå·ï¼ˆä¾‹: "1. "ï¼‰ã‚’å‰Šé™¤
  const nameText = nameElem.textContent.replace(/^\s*\d+\.\s*/, '').trim();
  
  return nameText === castName;
});


// detailsHTMLã‚’å›²ã‚“ã§éè¡¨ç¤ºã«ã™ã‚‹
const detailsHiddenHTML = `<div class="details-html-container" style="display:none; font-size:14px; margin-top:5px;">${detailsHTML}</div>`;

const fullHTML = `
  <div>
    <label><input type="checkbox" class="history-checkbox"> å‰Šé™¤å¯¾è±¡</label>
    ${resultText.replace(detailsHTML, '')}
    ${detailsHiddenHTML}
    <div style="margin-top: 5px;">
      <button onclick="restoreFromHistory(this)" style="margin-right: 5px; font-size: 12px;">å¾©å…ƒ</button>
      <button onclick="moveHistoryItem(this, 'up')" style="font-size: 12px;">â†‘</button>
      <button onclick="moveHistoryItem(this, 'down')" style="font-size: 12px;">â†“</button>
    </div>
  </div>
`;

if (existingItem) {
  existingItem.innerHTML = fullHTML;
} else {
  const listItem = document.createElement('li');
  listItem.innerHTML = fullHTML;
  historyList.prepend(listItem);
}

  renumberHistory();

  // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
  updateSummary();


  // ä¿å­˜å‡¦ç†
  const inputElements = document.querySelectorAll('input[type="number"], input[type="text"]');
  const inputValues = {};
  inputElements.forEach(input => {
    inputValues[input.id] = input.value;
  });
  localStorage.setItem('inputs', JSON.stringify(inputValues));
  localStorage.setItem('historyList', historyList.innerHTML);
  localStorage.setItem('result', resultText);
    // å±¥æ­´ã«è¿½åŠ ã—ãŸã®ã§ã€ãƒœãƒˆãƒ«å€™è£œã‚’æ›´æ–°
  refreshBottleDropdownsFromHistory();

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚‚ä¿å­˜
  const checkboxStates = {
  experienceAndRental: document.getElementById('experienceAndRental').checked
   };
  localStorage.setItem('checkboxes', JSON.stringify(checkboxStates));

    // ğŸ”½ ã“ã“ã‚’è¿½åŠ ï¼šãƒœãƒˆãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‚‚ä¿å­˜ã™ã‚‹
  saveBottleForms();

  document.getElementById("result").innerHTML = resultText;
const resultElem = document.getElementById("result");
if (resultElem) {
  const tabsEl = document.querySelector('.tabs');
  const tabsHeight = tabsEl ? tabsEl.offsetHeight : 0;

  const app2Nav = document.getElementById('app2-nav');
  const navHeight = app2Nav ? app2Nav.offsetHeight : 0;

  const extraOffset = 30;
  const totalOffset = tabsHeight + navHeight + extraOffset;

  const rect = resultElem.getBoundingClientRect();
  const targetY = rect.top + window.pageYOffset - totalOffset;
  window.scrollTo({ top: targetY, behavior: "smooth" });
}
}

function confirmAndCalculate(e){

  let subtotal = 0;
  let totalAmount = 0;   // â† è¿½åŠ ï¼šå®šç¾©æ¼ã‚Œä¿®æ­£
  let finalAmount = 0;   // â† è¿½åŠ ï¼šå®šç¾©æ¼ã‚Œä¿®æ­£

  // é€ä¿¡ã‚’æ­¢ã‚ã‚‹ï¼ˆEnteré€ä¿¡ç­‰ã‚‚çµ±ä¸€ï¼‰
  if (e && typeof e.preventDefault === 'function') e.preventDefault();

  const castName   = document.getElementById('castName').value || 'ï¼ˆåå‰ãªã—ï¼‰';
  const experience = document.getElementById('experienceAndRental').checked ? 'æœ‰ã‚Š' : 'ç„¡ã—';
  const sendoff    = document.getElementById('sendoffAmount').value || '0';
  const labels = { f:'F', f2:'F2', jounai:'å ´å†…', honshiri:'æœ¬æŒ‡', douhan:'åŒä¼´', eda:'æ', help:'HELP',
                   set40:'SET40', set20:'SET20', vip:'VIP', a:'A', b:'B', c:'C', d:'D', e:'E' };
  const mainItems = [];
  Object.keys(labels).forEach(key=>{
    const val = document.getElementById(key)?.value;
    if (parseInt(val)) mainItems.push(`${labels[key]} Ã—${val}`);
  });

  const bottles = [];
  document.querySelectorAll('.bottle-form').forEach(form=>{
    const sel = form.querySelector('.bottleDetails');
    const opt = sel?.selectedOptions?.[0];
    const det = (opt?.dataset?.base) || (sel?.value) || '';
    const spl = form.querySelector('.splitCount')?.value || '';
    const qty = form.querySelector('.bottleQuantity')?.value || '';
    const amtNum = parseInt((form.querySelector('.bottleAmount')?.value || '').replace(/,/g,''),10) || 0;
    if (det || spl || qty || amtNum) {
      const amt = amtNum.toLocaleString();
      bottles.push(`Â¥${amt}ï¼ˆ${det}${spl!==''?'/å‰²:'+spl:''}${qty!==''?'/æ•°é‡:'+qty:''}ï¼‰`);
    }
  });

  let msg = `å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n`
          + `ã‚­ãƒ£ã‚¹ãƒˆå:${castName}\nä½“é¨“åŠã³è²¸å‡º:${experience}\né€è¿é‡‘é¡:Â¥${sendoff}\n`
          + (mainItems.length ? `--- ä¼ç¥¨å†…è¨³ ---\n${mainItems.join('\n')}\n` : '')
          + (bottles.length   ? `--- ãƒœãƒˆãƒ«æ˜ç´° ---\n${bottles.join('\n')}\n`   : '');

  if (!window.confirm(msg)) return false;

  // å®Ÿè¨ˆç®—ï¼ˆã‚ãªãŸã®æ—¢å­˜ã® calculate ãŒ #result ã‚’æ›´æ–°ã—ã¾ã™ï¼‰
  calculate();

  // æç”»ãŒåæ˜ ã•ã‚ŒãŸæ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§çµæœã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  requestAnimationFrame(()=> navScrollTo('app2-resultSection','smooth'));

  // åˆè¨ˆãƒ»æœ€çµ‚é‡‘é¡ã‚’ #result ã‹ã‚‰æŠ½å‡º
  const resultText = document.querySelector('#result')?.innerText || '';
  const match = resultText.match(/åˆè¨ˆ[^\d]*(\d[\d,]*)/);
  if (match) {
    totalAmount = parseInt(match[1].replace(/,/g,''),10);
    finalAmount = totalAmount;
  }

  // çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const entry = {
    time: new Date().toISOString(),
    cast: castName,
    subtotal: subtotal,
    total: totalAmount,
    final: finalAmount,
    payload: {
      f: document.getElementById('f')?.value || '',
      f2: document.getElementById('f2')?.value || '',
      // ...å¿…è¦åˆ†
    }
  };

  // ğŸ”´ ä»¥ä¸‹3è¡Œã‚’å‰Šé™¤ï¼ˆapp2Historyã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ï¼‰
  // app2History.unshift(entry);
  // renderApp2History();
  // persistApp2History();

  return false; // é€ä¿¡ã¯å¸¸ã«æŠ‘æ­¢
}




function moveHistoryItem(button, direction) {
  const listItem = button.closest('li');
  if (!listItem) return;

  const parentList = listItem.parentNode;
  let targetItem = null;

  if (direction === 'up' && listItem.previousElementSibling) {
    targetItem = listItem.previousElementSibling;
    parentList.insertBefore(listItem, targetItem);
  } else if (direction === 'down' && listItem.nextElementSibling) {
    targetItem = listItem.nextElementSibling;
    parentList.insertBefore(targetItem, listItem);
  }

  // â†“ ç§»å‹•å¾Œã®è¦ç´ ã«å¼·åˆ¶ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆDOMåæ˜ å¾Œã«å®Ÿè¡Œï¼‰
  requestAnimationFrame(() => {
    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  renumberHistory(); // â† é€£ç•ªå†æŒ¯ã‚Š
  localStorage.setItem('historyList', parentList.innerHTML);
  updateSummary();
}


function restoreFromHistory(button) {
  const historyItem = button.closest('li') || button.closest('div');
  if (!historyItem) return;

  // ã‚­ãƒ£ã‚¹ãƒˆåã®å¾©å…ƒ
  const castNameElem = historyItem.querySelector('.castName');
  const castName = castNameElem ? castNameElem.textContent.replace(/^\s*\d+\.\s*/, '').trim() : '';
  document.getElementById('castName').value = castName;

  // ãƒ©ãƒ™ãƒ«å¯¾å¿œè¡¨ã‚’å®šç¾©ï¼ˆcalculateé–¢æ•°ã¨åŒã˜å†…å®¹ï¼‰
  const labels = {
    f: 'F',
    f2: 'F2',
    jounai: 'å ´å†…',
    honshiri: 'æœ¬æŒ‡',
    douhan: 'åŒä¼´',
    eda: 'æ',
    help: 'HELP',
    set40: 'SET40',
    set20: 'SET20',
    vip: 'VIP',
    a: 'A',
    b: 'B',
    c: 'C',
    d: 'D',
    e: 'E'
  };

  // æ•°å€¤å…¥åŠ›æ¬„ã‚’å¾©å…ƒ
  const inputIds = Object.keys(labels);
  inputIds.forEach(id => {
    const label = labels[id];
    const regex = new RegExp(`${label} Ã—(\\d+)`);
    const match = historyItem.textContent.match(regex);
    if (match) {
      document.getElementById(id).value = match[1];
    } else {
      document.getElementById(id).value = '';
    }
  });

  // é€è¿é‡‘é¡ã‚’å¾©å…ƒ
  const sendoffMatch = (historyItem.textContent || '').match(/é€è¿:\s*Â¥([\d,]+)/);
  if (sendoffMatch) {
    document.getElementById('sendoffAmount').value = parseInt(sendoffMatch[1].replace(/,/g, ''), 10);
  } else {
    document.getElementById('sendoffAmount').value = 0;
  }

  // ä½“é¨“åŠã³è²¸å‡ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¾©å…ƒï¼ˆtextContentã‹innerHTMLã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèªï¼‰
  const experienceElem = historyItem.querySelector('.experienceAndRental');
  const experienceText = experienceElem ? experienceElem.textContent : '';
  const experienceChecked = experienceText.includes('ä½“é¨“åŠã³è²¸å‡º: æœ‰ã‚Š');
  document.getElementById('experienceAndRental').checked = experienceChecked;

  // ãƒœãƒˆãƒ«æ˜ç´°ã‚’å¾©å…ƒ
  const bottleRegex = /ãƒœãƒˆãƒ«:\s*Â¥([\d,]+)ï¼ˆ([^/ï¼ˆï¼‰]*?)(?:\/å‰²:([^\s/ï¼ˆï¼‰]+))?(?:\/æ•°é‡:([^\s/ï¼ˆï¼‰]+))?ï¼‰/g;

  // å¾©å…ƒç”¨ã®ãƒ«ãƒ¼ãƒ—
  const bottles = [];
  let match;
  while ((match = bottleRegex.exec(historyItem.innerHTML)) !== null) {
  bottles.push({
    bottleAmount: parseInt(match[1].replace(/,/g, '')),
    bottleDetails: match[2] || '',
    splitCount: match[3] || '',
    bottleQuantity: match[4] || ''
  });
  }

  // å¾©å…ƒã—ã¦é…ç½®
  const container = document.getElementById('bottleFormsContainer');
  container.innerHTML = '';
  bottles.forEach(data => {
  const bottleForm = createBottleForm(
    data.bottleDetails,
    data.splitCount,
    data.bottleQuantity,
    data.bottleAmount
  );
  container.appendChild(bottleForm);
  });

  // ä¿å­˜å‡¦ç†ï¼ˆç¾åœ¨ã®å¾©å…ƒçŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠãï¼‰
  saveBottleForms();

    // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  window.scrollTo({ top: 0, behavior: 'smooth' });

}

function deleteSelectedHistory() {
  const historyList = document.getElementById('historyList');
  const items = historyList.querySelectorAll('li');

  const checkedItems = Array.from(items).filter(item => {
    const checkbox = item.querySelector('.history-checkbox');
    return checkbox && checkbox.checked;
  });

  if (checkedItems.length === 0) {
    alert('å‰Šé™¤ã™ã‚‹å±¥æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  const deletedNames = [];

  checkedItems.forEach(item => {
    const nameElem = item.querySelector('.castName');
    const name = nameElem ? nameElem.textContent.replace('', '').trim() : 'ä¸æ˜';

    const confirmed = confirm(`ã€Œ${name}ã€ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
    if (confirmed) {
      deletedNames.push(name);
      item.remove();
    }
  });

  // å‰Šé™¤å¾Œã®ä¿å­˜
  localStorage.setItem('historyList', historyList.innerHTML);
  updateSummary();
    // å±¥æ­´ã‚’å‰Šé™¤ã—ãŸã®ã§ã€ãƒœãƒˆãƒ«å€™è£œã‚’æ›´æ–°
  refreshBottleDropdownsFromHistory();

  // å‰Šé™¤çµæœã®è¡¨ç¤º
  if (deletedNames.length > 0) {
    const msg = deletedNames.map(name => `${name} ã®å±¥æ­´ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`).join('\n');
    alert(msg);
  }
}

function updateSummary() {
  const historyItems = document.querySelectorAll('#historyList li');
  let totalPeople = 0;
  let totalAmount = 0;
  let totalGensen = 0;

  historyItems.forEach(item => {
    const text = item.innerText;
    const amountMatch = text.match(/åˆè¨ˆ:\s*Â¥([\d,]+)/);
    const gensenMatch = text.match(/æºæ³‰è²»:\s*Â¥([\d,]+)/);

    if (amountMatch) {
      const amount = parseInt(amountMatch[1].replace(/,/g, ''), 10);
      totalAmount += amount;
    }

    if (gensenMatch) {
      const gensen = parseInt(gensenMatch[1].replace(/,/g, ''), 10);
      totalGensen += gensen;
    }

    totalPeople += 1;
  });

  document.getElementById('summaryTotalPeople').innerText = `${totalPeople}äºº`;
  document.getElementById('summaryTotalAmount').innerText = `Â¥${totalAmount.toLocaleString()}`;
  document.getElementById('summaryTotalTax').innerText = `Â¥${totalGensen.toLocaleString()}`;

  // ã‚«ãƒ³ãƒä»˜ãã§ã‚»ãƒƒãƒˆ
  document.getElementById('femaleSalary').value = totalAmount.toLocaleString();
  document.getElementById('femaleTax').value = totalGensen.toLocaleString();
}


function toggleDetails(button) {
  const container = button.nextElementSibling.nextElementSibling; 
  // ãƒœã‚¿ãƒ³ã®ã™ãæ¬¡ã®ãƒœã‚¿ãƒ³ã®æ¬¡ã®divï¼ˆdetails-html-containerï¼‰ã‚’å–å¾—
  if (container.style.display === 'none' || container.style.display === '') {
    container.style.display = 'block';
    button.textContent = 'è©³ç´°ã‚’éš ã™';
  } else {
    container.style.display = 'none';
    button.textContent = 'è©³ç´°ã‚’è¡¨ç¤º';
  }
}

function calculateBack() {
  const values = {
    f: 1500,
    f2: 2000,
    jounai: 1000,
    honshiri: 0,
    douhan: 1500,
    eda: 500,
    help: -1500,
    set40: 5500,
    set20: 3500,
    vip: 2000,
    a: 500,
    b: 1000,
    c: 1500,
    d: 2000,
    e: 2500
  };

  const inputs = {
    f: document.getElementById("f"),
    f2: document.getElementById("f2"),
    jounai: document.getElementById("jounai"),
    honshiri: document.getElementById("honshiri"),
    douhan: document.getElementById("douhan"),
    eda: document.getElementById("eda"),
    help: document.getElementById("help"),
    set40: document.getElementById("set40"),
    set20: document.getElementById("set20"),
    vip: document.getElementById("vip"),
    a: document.getElementById("a"),
    b: document.getElementById("b"),
    c: document.getElementById("c"),
    d: document.getElementById("d"),
    e: document.getElementById("e")
  };

  let total = 0;
  let detailLines = [];

  Object.keys(values).forEach(key => {
    const count = parseInt(inputs[key]?.value || 0);
    if (count > 0) {
      const unitPrice = values[key];
      const itemTotal = count * unitPrice;
      total += itemTotal;

      const sign = unitPrice < 0 ? "-" : "";
      detailLines.push(`${key.toUpperCase()} Ã—${count}ï¼ˆÂ¥${Math.abs(unitPrice).toLocaleString()}ï¼‰= ${sign}Â¥${Math.abs(itemTotal).toLocaleString()}`);
    }
  });

  document.getElementById("total").textContent = "Â¥" + total.toLocaleString();
  document.getElementById("detail").value = detailLines.join("\n");
}


function restoreCheckboxes() {
  const checkboxStates = JSON.parse(localStorage.getItem('checkboxes')) || {};
  document.getElementById('experienceAndRental').checked = checkboxStates.experienceAndRental || false;
}


document.addEventListener('DOMContentLoaded', () => {
  const exp = document.getElementById('experienceAndRental');
  if (exp) {
    exp.addEventListener('change', function () {
      if (this.checked) {
        const confirmed = confirm('ã€Œä½“é¨“åŠã³è²¸å‡ºã€ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã‚Šã¾ã—ãŸã€‚');
        if (!confirmed) this.checked = false;
      }
    });
  }
});

// çµ±ä¸€ã•ã‚ŒãŸåˆæœŸåŒ–å‡¦ç†
document.addEventListener('DOMContentLoaded', () => {

  // APP2
  loadBottleForms();
  restoreCheckboxes();
  restoreInputs(); 

  // APP1
  restoreForm();
  restoreCheckboxStates();
  document.querySelectorAll("table input[type='checkbox']").forEach(cb => {
    cb.addEventListener("change", saveCheckboxStates);
  });

  // APP3
  restoreApp3Data();
  attachApp3Listeners();

  // é¡§å•æ–™è‡ªå‹•åæ˜ 
  observeTotalCountForAdviserFee(); // â†ã“ã‚Œã‚’è¿½åŠ 

  attachCommaFormatApp1and3();

    const historyList = document.getElementById('historyList');
  if (historyList) {
    historyList.innerHTML = localStorage.getItem('historyList') || '';
  }

  updateSummary();
  updateCalculations(); // åˆæœŸè¨ˆç®—
  attachCommaFormatApp3();
  refreshBottleDropdownsFromHistory();
});

function restoreInputs() {
  const inputValues = JSON.parse(localStorage.getItem('inputs') || '{}');
  Object.entries(inputValues).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  });
}

// --- app2ãƒ•ã‚©ãƒ¼ãƒ ã®åå­—ã‚­ãƒ¼ç§»å‹• ---
// #app2å†…ã§ã®ã¿æœ‰åŠ¹
(function(){
  // ç§»å‹•å¯¾è±¡input,selectã®å…±é€šã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆå‹•çš„å¢—æ¸›å¯¾å¿œï¼‰
  function getApp2Fields() {
    // app2å†…ã®ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ï¼ˆbottle-formå«ã‚€ï¼‰
    return Array.from(document.querySelectorAll(
      '#app2 section#app2-inputSection input:not([type=hidden]):not([disabled]), ' +
      '#app2 section#app2-inputSection select:not([disabled])'
    )).filter(el => el.offsetParent !== null); // è¡¨ç¤ºã®ã¿
  }

  document.addEventListener('keydown', function(e) {
    // app2ä»¥å¤–ã¯ç„¡è¦–
    if (!document.getElementById('app2').classList.contains('active')) return;

    // çŸ¢å°ä»¥å¤–ã¯ç„¡è¦–
    if (!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) return;

    const target = e.target;
    // å¯¾è±¡ãŒapp2å†…ã®inputã‹selectã‹
    if (!target.closest('#app2')) return;
    if (!['INPUT','SELECT'].includes(target.tagName)) return;

    // input/textareaã®å·¦å³ã¯ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•å„ªå…ˆ
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && (target.selectionStart !== target.selectionEnd)) {
      // å…¥åŠ›å€¤å†…ã§ã®ã‚­ãƒ£ãƒ¬ãƒƒãƒˆç§»å‹•ã‚’å„ªå…ˆã•ã›ã‚‹
      if ((e.key === 'ArrowLeft' && target.selectionStart > 0) ||
          (e.key === 'ArrowRight' && target.selectionStart < target.value.length)) {
        return; // ä½•ã‚‚ã—ãªã„
      }
    }

    // ã“ã“ã§ãƒ•ã‚©ãƒ¼ãƒ ç¾¤å–å¾—
    const fields = getApp2Fields();
    const idx = fields.indexOf(target);
    if (idx === -1) return;

    // é…ç½®ã‚’2æ¬¡å…ƒé…åˆ—åŒ–
    const fieldMap = [];
    let lastTop = null, row = [];
    fields.forEach(f=>{
      const top = f.getBoundingClientRect().top;
      if (lastTop !== null && Math.abs(top-lastTop) > 8) {
        fieldMap.push(row);
        row = [];
      }
      row.push(f);
      lastTop = top;
    });
    if (row.length) fieldMap.push(row);

    // ç¾åœ¨ä½ç½®ã‚’ç‰¹å®š
    let rowIdx = -1, colIdx = -1;
    fieldMap.forEach((row,i)=>{
      const j = row.indexOf(target);
      if(j>=0){ rowIdx=i; colIdx=j; }
    });
    if(rowIdx===-1||colIdx===-1) return;

    // ç§»å‹•å…ˆã‚’æ±ºå®š
    let next;
    if(e.key==='ArrowLeft'){
      next = fieldMap[rowIdx][colIdx-1];
    }
    if(e.key==='ArrowRight'){
      next = fieldMap[rowIdx][colIdx+1];
    }
    if(e.key==='ArrowUp'){
      for(let up=rowIdx-1;up>=0;up--){
        if(fieldMap[up][colIdx]){ next=fieldMap[up][colIdx]; break;}
      }
    }
    if(e.key==='ArrowDown'){
      for(let dn=rowIdx+1;dn<fieldMap.length;dn++){
        if(fieldMap[dn][colIdx]){ next=fieldMap[dn][colIdx]; break;}
      }
    }

    if(next){
      e.preventDefault();
      next.focus();
      if(typeof next.select==='function') next.select();
    }
  });
})();













































//<app3 script----------------------------------------------------------------------------------------------------------------->
    function formatNumber(num) {
    return num.toLocaleString('ja-JP');
    }

function get(id) {
  const el = document.getElementById(id);
  if (!el) return 0;
  const raw = String(el.value || '').replace(/,/g, '');
  const n = parseInt(raw, 10);
  return isNaN(n) ? 0 : n;
}

function updateCalculations() {
  const cardTotalText = document.getElementById('cardTotal')?.textContent || '0';
  const cardTotal = parseInt(cardTotalText.replace(/,/g, ''), 10) || 0;

  const cardSalesInput = document.getElementById('cardSales');
  if (cardSalesInput) cardSalesInput.value = formatNumber(cardTotal);

  const summaryTaxText = document.getElementById('summaryTotalTax')?.innerText || 'Â¥0';
  const summaryTaxValue = parseInt(summaryTaxText.replace(/[Â¥,]/g, ''), 10) || 0;
  const femaleTaxEl0 = document.getElementById('femaleTax');
  if (femaleTaxEl0) femaleTaxEl0.value = summaryTaxValue;

  // totalBackAmount â†’ catchBack ã¸ï¼ˆè¦ç´ æœªå­˜åœ¨ã‚¬ãƒ¼ãƒ‰ï¼‰
  const totalBackAmountText =
    document.getElementById("totalBackAmount")?.textContent?.replace(/,/g, "") || "0";
  const totalBackAmount = parseInt(totalBackAmountText, 10) || 0;
  const catchBackEl = document.getElementById("catchBack");
  if (catchBackEl) catchBackEl.value = totalBackAmount.toLocaleString();

  const total = get('totalSales');
  const card = get('cardSales');
  const cash = total - card;
  const cashSalesEl = document.getElementById('cashSales');
  if (cashSalesEl) cashSalesEl.value = formatNumber(cash);

  const labor = get('femaleSalary') + get('maleSalary') + get('catchBack') + get('scoutBack') + get('adviserFee') + get('driverFee');
  const totalLaborEl = document.getElementById('totalLaborCosts');
  if (totalLaborEl) totalLaborEl.value = formatNumber(labor);

  const tax = get('femaleTax') + get('maleTax');
  const totalTaxEl = document.getElementById('totalTax');
  if (totalTaxEl) totalTaxEl.value = formatNumber(tax);

  const receiptTotal = get('receipt1') + get('receipt2') + get('receipt3') + get('receipt4') + get('receipt5');
  const r6 = document.getElementById('receipt6');
  if (r6) r6.value = formatNumber(receiptTotal);

  const expenses = get('alcohol') + receiptTotal;
  const totalExpEl = document.getElementById('totalExpenses');
  if (totalExpEl) totalExpEl.value = formatNumber(expenses);

  const gross = total - labor - tax - expenses;
  const grossEl = document.getElementById('grossProfit');
  if (grossEl) grossEl.value = formatNumber(gross);

  const remaining = gross - card;
  const remainingEl = document.getElementById('remainingCash');
  if (remainingEl) remainingEl.value = formatNumber(remaining);

  const startCash = get('startCash');
  const finalCash = get('finalCash');
  const difference = (finalCash - remaining - tax) - startCash;
  const diffEl = document.getElementById('cashDifference');
  if (diffEl) diffEl.value = formatNumber(difference);

  // adviserFee ã‚’è‡ªå‹•è¨ˆç®—ã—ã¦åæ˜ ï¼ˆå…ƒã®ã¾ã¾ã§OKã ãŒè¦ç´ ãƒã‚§ãƒƒã‚¯ã¯ç¶­æŒï¼‰
  const adviserCountEl = document.getElementById('totalCountValue');
  const adviserFeeInput = document.getElementById('adviserFee');
  if (adviserCountEl && adviserFeeInput) {
    const count = parseInt(adviserCountEl.textContent.replace(/,/g, ''), 10) || 0;
    adviserFeeInput.value = (count * 1000).toLocaleString();
  }

  // è¦‹ãŸç›®ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¦ç´ ãŒã‚ã‚‹æ™‚ã ã‘ï¼‰
  const femaleSalaryEl = document.getElementById('femaleSalary');
  if (femaleSalaryEl) femaleSalaryEl.value = formatNumber(get('femaleSalary'));

  const femaleTaxEl = document.getElementById('femaleTax');
  if (femaleTaxEl) femaleTaxEl.value = formatNumber(get('femaleTax'));

  // è‰²ä»˜ã‘ï¼ˆå†…éƒ¨ã§è¦ç´ ãƒã‚§ãƒƒã‚¯ã™ã‚‹ç‰ˆã«ã—ã¦ãŠãã¨å®‰å…¨ï¼‰
  updateNegativeColor('grossProfit');
  updateNegativeColor('remainingCash');
  updateNegativeColor('cashDifference');

  updateExtraGroupFields();
  attachCommaFormatApp3();

  saveToLocal();
}


function updateExtraGroupFields() {
  // ãã‚Œãã‚Œã®å€¤ã‚’å–å¾—ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ•°ã¯ä»–ã‹ã‚‰æ¸¡ã—ã¦ãã ã•ã„ï¼‰
  let grossProfit = get('grossProfit');         // ç²—åˆ©ç›Š
  let cardSales = get('cardSales');             // ã‚«ãƒ¼ãƒ‰å£²ä¸Š
  let remainingCash = get('remainingCash');     // ç¾é‡‘æ®‹
  let totalTax = get('totalTax');               // æºæ³‰è²»åˆè¨ˆ

  // åˆè¨ˆè¨ˆç®—ï¼šç¾é‡‘æ®‹ + æºæ³‰è²»
  let totalGrossPlusTax = remainingCash + totalTax;

  // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¡¨ç¤ºï¼ˆå­˜åœ¨ç¢ºèªã—ãªãŒã‚‰å®‰å…¨ã«ä»£å…¥ï¼‰
  let el;

  el = document.getElementById('grossProfit_extra');
  if (el) el.value = formatNumber(grossProfit);

  el = document.getElementById('cardSales_extra');
  if (el) el.value = formatNumber(cardSales);

  el = document.getElementById('remainingCash_extra');
  if (el) el.value = formatNumber(remainingCash);

  el = document.getElementById('totalWithholdingTax');
  if (el) el.value = formatNumber(totalTax);

  el = document.getElementById('totalGrossPlusTax');
  if (el) el.value = formatNumber(totalGrossPlusTax);
}


function updateNegativeColor(id) {
  const el = document.getElementById(id);
  if (!el) return; // ç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
  const v = parseInt((el.value || '0').replace(/,/g, ''), 10) || 0;
  el.classList.toggle('negative', v < 0);
}

function saveToLocal() {
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    // disabled çŠ¶æ…‹ã§ã‚‚ä¿å­˜
    localStorage.setItem(input.id, input.value);
  });
}

function loadFromLocal() {
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    const saved = localStorage.getItem(input.id);
    if (saved !== null) input.value = saved;
  });
}


//æ¥­å‹™å†…å®¹ã‚’ä¿å­˜
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const todayStr = today.toISOString().slice(0, 10); // "YYYY-MM-DD"

  if (!localStorage.getItem("workStartDate")) {
    localStorage.setItem("workStartDate", todayStr);
  }
});

function saveApp3Data() {
  const fields = [
    'startCash', 'maleSalary', 'scoutBack', 'driverFee', 'maleTax',
    'alcohol', 'receipt1', 'receipt2', 'receipt3', 'receipt4', 'receipt5', 'finalCash'
  ];
  const data = {};
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
  localStorage.setItem('app3_inputs', JSON.stringify(data));
}

function restoreApp3Data() {
  const saved = localStorage.getItem('app3_inputs');
  if (!saved) return;
  const data = JSON.parse(saved);
  Object.entries(data).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  });
  updateCalculations(); // è¨ˆç®—æ›´æ–°
  attachCommaFormatApp1and3();
}

function attachApp3Listeners() {
  const fields = [
    'startCash', 'maleSalary', 'scoutBack', 'driverFee', 'maleTax',
    'alcohol', 'receipt1', 'receipt2', 'receipt3', 'receipt4', 'receipt5', 'finalCash'
  ];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', saveApp3Data);
    }
  });
}




function getCustomFileName() {
  // JSTã«è£œæ­£ï¼ˆã‚µãƒ¼ãƒãƒ¼UTCãªã‚‰+9ï¼‰
  const now = new Date();
  now.setHours(now.getHours() + 9);

  let fileDate = new Date(now);
  const hour = now.getHours();
  if (hour < 20) {
    fileDate.setDate(fileDate.getDate() - 1);
  }
  const y = fileDate.getFullYear();
  const m = String(fileDate.getMonth() + 1).padStart(2, '0');
  const d = String(fileDate.getDate()).padStart(2, '0');

  return `IBASD_${y}-${m}-${d}`;
}




// =========================
// å…±é€šãƒªã‚»ãƒƒãƒˆé–¢æ•°
// =========================

// ç‰¹å®šã‚¢ãƒ—ãƒª(app1, app2, app3)ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetApp(appId, full = false) {
  if (!confirm(full 
    ? "æœ¬å½“ã«å®Œå…¨ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆå±¥æ­´ãƒ»ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰" 
    : "å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ"
  )) return;

  if (appId === 'app1') {
    resetApp1(full);
  } else if (appId === 'app2') {          // â† ã“ã‚Œã‚’è¿½åŠ 
    resetApp2(full);
  } else if (appId === 'app3') {
    resetApp3(full);
  }

  window.scrollTo({ top: 0, behavior: 'smooth' });

}

function resetAllApps() {
  if (!confirm("app1ã€œapp3ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const overlay = document.getElementById('resetOverlay');
  const canvas = document.getElementById('matrixCanvas');
  const flash = document.getElementById('resetFlash');
  overlay.style.display = 'flex';
  setTimeout(() => overlay.classList.add('active'), 20);

  startMatrixEffect(canvas);

  setTimeout(() => {
    flash.style.opacity = 1;
    setTimeout(() => {
      resetApp1(true);
      resetApp2(true);
      resetApp3(true);
      showApp('app1');
      window.scrollTo({top: 0, behavior: 'auto'});
      try { localStorage.removeItem('appScrollMap'); } catch(e) {}
      if (window.clearTabScrollMemory) window.clearTabScrollMemory();

      // â˜… ã“ã“ã§å…¨éƒ¨ä¸€æ°—ã«æ¶ˆã™
      setTimeout(() => {
        flash.style.opacity = 0;
        stopMatrixEffect();
        overlay.classList.remove('active');
        overlay.style.display = 'none';
      }, 520); // flashãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆåˆ†
    }, 400);  // ç™ºå…‰æŒç¶š
  }, 1600);   // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æ¼”å‡º

// ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æœ€ä¸Šæ®µã¸
window.scrollTo({ top: 0, behavior: 'auto' });

// contentWrapper ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ãƒªã‚»ãƒƒãƒˆ
const wrapper = document.getElementById("contentWrapper");
if (wrapper) wrapper.scrollTop = 0;

// APP1ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«åˆ‡æ›¿
document.body.setAttribute("data-active-app", "app1");

// ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿
document.querySelectorAll(".content").forEach(el => el.classList.remove("active"));
document.getElementById("app1").classList.add("active");

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
document.querySelector('.tab[data-target="app1"]').classList.add("active");

}





// =========================
// app1ç”¨ãƒªã‚»ãƒƒãƒˆ
// =========================
function resetApp1(full) {
  const formRows = document.getElementById("formRows");
  if (!formRows) return;

  // 1è¡Œã ã‘æ®‹ã—ã¦å‰Šé™¤
  while (formRows.rows.length > 1) formRows.deleteRow(1);

  // æœ€åˆã®è¡Œã®åˆæœŸåŒ–
  formRows.querySelectorAll("input, select").forEach(el => el.value = '');
  document.querySelectorAll("table input[type='checkbox']").forEach(cb => cb.checked = false);

  // åˆè¨ˆãƒªã‚»ãƒƒãƒˆ
document.getElementById("totalCustomers").textContent = "0";
document.getElementById("cashTotal").textContent = "0";
document.getElementById("cardTotal").textContent = "0";
document.getElementById("totalAmount").textContent = "0";
document.getElementById("totalCountCell").innerHTML =
  '<button type="button" class="print-mini" onclick="printEnvelopeApp1(\'ALL\')">å‡ºåŠ›</button>' +
  '<span id="totalCountValue" class="count-value">0</span>';
document.getElementById("totalBackAmount").textContent = "0";

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚‚ãƒªã‚»ãƒƒãƒˆ
  const categories = ["UK", "K", "AB", "LA", "PA", "BB", "MS", "GM", "B", "JOE", "KOSE", "HE", "PB", "X", "Z"];
  categories.forEach(cat => {
    document.getElementById(`${cat}count`).textContent = "0";
    document.getElementById(`${cat}total`).textContent = "0";
  });

  rowNumber = 2;
  updateTotals();

  if (full) {
    localStorage.removeItem("formData");
    localStorage.removeItem("checkboxStates");
  }
}


// =========================
// app2ç”¨ãƒªã‚»ãƒƒãƒˆ
// =========================
function resetApp2(full) {
  // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
  document.querySelectorAll('#app2 input[type="text"], #app2 input[type="number"]').forEach(el => el.value = '');
  const exp = document.getElementById('experienceAndRental');
  if (exp) exp.checked = false;
  const result = document.getElementById('result');
  if (result) result.innerHTML = '';
  const bottleForms = document.getElementById('bottleFormsContainer');
  if (bottleForms) bottleForms.innerHTML = '';

  if (full) {
    const historyList = document.getElementById('historyList');
    if (historyList) historyList.innerHTML = '';
    localStorage.removeItem('inputs');
    localStorage.removeItem('historyList');
    localStorage.removeItem('result');
    localStorage.removeItem('bottleForms');
    updateSummary();
  }
}


// =========================
// app3ç”¨ãƒªã‚»ãƒƒãƒˆ
// =========================
function resetApp3(full) {
  document.querySelectorAll('#app3 input').forEach(el => {
    if (el.type !== 'button') el.value = '';
  });
  updateCalculations();

  if (full) {
    localStorage.removeItem('app3_inputs');
    localStorage.removeItem('app3_result');
  }


  attachCommaFormatApp1and3();
}

function clearApp2Inputs() {
  resetApp2(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById('side-clear')?.addEventListener('click', clearApp2Inputs);

function addComma(numStr) {
  if (!numStr) return '';
  // æ•°å­—ã¨ãƒã‚¤ãƒŠã‚¹ä»¥å¤–ã¯é™¤å»
  let val = numStr.replace(/[^\d\-]/g, '');
  val = val.replace(/(?!^)-/g, '');
  if (val === '' || val === '-') return val;
  return parseInt(val, 10).toLocaleString('ja-JP');
}

// app1/app3å†…ã ã‘ã‚«ãƒ³ãƒä»˜ä¸
function attachCommaFormatApp1and3() {
  // app1å¯¾è±¡
  document.querySelectorAll(
    '#app1 input.amount, #app1 input.num, #app1 input.card, #app1 input.total, #app1 input.honshi, #app1 input.table-number'
  ).forEach(input => {
    if (input._commaFormatApplied) return;
    input._commaFormatApplied = true;

    input.addEventListener('input', function () {
      let val = this.value.replace(/,/g, '');
      if (val === '' || !/^-?\d*$/.test(val)) {
        this.value = '';
        return;
      }
      this.value = addComma(val);
    });
    input.addEventListener('focus', function () {
      this.value = this.value.replace(/,/g, '');
    });
    input.addEventListener('blur', function () {
      this.value = addComma(this.value);
    });
    // åˆæœŸå€¤ã«ã‚‚å³æ™‚ã‚«ãƒ³ãƒ
    if (input.value) input.value = addComma(input.value);
  });

  // app3å¯¾è±¡ï¼ˆ#app3ç›´ä¸‹ã§input[type="text"]ã®å…¨éƒ¨/disabledé™¤å¤–ï¼‰
  document.querySelectorAll('#app3 input[type="text"]:not([disabled])')
    .forEach(input => {
      if (input._commaFormatApplied) return;
      input._commaFormatApplied = true;

      input.addEventListener('input', function () {
        let val = this.value.replace(/,/g, '');
        if (val === '' || !/^-?\d*$/.test(val)) {
          this.value = '';
          return;
        }
        this.value = addComma(val);
      });
      input.addEventListener('focus', function () {
        this.value = this.value.replace(/,/g, '');
      });
      input.addEventListener('blur', function () {
        this.value = addComma(this.value);
      });
      if (input.value) input.value = addComma(input.value);
    });
}

function attachCommaFormatApp3() {
  document.querySelectorAll(
    '#app3 input[type="text"], #app3 input[type="number"]'
  ).forEach(input => {
    if (input._commaFormatApplied) return;
    input._commaFormatApplied = true;

    input.addEventListener('input', function () {
      let val = this.value.replace(/,/g, '');
      if (val === '' || !/^-?\d*$/.test(val)) {
        this.value = '';
        return;
      }
      this.value = addComma(val);
    });

    input.addEventListener('focus', function () {
      this.value = this.value.replace(/,/g, '');
    });

    input.addEventListener('blur', function () {
      this.value = addComma(this.value);
    });
  });
}

// --- ãƒãƒˆãƒªãƒƒã‚¯ã‚¹é¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ---
let matrixInterval, matrixStopFlag = false;

function startMatrixEffect(canvas) {
  const ctx = canvas.getContext('2d');
  let W = window.innerWidth;
  let H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
  let fontSize = 18;  // å°‘ã—å°ã•ãå¯†åº¦ã‚’å¢—ã‚„ã™
  let columns = Math.floor(W / fontSize) + 2;
  let drops = [];
  for (let i = 0; i < columns; i++) drops[i] = Math.random() * H / fontSize;

  // æ–‡å­—ã‚»ãƒƒãƒˆï¼ˆã‚«ã‚¿ã‚«ãƒŠãƒ»ã²ã‚‰ãŒãªãƒ»è‹±æ•°å¤§æ–‡å­—ãƒ»è‹±æ•°å°æ–‡å­—ãƒ»æ•°å­—ï¼‰
  const chars = [
    ..."ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³",
    ..."ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“",
    ..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
  ];

  matrixStopFlag = false;

  function draw() {
    ctx.fillStyle = 'rgba(25,30,44,0.23)';
    ctx.fillRect(0, 0, W, H);

    ctx.font = fontSize + "px monospace";
    ctx.fillStyle = "#47f7ff";
    // åˆ—ã”ã¨ã«è¤‡æ•°è¡Œãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦å¯†åº¦UP
    for (let i = 0; i < columns; i++) {
      for (let d = 0; d < 2; d++) { // 1åˆ—ã‚ãŸã‚Š2å€‹
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * fontSize, (drops[i] - d) * fontSize);
      }
      if (Math.random() > 0.975) drops[i] = 0;
      drops[i] += Math.random() * 1.3 + 0.7; // é€Ÿã•ãƒ©ãƒ³ãƒ€ãƒ 
    }
    if (!matrixStopFlag) matrixInterval = requestAnimationFrame(draw);
  }

  draw();
}

function stopMatrixEffect() {
  matrixStopFlag = true;
  if (matrixInterval) cancelAnimationFrame(matrixInterval);
  const canvas = document.getElementById('matrixCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

/* === CBè¡¨ã‚’ [ãƒã‚§ãƒƒã‚¯][ã‚«ãƒ†ã‚´ãƒª][æœ¬æ•°][é‡‘é¡] ã«å¤‰æ› === */
document.addEventListener('DOMContentLoaded', () => {
  const table = document.querySelector('#categorySection table');
  if (!table) return;

  /* ãƒ˜ãƒƒãƒ€ã‚’å·®ã—æ›¿ãˆ */
  const thRow = table.querySelector('thead tr');
  if (thRow) thRow.innerHTML = '<th></th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æœ¬æ•°</th><th>é‡‘é¡</th>';

  /* å„è¡Œã‚’4åˆ—åŒ–ï¼ˆ1åˆ—ç›®ã®ã€Œãƒã‚§ãƒƒã‚¯ï¼‹ã‚«ãƒ†ã‚´ãƒªåã€ã‚’åˆ†é›¢ï¼‰ */
  table.querySelectorAll('tbody tr').forEach(tr => {
    // ã™ã§ã«4åˆ—ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    if (tr.children.length >= 4) return;

    const firstTd = tr.children[0];
    if (!firstTd) return;

    const isTotal = /åˆè¨ˆ/.test(firstTd.textContent);

    if (isTotal) {
      // åˆè¨ˆè¡Œã¯ãƒã‚§ãƒƒã‚¯åˆ—ã‚’ç©ºã€ã‚«ãƒ†ã‚´ãƒªåˆ—ã«ã€Œåˆè¨ˆã€
      const blank = document.createElement('td');          // [ãƒã‚§ãƒƒã‚¯]
      tr.insertBefore(blank, firstTd);                     // å…ˆé ­ã«ç©ºåˆ—ã‚’è¿½åŠ 
      const catTd = document.createElement('td');          // [ã‚«ãƒ†ã‚´ãƒª]
      catTd.innerHTML = firstTd.innerHTML;                 // ã€Œåˆè¨ˆã€
      tr.replaceChild(catTd, firstTd);
      return;
    }

    // é€šå¸¸è¡Œï¼šãƒã‚§ãƒƒã‚¯ã¨ã‚«ãƒ†ã‚´ãƒªåã‚’åˆ†é›¢
    const cb = firstTd.querySelector('input[type="checkbox"]');
    const nameText = firstTd.textContent.replace(/\s+/g, ' ').trim();

    // å…ˆé ­ã‚»ãƒ«ã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã ã‘ã«
    firstTd.innerHTML = '';
    if (cb) firstTd.appendChild(cb);

    // ãƒã‚§ãƒƒã‚¯ã®æ¬¡ã«ã€Œã‚«ãƒ†ã‚´ãƒªåã€ã‚»ãƒ«ã‚’æŒ¿å…¥
    const catTd = document.createElement('td');
    catTd.textContent = nameText; // ä¾‹ï¼šUK
    tr.insertBefore(catTd, tr.children[1]);
  });
 });



// è¨ˆç®—ãƒœã‚¿ãƒ³
document.getElementById('side-calc')?.addEventListener('click', () => {
  confirmAndCalculate(new Event('submit'));
});

/* ========= ã‚¿ãƒ–åˆ‡æ›¿ï¼šå …ç‰¢ç‰ˆï¼ˆç«¶åˆã«å¼·ã„ï¼‰ ================================================================================== */
/* ========= ã‚¿ãƒ–åˆ‡æ›¿ + å„APPã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨˜æ†¶ =============================================================================== */
(function () {
  const tabsRoot = document.querySelector('.tabs');
  if (!tabsRoot) return;

  const pagesById = new Map(['app1','app2','app3'].map(id => [id, document.getElementById(id)]));

  const SCROLL_KEY = 'appScrollMap';
  const loadMap = () => { try { return JSON.parse(localStorage.getItem(SCROLL_KEY)) || {}; } catch(_) { return {}; } };
  const saveMap = (m) => { try { localStorage.setItem(SCROLL_KEY, JSON.stringify(m)); } catch(_) {} };
  let scrollMap = loadMap();

  const getY = () => window.pageYOffset || document.documentElement.scrollTop || 0;
  const restoreY = (id) => {
    const y = Number(scrollMap[id] ?? 0);
    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šå¾Œã«å¾©å¸°
    requestAnimationFrame(() => window.scrollTo({ top: y, behavior: 'auto' }));
  };

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã³ã«ã€Œç¾åœ¨ã®APPã€ã®ä½ç½®ã‚’ä¿å­˜ï¼ˆrAFã‚¹ãƒ­ãƒƒãƒˆãƒ«ï¼‰
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      ticking = false;
      const id = document.body.getAttribute('data-active-app');
      if (!id) return;
      scrollMap[id] = getY();
      saveMap(scrollMap);
    });
  }, { passive: true });

  function apply(targetId) {
    // åˆ‡æ›¿å‰ã«ç¾åœ¨ã®ä½ç½®ã‚’ä¿å­˜
    const prevId = document.body.getAttribute('data-active-app');
    if (prevId) {
      scrollMap[prevId] = getY();
      saveMap(scrollMap);
    }

    // ãƒšãƒ¼ã‚¸è¡¨ç¤º/éè¡¨ç¤º
    pagesById.forEach((el, id) => {
      const on = id === targetId;
      if (!el) return;
      el.style.display = on ? '' : 'none';
      el.classList.toggle('active', on);
      el.toggleAttribute('hidden', !on);
    });

    // ã‚¿ãƒ–ã®è¦‹ãŸç›®/ARIA
    tabsRoot.querySelectorAll('.tab').forEach(t => {
      const on = t.dataset.target === targetId;
      t.classList.toggle('active', on);
      t.setAttribute('aria-selected', on ? 'true' : 'false');
      if (!t.hasAttribute('tabindex')) t.setAttribute('tabindex', on ? '0' : '-1');
      t.setAttribute('role', 'tab');
    });

    document.body.setAttribute('data-active-app', targetId);
    try { localStorage.setItem('selectedTab', targetId); } catch (e) {}

    // ãã®APPã®ä»¥å‰ã®ä½ç½®ã¸å¾©å¸°
    restoreY(targetId);
  }

  // å¤–ã‹ã‚‰ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«
  window.showApp = apply;

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨˜æ†¶ã‚’å®Œå…¨ã‚¯ãƒªã‚¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/ãƒ¡ãƒ¢ãƒªä¸¡æ–¹ï¼‰
window.clearTabScrollMemory = () => {
  scrollMap = {};
  saveMap(scrollMap);
};

  // ã‚¯ãƒªãƒƒã‚¯ï¼†Enter/Spaceã§ã‚¿ãƒ–åˆ‡æ›¿
  tabsRoot.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab || !tabsRoot.contains(tab)) return;
    const id = tab.dataset.target;
    if (id) apply(id);
  });

  tabsRoot.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const tab = e.target.closest('.tab');
    if (!tab) return;
    e.preventDefault();
    const id = tab.dataset.target;
    if (id) apply(id);
  });

  // åˆæœŸè¡¨ç¤ºï¼ˆä¿å­˜ > æ—¢å­˜active > å…ˆé ­ > app1ï¼‰
  const saved = localStorage.getItem('selectedTab');
  const fallbackTab = tabsRoot.querySelector('.tab.active') || tabsRoot.querySelector('.tab');
  const fallback = fallbackTab?.dataset.target || 'app1';
  apply(saved || fallback);

  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ä¿é™º
  window.addEventListener('beforeunload', () => {
    const id = document.body.getAttribute('data-active-app');
    if (!id) return;
    scrollMap[id] = getY();
    saveMap(scrollMap);
  });
})();







// APP3ä¿å­˜ã¨å°ç­’å°åˆ·ã§å…±é€šåˆ©ç”¨ã™ã‚‹æ—¥ä»˜æ–‡å­—åˆ—ç”Ÿæˆé–¢æ•°
function getApp3StyleDate() {
  const d = new Date();
  // 5æ™‚ã‚ˆã‚Šå‰ãªã‚‰å‰æ—¥æ‰±ã„
  if (d.getHours() < 5) {
    d.setDate(d.getDate() - 1);
  }
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}/${m}/${day}`;
}


/* =========================================================
   APP1 ã ã‘ã§ä½¿ã†ã‚‚ã®ï¼ˆé¡§å•æ–™ï¼šALLï¼å€‹åˆ¥ã®å°ç­’å°åˆ·ï¼‰
   ä½¿ã„æ–¹ï¼š
     - é¡§å•æ–™ã¾ã¨ã‚å°ç­’ â€¦ printEnvelopeApp1('ALL')
     - ã‚«ãƒ†ã‚´ãƒªå°ç­’     â€¦ printEnvelopeApp1('UK') ãªã©
     - #resultã‚’ãã®ã¾ã¾å°åˆ· â€¦ preparePrintApp1()
   ========================================================= */

window.preparePrintApp1 = function () {
  const html = (document.getElementById('result')?.innerHTML || '').trim();
  if (!html) { alert('å°åˆ·ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
  const printCSS = `
    <style>
      @media print {
        @page { size: 90mm 205mm; margin: 0; }
        html, body { margin: 0; padding: 0; background: #fff;
          -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        #result {
          width: 90mm !important; max-height: 205mm !important;
          margin: 0 auto !important; padding: 8mm 6mm !important;
          box-sizing: border-box; font-size: 10.5pt; line-height: 1.25;
        }

        #result, .envelope {
         page-break-before: avoid;
         page-break-after: avoid;
         page-break-inside: avoid;
        }

        
      }
    </style>`;
  openPrintApp1(printCSS + html, { scale: 1.00, rotateOnMobile: true, trimBottomMM: 0 });
};

window.printEnvelopeApp1 = function (category) {
  const dateStr = (typeof getApp3StyleDate === 'function')
    ? getApp3StyleDate()
    : (()=>{const d=new Date();return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`})();

function summarizeDetails(arr) {
  const summary = {};
  (arr || []).forEach(d => {
    const u = Number(String(d.unit).replace(/,/g,'')) || 0;   // å˜ä¾¡
    const n = Number(String(d.count).replace(/,/g,'')) || 0;  // æœ¬æ•°
    if (!u) return;  // å˜ä¾¡ãŒç„¡ã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
    if (!summary[u]) summary[u] = { count: 0, total: 0 };
    summary[u].count += n;
    summary[u].total += u * n;
  });
  return summary;
}
  const yen = v => Number(v||0).toLocaleString('ja-JP');

  if (category === 'ALL') {
    if (!confirm('ä¼ç¥¨ã®è¨˜å…¥ã¯ã™ã¹ã¦å®Œäº†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ')) return;
    const countVal = parseInt((document.getElementById('totalCountValue')?.textContent || '0').replace(/,/g,''),10);
    const bottles  = isNaN(countVal) ? 0 : countVal;
    const amount   = bottles * 1000;
    const CATEGORIES = ['UK','K','AB','LA','PA','BB','MS','GM','B','JOE','KOSE','HE','PB','X'];
    const rowsHtml = CATEGORIES.map(key=>{
      const arr = (window.catchbackDetails && window.catchbackDetails[key]) || [];
      const sm  = summarizeDetails(arr);
const details = Object.entries(sm).sort((a,b)=>Number(b[0])-Number(a[0]))
  .map(([u,data]) => `<span>${u} Ã— ${data.count}</span>`)
  .join('<br>');
      const total = Object.values(sm).reduce((s, v) => s + (v?.count || 0), 0);
      return `<div class="print-detail-inline">
                <strong>${key}</strong>
                <div class="details">${details || '0'}</div>
                <div class="total">(è¨ˆ${total})</div>
              </div>`;
    }).join('');
    const inner = `
      <div class="envelope">
        <div class="print-date">${dateStr}</div>
        <div class="print-title">é¡§å•æ–™</div>
        <div style="text-align:center; font-size:26pt; margin:2mm 0 3mm;">ï¿¥${yen(amount)}</div>
        <div style="text-align:center; font-size:14pt; margin-bottom:4mm;">ï¼ˆäººæ•°: ${bottles}ï¼‰</div>
        <div class="print-detail-container"><div class="print-detail-matrix">${rowsHtml}</div></div>
      </div>`;
    openPrintApp1(inner, { scale: 0.98, rotateOnMobile: true, trimBottomMM: 20 });
    return;
  }

  // å€‹åˆ¥ã‚«ãƒ†ã‚´ãƒª
  const arr = (window.catchbackDetails && window.catchbackDetails[category]) || [];
const rows = arr.map(d =>
  `<div class="print-detail-row">
     <span>${d.unit}</span><span>Ã—</span><span>${d.count}</span>
   </div>`
).join('');
  const total = arr.reduce((s,d)=>s+Number(d.count||0),0);
  const amountText = (document.getElementById(category + 'total')?.textContent || '0').trim();
  const inner = `
    <div class="envelope">
      <div class="print-date">${dateStr}</div>
      <div class="print-title">${category}</div>
      <div style="text-align:center; font-size:22pt; margin:5mm 0 6mm;">ï¿¥${amountText}</div>
      ${rows || '<div style="text-align:center;">0</div>'}
      <div style="text-align:center; font-size:12pt; margin-top:4mm;">Total ${total}</div>
    </div>`;
  openPrintApp1(inner, { scale: 1.00, rotateOnMobile: true, trimBottomMM: 0 });
};

function openPrintApp1(innerHTML, opts = {}) {
  const { scale=1.00, rotateOnMobile=true, trimBottomMM=0 } = opts;
  const isSP = /iPhone|iPod|Android.*Mobile/i.test(navigator.userAgent);
  const rotate = rotateOnMobile && isSP;
  const printHTML = `<!doctype html><html lang="ja"><head><meta charset="utf-8">
  <title>print</title><meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --scale:${scale}; }
  @page { size: 90mm 205mm; margin: 0; }
  html,body{ margin:0; padding:0; background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }

  /* æ  */
  #page{
    width:90mm;
    max-height:205mm !important;
    margin:0 auto;
    overflow:hidden;           /* é€šå¸¸ã¯éš ã™ */
  }
  /* å›è»¢æ™‚ï¼šã‚¯ãƒªãƒƒãƒ—å›é¿ï¼‹é«˜ã•å›ºå®šï¼‹ä»»æ„ã®ä¸‹ç«¯ãƒˆãƒªãƒ  */
  .rotate180 #page{
    overflow:visible !important;
    height:205mm !important;   /* max-height ã§ã¯ãªã height ã§å›ºå®š */
    margin-bottom:-${trimBottomMM}mm;
  }

  /* ä¸­èº« */
  #result{
    width:calc(90mm/var(--scale));
    min-height:calc(205mm/var(--scale));
    margin:0 auto; padding:0; box-sizing:border-box;
    transform:scale(var(--scale));
    transform-origin:top center;  /* ä¸ŠåŸºæº– */
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }
  /* å›è»¢æ™‚ï¼šä¸ŠåŸºæº–ã®ã¾ã¾180Â°å›è»¢ï¼ˆæ°åã®ä¸Šåˆ‡ã‚Œé˜²æ­¢ï¼‰ */
  .rotate180 #result{
    transform:rotate(180deg) scale(var(--scale));
    transform-origin:top center !important;
  }

  /* å°ç­’UIï¼ˆAPP1ç”¨ï¼‰ */
  .envelope{
    width:86mm; max-height:205mm; margin:0 auto; text-align:center;
    font-family:'ï¼­ï¼³ æ˜æœ',serif; font-weight:bold; font-variant-numeric:tabular-nums; letter-spacing:.02em;
  }
  .print-date{ text-align:left;  font-size:11pt; margin: 4mm 0 0; }
  .print-title{ text-align:center; font-size:14pt; margin: 2mm 0 8mm; font-weight:700; }
  .print-detail-row{ display:flex; justify-content:center; align-items:baseline; gap:2mm; font-size:12pt; margin:1mm 0; }

  .print-detail-container{
    width:78mm; margin:6mm auto 0; padding:3mm 3.2mm;
    border:2px solid #000; border-radius:2mm; box-sizing:border-box;
  }
  .print-detail-matrix{
    display:grid;
    grid-template-columns:1fr;     /* 1åˆ— */
    row-gap:1.5mm;                 /* è¡Œé–“ */
    justify-items:start;           /* å·¦å¯„ã› */
  }
  .print-detail-inline{
    width:100%; display:grid; grid-template-columns:12mm 1fr 13mm;
    justify-items:center; align-items:center; text-align:center;
    font-size:10.5pt; line-height:1.25; font-variant-numeric:tabular-nums; margin:1mm 0;
  }
  .print-detail-inline .details{ white-space:normal; letter-spacing:-0.2pt; }
  .print-detail-inline .details span{ display:inline-block; margin:0 .9mm; }
</style>
  </head><body class="${rotate ? 'rotate180' : ''}">
    <div id="page"><div id="result">${innerHTML}</div></div>
    <script>
      function tryClose(){ try{ window.close(); }catch(e){} }
      window.onload = function(){
        try{ window.focus(); window.print(); }catch(e){}
        window.onafterprint = tryClose;
        window.addEventListener('focus', tryClose, { once:true });
        document.addEventListener('visibilitychange', function(){ if(!document.hidden) tryClose(); });
        setTimeout(tryClose, 2500);
      };

      
    <\/script>
  </body></html>`;
  try {
    let w = window.open('', 'PRINT_APP1', 'width=480,height=800');
    if (w && w.document) { w.document.open(); w.document.write(printHTML); w.document.close(); return; }
  } catch(_) {}
  try { const blob=new Blob([printHTML],{type:'text/html'}); const url=URL.createObjectURL(blob); window.open(url,'_blank'); return; } catch(_) {}
}

/* =========================================================
   APP2 ã ã‘ã§ä½¿ã†ã‚‚ã®ï¼ˆ#result ã‚’å°ç­’ã‚µã‚¤ã‚ºã§å‡ºåŠ›ï¼‰
   ä½¿ã„æ–¹ï¼š
     - #resultã‚’å°ç­’ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ â€¦ preparePrintApp2('envelope')  â†æ—¢å®š
     - #resultãã®ã¾ã¾            â€¦ preparePrintApp2('plain')
   ========================================================= */

window.preparePrintApp2 = function (mode = 'envelope') {
  if (typeof window.showApp === 'function') window.showApp('app2');
  if (typeof window.calculate === 'function') window.calculate();

  // ğŸ”½ ã“ã“ã‹ã‚‰è¿½åŠ ï¼šçµæœã¾ã§ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    const resultEl = document.getElementById('result');
    if (resultEl) {
      resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 600); // è¨ˆç®—å®Œäº†å¾Œã«é…ã‚Œã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆ500ã€œ800msãŒç›®å®‰ï¼‰
  // ğŸ”¼ è¿½åŠ ã“ã“ã¾ã§

  const html = (document.getElementById('result')?.innerHTML || '').trim();
  if (!html) {
    alert('å°åˆ·ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€Œè¨ˆç®—ã€ã§çµæœã‚’å‡ºã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // å°ç­’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ .envelope ã§åŒ…ã‚€
  const hasEnvelope = /class\s*=\s*["'][^"']*envelope/.test(html);
  const inner = (mode === 'envelope' && !hasEnvelope)
    ? `<div class="envelope">${html}</div>`
    : html;

  openPrintApp2(inner, { scale: 1.05, rotateOnMobile: true, trimBottomMM: 20 });
};


function openPrintApp2(innerHTML, opts = {}) {
  const { scale = 1.00, rotateOnMobile = true, trimBottomMM = 0 } = opts;
  const isSP = /iPhone|iPod|Android.*Mobile/i.test(navigator.userAgent);
  const rotate = rotateOnMobile && isSP;

  // â˜… æœ€çµ‚åˆè¨ˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ¡ä»¶ã‚’æº€ãŸã›ã° special ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
  const temp = document.createElement('div');
  temp.innerHTML = innerHTML;
  const finalEl = temp.querySelector('.finalAmount');
  if (finalEl) {
    const num = parseInt(finalEl.textContent.replace(/[^0-9]/g, ''), 10);
    if (num >= 100000) {
      finalEl.classList.add('rainbow-print');
    }
  }
  innerHTML = temp.innerHTML;

  const printHTML = `<!doctype html><html lang="ja"><head>
  <meta charset="utf-8"><title>print</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --scale:${scale}; }
    @page { size: 90mm 205mm; margin: 0; }
    html,body {
      margin:0; padding:0; background:#fff;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }

    #page { width:90mm; max-height:205mm; margin:0 auto; overflow:hidden; }
    .rotate180 #page { margin-bottom:-${trimBottomMM}mm; }

    #result {
      width:calc(90mm/var(--scale));
      min-height:calc(205mm/var(--scale));
      margin:0 auto; padding:0;
      box-sizing:border-box;
      transform:scale(var(--scale));
      transform-origin:top center;
    }
    .rotate180 #result {
      transform:rotate(180deg) scale(var(--scale));
      transform-origin:center center;
    }

.envelope {
  box-sizing: border-box;
  width: calc(84mm / var(--scale)); /* â† 86â†’84 ã«ã—ã¦å·¦å³3mmãšã¤ã®ä½™ç™½ã‚’ç¢ºä¿ */
  max-height: 205mm;
  margin: 0 auto;
  text-align: left;
  font-family: 'ï¼­ï¼³ æ˜æœ', serif;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: .02em;
  padding: calc(5mm / var(--scale)); /* padding ã‚‚ã‚¹ã‚±ãƒ¼ãƒ«ã§å‰²ã£ã¦å®ŸåŠ¹å¹…ã‚’ç¶­æŒ */
}
    .print-date  { text-align:left;  font-size:11pt; margin:4mm 0 0; }
    .print-title { text-align:center;font-size:14pt;margin:2mm 0 8mm;font-weight:700; }
    .receipt-row { display:flex; justify-content:space-between; align-items:baseline; }
    .receipt-row .label{ margin-right:5mm; white-space:nowrap; }
    .receipt-row .value{ font-weight:700; font-size:12pt; text-align:right; }
    .totalAmount{ font-size:18pt !important; font-weight:800; color:#0066cc; margin:3mm 0 2mm; }
    .finalAmount{ font-size:18pt !important; font-weight:900; color:#009944; margin:4mm 0 3mm; }
    .castName   { font-size:16pt !important; font-weight:700; }

      .castName {
    font-size: 18pt !important;
    font-weight: 800 !important;
    margin: 3mm 0 !important;   /* åå‰ä¸Šä¸‹ã®ä½™ç™½å¾©æ´» */
  }

  .subtotal {
    font-size: 14pt !important;
    font-weight: 700 !important;
    color: #333 !important;
    margin-top: 2mm !important;
    margin-bottom: 2mm !important;
  }

  .totalAmount {
    font-size: 15pt !important;
    font-weight: 800 !important;
    color: #0066cc !important;
    margin-top: 3mm !important;
    margin-bottom: 2mm !important;
  }

  .finalAmount {
    font-size: 18pt !important;
    font-weight: 900 !important;
    color: #009944 !important;
    margin-top: 4mm !important;
    margin-bottom: 3mm !important;
  }

    /* å°åˆ·ã ã‘è™¹è‰² */
    @media print {
      @keyframes rainbowText {
        0%   { color: red; }
        20%  { color: orange; }
        40%  { color: yellow; }
        60%  { color: green; }
        80%  { color: blue; }
        100% { color: purple; }
      }

  .rainbow-print {
    background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900;
  }

#result .congrats.print-only {
  display: none;
  text-align: center;
  font-weight: bold;
  font-size: 14pt;

  /* â†“ ã“ã“ã‚’è¿½åŠ ã¾ãŸã¯èª¿æ•´ */
  margin-bottom: 2px;   /* æœ€çµ‚åˆè¨ˆã¨ã®é–“éš”ã‚’å°ã•ãã™ã‚‹ */
}
@media print {
  #result .congrats.print-only {
    display: block;
  }

#result .congrats-box {
  border: 2px solid #000;
  padding: 6px 10px;
  margin: 6px 0;

  /* ã“ã“ã‹ã‚‰è¿½åŠ /å¤‰æ›´ */
  max-width: calc(100% - 4mm); /* â† å³ç«¯ã‚¯ãƒªãƒƒãƒ—å›é¿ã®å®‰å…¨å¹… */
  margin-left: 2mm;
  margin-right: 2mm;
  /* ã“ã“ã¾ã§ */

  text-align: center;
  border-radius: 6px;
  display: block;
  box-sizing: border-box;
}

#result .congrats.print-only {
  font-weight: bold;
  font-size: 14pt;
  margin-bottom: 2px;       /* æœ€çµ‚åˆè¨ˆã¨ã®é–“éš”ã‚’èª¿æ•´ */
}
}
       
    }
    
  </style>
  </head><body class="${rotate ? 'rotate180' : ''}">
    <div id="page"><div id="result">${innerHTML}</div></div>
    <script>
      function tryClose(){ try{ window.close(); }catch(e){} }
      window.onload = function(){
        try{ window.focus(); window.print(); }catch(e){}
        window.onafterprint = tryClose;
        window.addEventListener('focus', tryClose, { once:true });
        document.addEventListener('visibilitychange', function(){ if(!document.hidden) tryClose(); });
        setTimeout(tryClose, 2500);
      };
    <\/script>
  </body></html>`;

  try {
    let w = window.open('', 'PRINT_APP2', 'width=480,height=800');
    if (w && w.document) {
      w.document.open(); w.document.write(printHTML); w.document.close();
      return;
    }
  } catch(_) {}
  try {
    const blob = new Blob([printHTML], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url,'_blank');
    return;
  } catch(_) {}
}


























</script>

<script type="module">
/***  Firebase v10 ESMï¼ˆCDNï¼‰ ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, enableIndexedDbPersistence,
  doc, getDoc, setDoc, updateDoc, onSnapshot,
  serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/*** â†ã“ã“ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®å€¤ã§ç½®ãæ›ãˆ ***/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "ibasdbeta",
  storageBucket: "ibasdbeta.firebasestorage.app",
  messagingSenderId: "317393843615",
  appId: "1:317393843615:web:xxxxxxxxxxxxxxxx",
  measurementId: "G-XXXXXXXXXX"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{ /* è¤‡æ•°ã‚¿ãƒ–æ™‚ãªã©ã¯ç„¡è¦–ã§OK */ });

/*** Firestore ãƒ‘ã‚¹è¨­è¨ˆ ***/
const COLLECTION = "IBAS";
const CLIENT_ID = (() => {
  const k="ibas-client-id";
  return localStorage.getItem(k) || (localStorage.setItem(k,crypto.randomUUID()), localStorage.getItem(k));
})();

const monthKey = (d=new Date()) => d.toISOString().slice(0,7);
const docRefFor = (key = monthKey()) => doc(db, COLLECTION, key);

/*** ç”»é¢å³ä¸Šã®ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–è¡¨ç¤º ***/
function ensureIndicator(){
  if(document.getElementById("syncIndicator")) return;
  const el = document.createElement("div");
  el.id = "syncIndicator";
  el.style.cssText = `
    position:fixed; top:8px; right:10px; z-index:3000;
    background:rgba(0,34,43,.95); color:#00f5ff; border:1px solid #00f5ff55;
    padding:6px 10px; border-radius:8px; font:14px/1.2 system-ui, sans-serif;
    box-shadow:0 2px 10px rgba(0,245,255,.2); display:none;`;
  el.textContent = "ä¿å­˜ä¸­â€¦";
  document.body.appendChild(el);
}
function _showSaving(){ ensureIndicator(); const el=document.getElementById("syncIndicator"); el.style.display="block"; el.textContent="ä¿å­˜ä¸­â€¦"; }
function _saved(){ const el=document.getElementById("syncIndicator"); if(!el) return; el.textContent="ä¿å­˜æ¸ˆã¿"; setTimeout(()=>{el.style.display="none"}, 900); }

/*** ==== åé›†ï¼†å¾©å…ƒï¼ˆã‚ãªãŸã®UIã«åˆã‚ã›æ¸ˆã¿ï¼‰ ==== ***/
/* app1ï¼ˆä¼ç¥¨ï¼‰ï¼š#formRows ã®å‹•çš„è¡Œã‚’ä¿å­˜/å¾©å…ƒ */
function collectApp1State(){
  const rows = [...document.querySelectorAll('#formRows tr.row')].map(tr => ({
    table:  tr.querySelector('.table-number')?.value ?? "",
    honshi: tr.querySelector('.honshi')?.value ?? "",
    c:      tr.querySelector('.c')?.value ?? "",
    amount: tr.querySelector('.amount')?.value ?? "",
    num:    tr.querySelector('.num')?.value ?? "",
    detail: tr.querySelector('.detail')?.value ?? "",
    card:   tr.querySelector('.card')?.value ?? "",
    total:  tr.querySelector('.total')?.value ?? ""
  }));

  // â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼šCBè¡¨ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ‹¾ã†
  // ã€ŒUKtotalã€ã€ŒKtotalã€â€¦ã® <span id="â—¯â—¯total"> ã‚’ã‚­ãƒ¼ã®å…ƒã«ã—ã¦å®‰å®šåŒ–
  const catChecks = {};
  document.querySelectorAll('#categorySection tbody tr').forEach(tr => {
    const cb = tr.querySelector('input[type="checkbox"]');
    if (!cb) return;
    const key =
      (tr.querySelector('span[id$="total"]')?.id || '')
        .replace(/total$/, '')              // "UKtotal" -> "UK"
      || (tr.textContent || '').trim().split(/\s+/)[0]; // å¿µã®ãŸã‚ä¿é™º
    if (key) catChecks[key] = !!cb.checked;
  });

  return { rows, catChecks };   // â˜… è¿½åŠ ã—ãŸ catChecks ã‚‚è¿”ã™
}
function applyApp1State(state){
  if(!state || !state.rows) return;
  const tbody = document.getElementById('formRows');
  if(!tbody) return;

  // æ—¢å­˜è¡Œã‚’ç©ºã«
  tbody.innerHTML = "";

  // è¡Œã‚’è¿½åŠ ã—ã¦å€¤ã‚’æµã—è¾¼ã‚€
  state.rows.forEach((r, idx)=>{
    if(typeof window.addRow === "function"){
      window.addRow();
    }else{
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è¡Œã‚’è¿½åŠ 
      const tr = document.createElement('tr');
      tr.className = 'row';
      tr.innerHTML = `
        <td><button class="delete-btn" onclick="deleteRow(this)">Ã—</button></td>
        <td class="rowNumber">${idx+1}</td>
        <td><input class="table-number" type="text"/></td>
        <td><input class="honshi" type="text"/></td>
        <td>
          <select class="c">
            <option value=""></option>
            <option>UK</option><option>K</option><option>AB</option><option>LA</option>
            <option>PA</option><option>BB</option><option>MS</option><option>GM</option>
            <option>B</option><option>JOE</option><option>KOSE</option><option>HE</option>
            <option>PB</option><option>X</option><option>Z</option>
          </select>
        </td>
        <td><input class="amount" type="text"/></td>
        <td><input class="num" type="text"/></td>
        <td><input class="detail" type="text"/></td>
        <td><input class="card" type="text"/></td>
        <td><input class="total" type="text"/></td>`;
      tbody.appendChild(tr);
    }

    // è¿½åŠ ã—ãŸè¡Œã‚’å–å¾—
    const tr = tbody.querySelector('tr.row:last-child');
    if(!tr) return;

    // å€¤ã‚’å®‰å…¨ã«ä»£å…¥ã™ã‚‹ãƒ˜ãƒ«ãƒ‘
    const setVal = (sel, val) => {
      const el = tr.querySelector(sel);
      if (el) el.value = (val ?? "");
    };

    setVal('.table-number', r.table);
    setVal('.honshi',       r.honshi);
    setVal('.c',            r.c);
    setVal('.amount',       r.amount);
    setVal('.num',          r.num);
    setVal('.detail',       r.detail);
    setVal('.card',         r.card);
    setVal('.total',        r.total);
  });

    // â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼šCBè¡¨ã®ãƒã‚§ãƒƒã‚¯ã‚’å¾©å…ƒ
  if (state.catChecks) {
    Object.entries(state.catChecks).forEach(([key, checked]) => {
      // "UK" â†’ "#UKtotal" ã‚’æ¢ã—ã€ãã®è¡Œã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
      const span = document.querySelector(`#categorySection #${CSS.escape(key)}total`);
      const tr   = span?.closest('tr');
      const cb   = tr?.querySelector('input[type="checkbox"]');
      if (cb) cb.checked = !!checked;
    });
  }

  // åˆè¨ˆå†è¨ˆç®—
  if (typeof window.updateTotals === "function") {
    window.updateTotals();
  }
}

/* app2ï¼ˆå ±é…¬è¨ˆç®—ï¼‰ï¼šid ã‚’æŒã¤ input/select/textarea ã‚’ä¸¸ã”ã¨ä¿å­˜/å¾©å…ƒï¼‹ãƒœãƒˆãƒ«æ˜ç´° */
function collectApp2State(){
  const root = document.getElementById('app2');
  if(!root) return {};

  const fields = {};
  root.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
    fields[el.id] = (el.type === 'checkbox') ? !!el.checked : (el.value ?? "");
  });

  // æ—¢å­˜: ãƒœãƒˆãƒ«æ˜ç´°
  const bottles = [...root.querySelectorAll('#bottleFormsContainer .bottle-form')].map(form => ({
    details: form.querySelector('.bottleDetails')?.value ?? "",
    split:   form.querySelector('.splitCount')?.value ?? "",
    qty:     form.querySelector('.bottleQuantity')?.value ?? "",
    amount:  form.querySelector('.bottleAmount')?.value ?? ""
  }));

  // â˜…è¿½åŠ : å±¥æ­´ï¼ˆHTMLãã®ã¾ã¾ï¼‰
  const historyRoot = document.getElementById('historyList');
  const historyHTML = historyRoot ? historyRoot.innerHTML : "";

  return { fields, bottles, historyHTML };
}

function applyApp2State(state){
  const root = document.getElementById('app2');
  if(!root || !state) return;

  if(state.fields){
    Object.entries(state.fields).forEach(([id, val])=>{
      const el = root.querySelector('#'+CSS.escape(id));
      if(!el) return;
      if(el.type === 'checkbox'){ el.checked = !!val; }
      else { el.value = val ?? ""; }
    });
  }

  if(Array.isArray(state.bottles)){
    const container = root.querySelector('#bottleFormsContainer');
    if(container){
      container.innerHTML = "";
      state.bottles.forEach(b=>{
        // æ—¢å­˜ã®è¿½åŠ é–¢æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
        if(typeof window.addBottleForm === "function"){
          const el = window.addBottleForm();
          (el?.querySelector('.bottleDetails')||{}).value = b.details ?? "";
          (el?.querySelector('.splitCount')||{}).value    = b.split ?? "";
          (el?.querySelector('.bottleQuantity')||{}).value= b.qty ?? "";
          (el?.querySelector('.bottleAmount')||{}).value  = b.amount ?? "";
        }else{
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”Ÿæˆï¼ˆæ—¢å­˜å®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼‰
          const row = document.createElement('div');
          row.className = 'bottle-form';
          row.innerHTML = `
            <div class="left-group">
              <button type="button" class="delete-btn" onclick="this.closest('.bottle-form')?.remove()">Ã—</button>
              <select class="bottleDetails"><option value=""></option></select>
            </div>
            <input class="splitCount" type="text"/>
            <input class="bottleQuantity" type="text"/>
            <input class="bottleAmount" type="text"/>`;
          container.appendChild(row);
          row.querySelector('.bottleDetails').value = b.details ?? "";
          row.querySelector('.splitCount').value    = b.split ?? "";
          row.querySelector('.bottleQuantity').value= b.qty ?? "";
          row.querySelector('.bottleAmount').value  = b.amount ?? "";
        }
      });
    }
  }

  // â˜…è¿½åŠ : å±¥æ­´HTMLã®åæ˜ ï¼‹æ´¾ç”Ÿå‡¦ç†
  if (typeof state.historyHTML === "string") {
    const historyRoot = document.getElementById('historyList');
    if (historyRoot && historyRoot.innerHTML !== state.historyHTML) {
      historyRoot.innerHTML = state.historyHTML;
      try { localStorage.setItem('historyList', state.historyHTML); } catch(e){}
      if (typeof window.renumberHistory === "function") renumberHistory();
      if (typeof window.refreshBottleDropdownsFromHistory === "function") refreshBottleDropdownsFromHistory();
      if (typeof window.updateSummary === "function") updateSummary();
    }
  }
}


/* app3ï¼ˆã–ã£ãã‚Šï¼‰ï¼šidä»˜ãã®è¦ç´ ã‚’ä¸€æ‹¬ä¿å­˜/å¾©å…ƒ */
function collectApp3State(){
  const root = document.getElementById('app3');
  if(!root) return {};
  const fields = {};
  root.querySelectorAll('input[id], select[id], textarea[id]').forEach(el=>{
    fields[el.id] = (el.type === 'checkbox') ? !!el.checked : (el.value ?? "");
  });
  return { fields };
}
function applyApp3State(state){
  const root = document.getElementById('app3');
  if(!root || !state || !state.fields) return;
  Object.entries(state.fields).forEach(([id, val])=>{
    const el = root.querySelector('#'+CSS.escape(id));
    if(!el) return;
    if(el.type === 'checkbox'){ el.checked = !!val; }
    else { el.value = val ?? ""; }
  });
}

/*** ==== èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜ãƒ»è³¼èª­ ==== ***/
async function loadAllApps(key = monthKey()){
  const snap = await getDoc(docRefFor(key));
  const data = snap.exists() ? snap.data() : {};
  applyApp1State(data.app1);
  applyApp2State(data.app2);
  applyApp3State(data.app3);
}

async function saveAllApps(key = monthKey()){
  _showSaving();
  const payload = {
    app1: collectApp1State(),
    app2: collectApp2State(),
    app3: collectApp3State(),
    updatedAt: serverTimestamp(),
    lastAuthor: CLIENT_ID
  };
  await setDoc(docRefFor(key), payload, { merge:true });
  _saved();
}

/* ä»–ç«¯æœ«ã‹ã‚‰ã®æ›´æ–°ã‚’å—ã‘å–ã‚Šåæ˜ ï¼ˆè‡ªç«¯æœ«ã®ç›´å¾Œã®æ›¸ãè¾¼ã¿ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰ */
function subscribeRemote(key = monthKey()){
  return onSnapshot(docRefFor(key), snap=>{
    if(!snap.exists()) return;
    const data = snap.data();
    if(data?.lastAuthor === CLIENT_ID) return; // è‡ªåˆ†ã®æ›¸ãè¾¼ã¿ã¯ç„¡è¦–
    applyApp1State(data.app1 || {});
    applyApp2State(data.app2 || {});
    applyApp3State(data.app3 || {});
  });
}

/*** ==== ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰ ==== ***/
let _saveTimer = null;
function scheduleAutosave(){
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=> saveAllApps(monthKey()), 800);
}

// ===== åŒæœŸãƒ˜ãƒ«ãƒ‘ =====
function saveNow(reason=""){ 
  try{ console.debug("[SYNC] now:", reason); }catch(_){}
  return saveAllApps(monthKey());
}

// é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã€Œå®Ÿè¡Œå¾Œã€ã«åŒæœŸã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function wrapAndSync(name, {immediate=false} = {}){
  const fn = window[name];
  if(typeof fn !== "function") return;
  window[name] = async function(...args){
    const ret = fn.apply(this, args);
    try { if (ret && typeof ret.then === "function") await ret; } catch(e){}
    if (immediate) { await saveNow(name); } else { scheduleAutosave(); }
    return ret;
  };
}

// å„APPã®ã‚¯ãƒªã‚¢ç³»é–¢æ•°ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘å‹•ãï¼‰
["clearApp1","clearApp2","clearApp3","resetAllApps","clearAll"].forEach(n=>{
  wrapAndSync(n, { immediate:true });
});

// APP2 è¨ˆç®—å®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ  onsubmit ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®šï¼‰
wrapAndSync("confirmAndCalculate", { immediate:true });

// APP1 ä¼ç¥¨ãƒ•ã‚£ãƒ«ã‚¿
wrapAndSync("filterCategory",      { immediate:false });
wrapAndSync("filterCashOnlyRows",  { immediate:false });
wrapAndSync("filterCardInputRows", { immediate:false });
wrapAndSync("resetSearch",         { immediate:false });

(function observeApp2History(){
  const historySection = document.getElementById("app2-historySection");
  if (!historySection) return;

  let debounceTimer = null;

  const observer = new MutationObserver(() => {
    clearTimeout(debounceTimer);
    // 100ms ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã§ä¸¡æ–¹ã®å‡¦ç†ã‚’å®‰å…¨ã«å‘¼ã¶
    debounceTimer = setTimeout(() => {
      scheduleAutosave();
      createHistoryIndex();
    }, 100);
  });

  observer.observe(historySection, {
    childList: true,
    subtree: true,
    characterData: true
  });
})();

function attachAutosave(){
  ['input','change'].forEach(evt=>{
    document.body.addEventListener(evt, scheduleAutosave, { capture:true });
  });
}

/*** ==== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¨ãƒ©ãƒ¼ã§å‡ºã¦ã„ãŸ clearAllRemote ã‚‚å®šç¾©ï¼‰ ==== ***/
async function clearAllRemote(key = monthKey()){
  await setDoc(docRefFor(key), {
    app1: {}, app2: {}, app3: {},
    updatedAt: serverTimestamp(),
    lastAuthor: CLIENT_ID
  }, { merge:true });
}
window.clearAllRemote = clearAllRemote;
window.saveAllApps   = saveAllApps;   // æ‰‹å‹•ä¿å­˜ã—ãŸã„æ™‚ç”¨
window.loadAllApps   = loadAllApps;   // æ‰‹å‹•èª­è¾¼ã—ãŸã„æ™‚ç”¨

/*** ==== èµ·å‹• ==== ***/
window.addEventListener('DOMContentLoaded', async ()=>{
  ensureIndicator();
  await loadAllApps(monthKey());  // â‘ ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã‚‰å³èª­ã¿è¾¼ã¿
  attachAutosave();               // â‘¡å…¥åŠ›ã®ãŸã³ã«è‡ªå‹•ä¿å­˜ï¼ˆ800msãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  subscribeRemote(monthKey());    // â‘¢ä»–ç«¯æœ«ã®æ›´æ–°ã‚’å³æ™‚åæ˜ 
});

// ===== app2 å±¥æ­´ã®ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ =====
let app2History = [];

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSS/ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œå¯¾ç­–ï¼‰
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// å±¥æ­´ã®æç”»
function renderApp2History(){
  const ul = document.getElementById('app2-historyList');
  if(!ul) return;
  ul.innerHTML = app2History.map(e => {
    const when = new Date(e.time||Date.now()).toLocaleString();
  return `<li class="history-item">
            <span class="history-name">${escapeHtml(e.cast||'ï¼ˆåå‰ãªã—ï¼‰')}</span>ï½œ${when}
            ï½œå°è¨ˆ:${e.subtotal?.toLocaleString?.() ?? e.subtotal}
            ï½œåˆè¨ˆ:${e.total?.toLocaleString?.() ?? e.total}
            ï½œæœ€çµ‚:${e.final?.toLocaleString?.() ?? e.final}
          </li>`;
  }).join('');
}

// Firebase ã¸å±¥æ­´ã‚’ä¿å­˜ï¼ˆsaveRemote ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼‰
async function persistApp2History(){
  // â‘  æ—¢å­˜ã® saveRemote(appId, stateObj) ãŒã‚ã‚‹å ´åˆ
  if (typeof saveRemote === 'function'){
    await saveRemote('app2', { history: app2History });
    return;
  }
  // â‘¡ ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆuseFirebase ã‚’ä½¿ã†å‰æï¼‰
  if (typeof useFirebase === 'function'){
    const fb = await useFirebase();
    if(!fb) return;
    const { db, doc, setDoc, serverTimestamp } = fb;
    await setDoc(
      doc(db, 'apps', 'app2'),              // â† ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç’°å¢ƒã«åˆã‚ã›ã¦
      { history: app2History, updatedAt: serverTimestamp() },
      { merge: true }
    );
  }
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­ï¼ˆä»–ç«¯æœ«ã®æ›´æ–°ã‚’å³åæ˜ ï¼‰
async function startApp2Realtime(){
  if (typeof useFirebase !== 'function') return;
  const fb = await useFirebase();
  if(!fb) return;
  const { db, doc, onSnapshot } = fb;
  const ref = doc(db, 'apps', 'app2');      // â† ä¿å­˜å…ˆã«åˆã‚ã›ã¦åŒã˜å‚ç…§ã«ã™ã‚‹
  onSnapshot(ref, (snap) => {
    const data = snap.data();
    if (!data || !Array.isArray(data.history)) return;
    // è‡ªåˆ†ã®ç›´å¾Œä¿å­˜ã§é‡è¤‡ã—ã«ãã„ã‚ˆã†ç°¡å˜ãªç­‰ä¾¡ãƒã‚§ãƒƒã‚¯
    const jsonLocal  = JSON.stringify(app2History);
    const jsonRemote = JSON.stringify(data.history);
    if (jsonLocal !== jsonRemote){
      app2History = data.history;
      renderApp2History();
    }
  });
}

// åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼ˆãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ä¸€åº¦ã ã‘å–ã‚Šè¾¼ã¿ï¼‰
async function loadApp2HistoryOnce(){
  if (typeof useFirebase !== 'function') return renderApp2History();
  const fb = await useFirebase();
  if(!fb) return renderApp2History();
  const { db, doc, getDoc } = fb;
  const ref = doc(db, 'apps', 'app2');      // â† ä¿å­˜å…ˆã«åˆã‚ã›ã‚‹
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : null;
  app2History = Array.isArray(data?.history) ? data.history : [];
  renderApp2History();
}

document.addEventListener('DOMContentLoaded', () => {
  loadApp2HistoryOnce();  // ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€
  startApp2Realtime();    // ä»¥å¾Œã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
});

/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.1
   - å€¤ã‚’å±æ€§ã«ç„¼ãè¾¼ã¿ï¼ˆvalue/checked/selectedï¼‰
   - ã‚¿ãƒ–ã‚’ã‚¢ãƒ³ã‚«ãƒ¼å¼ã«å¤‰æ›ï¼ˆ:targetï¼‰
   - JSãªã—ãƒ»ç·¨é›†ä¸å¯
   - createElementã¯å¸¸ã« document.createElement ã‚’ä½¿ç”¨
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.2ï¼ˆJSä¸è¦ã§åˆ‡æ›¿ã€å€¤ã‚’ç„¼ãè¾¼ã¿ã€ç·¨é›†ä¸å¯ï¼‰
   - createElement ã¯å¸¸ã« document.createElement ã‚’ä½¿ç”¨
   - onclick ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã« window ã«å…¬é–‹
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.3
   - id/nameãƒãƒƒãƒã§â€œæ­£ã—ã„ç›¸æ‰‹â€ã«å€¤ã‚’ç„¼ãè¾¼ã¿ï¼ˆindexä¾å­˜ã‚’ã‚„ã‚ã‚‹ï¼‰
   - input/textarea/select/checkbox/radio ã«åŠ ãˆã€span/div/output/contenteditable ã‚‚å›ºå®š
   - ã‚¿ãƒ–ã¯<a href="#appX">+ :target ã§JSä¸è¦åˆ‡æ›¿
   - ç”Ÿæˆç‰©ã¯ç·¨é›†ä¸å¯ï¼ˆdisabled/readonlyï¼‰ï¼‹å…¨scriptå‰Šé™¤
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.4
   - å€¤ã‚’å±æ€§ã¸â€œç„¼ãè¾¼ã¿â€ï¼ˆvalue / checked / selectedï¼‰
   - span/div/output ãªã©è¡¨ç¤ºç”¨ãƒãƒ¼ãƒ‰ã‚‚å›ºå®š
   - contenteditable ã‚‚ä¸­èº«ã‚’å›ºå®šã—ã¦éç·¨é›†åŒ–
   - ã‚¿ãƒ–ã¯ <a href="#appX"> + :target ã§ JSä¸è¦åˆ‡æ›¿
   - ç”Ÿæˆç‰©ã¯ç·¨é›†ä¸å¯ï¼ˆå…¨ãƒ•ã‚©ãƒ¼ãƒ ç„¡åŠ¹åŒ–ï¼‰ï¼‹å…¨ <script> å‰Šé™¤
   - createElement ã¯å¿…ãš document.createElement ã‚’ä½¿ç”¨
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.5
   - ç¾åœ¨å€¤ã‚’å±æ€§ã¸ç„¼ãè¾¼ã¿ï¼ˆvalue/checked/selectedï¼‰
   - span/div/output/contenteditable ã‚‚å›ºå®š
   - ã‚¿ãƒ–(.tabs .tab)ã¯ <a href="#appX"> ã«ç½®æ›ã—ã¦ :target ã§åˆ‡æ›¿
   - ä¿å­˜ç‰©ã¯ç·¨é›†ä¸å¯ï¼ˆdisabled/readonlyï¼‰ï¼‹ <script> å…¨å‰Šé™¤
   - createElement ã¯ document.createElementã€idå‚ç…§ã¯ querySelector ã§çµ±ä¸€
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.6ï¼ˆå®‰å®šç‰ˆï¼‰
   - input/textarea/select ã®ç¾åœ¨å€¤ã ã‘â€œç„¼ãè¾¼ã¿â€ï¼ˆvalue/checked/selectedï¼‰
   - span/div/output ç­‰ã®ãƒ†ã‚­ã‚¹ãƒˆç„¼ãè¾¼ã¿ã¯ä¸€æ—¦ã‚„ã‚ã¦å®‰å…¨å´ã¸
   - 3ã¤ã®APP(#app1,#app2,#app3)ã¯å¼·åˆ¶ display:block ã«ã—ã¦å…¨ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
   - ä¿å­˜ç‰©ã¯ç·¨é›†ä¸å¯ï¼ˆdisabled/readonlyï¼‰ï¼‹ <script> å…¨å‰Šé™¤
   - ã‚¿ãƒ–åˆ‡æ›¿ã®CSSã¯è¿½åŠ ã—ãªã„ï¼ˆè¦‹ãˆãªããªã‚‹äº‹æ•…é˜²æ­¢ï¼‰
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.7
   - å€¤ã‚’ç„¼ãè¾¼ã¿ï¼ˆvalue/checked/selectedï¼‰
   - ã‚¿ãƒ–<div.tab data-target="appX">â†’ <a class="tab" href="#appX"> ã«å¤‰æ›
   - :target ã§ .content ã‚’åˆ‡æ›¿ï¼ˆJSä¸è¦ï¼‰ã€‚ãƒãƒƒã‚·ãƒ¥ç„¡ã—æ™‚ã¯ #app1 ã‚’è¡¨ç¤º
   - æ—¢å­˜JSã¯å‰Šé™¤ã€ä¿å­˜ç‰©ã¯ç·¨é›†ä¸å¯
*/
/* å…¥åŠ›æ¸ˆã¿HTMLã¨ã—ã¦ä¿å­˜ v2.9
   - å€¤ç„¼ãè¾¼ã¿ï¼ˆid/nameå„ªå…ˆï¼‹APP1ã¯è¡ŒÃ—ã‚¯ãƒ©ã‚¹ã€ã‚«ãƒ†ã‚´ãƒªè¡¨ãƒã‚§ãƒƒã‚¯ã¯å‡ºç¾é †ï¼‰
   - ã‚¿ãƒ– <div.tab data-target="appX"> â†’ <a class="tab" href="#appX">
   - :target ã§ .content ã‚’åˆ‡æ›¿ï¼ˆJSä¸è¦ï¼‰ã€‚åˆæœŸã¯ app1 ã‚’è¡¨ç¤º
   - æ—¢å­˜ã®opacity/transformã‚¢ãƒ‹ãƒ¡ã¯ä¸Šæ›¸ãã§ç„¡åŠ¹åŒ–ï¼ˆè¦‹ãˆãªã„äº‹æ•…é˜²æ­¢ï¼‰
   - ä¿å­˜ç‰©ã¯ç·¨é›†ä¸å¯ï¼ˆdisabled/readonlyï¼‰ï¼‹ <script> å…¨å‰Šé™¤
*/
window.exportAsFilledHTML = function(){
  const doc = document;
  const cloned = doc.documentElement.cloneNode(true);
  const $all = (root, sel) => Array.from(root.querySelectorAll(sel));
  const esc  = (window.CSS && CSS.escape) ? CSS.escape : s=>String(s).replace(/[^a-zA-Z0-9_\-]/g,'\\$&');
  const byId = (root, id) => id ? root.querySelector('#'+esc(id)) : null;

  // ===== 1) å€¤ã®ç„¼ãè¾¼ã¿ï¼ˆid/name å„ªå…ˆï¼‰ =====
  // input
  $all(doc,'input').forEach(oi=>{
    const ci = (oi.id && byId(cloned,oi.id)) || (oi.name && cloned.querySelector(`[name="${esc(oi.name)}"]`));
    if(!ci) return;
    const type=(oi.getAttribute('type')||'text').toLowerCase();
    if(type==='checkbox'||type==='radio'){
      if(oi.checked) ci.setAttribute('checked',''); else ci.removeAttribute('checked');
      if(type==='radio' && oi.name){
        $all(cloned,`input[type="radio"][name="${esc(oi.name)}"]`).forEach(r=>{ if(r!==ci) r.removeAttribute('checked'); });
      }
    }else{
      ci.setAttribute('value', oi.value ?? '');
    }
    ci.setAttribute('disabled','disabled'); ci.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>ci.removeAttribute(a));
  });
  // textarea
  $all(doc,'textarea').forEach(ot=>{
    const ct = (ot.id && byId(cloned,ot.id)) || (ot.name && cloned.querySelector(`[name="${esc(ot.name)}"]`));
    if(!ct) return;
    ct.textContent = ot.value ?? '';
    ct.setAttribute('disabled','disabled'); ct.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>ct.removeAttribute(a));
  });
  // select
  $all(doc,'select').forEach(os=>{
    const cs = (os.id && byId(cloned,os.id)) || (os.name && cloned.querySelector(`[name="${esc(os.name)}"]`));
    if(!cs) return;
    const val = os.value ?? '';
    $all(cs,'option').forEach(opt=>{ if(opt.value===val) opt.setAttribute('selected',''); else opt.removeAttribute('selected'); });
    cs.setAttribute('disabled','disabled'); cs.setAttribute('readonly','readonly');
    ['onclick','onchange','oninput','onsubmit'].forEach(a=>cs.removeAttribute(a));
  });

  // ===== 2) APP1 ä¼ç¥¨è¡Œï¼ˆ#formRows tr.rowï¼‰ã‚’è¡ŒÃ—ã‚¯ãƒ©ã‚¹ã§ç„¼ãè¾¼ã¿ =====
  const oRows = $all(doc,'#formRows tr.row');
  const cRows = $all(cloned,'#formRows tr.row');
  const fields = ['.table-number','.honshi','.c','.amount','.num','.detail','.card','.total'];
  oRows.forEach((tr,i)=>{
    const ctr = cRows[i]; if(!ctr) return;
    fields.forEach(sel=>{
      const oi = tr.querySelector(sel);
      const ci = ctr.querySelector(sel);
      if(!oi || !ci) return;
      if (ci.tagName === 'SELECT') {
        const val = oi.value ?? '';
        $all(ci,'option').forEach(opt=>{ if(opt.value===val) opt.setAttribute('selected',''); else opt.removeAttribute('selected'); });
      } else {
        const type=(oi.getAttribute('type')||'text').toLowerCase();
        if(type==='checkbox'||type==='radio'){
          if(oi.checked) ci.setAttribute('checked',''); else ci.removeAttribute('checked');
        }else{
          ci.setAttribute('value', oi.value ?? '');
        }
      }
      ci.setAttribute('disabled','disabled'); ci.setAttribute('readonly','readonly');
      ['onclick','onchange','oninput','onsubmit'].forEach(a=>ci.removeAttribute(a));
    });
  });

  // ===== 3) ã‚«ãƒ†ã‚´ãƒªè¡¨ãƒã‚§ãƒƒã‚¯ï¼ˆ#categorySectionï¼‰ã‚’å‡ºç¾é †ã§å›ºå®š =====
  const oCbs = $all(doc,'#categorySection input[type="checkbox"]');
  const cCbs = $all(cloned,'#categorySection input[type="checkbox"]');
  oCbs.forEach((o,i)=>{
    const c = cCbs[i]; if(!c) return;
    if(o.checked) c.setAttribute('checked',''); else c.removeAttribute('checked');
    c.setAttribute('disabled','disabled');
    ['onclick','onchange'].forEach(a=>c.removeAttribute(a));
  });

  // ===== 4) ã‚¿ãƒ–ã‚’ã‚¢ãƒ³ã‚«ãƒ¼å¼ã«å¤‰æ›ï¼ˆJSä¸è¦ã®åˆ‡æ›¿ï¼‰ =====
  const tabsBar = cloned.querySelector('.tabs');
  if(tabsBar){
    $all(tabsBar,'.tab').forEach(old=>{
      if(old.tagName.toLowerCase()==='a') return;
      const target = old.getAttribute('data-target') || 'app1';
      const label  = (old.textContent||'').trim() || target;
      const a = document.createElement('a');
      a.className = old.className.replace(/\bactive\b/g,'').trim();
      a.setAttribute('href','#'+target);
      a.setAttribute('role','tab');
      a.textContent = label;
      old.replaceWith(a);
    });
  }

  // ===== 5) ä¿å­˜ç‰ˆç”¨CSSã‚’è¿½åŠ ï¼ˆ:target ã§åˆ‡æ›¿ & ã‚¢ãƒ‹ãƒ¡ç„¡åŠ¹åŒ–ï¼‰ =====
  const head  = cloned.querySelector('head') || cloned.getElementsByTagName('head')[0];
  const style = document.createElement('style');
  style.textContent = `
    /* ä¿å­˜ç‰ˆãƒãƒƒã‚¸ï¼†æ“ä½œä¸å¯ */
    body[data-frozen="1"] * { caret-color: transparent; }
    [disabled], input[readonly], select[disabled], textarea[disabled]{ opacity:.85; pointer-events:none; }
    .frozen-banner{
      position:fixed; top:8px; right:8px; z-index:99999;
      padding:6px 10px; font:12px/1 system-ui,-apple-system,Segoe UI,Roboto,"M PLUS 2",sans-serif;
      background:rgba(0,245,255,.14); border:1px solid rgba(0,245,255,.55);
      border-radius:8px; color:#00f5ff; backdrop-filter: blur(6px);
    }
    /* æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ã‚’æ‰“ã¡æ¶ˆã—ã¦â€œè¡¨ç¤ºå„ªå…ˆâ€ */
    .content{ opacity:1 !important; transform:none !important; }

    /* JSãªã—ã®APPåˆ‡æ›¿ï¼šãƒ‡ãƒ•ã‚©éè¡¨ç¤ºã€:targetã ã‘è¡¨ç¤º */
    .content{ display:none !important; }
    .content:target{ display:block !important; }
    /* ãƒãƒƒã‚·ãƒ¥ç„¡ã—ã®åˆæœŸè¡¨ç¤ºã¯app1 */
    :root #app1{ display:block !important; }
  `;
  head.appendChild(style);

  // ===== 6) ãƒãƒŠãƒ¼ä»˜ä¸ãƒ»åˆæœŸè¡¨ç¤ºã®ä¿é™º =====
  const body = cloned.querySelector('body') || cloned.getElementsByTagName('body')[0];
  if(body){
    body.setAttribute('data-frozen','1');
    const banner = document.createElement('div');
    banner.className = 'frozen-banner';
    banner.textContent = 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…¥åŠ›æ¸ˆã¿ã®ä¿å­˜ç‰ˆï¼ˆç·¨é›†ä¸å¯ï¼‰';
    body.appendChild(banner);
  }
  ['app1','app2','app3'].forEach(id=>{
    const el = byId(cloned,id);
    if(el){ el.removeAttribute('hidden'); el.style.visibility='visible'; }
  });

  // ===== 7) ã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼ˆè¨¼è·¡ç”¨ï¼‰ =====
  $all(cloned,'button').forEach(b=>{ b.setAttribute('disabled','disabled'); b.removeAttribute('onclick'); b.type='button'; });
  $all(cloned,'form').forEach(f=>{ f.setAttribute('onsubmit','return false;'); });

  // ===== 8) <script> å…¨å‰Šé™¤ï¼ˆå®Œå…¨é™çš„åŒ–ï¼‰ =====
  $all(cloned,'script').forEach(s=> s.remove());

  // ===== 9) ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
  const htmlText = '<!DOCTYPE html>\n' + cloned.outerHTML;
  const blob = new Blob([htmlText], { type:'text/html' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  try{
    const base = (typeof window.getCustomFileName==='function') ? window.getCustomFileName()
               : 'IBASD_' + new Date().toISOString().slice(0,10);
    a.href = url; a.download = base + '.html'; a.click();
  } finally {
    URL.revokeObjectURL(url);
  }
};


/* åˆè¨ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°å®šç¾©ï¼‰ */
if (typeof window.subtotal !== 'function') {
  window.subtotal = function(values){
    let s = 0; for (const v of (values||[])) s += (Number(v)||0); return s;
  };
}

// ====== å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ ======
// CSSå¤‰æ•°(px)ã‚’å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ï¼‰
function getVarPx(name, fallback = 0){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : fallback;
}

// å›ºå®šãƒ˜ãƒƒãƒ€ï¼ˆã‚¿ãƒ–ï¼‹ã‚µãƒ–ãƒŠãƒ“ï¼‰ã®ç·é«˜ã•ã‚’å–å¾—
function getNavOffsetPx(){
  const tabs = document.querySelector('.tabs')?.offsetHeight ?? getVarPx('--tabs-h', 56);
  const sub  = document.querySelector('#app2-nav')?.offsetHeight ?? getVarPx('--subnav-h', 50);
  return tabs + sub + 10; // ä»•ä¸Šã’ã®ä½™ç™½10px
}

// ã‚ªãƒ•ã‚»ãƒƒãƒˆä»˜ãã‚¹ãƒ ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
function scrollWithOffset(targetEl){
  const y = targetEl.getBoundingClientRect().top + window.scrollY - getNavOffsetPx();
  window.scrollTo({ top: y, behavior: 'smooth' });
}

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç½®ãå ´ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã‚’ç¢ºä¿ or ä½œæˆï¼ˆapp2-inputSection ã®ç›´å‰ï¼‰
function ensureHistoryIndexTable(){
  let table = document.getElementById('historyIndexTable');
  if (table) return table;

  const inputSection = document.getElementById('app2-inputSection'); // â†ã“ã“ã‚’åŸºæº–ã«å·®ã—è¾¼ã¿
  if (!inputSection) return null;

  table = document.createElement('table');
  table.id = 'historyIndexTable';
  table.className = 'history-index-table';
table.innerHTML = `
  <thead>
    <tr>
      <th>
        <button id="historyIndexToggle" class="history-index-toggle" type="button">
          <span class="history-index-title">å±¥æ­´</span>
          <span id="historyIndexCount" class="history-index-count">0äºº</span>
          <span class="caret">â–¾</span>
        </button>
      </th>
    </tr>
  </thead>
  <tbody id="historyIndexBody"></tbody>
`;

  // app2-inputSection ã®ã€Œç›´å‰ã€ã«è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã®ä¸Šã«å‡ºã™ï¼‰
  inputSection.parentNode.insertBefore(table, inputSection);
  return table;
}

document.addEventListener('click', (e)=>{
  if (e.target.closest('#historyIndexToggle')) {
    const tbl = document.getElementById('historyIndexTable');
    tbl?.classList.toggle('collapsed');
  }
});

// ãƒ†ãƒ¼ãƒ–ãƒ«ç‰ˆï¼šå±¥æ­´ã‹ã‚‰æ°åãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼ˆåˆ—æ•°ã¯ç”»é¢å¹…ã§å¤‰åŒ–ï¼‰
function createHistoryIndex(){
  const historySection = document.getElementById('app2-historySection');
  if (!historySection) return;

  const table = ensureHistoryIndexTable();
  if (!table) return;

  const tbody = table.querySelector('#historyIndexBody');
  if (!tbody) return;

  // 1) å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‹¾ã†ï¼ˆæ¨å¥¨: .history-itemã€æ—§: #historyList > liï¼‰
  let items = historySection.querySelectorAll('.history-item');
  if (items.length === 0) {
    const list = document.getElementById('historyList');
    if (list) items = list.querySelectorAll('li');
  }
  if (!items || items.length === 0){
    tbody.innerHTML = '';
    return;
  }

// 2) {name, el} ã®é…åˆ—ã‚’ä½œã‚‹ï¼ˆ.history-name / .castName / <b>ï¼‰
const map = new Map();
items.forEach(item => {
  const nameEl = item.querySelector('.history-name')
              || item.querySelector('.castName')
              || item.querySelector('b');
  const raw  = nameEl?.textContent?.trim() || '';
  const base = stripLeadingSerial(raw);   // â˜… é€£ç•ªã‚’é™¤å»ã—ãŸè¡¨ç¤ºå
  if (base && !map.has(base)) map.set(base, item);
});

const pairs = Array.from(map, ([name, el]) => ({ name, el }));

  const countEl = document.getElementById('historyIndexCount');
  if (countEl) countEl.textContent = `${pairs.length}äºº`;


// 3) ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šãƒ¢ãƒã‚¤ãƒ«ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒãƒƒãƒ—1è¡Œ / PCã¯è¡¨ã‚°ãƒªãƒƒãƒ‰
const isMobile = window.matchMedia('(max-width:700px)').matches;
tbody.innerHTML = '';

if (isMobile) {
  const tr = document.createElement('tr');
  const td = document.createElement('td');
  const wrap = document.createElement('div');
  wrap.className = 'history-chip-row'; // â† CSSã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

  pairs.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'idx-btn';
    btn.type = 'button';
    btn.textContent = p.name;
    btn.addEventListener('click', () => scrollWithOffset(p.el));
    wrap.appendChild(btn);
  });

  td.appendChild(wrap);
  tr.appendChild(td);
  tbody.appendChild(tr);
} else {
  const COLS = 6; // PCåˆ—æ•°
  for (let i = 0; i < pairs.length; i += COLS){
    const tr = document.createElement('tr');
    for (let c = 0; c < COLS; c++){
      const td = document.createElement('td');
      const p = pairs[i + c];
      if (p){
        const btn = document.createElement('button');
        btn.className = 'idx-btn';
        btn.type = 'button';
        btn.textContent = p.name;
        btn.addEventListener('click', () => scrollWithOffset(p.el));
        td.appendChild(btn);
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

}

// å…¬é–‹ã—ã¦ãŠãï¼ˆå¿…è¦ãªã‚‰æ‰‹å‹•å†ç”Ÿæˆã§å‘¼ã¹ã‚‹ï¼‰
window.createHistoryIndex = createHistoryIndex;

// åˆæœŸåŒ–ï¼šå±¥æ­´å¤‰åŒ–ã‚’ç›£è¦–ã—ã¦è‡ªå‹•å†ç”Ÿæˆï¼‹åˆå›å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', () => {
  const historySection = document.getElementById('app2-historySection');
  if (historySection){
    const mo = new MutationObserver(() => createHistoryIndex());
    mo.observe(historySection, { childList:true, subtree:true });
  }
  createHistoryIndex();
});

// å…ˆé ­ã®é€£ç•ªã€Œ1. ã€ã€Œï¼‘ï¼‰ã€ã€Œ#3 ã€ãªã©ã‚’å‰Šé™¤
function stripLeadingSerial(s){
  if (!s) return '';
  return s.replace(
    /^\s*(?:No\.|#)?\s*[0-9ï¼-ï¼™]+\s*[\)\]ï¼‰.ï¼ã€:ï¼š-]?\s*/u,
    ''
  ).trim();
}

document.addEventListener('DOMContentLoaded', () => {
  addOutputButtonsNextToRestore();
  const his = document.getElementById('app2-historySection');
  if (his) {
    const mo = new MutationObserver(() => addOutputButtonsNextToRestore());
    mo.observe(his, { childList: true, subtree: true });
  }
});

function addOutputButtonsNextToRestore() {
  const historySection = document.getElementById('app2-historySection');
  if (!historySection) return;

  let items = historySection.querySelectorAll('.history-item');
  if (items.length === 0) {
    const list = document.getElementById('historyList');
    if (list) items = list.querySelectorAll('li');
  }
  if (!items.length) return;

  items.forEach(item => {
    if (item.querySelector('.output-btn')) return;

    // å¾©å…ƒãƒœã‚¿ãƒ³æ¢ã™
    const restoreBtn = Array.from(item.querySelectorAll('button'))
      .find(b => b.textContent.includes('å¾©å…ƒ'));
    if (!restoreBtn) return;

    // å‡ºåŠ›ãƒœã‚¿ãƒ³ç”Ÿæˆ
    const outBtn = document.createElement('button');
    outBtn.className = 'output-btn';
    outBtn.textContent = 'å‡ºåŠ›';
    outBtn.style.marginLeft = '8px';

    outBtn.addEventListener('click', async e => {
      e.stopPropagation();

      // 1ï¸âƒ£ è©²å½“ã®å¾©å…ƒãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
      restoreBtn.click();

      // 2ï¸âƒ£ å¾©å…ƒå‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§å°‘ã—å¾…ã¤ï¼ˆéåŒæœŸå‡¦ç†å¯¾ç­–ï¼‰
      await new Promise(res => setTimeout(res, 800));

      // 3ï¸âƒ£ æ—¢å­˜ã®å‡ºåŠ›å‡¦ç†ï¼ˆpreparePrintApp2ï¼‰ã‚’å‘¼ã¶
      if (typeof window.preparePrintApp2 === 'function') {
        preparePrintApp2('envelope');
      } else {
        alert('å‡ºåŠ›æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
      }
    });

    // å¾©å…ƒã®å³æ¨ªã«è¨­ç½®
    restoreBtn.insertAdjacentElement('afterend', outBtn);

    // æ¨ªä¸¦ã³ã‚’æ•´ãˆã‚‹
    const parent = restoreBtn.parentElement;
    parent.style.display = 'flex';
    parent.style.flexWrap = 'nowrap';
    parent.style.alignItems = 'center';
    parent.style.gap = '8px';
  });
}

// è‡ªå‹•å†é©ç”¨
document.addEventListener('DOMContentLoaded', () => {
  addOutputButtonsNextToRestore();
  const his = document.getElementById('app2-historySection');
  if (his) {
    const mo = new MutationObserver(() => addOutputButtonsNextToRestore());
    mo.observe(his, { childList: true, subtree: true });
  }
});

window.sortHistoryIndex = function() {
  const container = document.querySelector('.history-index-table');
  if (!container) return;

  // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å…¨éƒ¨å–å¾—ï¼ˆè¡¨é¡Œè¡Œã¯é™¤å¤–ï¼‰
  const buttons = Array.from(container.querySelectorAll('.idx-btn'));

  // 50éŸ³é †ã‚½ãƒ¼ãƒˆï¼ˆæ¿éŸ³ãƒ»åŠæ¿éŸ³ãƒ»å°æ–‡å­—ã‚‚è€ƒæ…®ï¼‰
  buttons.sort((a, b) => {
    const aText = a.textContent
      .replace(/[ã‚¡-ãƒ³]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60)) // ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
      .replace(/[ï¾ï¾Ÿ]/g, ""); // æ¿ç‚¹é™¤å»
    const bText = b.textContent
      .replace(/[ã‚¡-ãƒ³]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60))
      .replace(/[ï¾ï¾Ÿ]/g, "");
    return aText.localeCompare(bText, 'ja');
  });

  // ä¸¦ã¹æ›¿ãˆåæ˜ ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ã‚’å‰Šé™¤ã—ã¦å†è¿½åŠ ï¼‰
  const title = container.querySelector('.history-index-title');
  container.querySelectorAll('.idx-btn').forEach(btn => btn.remove());
  buttons.forEach(btn => container.appendChild(btn));
  
  // æˆåŠŸæ™‚ã®è»½ã„è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  title.style.textShadow = '0 0 8px #00f5ff';
  setTimeout(() => title.style.textShadow = '', 800);
};


</script>



</body>
</html>
